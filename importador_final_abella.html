<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Importador Oficial | Abella Joias</title>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#fdfaf5;
  padding:40px;
}
.box{
  max-width:650px;
  margin:auto;
  background:#fff;
  border:2px solid #A68966;
  border-radius:16px;
  padding:30px;
}
h1{color:#A68966;margin-bottom:10px}
button{
  width:100%;
  padding:15px;
  font-weight:bold;
  border:none;
  background:#1a1a1a;
  color:#fff;
  cursor:pointer;
  margin-top:15px;
}
#log{
  background:#f4f4f4;
  padding:15px;
  margin-top:20px;
  height:240px;
  overflow:auto;
  font-family:monospace;
  font-size:12px;
}
.ok{color:green}
.err{color:red}
</style>
</head>

<body>

<div class="box">
  <h1>Importador Oficial Abella</h1>
  <p>Selecione o arquivo <b>CSV UTF-8</b> exportado da planilha</p>

  <input type="file" id="csvFile" accept=".csv">

  <button onclick="importar()">LIMPAR PRODUTOS E IMPORTAR</button>

  <div id="status" style="margin-top:15px;font-weight:bold"></div>
  <div id="log">Aguardando arquivo…</div>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
  authDomain: "catalogo-abella-joias.firebaseapp.com",
  databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
  projectId: "catalogo-abella-joias"
});

const db = firebase.database();
const log = msg => {
  document.getElementById('log').innerHTML += msg + "<br>";
  document.getElementById('log').scrollTop = 99999;
};

async function importar(){
  const file = document.getElementById('csvFile').files[0];
  if(!file) return alert("Selecione o CSV");

  document.getElementById('status').innerHTML = "⏳ Processando…";
  document.getElementById('log').innerHTML = "";

  const texto = await file.text();
  const linhas = texto.replace(/\r/g,'').split('\n');

  if(linhas.length < 2){
    alert("Arquivo inválido");
    return;
  }

  // Cabeçalhos
  const headers = linhas[0].split(',').map(h=>h.trim().toLowerCase());

  const idx = nome => headers.indexOf(nome);

  if(idx('sku') === -1){
    alert("Coluna SKU não encontrada");
    return;
  }

  await db.ref('products').remove();
  log("✔ Banco de produtos limpo");

  let total = 0;

  for(let i=1;i<linhas.length;i++){
    const linha = linhas[i].trim();
    if(!linha) continue;

    const cols = linha.split(',');

    const produto = {
      nome: cols[idx('nome')]?.replace(/"/g,'').trim() || '',
      sku: cols[idx('sku')]?.replace(/"/g,'').trim(),
      categoria: cols[idx('categoria')]?.replace(/"/g,'').trim() || 'Geral',
      preco: parseFloat(cols[idx('preco')]?.replace(',','.')) || 0,
      peso: parseFloat(cols[idx('peso')]?.replace(',','.')) || 0,
      imagem: cols[idx('imagem')]?.replace(/"/g,'') || '',
      promo: 0,
      variacoes: cols[idx('variacoes')] === 'TRUE',
      ativo: true,
      dataImportacao: new Date().toISOString()
    };

    if(!produto.sku) continue;

    const key = produto.sku.replace(/[.#$/\[\]]/g,'_');
    await db.ref('products/'+key).set(produto);

    total++;
    log(`<span class="ok">✔ ${produto.sku} importado</span>`);
  }

  document.getElementById('status').innerHTML =
    `<span class="ok">✅ Importação concluída (${total} produtos)</span>`;
}
</script>

</body>
</html>

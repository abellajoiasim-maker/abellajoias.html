<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Importador Mestre - Abella Joias</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 40px; background: #f8f6f2; }
        .box { background: white; max-width: 500px; margin: auto; padding: 30px; border-radius: 15px; border: 2px solid #A68966; box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        button { background: #000; color: #fff; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 20px; }
        #log { text-align: left; background: #f0f0f0; padding: 15px; margin-top: 20px; font-size: 13px; max-height: 200px; overflow-y: auto; border-radius: 5px; }
    </style>
</head>
<body>

<div class="box">
    <h2 style="color:#A68966">Importação Geral</h2>
    <p>Selecione o arquivo: <br><b>abella-produtos-importacao.csv</b></p>
    
    <input type="file" id="arquivoCsv" accept=".csv">
    <button onclick="importarTudo()">LIMPAR E IMPORTAR TUDO</button>
    
    <div id="status" style="margin-top:20px; font-weight:bold;">Aguardando...</div>
    <div id="log">Pronto para iniciar.</div>
</div>

<script>
    var firebaseConfig = {
        apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
        authDomain: "catalogo-abella-joias.firebaseapp.com",
        databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
        projectId: "catalogo-abella-joias"
    };
    
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();

    async function importarTudo() {
        var input = document.getElementById('arquivoCsv');
        var status = document.getElementById('status');
        var log = document.getElementById('log');

        if (input.files.length === 0) return alert("Selecione o arquivo CSV!");

        status.innerText = "Limpando banco e processando...";
        log.innerHTML = "Iniciando leitura...";

        try {
            var file = input.files[0];
            var texto = await file.text();
            
            // Limpa o banco de produtos atual para começar do zero
            await db.ref('products').remove();

            // Divide as linhas tratando quebras de linha de diferentes sistemas
            var linhas = texto.replace(/\r/g, "").split("\n");
            var batch = {};
            var contador = 0;

            for (var i = 1; i < linhas.length; i++) {
                if (!linhas[i].trim()) continue;

                // Este arquivo usa VÍRGULA como separador
                var colunas = linhas[i].split(",");
                
                var sku = colunas[1] ? colunas[1].trim() : "";
                if (!sku || sku.toLowerCase() === 'sku') continue;

                var chave = sku.replace(/[\.\#\$\/\[\]]/g, "_");

                batch[chave] = {
                    nome: colunas[0] ? colunas[0].trim().replace(/"/g, "") : "Sem nome",
                    sku: sku,
                    categoria: colunas[2] ? colunas[2].trim() : "Geral",
                    preco: colunas[3] ? parseFloat(colunas[3]) : 0,
                    peso: colunas[4] ? parseFloat(colunas[4]) : 0,
                    imagem: ""
                };
                contador++;

                // Envia em blocos de 200 para não travar a conexão
                if (contador % 200 === 0) {
                    await db.ref('products').update(batch);
                    log.innerHTML += `Enviados ${contador} itens...<br>`;
                    batch = {}; 
                }
            }

            // Envia o restante
            if (Object.keys(batch).length > 0) {
                await db.ref('products').update(batch);
            }

            status.style.color = "green";
            status.innerText = "SUCESSO!";
            log.innerHTML += `<br><b>TOTAL FINAL: ${contador} produtos importados!</b>`;
            alert("Importação concluída com " + contador + " itens.");

        } catch (e) {
            console.error(e);
            status.innerText = "ERRO NA IMPORTAÇÃO";
            log.innerHTML += "<br>Erro: " + e.message;
        }
    }
</script>

</body>
</html>

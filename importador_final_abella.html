<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Importador Oficial – Abella Joias</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background:#fdfaf5;
  padding:40px;
  text-align:center;
}
.box {
  max-width:650px;
  margin:auto;
  background:#fff;
  border:2px solid #A68966;
  border-radius:16px;
  padding:30px;
}
button {
  width:100%;
  padding:14px;
  background:#1a1a1a;
  color:#fff;
  border:none;
  font-weight:bold;
  margin-top:15px;
  cursor:pointer;
}
#log {
  margin-top:20px;
  background:#f4f4f4;
  height:220px;
  overflow:auto;
  text-align:left;
  padding:15px;
  font-size:12px;
  font-family:monospace;
}
</style>
</head>

<body>
<div class="box">
  <h2 style="color:#A68966">Importador Final de Produtos</h2>
  <input type="file" id="file" accept=".csv">
  <button onclick="importar()">IMPORTAR PRODUTOS</button>
  <div id="status">Aguardando arquivo…</div>
  <div id="log">Logs:</div>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
  authDomain: "catalogo-abella-joias.firebaseapp.com",
  databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
  projectId: "catalogo-abella-joias"
});

const db = firebase.database();

function importar() {
  const file = document.getElementById("file").files[0];
  const log = document.getElementById("log");
  const status = document.getElementById("status");

  if (!file) return alert("Selecione o CSV");

  status.innerHTML = "Processando...";
  log.innerHTML = "Iniciando importação…<br>";

  const reader = new FileReader();
  reader.onload = async e => {
    const linhas = e.target.result.split("\n").map(l => l.trim()).filter(Boolean);
    const headers = linhas.shift().split(",").map(h => h.trim());

    let total = 0;
    let batch = {};

    for (const linha of linhas) {
      const cols = linha.split(",").map(c => c.replace(/"/g,"").trim());
      let item = {};

      headers.forEach((h,i)=> item[h] = cols[i] ?? "");

      if (!item.sku || !item.nome) continue;

      const key = item.sku.replace(/[.#$/\[\]]/g,"_");

      batch[key] = {
        nome: item.nome,
        sku: item.sku,
        categoria: item.categoria || "Geral",
        preco: parseFloat(item.preco) || 0,
        peso: parseFloat(item.peso) || 0,
        imagem: item.imagem || "",
        promo: 0
      };

      total++;

      if (total % 100 === 0) {
        await db.ref("products").update(batch);
        batch = {};
        log.innerHTML += `✔ ${total} produtos<br>`;
      }
    }

    if (Object.keys(batch).length)
      await db.ref("products").update(batch);

    status.innerHTML = "<b style='color:green'>Importação concluída!</b>";
    log.innerHTML += `<br><b>Total importado: ${total}</b>`;
  };

  reader.readAsText(file);
}
</script>
</body>
</html>

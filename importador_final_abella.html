<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Importador Master - Abella Joias</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        body { font-family: sans-serif; padding: 40px; background: #F8F6F2; text-align: center; }
        .card { max-width: 550px; margin: auto; background: white; padding: 30px; border-radius: 15px; border: 2px solid #A68966; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .btn-import { background: #000; color: white; padding: 15px; border: none; cursor: pointer; width: 100%; font-weight: bold; font-size: 16px; margin-top: 20px; border-radius: 5px; }
        #status { margin: 20px 0; font-weight: bold; padding: 10px; background: #eee; border-radius: 5px; min-height: 20px; }
        #log { font-size: 12px; height: 200px; overflow-y: auto; background: #1a1a1a; color: #33ff33; padding: 15px; text-align: left; border-radius: 5px; font-family: 'Courier New', monospace; white-space: pre-wrap; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="color:#A68966; margin-bottom: 5px;">Importador de Produtos</h2>
    <p style="font-size: 13px; color: #888; margin-top: 0;">Abella Joias - 1.300+ Itens</p>
    
    <input type="file" id="csvFiles" multiple accept=".csv" style="margin: 20px 0;">
    
    <button onclick="importarTudo()" class="btn-import">LIMPAR BANCO E IMPORTAR</button>
    
    <div id="status">Aguardando seleção de arquivos...</div>
    <div id="log">Console pronto...</div>
</div>

<script>
    // Configurações do seu Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
        authDomain: "catalogo-abella-joias.firebaseapp.com",
        databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
        projectId: "catalogo-abella-joias"
    };

    // Inicialização
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    async function importarTudo() {
        const input = document.getElementById('csvFiles');
        const status = document.getElementById('status');
        const log = document.getElementById('log');

        if (input.files.length === 0) {
            alert("Selecione os arquivos CSV primeiro!");
            return;
        }

        if (!confirm("Isso apagará os produtos atuais para evitar duplicados. Confirmar?")) return;

        try {
            status.style.color = "blue";
            status.innerText = "Limpando banco de dados...";
            log.innerHTML = "> Iniciando limpeza...\n";
            
            // Apaga produtos antigos
            await db.ref('products').remove();
            log.innerHTML += "> Banco de dados limpo.\n";

            let totalImportado = 0;
            const arquivos = Array.from(input.files);

            for (const file of arquivos) {
                status.innerText = `Processando: ${file.name}`;
                log.innerHTML += `> Lendo: ${file.name}\n`;

                const texto = await file.text();
                const linhas = texto.split(/\r?\n/);
                const batch = {};

                // Começa em 1 para pular o cabeçalho
                for (let i = 1; i < linhas.length; i++) {
                    const linha = linhas[i].trim();
                    if (!linha) continue;

                    const colunas = linha.split(';');
                    if (colunas.length < 5) continue;

                    const skuOrigem = colunas[2] ? colunas[2].trim() : null;
                    if (!skuOrigem || skuOrigem.toLowerCase() === 'sku') continue;

                    // Chave limpa para o Firebase
                    const skuChave = skuOrigem.replace(/[\.\#\$\/\[\]]/g, "_");

                    batch[skuChave] = {
                        nome: colunas[1] ? colunas[1].trim() : "Sem nome",
                        sku: skuOrigem,
                        categoria: colunas[3] ? colunas[3].trim() : "Geral",
                        preco: parseFloat(colunas[4].replace(',', '.')) || 0,
                        peso: parseFloat(colunas[5].replace(',', '.')) || 0,
                        imagem: "" // Preenchido depois pelo Sincronizador de Fotos
                    };
                    totalImportado++;
                }

                // Envia este arquivo para o banco
                await db.ref('products').update(batch);
                log.innerHTML += `> OK: ${file.name} (${Object.keys(batch).length} itens)\n`;
                log.scrollTop = log.scrollHeight;
            }

            status.style.color = "green";
            status.innerText = "IMPORTAÇÃO CONCLUÍDA!";
            log.innerHTML += `\n> TOTAL FINAL: ${totalImportado} PRODUTOS.`;
            alert("Sucesso! " + totalImportado + " produtos importados.");

        } catch (error) {
            console.error(error);
            status.style.color = "red";
            status.innerText = "ERRO NA IMPORTAÇÃO";
            log.innerHTML += `\n> ERRO CRÍTICO: ${error.message}`;
        }
    }
</script>

</body>
</html>

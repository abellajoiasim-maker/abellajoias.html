<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gestão de Pedidos - Abella Joias</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f8f9fa; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        .header-flex { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #caa85c; margin-bottom: 20px; padding-bottom: 10px; }
        h2 { color: #caa85c; margin: 0; letter-spacing: 1px; }

        /* Barra de Busca Aprimorada */
        .search-container { background: #fdfdfd; padding: 15px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 20px; }
        .search-grid { display: grid; grid-template-columns: 1fr 2fr 1.5fr; gap: 15px; }
        .search-grid input { padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; outline: none; transition: 0.3s; }
        .search-grid input:focus { border-color: #caa85c; box-shadow: 0 0 5px rgba(202, 168, 92, 0.3); }

        /* Tabela Estilizada */
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f8f8f8; color: #666; padding: 12px 10px; text-align: left; font-size: 11px; text-transform: uppercase; border-bottom: 2px solid #eee; }
        td { padding: 12px 10px; border-bottom: 1px solid #f2f2f2; font-size: 13px; color: #444; }
        tr:hover { background: #fffcf5; }

        .endereco-txt { font-size: 11px; color: #777; line-height: 1.3; }
        .btn-group { display: flex; gap: 5px; }
        .btn-acao { padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 10px; font-weight: bold; transition: 0.2s; text-transform: uppercase; }
        .btn-comp { background: #caa85c; color: white; }
        .btn-simp { background: #555; color: white; }
        .btn-foto { background: #333; color: white; }
        .btn-acao:hover { opacity: 0.8; transform: translateY(-1px); }

        .no-results { text-align: center; padding: 40px; color: #999; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-flex">
        <div>
            <h2>ABELLA JOIAS</h2>
            <small style="color:#999">Painel de Gerenciamento de Pedidos</small>
        </div>
        <div id="contagem" style="font-size: 12px; font-weight: bold; color: #666;">Carregando pedidos...</div>
    </div>

    <div class="search-container">
        <div class="search-grid">
            <input type="text" id="buscaNumero" placeholder="Nº Pedido..." oninput="filtrarPedidos()">
            <input type="text" id="buscaCliente" placeholder="Nome do Cliente..." oninput="filtrarPedidos()">
            <input type="text" id="buscaTelefone" placeholder="Telefone..." oninput="filtrarPedidos()">
        </div>
    </div>

    <table id="tabelaPedidos">
        <thead>
            <tr>
                <th style="width: 80px;">ID</th>
                <th style="width: 200px;">Cliente / Contato</th>
                <th>Endereço Completo de Entrega</th>
                <th style="width: 100px;">Total</th>
                <th style="width: 260px; text-align: center;">Gerar Romaneio</th>
            </tr>
        </thead>
        <tbody id="listaCorpo">
            </tbody>
    </table>
    <div id="avisoVazio" class="no-results" style="display:none;">Nenhum pedido encontrado com esses filtros.</div>
</div>

<script>
    // Inicialização do Firebase (Substitua pelos seus dados)
    const firebaseConfig = { /* SEUS DADOS AQUI */ };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let cachePedidos = [];

    // Função para carregar dados
    function carregarDados() {
        db.ref('orders').on('value', snapshot => {
            cachePedidos = [];
            snapshot.forEach(child => {
                let p = child.val();
                p.key = child.key;
                cachePedidos.push(p);
            });
            // Ordenar por mais recentes primeiro
            cachePedidos.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            filtrarPedidos();
        });
    }

    function filtrarPedidos() {
        const fNum = document.getElementById('buscaNumero').value.toLowerCase();
        const fNome = document.getElementById('buscaCliente').value.toLowerCase();
        const fTel = document.getElementById('buscaTelefone').value.toLowerCase();
        
        const corpo = document.getElementById('listaCorpo');
        corpo.innerHTML = "";
        
        const filtrados = cachePedidos.filter(p => {
            const numPedido = (p.numeroPedido || p.key).toString().toLowerCase();
            const nomeCliente = (p.cliente || "").toLowerCase();
            const telCliente = (p.whatsapp || "").toLowerCase();
            
            return numPedido.includes(fNum) && 
                   nomeCliente.includes(fNome) && 
                   telCliente.includes(fTel);
        });

        document.getElementById('contagem').innerText = filtrados.length + " Pedido(s) encontrado(s)";
        document.getElementById('avisoVazio').style.display = filtrados.length === 0 ? "block" : "none";

        filtrados.forEach(p => {
            const e = p.endereco_detalhado || {};
            const row = document.createElement('tr');
            
            // Montagem do Endereço Completo
            const enderecoFormatado = `
                <div class="endereco-txt">
                    <strong>${e.rua || 'A retirar'}, ${e.num || 'S/N'}</strong><br>
                    ${e.bairro || ''} - ${e.cidade || ''} ${e.local ? ' | Ref: ' + e.local : ''}
                </div>
            `;

            row.innerHTML = `
                <td style="font-weight:bold; color:#caa85c;">#${p.numeroPedido || p.key.substring(0,5)}</td>
                <td><strong>${p.cliente}</strong><br><small>${p.whatsapp || 'N/A'}</small></td>
                <td>${enderecoFormatado}</td>
                <td style="font-weight:bold;">R$ ${parseFloat(p.total || 0).toFixed(2)}</td>
                <td>
                    <div class="btn-group">
                        <button class="btn-acao btn-comp" onclick="gerarRomaneio('${p.key}', 'completo')">Completo</button>
                        <button class="btn-acao btn-simp" onclick="gerarRomaneio('${p.key}', 'simples')">Simples</button>
                        <button class="btn-acao btn-foto" onclick="gerarRomaneio('${p.key}', 'foto')">C/ Fotos</button>
                    </div>
                </td>
            `;
            corpo.appendChild(row);
        });
    }

    // Cole aqui a sua função gerarRomaneio(id, tipo) atualizada para que os botões funcionem.
    function gerarRomaneio(id, tipo) {
        // ... (A lógica de impressão que já definimos antes)
    }

    carregarDados();
</script>
</body>
</html>

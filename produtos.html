<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Abella Joias | Produtos</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
    /* FOR√áANDO ESTILOS NOVOS PARA SAIR DO CACHE */
    body { font-family: 'Poppins', sans-serif; background: #f8f6f2 !important; color: #333; }
    .FONTE-LUXO { font-family: 'Cinzel', serif !important; color: #A68966 !important; }
    .BARRA-OURO { h-px; background: #A68966 !important; width: 80px; margin: 10px auto; }
    .CARD-NOVO { background: #fff; border-radius: 20px; border: 1px solid #eee; padding: 12px; transition: 0.3s; position: relative; }
    .TAG-PESO-REAL { background: #000 !important; color: #fff !important; font-size: 10px; font-weight: bold; padding: 4px 10px; border-radius: 8px; display: inline-block; margin-top: 5px; }
    .BOTAO-NAV { background: #fff; border: 1px solid #ddd; padding: 6px 12px; border-radius: 20px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
</style>
</head>

<body>

<header class="bg-white border-b sticky top-0 z-50 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
        <button onclick="window.history.back()" class="BOTAO-NAV">‚Üê VOLTAR</button>
        <a href="checkout_premium.html" class="BOTAO-NAV">üõí CARRINHO (<span id="countV">0</span>)</a>
    </div>
    
    <div class="text-center py-6">
        <h1 class="FONTE-LUXO text-4xl tracking-[0.2em]">Abella Joias</h1>
        <div class="BARRA-OURO" style="height: 1px;"></div>
        <p class="text-[10px] text-gray-500 uppercase tracking-[0.3em] font-medium mt-2">Atacado de Joias no Bruto</p>
    </div>
</header>

<main class="max-w-7xl mx-auto p-4">
    <div id="gradeProdutos" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
</main>

<script>
const firebaseConfig = { apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY", databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com" };
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const slug = new URLSearchParams(window.location.search).get('cat');
let promoAtiva = {};
let categorias = {};

// 1. Pega configura√ß√µes de desconto
db.ref('settings/promocao').on('value', s => { promoAtiva = s.val() || {}; });
db.ref('categories').on('value', s => { 
    s.forEach(c => { categorias[c.key] = c.val(); });
    desenharProdutos();
});

function atualizarIcone() {
    const c = JSON.parse(localStorage.getItem('carrinho') || '[]');
    document.getElementById('countV').innerText = c.length;
}

function desenharProdutos() {
    db.ref('products').orderByChild('category').equalTo(slug).on('value', snap => {
        const grid = document.getElementById('gradeProdutos');
        grid.innerHTML = '';
        
        snap.forEach(sp => {
            const p = sp.val();
            if(p.paused) return;

            // L√≥gica de Pre√ßo
            const dCat = parseInt(categorias[p.category]?.discount || 0);
            const dGlob = promoAtiva.ativa ? parseInt(promoAtiva.porcentagem) : 0;
            const maiorD = Math.max(dCat, dGlob);
            const vOrig = parseFloat(p.price || 0);
            const vFinal = maiorD > 0 ? vOrig * (1 - maiorD/100) : vOrig;

            // PESO COM TEXTO CLARO
            const textoPeso = p.weight ? `PESO: ${p.weight}g` : "PESO: SOB CONSULTA";

            grid.innerHTML += `
                <div class="CARD-NOVO">
                    <img src="${p.image}" class="w-full aspect-square object-cover rounded-xl mb-3">
                    <p class="text-[8px] text-gray-400 font-bold uppercase">REF: ${p.sku || '---'}</p>
                    <h3 class="text-[11px] font-bold text-gray-800 h-8 overflow-hidden mb-1">${p.name}</h3>
                    
                    <div class="TAG-PESO-REAL">${textoPeso}</div>
                    
                    <div class="mt-3 border-t pt-2">
                        <p class="text-sm font-bold gold">R$ ${vFinal.toFixed(2)}</p>
                        ${maiorD > 0 ? `<p class="text-[9px] text-gray-400 line-through">R$ ${vOrig.toFixed(2)}</p>` : ''}
                        <p class="text-[9px] text-green-600 font-bold">R$ ${(vFinal*0.95).toFixed(2)} NO PIX</p>
                    </div>

                    <button onclick="add('${sp.key}', ${vFinal})" class="w-full bg-black text-white text-[10px] font-bold py-2 mt-3 rounded-lg uppercase">
                        Adicionar
                    </button>
                </div>`;
        });
    });
}

function add(id, preco) {
    db.ref('products/' + id).once('value', s => {
        const p = s.val();
        let cart = JSON.parse(localStorage.getItem('carrinho') || '[]');
        cart.push({ nome: p.name, sku: p.sku, preco: preco, qtd: 1, image: p.image, peso: p.weight });
        localStorage.setItem('carrinho', JSON.stringify(cart));
        atualizarIcone();
        alert('Adicionado!');
    });
}

atualizarIcone();
</script>
</body>
</html>

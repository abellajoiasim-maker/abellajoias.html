<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Administrativo ‚Ä¢ Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#0b0b0b;color:#eee;font-family:Inter,Arial;margin:0}
nav button.active{border-color:#caa85c;color:#caa85c}
section{display:none;min-height:300px}
section.active{display:block}
.card{background:#141414;border:1px solid #2a2a2a;border-radius:16px;padding:14px}
.btn{background:#222;border:1px solid #444;padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer}
.btn-gold{background:#caa85c;color:#000;font-weight:700}
input,select{background:#111;border:1px solid #333;padding:8px;border-radius:8px;width:100%;margin-bottom:8px;color:#fff}

#print-area{display:none}

@media print{
 body *{visibility:hidden}
 #print-area,#print-area *{visibility:visible}
 #print-area{position:absolute;top:0;left:0;width:100%;background:#fff;color:#000;display:block}
}
<style>
  main section { display: none; }
  main section.active { display: block; }
</style>

</head>

<body>

<header class="p-5 text-center text-xl font-bold bg-black border-b border-[#222]">
  Painel Administrativo ‚Ä¢ Abella Joias
</header>

<nav class="flex gap-2 p-2 bg-[#111] sticky top-0 z-50 overflow-x-auto">
  <button type="button" class="btn active" onclick="showTab('empresa', this)">Empresa</button>
  <button type="button" class="btn" onclick="showTab('categorias', this)">Categorias</button>
  <button type="button" class="btn" onclick="showTab('produtos', this)">Produtos</button>
  <button type="button" class="btn" onclick="showTab('promocoes', this)">Promo√ß√µes</button>
  <button type="button" class="btn" onclick="showTab('pedidos', this)">Pedidos</button>
</nav>

<main class="p-6">

  <section id="empresa" class="active">
    <div class="card space-y-3">
      <h2 class="text-[#caa85c] font-bold">Configura√ß√µes da Loja</h2>
      <input id="empNome" placeholder="Nome da Empresa">
      <input id="empSub" placeholder="Subt√≠tulo">
      <input id="empWhats" placeholder="WhatsApp">
      <input id="empDesc" type="number" placeholder="Desconto PIX (%)">
      <input id="empParc" type="number" placeholder="Parcelas sem acr√©scimo">
      <button type="button" class="btn-gold w-full" onclick="salvarEmpresa()">Salvar</button>
    </div>
  </section>

  <section id="categorias">
    <button type="button" class="btn-gold mb-3" onclick="novaCategoria()">+ Nova Categoria</button>
    <div id="listaCategorias"></div>
  </section>

  <section id="produtos">
    <button type="button" class="btn-gold mb-3" onclick="novoProduto()">+ Novo Produto</button>
    <div id="listaProdutos"></div>
  </section>

  <section id="promocoes">
    <h2 class="text-[#caa85c] font-bold mb-4 text-center">Gest√£o de Promo√ß√µes Individual</h2>
    <div class="flex gap-2 mb-4">
      <button type="button" class="btn flex-1 bg-[#222] border-[#caa85c]/50 text-[#caa85c] font-bold py-3" onclick="listarPromos('categorias')">üè∑Ô∏è Por Categorias</button>
      <button type="button" class="btn flex-1 bg-[#222] border-[#caa85c]/50 text-[#caa85c] font-bold py-3" onclick="listarPromos('produtos')">üíé Por Produtos</button>
    </div>

    <div id="listaPromocoes" class="grid gap-2">
      <p class="text-center text-gray-500 mt-10">Selecione uma op√ß√£o acima para editar os descontos.</p>
    </div>
  </section>

  <section id="pedidos">
    <h2 class="text-[#caa85c] font-bold mb-4 text-center uppercase tracking-widest">Pedidos Recebidos</h2>
    <div id="listaPedidos" class="grid gap-4"></div>
  </section>

  <div id="print-area"></div>

</main>

<script>
/* FIREBASE (prote√ß√£o contra reinicializa√ß√£o) */
if (!firebase.apps.length) {
  firebase.initializeApp({
    apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
    databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com"
  });
}
const db = firebase.database();

/* HELPERS */
const fMoeda = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);

/* NAVEGA√á√ÉO ‚Äî VERS√ÉO √öNICA (remove duplicidade que travava o menu) */
function showTab(tab, btn){
  document.querySelectorAll('.tab').forEach(t => t.classList.add('hidden'));
  document.getElementById(tab).classList.remove('hidden');

  document.querySelectorAll('nav .btn').forEach(b => b.classList.remove('active'));
  if(btn) btn.classList.add('active');
}

  const target = document.getElementById(id);
  if (target) target.classList.add('active');

  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');

  if (id === 'categorias') carregarCategorias();
  if (id === 'produtos') carregarProdutos();
  if (id === 'pedidos') carregarPedidos();

  if (id === 'promocoes') {
    const box = document.getElementById('listaPromocoes');
    if (box) {
      box.innerHTML = '<p class="text-center text-gray-500 mt-10">Selecione "Por Categorias" ou "Por Produtos" acima.</p>';
    }
  }
 function removerProduto(id) {
  if (confirm("Excluir este produto?")) {
    db.ref('products/' + id).remove()
      .then(() => carregarProdutos())
      .catch(() => alert("Erro ao excluir produto."));
  }
}



/* EMPRESA */
function salvarEmpresa() {
  db.ref('settings/empresa').set({
    nome: document.getElementById('empNome').value,
    subtitulo: document.getElementById('empSub').value,
    whats: document.getElementById('empWhats').value,
    descontoPix: +document.getElementById('empDesc').value || 0,
    parcelas: +document.getElementById('empParc').value || 0
  });
  alert('Salvo');
}

/* CATEGORIAS */
function carregarCategorias() {
  db.ref('categories').once('value', s => {
    const lista = document.getElementById('listaCategorias');
    if (!lista) return;
    lista.innerHTML = '';

    let cats = [];
    s.forEach(c => cats.push({ key: c.key, ...c.val() }));
    cats.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

    cats.forEach(c => {
      const temImg = c.image ? 'üñºÔ∏è' : '<span class="opacity-20">üö´</span>';

      lista.innerHTML += `
        <div class="card flex justify-between items-center mb-2 py-2 px-4 text-sm">
          <div class="flex items-center gap-3">
            ${temImg}
            <b class="uppercase">${c.name}</b>
          </div>
          <div class="flex gap-2">
            <button class="btn text-blue-400" onclick="editarCategoria('${c.key}', '${c.name}')">‚úé</button>
            <button class="btn text-red-500" onclick="if(confirm('Excluir categoria?')) db.ref('categories/${c.key}').remove().then(()=>carregarCategorias())">X</button>
          </div>
        </div>`;
    });
  });
}

/* PRODUTOS */
let cacheProdutos = [];

function carregarProdutos() {
  const lista = document.getElementById('listaProdutos');
  if (!lista) return;
  lista.innerHTML = '<p class="text-center p-4 text-gray-500">Sincronizando estoque...</p>';

  db.ref('products').once('value', s => {
    cacheProdutos = [];
    s.forEach(p => cacheProdutos.push({ key: p.key, ...p.val() }));
    cacheProdutos.sort((a, b) => (a.sku || "").localeCompare(b.sku || "", undefined, { numeric: true }));
    renderizarEstruturaProdutos();
  });
}

function renderizarEstruturaProdutos() {
  const lista = document.getElementById('listaProdutos');
  if (!lista) return;
  lista.innerHTML = '';

  const categoriasPresentes = [...new Set(cacheProdutos.map(p => p.category || "Sem Categoria"))].sort();

  categoriasPresentes.forEach(cat => {
    const catId = cat.replace(/\s+/g, '-');
    const produtosFiltrados = cacheProdutos.filter(p => (p.category || "Sem Categoria") === cat);

lista.innerHTML += `
  <div class="mb-2">
    <div onclick="toggleCategoria('${cat}', '${catId}')"
         class="flex justify-between items-center bg-[#141414] p-3 rounded-lg cursor-pointer border-l-4 border-[#caa85c]">
      <b class="text-[11px] uppercase">${cat} (${produtosFiltrados.length})</b>
      <span id="seta-${catId}" class="text-[10px] text-gray-500">‚ñº</span>
    </div>
    <div id="cat-content-${catId}" class="hidden flex flex-col gap-1 mt-1 pl-2 border-l border-[#222]"></div>
  </div>`;

function toggleCategoria(nomeCat, catId) {
  const content = document.getElementById(`cat-content-${catId}`);
  const seta = document.getElementById(`seta-${catId}`);
  if (!content) return;

  const isHidden = content.classList.contains('hidden');

  document.querySelectorAll('[id^="cat-content-"]').forEach(el => el.classList.add('hidden'));
  document.querySelectorAll('[id^="seta-"]').forEach(el => el.innerText = '‚ñº');

  if (isHidden) {
    content.classList.remove('hidden');
    seta.innerText = '‚ñ≤';

    const prods = cacheProdutos
      .filter(p => (p.category || "Sem Categoria") === nomeCat)
      .sort((a,b)=>(a.sku||"").localeCompare(b.sku||"",undefined,{numeric:true}));

    content.innerHTML = prods.map(p => `
      <div class="card flex justify-between py-1 px-2 text-[11px] bg-[#0d0d0d]">
        <div>
          <span class="text-gray-400">${p.sku || '---'}</span>
          <b class="ml-1">${p.name}</b>
        </div>
        <div class="flex gap-2">
          <button onclick="editarProduto('${p.key}')" class="text-blue-400">‚úé</button>
          <button onclick="removerProduto('${p.key}')" class="text-red-500">X</button>
        </div>
      </div>
    `).join('');
  }
}
/* ================= PROMO√á√ïES (MODAL) ================= */
function listarPromos(tipo){
 const container=document.getElementById('listaPromocoes');
 container.innerHTML='Carregando...';
 db.ref(tipo==='categorias'?'categories':'products').once('value',s=>{
  container.innerHTML='';
  let itens=[]; s.forEach(i=>itens.push({key:i.key,...i.val()}));
  itens.sort((a,b)=>(a.name||'').localeCompare(b.name||''));

  itens.forEach(item=>{
   const nome=tipo==='categorias'?item.name:`[${item.sku||'---'}] ${item.name}`;
   container.innerHTML+=`
   <div class="card text-xs flex justify-between items-center">
    <div class="flex-1">
     <b>${nome}</b>
     <div class="flex gap-2 mt-1">
      <input type="number" value="${item.promoPct||0}" onchange="salvarPromo('${tipo}','${item.key}','promoPct',this.value)" class="w-14 bg-black border text-center">
      <input type="text" value="${item.promoTexto||'OFF'}" onchange="salvarPromo('${tipo}','${item.key}','promoTexto',this.value)" class="w-16 bg-black border text-center">
      <input type="color" value="${item.promoCor||'#caa85c'}" onchange="salvarPromo('${tipo}','${item.key}','promoCor',this.value)">
     </div>
    </div>
    <button class="text-red-500" onclick="limparPromo('${tipo}','${item.key}')">X</button>
   </div>`;
  });
 });
}

/* PEDIDOS - GEST√ÉO COMPLETA (ROMANEIOS + EDI√á√ÉO + EXCLUS√ÉO) */
let pedidosListenerAtivo = false;

function carregarPedidos() {
  const listaPedidos = document.getElementById('listaPedidos');
  if (!listaPedidos) return;

  listaPedidos.innerHTML = '<p class="p-4 text-center text-gray-500">Carregando pedidos...</p>';

  // Evita m√∫ltiplos listeners acumulando (causa travamento)
  if (pedidosListenerAtivo) return;
  pedidosListenerAtivo = true;

  db.ref('orders').on('value', snapshot => {
    if (!listaPedidos) return;

    listaPedidos.innerHTML = '';
    if (!snapshot.exists()) {
      listaPedidos.innerHTML = '<p class="p-4 text-center text-gray-500">Nenhum pedido encontrado.</p>';
      return;
    }

    let pedidosHtml = [];

    snapshot.forEach(ped => {
      const p = ped.val() || {};
      const id = ped.key;
      const nomeCliente = (p.cliente && typeof p.cliente === 'object') ? p.cliente.nome : (p.cliente || 'Cliente s/ nome');

      const html = `
        <div class="card mb-3 border-l-4 border-[#caa85c]">
          <div class="flex justify-between items-start mb-2">
            <div>
              <b class="text-[#caa85c] text-sm uppercase">${nomeCliente}</b>
              <p class="text-[10px] text-gray-400">${p.data || ''}</p>
            </div>
            <span class="bg-[#222] px-2 py-1 rounded text-[9px] font-bold uppercase">${p.pagamento || 'N/A'}</span>
          </div>

          <div class="grid grid-cols-3 gap-1 mt-2 border-t border-[#2a2a2a] pt-2">
            <button class="btn text-[9px] py-1" onclick="gerarRomaneio('${id}', 1)">Simples</button>
            <button class="btn text-[9px] py-1" onclick="gerarRomaneio('${id}', 2)">Completo</button>
            <button class="btn text-[9px] py-1" onclick="gerarRomaneio('${id}', 3)">Com Foto</button>
          </div>

          <div class="flex gap-2 mt-2">
            <button class="btn flex-1 text-blue-400 border-blue-900/30 text-[10px] py-1" onclick="abrirEditorPedido('${id}')">‚úé AJUSTAR</button>
            <button class="btn flex-1 text-red-500 border-red-900/30 text-[10px] py-1" onclick="excluirPedido('${id}')">EXCLUIR</button>
          </div>

          <div class="mt-2 text-right">
            ${p.ajustadoManualmente ? '<span class="text-[9px] text-green-500 mr-2 font-bold">AJUSTADO</span>' : ''}
            <b class="text-white text-sm">${fMoeda(p.total || 0)}</b>
          </div>
        </div>`;

      pedidosHtml.push(html);
    });

    listaPedidos.innerHTML = pedidosHtml.reverse().join('');
  });
}

/* EXCLUIR PEDIDO */
function excluirPedido(id) {
  if (!id) return;
  if (confirm("Deseja realmente apagar este pedido? Esta a√ß√£o n√£o pode ser desfeita.")) {
    db.ref('orders/' + id).remove()
      .then(() => alert("Pedido removido do sistema."))
      .catch(() => alert("Erro ao excluir."));
  }
}

/* EDITAR PEDIDO - AJUSTE MANUAL PARA ATACADO */
function abrirEditorPedido(id) {
  if (!id) return;

  db.ref('orders/' + id).once('value', s => {
    const p = s.val();
    if (!p) return alert("Pedido n√£o encontrado.");

    const novoTotal = prompt(
      `Valor Total Atual: ${fMoeda(p.total || 0)}\nInforme o novo valor final para o cliente:`,
      p.total || 0
    );

    if (novoTotal === null) return;

    const nota = prompt("Motivo do ajuste ou observa√ß√£o para o romaneio:", p.obs || "");

    db.ref('orders/' + id).update({
      total: Number(novoTotal) || 0,
      obs: nota || '',
      ajustadoManualmente: true
    }).then(() => {
      alert("Pedido atualizado!");
    }).catch(() => {
      alert("Erro ao atualizar pedido.");
    });
  });
}


function gerarRomaneio(id, tipo = 1) {
  db.ref('orders/' + id).once('value', s => {
    const p = s.val();
    if (!p) return;

    db.ref('settings/empresa').once('value', e => {
      const emp = e.val() || {};

      let html = `
      <style>
        .print-body { font-family: Arial, sans-serif; color:#000; padding:20px; font-size:11px; }
        .lux-head { text-align:center; border-bottom:2px solid #A68966; padding-bottom:10px; margin-bottom:15px; }
        .lux-head h1 { margin:0; color:#A68966; font-size:22px; }
        .grid-dados { display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:15px; }
        table { width:100%; border-collapse:collapse; margin-top:10px; font-size:11px; }
        table th { background:#f5f5f5; text-align:left; border-bottom:1px solid #000; padding:4px; }
        table td { border-bottom:1px solid #ddd; padding:4px; }
        .totais { text-align:right; margin-top:15px; font-size:12px; }
        .img-mini { width:40px; height:40px; object-fit:cover; border-radius:4px; }
      </style>

      <div class="print-body">
        <div class="lux-head">
          <h1>${emp.nome || 'Abella Joias'}</h1>
          <p>${emp.subtitulo || ''}<br>WhatsApp: ${emp.whats || ''}</p>
        </div>

        <div class="grid-dados">
          <div>
            <b>DADOS DO CLIENTE</b><br>
            Nome: ${p.cliente?.nome || p.cliente || ''}<br>
            WhatsApp: ${p.cliente?.telefone || p.whatsapp || ''}
          </div>
          <div>
            <b>LOCAL DE ENTREGA</b><br>
            ${p.endereco?.nome || 'Residencial'}<br>
            ${p.endereco?.rua || ''}, ${p.endereco?.num || ''}<br>
            ${p.endereco?.bairro || ''} - ${p.endereco?.cidade || ''}
          </div>
        </div>

        <table>
          <thead>
            <tr>
              ${tipo === 3 ? '<th>Foto</th>' : ''}
              <th>SKU</th>
              <th>Produto</th>
              ${tipo > 1 ? '<th>Peso U.</th><th>Pre√ßo U.</th>' : ''}
              <th>Qtd</th>
              ${tipo > 1 ? '<th>Subtotal</th>' : ''}
            </tr>
          </thead>
          <tbody>
      `;

      let subtotalCalc = 0;
      let pesoTotalCalc = 0;

      (p.itens || []).forEach(i => {
        const preco = Number(i.precoFinal || i.price || 0);
        const qtd = Number(i.quantidade || 1);
        const pesoKg = (Number(i.peso || 0) / 1000);
        const subtotalItem = preco * qtd;

        subtotalCalc += subtotalItem;
        pesoTotalCalc += pesoKg * qtd;

        html += `
          <tr>
            ${tipo === 3 ? `<td><img src="${i.image || ''}" class="img-mini"></td>` : ''}
            <td>${i.sku || '---'}</td>
            <td>${i.name || ''}</td>
            ${tipo > 1 ? `<td>${pesoKg.toFixed(3)} Kg</td><td>${fMoeda(preco)}</td>` : ''}
            <td>${qtd}</td>
            ${tipo > 1 ? `<td>${fMoeda(subtotalItem)}</td>` : ''}
          </tr>
        `;
      });

      html += `</tbody></table>`;

      if (tipo > 1) {
        html += `
          <div class="totais">
            Subtotal: ${fMoeda(p.subtotal ?? subtotalCalc)}<br>
            Peso Total: ${pesoTotalCalc.toFixed(2)} Kg<br>
            Descontos: - ${fMoeda(p.descontos || 0)}<br>
            <b style="font-size:16px; color:#A68966">TOTAL: ${fMoeda(p.total)}</b>
            ${p.obs ? `<div style="margin-top:6px;font-size:10px;"><b>Obs:</b> ${p.obs}</div>` : ''}
          </div>
        `;
      }

      html += `</div>`;

      document.getElementById('print-area').innerHTML = html;

      setTimeout(() => {
        window.print();
      }, 500);
    });
  });
}

function carregarEmpresaSeExistir() {
  db.ref('settings/empresa').once('value', s => {
    const v = s.val();
    if (!v) return;

    const empNome  = document.getElementById('empNome');
    const empSub   = document.getElementById('empSub');
    const empWhats = document.getElementById('empWhats');
    const empDesc  = document.getElementById('empDesc');
    const empParc  = document.getElementById('empParc');

    if (empNome)  empNome.value  = v.nome || '';
    if (empSub)   empSub.value   = v.subtitulo || '';
    if (empWhats) empWhats.value = v.whats || '';
    if (empDesc)  empDesc.value  = v.descontoPix || 0;
    if (empParc)  empParc.value  = v.parcelas || 0;
  });
}
 function editarProduto(id) {
  db.ref('products/' + id).once('value', s => {
    const p = s.val();
    if (!p) return alert("Produto n√£o encontrado.");

    const novoNome = prompt("Nome do produto:", p.name || "");
    const novoPreco = prompt("Pre√ßo do produto:", p.price || 0);
    const novoSku = prompt("SKU do produto:", p.sku || "");

    if (novoNome !== null) {
      db.ref('products/' + id).update({
        name: novoNome,
        price: Number(novoPreco) || 0,
        sku: novoSku
      }).then(() => {
        alert("Produto atualizado!");
        carregarProdutos(); // Atualiza a tela
      });
    }
  });
}
function editarCategoria(id, nomeAtual) {
  const novoNome = prompt("Novo nome da categoria:", nomeAtual);
  if (!novoNome || novoNome === nomeAtual) return;

  db.ref('categories/' + id).update({ name: novoNome })
    .then(() => {
      alert("Categoria atualizada!");
      carregarCategorias(); // Atualiza lista
    })
    .catch(() => alert("Erro ao atualizar categoria."));
}


/* ================= INIT ================= */
window.addEventListener('DOMContentLoaded', () => {
  const firstBtn = document.querySelector('nav button.active');
  if (firstBtn) firstBtn.click();
});

</script>

</body>
</html>

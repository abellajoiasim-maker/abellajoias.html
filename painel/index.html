<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Administrativo ‚Ä¢ Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#0b0b0b;color:#eee;font-family:Inter,Arial;margin:0}
nav button.active{border-color:#caa85c;color:#caa85c}
section{display:none;min-height:300px}
section.active{display:block}
.card{background:#141414;border:1px solid #2a2a2a;border-radius:16px;padding:14px}
.btn{background:#222;border:1px solid #444;padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer}
.btn-gold{background:#caa85c;color:#000;font-weight:700}
input,select{background:#111;border:1px solid #333;padding:8px;border-radius:8px;width:100%;margin-bottom:8px;color:#fff}

#print-area{display:none}

@media print{
 body *{visibility:hidden}
 #print-area,#print-area *{visibility:visible}
 #print-area{position:absolute;top:0;left:0;width:100%;background:#fff;color:#000;display:block}
}
</style>
</head>

<body>

<header class="p-5 text-center text-xl font-bold bg-black border-b border-[#222]">
  Painel Administrativo ‚Ä¢ Abella Joias
</header>

<nav class="flex gap-2 p-2 bg-[#111] sticky top-0 z-50 overflow-x-auto">
  <button class="btn active" onclick="showTab('empresa',this)">Empresa</button>
  <button class="btn" onclick="showTab('categorias',this)">Categorias</button>
  <button class="btn" onclick="showTab('produtos',this)">Produtos</button>
  <button class="btn" onclick="showTab('promocoes',this)">Promo√ß√µes</button>
  <button class="btn" onclick="showTab('pedidos',this)">Pedidos</button>
</nav>

<main class="p-6">

<section id="empresa" class="active">
  <div class="card space-y-3">
    <h2 class="text-[#caa85c] font-bold">Configura√ß√µes da Loja</h2>
    <input id="empNome" placeholder="Nome da Empresa">
    <input id="empSub" placeholder="Subt√≠tulo">
    <input id="empWhats" placeholder="WhatsApp">
    <input id="empDesc" type="number" placeholder="Desconto PIX (%)">
    <input id="empParc" type="number" placeholder="Parcelas sem acr√©scimo">
    <button class="btn-gold w-full" onclick="salvarEmpresa()">Salvar</button>
  </div>
</section>

<section id="categorias">
  <button class="btn-gold mb-3" onclick="novaCategoria()">+ Nova Categoria</button>
  <div id="listaCategorias"></div>
</section>

<section id="produtos">
  <button class="btn-gold mb-3" onclick="novoProduto()">+ Novo Produto</button>
  <div id="listaProdutos"></div>
</section>

<section id="promocoes">
  <h2 class="text-[#caa85c] font-bold mb-4 text-center">Gest√£o de Promo√ß√µes Individual</h2>
  <div class="flex gap-2 mb-4">
    <button class="btn flex-1 bg-[#222] border-[#caa85c]/50 text-[#caa85c] font-bold py-3" onclick="listarPromos('categorias')">üè∑Ô∏è Por Categorias</button>
    <button class="btn flex-1 bg-[#222] border-[#caa85c]/50 text-[#caa85c] font-bold py-3" onclick="listarPromos('produtos')">üíé Por Produtos</button>
  </div>
  
  <div id="listaPromocoes" class="grid gap-2">
    <p class="text-center text-gray-500 mt-10">Selecione uma op√ß√£o acima para editar os descontos.</p>
  </div>
</section>

<section id="pedidos">
  <h2 class="text-[#caa85c] font-bold mb-4 text-center uppercase tracking-widest">Pedidos Recebidos</h2>
  <div id="listaPedidos" class="grid gap-4"></div>
</section>

<div id="print-area"></div>

</main>

<script>
/* FIREBASE CONFIG */
firebase.initializeApp({
 apiKey:"AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
 databaseURL:"https://catalogo-abella-joias-default-rtdb.firebaseio.com"
});
const db = firebase.database();

/* HELPERS */
const fMoeda = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);

/* NAVEGA√á√ÉO CENTRALIZADA (CORRIGE O TRAVAMENTO) */
function showTab(id, btn) {
  // 1. Esconde todas as se√ß√µes 
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  // 2. Desativa todos os bot√µes do menu
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));

  // 3. Ativa o que foi clicado 
  const target = document.getElementById(id);
  if (target) {
    target.classList.add('active');
    if (btn) btn.classList.add('active');
  }

  // 4. Carrega os dados da aba
  if (id === 'categorias') carregarCategorias();
  if (id === 'produtos') carregarProdutos();
  if (id === 'pedidos') carregarPedidos();
  if (id === 'promocoes') {
    document.getElementById('listaPromocoes').innerHTML = '<p class="text-center text-gray-500 mt-10">Selecione uma op√ß√£o acima.</p>';
  }
}

/* EMPRESA */
function salvarEmpresa() {
  db.ref('settings/empresa').set({
    nome: document.getElementById('empNome').value,
    subtitulo: document.getElementById('empSub').value,
    whats: document.getElementById('empWhats').value,
    descontoPix: +document.getElementById('empDesc').value || 0,
    parcelas: +document.getElementById('empParc').value || 0
  }).then(() => alert('Configura√ß√µes salvas!'));
}

function carregarEmpresaSeExistir() {
  db.ref('settings/empresa').once('value', s => {
    const v = s.val();
    if (v) {
      document.getElementById('empNome').value = v.nome || '';
      document.getElementById('empSub').value = v.subtitulo || '';
      document.getElementById('empWhats').value = v.whats || '';
      document.getElementById('empDesc').value = v.descontoPix || 0;
      document.getElementById('empParc').value = v.parcelas || 0;
    }
  });
}

/* CATEGORIAS */
function carregarCategorias() {
  db.ref('categories').once('value', s => {
    const lista = document.getElementById('listaCategorias');
    lista.innerHTML = '';
    let cats = [];
    s.forEach(c => { cats.push({ key: c.key, ...c.val() }); });
    cats.sort((a, b) => a.name.localeCompare(b.name));
    cats.forEach(c => {
      lista.innerHTML += `
        <div class="card flex justify-between items-center mb-2 py-2 px-4 text-sm">
          <b class="uppercase">${c.name}</b>
          <div class="flex gap-2">
            <button class="btn text-red-500" onclick="if(confirm('Excluir?')) db.ref('categories/${c.key}').remove().then(()=>carregarCategorias())">X</button>
          </div>
        </div>`;
    });
  });
}

/* PRODUTOS E CACHE (OTIMIZADO) */
let cacheProdutos = [];
function carregarProdutos() {
  const lista = document.getElementById('listaProdutos');
  lista.innerHTML = '<p class="text-center p-4">Sincronizando...</p>';
  db.ref('products').once('value', s => {
    cacheProdutos = [];
    s.forEach(p => { cacheProdutos.push({ key: p.key, ...p.val() }); });
    cacheProdutos.sort((a, b) => (a.sku || "").localeCompare(b.sku || "", undefined, { numeric: true }));
    renderizarEstruturaProdutos();
  });
}

function renderizarEstruturaProdutos() {
  const lista = document.getElementById('listaProdutos');
  lista.innerHTML = '';
  const categorias = [...new Set(cacheProdutos.map(p => p.category || "Sem Categoria"))].sort();
  categorias.forEach(cat => {
    const total = cacheProdutos.filter(p => (p.category || "Sem Categoria") === cat).length;
    const catId = cat.replace(/\s+/g, '-');
    lista.innerHTML += `
      <div class="mb-2">
        <div onclick="toggleCategoria('${cat}', '${catId}')" class="flex justify-between p-3 bg-[#1a1a1a] rounded-lg cursor-pointer">
          <b class="text-xs uppercase">${cat} (${total})</b>
          <span id="seta-${catId}">‚ñº</span>
        </div>
        <div id="cat-content-${catId}" class="hidden flex flex-col gap-1 mt-1 pl-2 border-l border-[#caa85c]"></div>
      </div>`;
  });
}

function toggleCategoria(nomeCat, catId) {
  const content = document.getElementById(`cat-content-${catId}`);
  const isHidden = content.classList.contains('hidden');
  document.querySelectorAll('[id^="cat-content-"]').forEach(el => el.classList.add('hidden'));
  if (isHidden) {
    content.classList.remove('hidden');
    const prods = cacheProdutos.filter(p => (p.category || "Sem Categoria") === nomeCat);
    content.innerHTML = prods.map(p => `
      <div class="card flex justify-between py-2 px-3 text-[11px] bg-[#0d0d0d]">
        <div>
          <span class="text-[#caa85c]">[${p.sku || '---'}]</span> <b>${p.name}</b>
          ${p.variacao ? `<br><small class="text-blue-400">Var: ${p.variacao}</small>` : ''}
        </div>
        <button class="text-red-500" onclick="removerProduto('${p.key}')">X</button>
      </div>`).join('');
  }
}

/* PEDIDOS */
function carregarPedidos() {
  const lista = document.getElementById('listaPedidos');
  db.ref('orders').on('value', snapshot => {
    lista.innerHTML = '';
    if (!snapshot.exists()) return;
    snapshot.forEach(ped => {
      const p = ped.val();
      const id = ped.key;
      lista.innerHTML += `
        <div class="card mb-3 border-l-4 border-[#caa85c]">
          <div class="flex justify-between">
            <b class="text-sm uppercase">${p.cliente?.nome || p.cliente}</b>
            <span class="text-[9px] bg-[#222] px-1">${p.pagamento || ''}</span>
          </div>
          <div class="grid grid-cols-3 gap-1 mt-2">
            <button class="btn text-[9px]" onclick="gerarRomaneio('${id}', 1)">Simples</button>
            <button class="btn text-[9px]" onclick="gerarRomaneio('${id}', 2)">Completo</button>
            <button class="btn text-[9px]" onclick="gerarRomaneio('${id}', 3)">Com Foto</button>
          </div>
          <div class="flex gap-2 mt-2">
            <button class="btn flex-1 text-blue-400" onclick="abrirEditorPedido('${id}')">‚úé AJUSTAR</button>
            <button class="btn flex-1 text-red-500" onclick="excluirPedido('${id}')">EXCLUIR</button>
          </div>
          <div class="text-right mt-2 font-bold">${fMoeda(p.total)}</div>
        </div>`;
    });
  });
}

function excluirPedido(id) {
  if (confirm("Excluir pedido?")) db.ref('orders/' + id).remove();
}

function abrirEditorPedido(id) {
  db.ref('orders/' + id).once('value', s => {
    const p = s.val();
    const novoTotal = prompt("Novo valor total:", p.total);
    const nota = prompt("Observa√ß√£o:", p.obs || "");
    if (novoTotal) db.ref('orders/' + id).update({ total: Number(novoTotal), obs: nota, ajustadoManualmente: true });
  });
}

/* ROMANEIO */
function gerarRomaneio(id, tipo) {
  db.ref('orders/'+id).once('value', s => {
    const p = s.val();
    db.ref('settings/empresa').once('value', e => {
      const emp = e.val() || {};
      let html = `<div style="font-family:Arial; padding:20px;">
        <h1 style="text-align:center; color:#A68966">${emp.nome || 'Abella Joias'}</h1>
        <p style="text-align:center">${emp.subtitulo || ''}<br>Whats: ${emp.whats || ''}</p>
        <hr>
        <p><b>Cliente:</b> ${p.cliente?.nome || p.cliente}</p>
        <table style="width:100%; border-collapse:collapse; margin-top:10px;">
          <thead><tr style="border-bottom:1px solid #000"><th>Produto</th><th>Peso</th><th>Pre√ßo</th><th>Qtd</th><th>Subtotal</th></tr></thead>
          <tbody>`;
      
      p.itens.forEach(i => {
        const peso = (Number(i.peso || 0) / 1000).toFixed(3);
        html += `<tr style="border-bottom:1px solid #eee">
          <td>${i.name} ${i.variacao ? '('+i.variacao+')' : ''}</td>
          <td>${peso} Kg</td><td>${fMoeda(i.precoFinal || i.price)}</td><td>${i.quantidade}</td>
          <td>${fMoeda((i.precoFinal || i.price) * i.quantidade)}</td></tr>`;
      });

      html += `</tbody></table>`;
      if (tipo > 1) {
        html += `<div style="text-align:right; margin-top:20px;">
          Subtotal: ${fMoeda(p.subtotal)}<br>
          <b>TOTAL: ${fMoeda(p.total)}</b><br>
          ${p.obs ? `<small>Obs: ${p.obs}</small>` : ''}
        </div>`;
      }
      html += `</div>`;
      document.getElementById('print-area').innerHTML = html;
      setTimeout(() => window.print(), 500);
    });
  });
}

/* INICIALIZA√á√ÉO */
window.addEventListener('load', () => {
  carregarEmpresaSeExistir();
  showTab('empresa', document.querySelector('nav button'));
});

</script>

</body>
</html>

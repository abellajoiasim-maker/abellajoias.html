<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel Admin | Categorias</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    body{
      font-family: Arial, sans-serif;
      background:#f6f6f6;
      padding:20px;
    }
    h1{margin-bottom:20px}

    table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
    }
    th,td{
      padding:10px;
      border-bottom:1px solid #ddd;
      text-align:left;
    }

    button{
      padding:6px 10px;
      border:none;
      border-radius:5px;
      cursor:pointer;
      margin-right:4px;
    }

    .btn-primary{background:#000;color:#fff}
    .btn-secondary{background:#666;color:#fff}
    .btn-danger{background:#c0392b;color:#fff}

    /* MODAL */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.5);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .hidden{display:none}
    .modal-box{
      background:#fff;
      padding:20px;
      border-radius:10px;
      width:420px;
      max-width:95%;
    }
    .modal-box h3{margin-top:0}
    .modal-box input{
      width:100%;
      padding:8px;
      margin-bottom:10px;
    }
    ul{padding-left:18px}
    li{margin-bottom:6px}
    img.preview{
      max-width:80px;
      margin-bottom:10px;
      display:block;
    }
  </style>
</head>

<body>

<h1>Categorias</h1>

<button class="btn-primary" onclick="novaCategoria()">+ Nova Categoria</button>

<br><br>

<table>
  <thead>
    <tr>
      <th>Nome</th>
      <th>Imagem</th>
      <th>Variações</th>
      <th>Ações</th>
    </tr>
  </thead>
  <tbody id="listaCategorias"></tbody>
</table>

<!-- MODAL CATEGORIA -->
<div id="modalCategoria" class="modal hidden">
  <div class="modal-box">
    <h3>Categoria</h3>

    <input id="catNome" placeholder="Nome da categoria">
    <input id="catImagem" placeholder="URL da imagem">

    <img id="previewCategoria" class="preview" />

    <button class="btn-primary" onclick="salvarCategoria()">Salvar</button>
    <button onclick="fecharCategoria()">Cancelar</button>
  </div>
</div>

<!-- MODAL VARIAÇÕES -->
<div id="modalVariacoes" class="modal hidden">
  <div class="modal-box">
    <h3>Variações da Categoria</h3>

    <input id="novaVariacao" placeholder="Ex: Aro 18">

    <button class="btn-secondary" onclick="addVariacao()">Adicionar</button>

    <ul id="listaVariacoes"></ul>

    <button class="btn-primary" onclick="salvarVariacoes()">Salvar</button>
    <button onclick="fecharVariacoes()">Fechar</button>
  </div>
</div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "SUA_API_KEY",
  authDomain: "SEU_DOMINIO",
  databaseURL: "SUA_DATABASE_URL",
  projectId: "SEU_PROJECT_ID"
});

const db = firebase.database();

/* ================= CATEGORIAS ================= */
let categoriaEditando = null;

function carregarCategorias(){
  db.ref('categories').on('value', snap=>{
    const tbody = document.getElementById('listaCategorias');
    tbody.innerHTML = '';

    snap.forEach(cat=>{
      const d = cat.val();
      tbody.innerHTML += `
        <tr>
          <td>${d.name || '-'}</td>
          <td>${d.image ? 'Sim' : 'Não'}</td>
          <td>${d.variations ? d.variations.length : 0}</td>
          <td>
            <button onclick="editarCategoria('${cat.key}')">Editar</button>
            <button onclick="abrirVariacoes('${cat.key}')">Variações</button>
            <button class="btn-danger" onclick="excluirCategoria('${cat.key}')">Excluir</button>
          </td>
        </tr>
      `;
    });
  });
}

function novaCategoria(){
  categoriaEditando = null;
  catNome.value = '';
  catImagem.value = '';
  previewCategoria.src = '';
  modalCategoria.classList.remove('hidden');
}

function editarCategoria(id){
  categoriaEditando = id;
  db.ref('categories/'+id).once('value').then(s=>{
    catNome.value = s.val().name || '';
    catImagem.value = s.val().image || '';
    previewCategoria.src = s.val().image || '';
    modalCategoria.classList.remove('hidden');
  });
}

function salvarCategoria(){
  const data = {
    name: catNome.value,
    image: catImagem.value
  };

  if(categoriaEditando){
    db.ref('categories/'+categoriaEditando).update(data);
  }else{
    db.ref('categories').push({...data, variations: []});
  }
  fecharCategoria();
}

function excluirCategoria(id){
  if(confirm('Excluir categoria?')){
    db.ref('categories/'+id).remove();
  }
}

function fecharCategoria(){
  modalCategoria.classList.add('hidden');
}

/* ================= VARIAÇÕES ================= */
let CAT_ID = null;
let VARIACOES = [];

function abrirVariacoes(id){
  CAT_ID = id;
  modalVariacoes.classList.remove('hidden');

  db.ref('categories/'+id+'/variations').once('value').then(s=>{
    VARIACOES = s.val() || [];
    renderVariacoes();
  });
}

function renderVariacoes(){
  listaVariacoes.innerHTML = '';
  VARIACOES.forEach((v,i)=>{
    listaVariacoes.innerHTML += `
      <li>
        ${v}
        <button onclick="removerVariacao(${i})">✖</button>
      </li>
    `;
  });
}

function addVariacao(){
  if(!novaVariacao.value) return;
  VARIACOES.push(novaVariacao.value);
  novaVariacao.value = '';
  renderVariacoes();
}

function removerVariacao(i){
  VARIACOES.splice(i,1);
  renderVariacoes();
}

function salvarVariacoes(){
  db.ref('categories/'+CAT_ID).update({ variations: VARIACOES });
  fecharVariacoes();
}

function fecharVariacoes(){
  modalVariacoes.classList.add('hidden');
}

/* ================= INIT ================= */
carregarCategorias();
</script>

</body>
</html>

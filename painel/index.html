/* === FUN√á√ïES DE APOIO E GEST√ÉO === */



function filtrarPedidos() {

    const termo = document.getElementById('inputBusca').value.toLowerCase();

    const cards = document.querySelectorAll('.pedido-card');

    cards.forEach(card => {

        const textoCard = card.innerText.toLowerCase();

        card.style.display = textoCard.includes(termo) ? 'flex' : 'none';

    });

}



function excluirReal(id) {

    if(confirm("‚ö†Ô∏è AVISO: Isso apagar√° o pedido permanentemente do Firebase. Deseja continuar?")) {

        db.ref('orders/' + id).remove();

    }

}



function cancelarPedido(id) {

    if(confirm("Deseja arquivar este pedido? Ele sair√° da lista principal.")) {

        db.ref('orders/' + id).update({ status: 'Cancelado', arquivado: true });

    }

}

function verDetalhesPedido(id) {

    db.ref('orders/' + id).once('value').then(s => {

        const p = s.val();

        const e = p.endereco_detalhado || {};

        

        // C√°lculos Financeiros

        const subtotalItens = Object.values(p.itens||{}).reduce((acc, i) => acc + (i.preco * i.qtd), 0);

        const descPromo = parseFloat(p.descontoPromocional || 0);

        const descPix = parseFloat(p.descontoPix || 0);

        const totalFinal = parseFloat(p.total || 0);



        let itensHtml = '';

        Object.values(p.itens||{}).forEach(i => {

            itensHtml += `<div class="flex justify-between text-[11px] border-b border-[#222] py-1">

                <span>${i.qtd}x ${i.nome}</span>

                <span>R$ ${(i.preco * i.qtd).toFixed(2)}</span>

            </div>`;

        });



        abrirModal('Detalhes do Pedido', `

            <div class="text-[11px] space-y-2">

                <p><b>Cliente:</b> ${p.cliente} <br><b>Whats:</b> ${p.whatsapp || 'S/N'}</p>

                <p><b>Endere√ßo:</b> ${e.rua||'N/A'}, ${e.num||''}<br>${e.bairro||''} - ${e.cidade||''}</p>

                

                <div class="py-2 max-h-40 overflow-y-auto">${itensHtml}</div>

                

                <div class="bg-[#0a0a0a] p-2 rounded border border-[#222] space-y-1">

                    <div class="flex justify-between opacity-60"><span>Subtotal Itens:</span> <span>R$ ${subtotalItens.toFixed(2)}</span></div>

                    ${descPromo > 0 ? `<div class="flex justify-between text-orange-400"><span>Desc. Promocional:</span> <span>- R$ ${descPromo.toFixed(2)}</span></div>` : ''}

                    ${descPix > 0 ? `<div class="flex justify-between text-green-500"><span>Desc. Extra PIX:</span> <span>- R$ ${descPix.toFixed(2)}</span></div>` : ''}

                    <div class="flex justify-between text-lg font-bold text-white border-t border-[#333] pt-1">

                        <span>TOTAL FINAL:</span> <span>R$ ${totalFinal.toFixed(2)}</span>

                    </div>

                </div>

                <div class="text-lg font-bold text-green-500 text-right">Total: R$ ${parseFloat(p.total).toFixed(2)}</div>

                <div class="grid grid-cols-1 gap-2 mt-4 no-print">

                    <button onclick="gerarRomaneio('${id}','simples')" class="btn bg-gray-700">üìÑ Romaneio Simples</button>

                    <button onclick="gerarRomaneio('${id}','completo')" class="btn bg-blue-700">üñ®Ô∏è Romaneio Completo</button>

                    <button onclick="gerarRomaneio('${id}','cliente')" class="btn bg-green-700">üì∏ Romaneio Cliente (Fotos)</button>

                </div>

            </div>

        `, null);

    });

}



function editarPedido(id) {

    db.ref('orders/' + id).once('value').then(s => {

        const p = s.val();

        // Garante que o objeto de endere√ßo exista para n√£o dar erro ao abrir

        const e = p.endereco_detalhado || {local:'', rua:'', num:'', bairro:'', cidade:''};

        

        let itensEditHtml = '';

        Object.entries(p.itens || {}).forEach(([k, i]) => {

            itensEditHtml += `

            <div class="item-edit-row border-b border-[#222] py-2" data-id="${k}">

                <div class="text-[10px] text-[#caa85c]">${i.nome}</div>

                <div class="flex gap-2">

                    <input type="number" class="edit-qtd w-20 mb-0 bg-transparent border-[#333]" value="${i.qtd}" oninput="recalcularTotalEdicao()" data-preco="${i.preco}">

                    <input type="text" class="opacity-40 mb-0 bg-transparent border-none" value="R$ ${i.preco}" readonly>

                </div>

            </div>`;

        });



        abrirModal('Editar Pedido', `

            <div class="space-y-2 text-left">

                <label class="text-[10px] text-[#caa85c] uppercase font-bold">Dados do Cliente</label>

                <input id="editCli" value="${p.cliente}" placeholder="Nome Cliente">

                

                <label class="text-[10px] text-[#caa85c] uppercase font-bold mt-2 block">Local de Entrega</label>

                <input id="editEndLocal" value="${e.local || ''}" placeholder="Local (Ex: Casa, Loja)">

                

                <div class="flex gap-2">

                    <input id="editEndRua" value="${e.rua || ''}" placeholder="Rua" class="flex-[3]">

                    <input id="editEndNum" value="${e.num || ''}" placeholder="N¬∫" class="flex-[1]">

                </div>



                <div class="flex gap-2">

                    <input id="editEndBairro" value="${e.bairro || ''}" placeholder="Bairro" class="flex-1">

                    <input id="editEndCidade" value="${e.cidade || ''}" placeholder="Cidade" class="flex-1">

                </div>



                <div id="containerItensEdit" class="mt-4 max-h-40 overflow-y-auto">${itensEditHtml}</div>

                

                <div class="mt-4 p-2 bg-black rounded border border-[#222]">

                    <label class="text-[10px] text-green-500 font-bold uppercase">Total Final</label>

                    <input id="editTotal" type="number" step="0.01" value="${p.total}" class="text-xl font-bold text-green-500 bg-transparent border-none w-full">

                </div>

            </div>

        `, () => {

            // FUN√á√ÉO SALVAR (Ao clicar no bot√£o dourado)

            const novosItens = {...p.itens};

            document.querySelectorAll('.item-edit-row').forEach(row => {

                const iId = row.dataset.id;

                const nQtd = parseInt(row.querySelector('.edit-qtd').value);

                if(nQtd > 0) {

                    if(novosItens[iId]) novosItens[iId].qtd = nQtd;

                } else {

                    delete novosItens[iId];

                }

            });



            // Atualiza no Firebase incluindo BAIRRO e CIDADE

            db.ref('orders/' + id).update({

                cliente: document.getElementById('editCli').value,

                total: parseFloat(document.getElementById('editTotal').value),

                itens: novosItens,

                endereco_detalhado: { 

                    local: document.getElementById('editEndLocal').value, 

                    rua: document.getElementById('editEndRua').value, 

                    num: document.getElementById('editEndNum').value,

                    bairro: document.getElementById('editEndBairro').value,

                    cidade: document.getElementById('editEndCidade').value

                }

            }).then(() => {

                console.log("Pedido atualizado!");

            });

        });

    });

}



function recalcularTotalEdicao() {

    let soma = 0;

    document.querySelectorAll('.item-edit-row').forEach(row => {

        const q = parseInt(row.querySelector('.edit-qtd').value) || 0;

        const p = parseFloat(row.querySelector('.edit-qtd').dataset.preco) || 0;

        soma += (q * p);

    });

    document.getElementById('editTotal').value = soma.toFixed(2);

}



function gerarRomaneio(id, tipo) {

    db.ref('orders/'+id).once('value').then(s => {

        const p = s.val();

        if(!p) return;

        

        // Coleta o endere√ßo detalhado ou define um objeto vazio para evitar erro

        const e = p.endereco_detalhado || {};

        const data = new Date().toLocaleString('pt-BR');

        const telefoneLoja = "(11) 98765-4321"; // Edite aqui



        db.ref('settings').once('value').then(set => {

            const config = set.val() || { parcelas: 1, pix: 0 };

            const valorTotal = parseFloat(p.total) || 0;

            const desconto = parseFloat(p.descontoPix) || 0;

            const subtotalGeral = valorTotal + desconto;



            const mostrarFoto = (tipo === 'foto' || tipo === 'cliente');



            let html = `<html><head><title>Romaneio ${tipo.toUpperCase()}</title><style>

                @page { size: A4; margin: 1cm; }

                body { font-family: 'Segoe UI', Arial, sans-serif; color: #333; margin: 0; padding: 0; }

                .header { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid #caa85c; padding-bottom: 8px; margin-bottom: 15px; }

                .logo-area h1 { margin: 0; color: #caa85c; font-size: 22px; letter-spacing: 1px; }

                .logo-area span { font-size: 10px; color: #666; font-weight: bold; }

                .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; font-size: 10px; }

                .info-box { padding: 8px; border: 1px solid #eee; background: #fafafa; line-height: 1.5; }

                

                table { width: 100%; border-collapse: collapse; table-layout: fixed; }

                th { background: #f2f2f2; padding: 7px 4px; border: 1px solid #ccc; font-size: 9px; text-transform: uppercase; }

                td { padding: 6px 4px; border: 1px solid #eee; font-size: 9px; vertical-align: middle; word-wrap: break-word; }

                

                .col-center { text-align: center; }

                .col-right { text-align: right; }

                .img-item { width: 45px; height: 45px; object-fit: cover; border-radius: 3px; border: 1px solid #ddd; display: block; margin: 0 auto; }

                

                .financeiro-box { width: 250px; border: 1px solid #eee; padding: 10px; margin-left: auto; margin-top: 15px; }

                .fin-row { display: flex; justify-content: space-between; padding: 3px 0; font-size: 10px; border-bottom: 1px solid #f9f9f9; }

                .total-final { font-size: 15px; font-weight: bold; border-top: 2px solid #caa85c; padding-top: 5px; }

            </style></head><body>

            

            <div class="header">

                <div class="logo-area">

                    <h1>ABELLA JOIAS</h1>

                    <span>ROMANEIO ${tipo.toUpperCase()}</span>

                    <div style="font-size:10px; color:#444;">WhatsApp: ${telefoneLoja}</div>

                </div>

                <div style="text-align:right; font-size: 10px;">

                    <strong>PEDIDO:</strong> #${id.toUpperCase()}<br><strong>DATA:</strong> ${data}

                </div>

            </div>



            <div class="info-grid">

                <div class="info-box">

                    <strong>CLIENTE:</strong> ${p.cliente}<br>

                    <strong>WHATSAPP:</strong> ${p.whatsapp || 'N/A'}<br>

                    <strong>FORMA PAGTO:</strong> ${p.pagamento || 'A combinar'}

                </div>

                <div class="info-box">

                    <strong>LOCAL DE ENTREGA:</strong> ${e.local || 'N√£o especificado'}<br>

                    <strong>ENDERE√áO:</strong> ${e.rua || 'A retirar'}, ${e.num || 'S/N'}<br>

                    <strong>BAIRRO:</strong> ${e.bairro || '---'} | <strong>CIDADE:</strong> ${e.cidade || '---'}

                </div>

            </div>



            <table>

                <thead>

                    <tr>

                        ${mostrarFoto ? '<th style="width: 55px;">FOTO</th>' : ''}

                        <th style="width: 70px;">SKU</th>

                        <th>DESCRI√á√ÉO</th>

                        <th style="width: 35px;">QTD</th>

                        ${tipo !== 'simples' ? '<th style="width: 50px;">PESO U.</th><th style="width: 50px;">PESO T.</th>' : ''}

                        <th style="width: 75px;">VALOR U.</th>

                        <th style="width: 75px;">SUBTOTAL</th>

                    </tr>

                </thead>

                <tbody>`;

            

            let pesoTotalGeral = 0;

            Object.values(p.itens || {}).forEach(i => {

                const qtd = parseInt(i.qtd) || 0;

                const pU = parseFloat(i.weight || i.peso || 0);

                const vU = parseFloat(i.preco || 0);

                const pT = pU * qtd;

                const vT = vU * qtd;

                pesoTotalGeral += pT;



                const urlImagem = i.image || i.foto || i.thumb || '';



                html += `<tr>

                    ${mostrarFoto ? `<td class="col-center"><img src="${urlImagem}" class="img-item" onerror="this.src='https://via.placeholder.com/45?text=S/FOTO'"></td>` : ''}

                    <td style="font-family: monospace;">${i.sku || '---'}</td>

                    <td>${i.nome} ${i.variacao ? '<br><small style="color:#888;">('+i.variacao+')</small>' : ''}</td>

                    <td class="col-center">${qtd}</td>

                    ${tipo !== 'simples' ? `<td class="col-center">${pU.toFixed(2)}g</td><td class="col-center">${pT.toFixed(2)}g</td>` : ''}

                    <td class="col-right">R$ ${vU.toFixed(2)}</td>

                    <td class="col-right"><strong>R$ ${vT.toFixed(2)}</strong></td>

                </tr>`;

            });



            html += `</tbody></table>



            <div class="financeiro-box">

                ${tipo !== 'simples' ? `<div class="fin-row"><span>Peso Total:</span> <strong>${pesoTotalGeral.toFixed(2)}g</strong></div>` : ''}

                <div class="fin-row"><span>Subtotal:</span> <span>R$ ${subtotalGeral.toFixed(2)}</span></div>

                <div class="fin-row" style="color:green;"><span>Desconto:</span> <span>- R$ ${desconto.toFixed(2)}</span></div>

                <div class="fin-row total-final"><span>TOTAL:</span> <span>R$ ${valorTotal.toFixed(2)}</span></div>

            </div>



            <script>window.onload = function() { setTimeout(() => { window.print(); window.close(); }, 500); }<\/script>

            </body></html>`;



            const win = window.open('','_blank');

            win.document.write(html);

            win.document.close();

        });

    });

}

function salvarPromos(){

    document.querySelectorAll('[id^="promo-"]').forEach(i=>{

        db.ref('categories/'+i.id.replace('promo-','')).update({discount:+i.value});

    });

    alert('Promo√ß√µes atualizadas');

}

function abrirPainelPromocoes() {
    Promise.all([
        db.ref('categories').once('value'),
        db.ref('settings/promocao').once('value')
    ]).then(([snapCats, snapPromo]) => {
        const promo = snapPromo.val() || { ativa: false, porcentagem: 0 };
        let listaCats = '';

        snapCats.forEach(c => {
            const d = c.val();
            listaCats += `
                <div class="flex justify-between items-center p-2 bg-black mb-1 rounded border border-[#222]">
                    <span class="text-[10px] uppercase">${d.name}</span>
                    <input type="number" id="promo-${c.key}" value="${d.discount || 0}" class="w-16 mb-0 text-center text-xs">
                </div>`;
        });

        abrirModal('Gerenciar Promo√ß√µes', `
            <div class="space-y-4">
                <div class="p-3 bg-[#111] rounded border border-[#222] flex justify-between items-center">
                    <span class="text-xs font-bold">PROMO√á√ÉO GERAL</span>
                    <button onclick="togglePromo()" class="btn ${promo.ativa ? 'bg-green-600' : 'bg-red-600'}">
                        ${promo.ativa ? 'ATIVA' : 'INATIVA'}
                    </button>
                </div>
                <div>
                    <label class="text-[10px] text-[#caa85c] font-bold">PORCENTAGEM GERAL (%)</label>
                    <input type="number" id="promoPorcentagem" value="${promo.porcentagem}">
                </div>
                <hr class="border-[#222]">
                <label class="text-[10px] text-[#caa85c] font-bold">DESCONTOS POR CATEGORIA (%)</label>
                <div class="max-h-40 overflow-y-auto">${listaCats}</div>
            </div>
        `, () => {
            // Salvar tudo de uma vez
            const pGeral = document.getElementById('promoPorcentagem').value;
            db.ref('settings/promocao/porcentagem').set(parseInt(pGeral));
            
            // Salva categorias
            document.querySelectorAll('[id^="promo-"]').forEach(i => {
                db.ref('categories/' + i.id.replace('promo-', '')).update({ discount: parseInt(i.value || 0) });
            });
            alert('Promo√ß√µes aplicadas com sucesso!');
        });
    });
}

function togglePromo() {
    db.ref('settings/promocao/ativa').once('value').then(s => {
        const statusAtual = s.val() || false;
        db.ref('settings/promocao/ativa').set(!statusAtual).then(() => {
            fecharModal();
            abrirPainelPromocoes();
        });
    });
}
</script>
</body>
</html>

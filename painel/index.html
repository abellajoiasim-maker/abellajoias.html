<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Administrativo ‚Ä¢ Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#0b0b0b;color:#eee;font-family:Inter,Arial,sans-serif;margin:0}
nav button.active{border-color:#caa85c;color:#caa85c}
section{display:none;min-height:300px}
section.active{display:block}
.card{background:#141414;border:1px solid #2a2a2a;border-radius:16px;padding:14px}
.btn{background:#222;border:1px solid #444;padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer;transition:all 0.2s}
.btn-gold{background:#caa85c;color:#000;font-weight:700}
input,select{background:#111;border:1px solid #333;padding:8px;border-radius:8px;width:100%;margin-bottom:8px;color:#fff}
#print-area{display:none}

@media print{
 body *{visibility:hidden}
 #print-area,#print-area *{visibility:visible}
 #print-area{position:absolute;top:0;left:0;width:100%;background:#fff;color:#000;display:block}
}
</style>
</head>
<body>

<header class="p-5 text-center text-xl font-bold bg-black border-b border-[#222]">
  Painel Administrativo ‚Ä¢ Abella Joias
</header>

<nav class="flex gap-2 p-2 bg-[#111] sticky top-0 z-50 overflow-x-auto">
  <button class="btn active" onclick="showTab('empresa',this)">Empresa</button>
  <button class="btn" onclick="showTab('categorias',this)">Categorias</button>
  <button class="btn" onclick="showTab('produtos',this)">Produtos</button>
  <button class="btn" onclick="showTab('promocoes',this)">Promo√ß√µes</button>
  <button class="btn" onclick="showTab('pedidos',this)">Pedidos</button>
</nav>

<main class="p-6">
  <section id="empresa" class="active">
    <div class="card space-y-3">
      <h2 class="text-[#caa85c] font-bold">Configura√ß√µes da Loja</h2>
      <input id="empNome" placeholder="Nome da Empresa">
      <input id="empSub" placeholder="Subt√≠tulo">
      <input id="empWhats" placeholder="WhatsApp">
      <input id="empDesc" type="number" placeholder="Desconto PIX (%)">
      <input id="empParc" type="number" placeholder="Parcelas sem acr√©scimo">
      <button class="btn-gold w-full py-3 rounded-lg" onclick="salvarEmpresa()">Salvar Configura√ß√µes</button>
    </div>
  </section>

  <section id="categorias">
    <div id="listaCategorias" class="grid gap-2"></div>
  </section>

  <section id="produtos">
    <div id="listaProdutos" class="grid gap-2"></div>
  </section>

  <section id="promocoes">
    <h2 class="text-[#caa85c] font-bold mb-4 text-center">Gest√£o de Promo√ß√µes</h2>
    <div class="flex gap-2 mb-4">
      <button class="btn flex-1 py-3" onclick="listarPromos('categorias')">üè∑Ô∏è Por Categorias</button>
      <button class="btn flex-1 py-3" onclick="listarPromos('produtos')">üíé Por Produtos</button>
    </div>
    <div id="listaPromocoes" class="grid gap-2">
      <p class="text-center text-gray-500 mt-10">Selecione uma op√ß√£o acima.</p>
    </div>
  </section>

  <section id="pedidos">
    <div id="listaPedidos" class="grid gap-4"></div>
  </section>

  <div id="print-area"></div>
</main>

<script>
/* CONFIGURA√á√ÉO */
firebase.initializeApp({
 apiKey:"AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
 databaseURL:"https://catalogo-abella-joias-default-rtdb.firebaseio.com"
});
const db = firebase.database();
const fMoeda = v => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0);

/* NAVEGA√á√ÉO */
function showTab(id, btn) {
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  
  const target = document.getElementById(id);
  if(target) target.classList.add('active');
  if(btn) btn.classList.add('active');

  if(id === 'categorias') carregarCategorias();
  if(id === 'produtos') carregarProdutos();
  if(id === 'pedidos') carregarPedidos();
}

/* EMPRESA */
function salvarEmpresa() {
  db.ref('settings/empresa').set({
    nome: document.getElementById('empNome').value,
    subtitulo: document.getElementById('empSub').value,
    whats: document.getElementById('empWhats').value,
    descontoPix: +document.getElementById('empDesc').value || 0,
    parcelas: +document.getElementById('empParc').value || 0
  }).then(() => alert('Salvo!'));
}

function carregarEmpresaSeExistir() {
  db.ref('settings/empresa').once('value', s => {
    const v = s.val();
    if(v) {
      document.getElementById('empNome').value = v.nome || '';
      document.getElementById('empSub').value = v.subtitulo || '';
      document.getElementById('empWhats').value = v.whats || '';
      document.getElementById('empDesc').value = v.descontoPix || 0;
      document.getElementById('empParc').value = v.parcelas || 0;
    }
  });
}

/* CATEGORIAS */
function carregarCategorias() {
  const lista = document.getElementById('listaCategorias');
  lista.innerHTML = '<p class="p-4 text-center">Buscando...</p>';
  db.ref('categories').once('value', s => {
    lista.innerHTML = '';
    let cats = [];
    s.forEach(c => cats.push({ key: c.key, ...c.val() }));
    cats.sort((a,b) => a.name.localeCompare(b.name));
    cats.forEach(c => {
      lista.innerHTML += `
        <div class="card flex justify-between items-center py-2 px-4 mb-2">
          <b class="uppercase text-sm">${c.name}</b>
          <button class="text-red-500 font-bold" onclick="if(confirm('Excluir?')) db.ref('categories/${c.key}').remove().then(()=>carregarCategorias())">√ó</button>
        </div>`;
    });
  });
}

/* PRODUTOS (ACORDE√ÉO PARA VELOCIDADE) */
let cacheProdutos = [];
function carregarProdutos() {
  const lista = document.getElementById('listaProdutos');
  lista.innerHTML = '<p class="text-center p-4">Sincronizando...</p>';
  db.ref('products').once('value', s => {
    cacheProdutos = [];
    s.forEach(p => cacheProdutos.push({ key: p.key, ...p.val() }));
    cacheProdutos.sort((a,b) => (a.sku || "").localeCompare(b.sku || "", undefined, {numeric: true}));
    renderizarEstruturaProdutos();
  });
}

function renderizarEstruturaProdutos() {
  const lista = document.getElementById('listaProdutos');
  lista.innerHTML = '';
  const categorias = [...new Set(cacheProdutos.map(p => p.category || "Sem Categoria"))].sort();
  categorias.forEach(cat => {
    const total = cacheProdutos.filter(p => (p.category || "Sem Categoria") === cat).length;
    const catId = cat.replace(/\s+/g, '-');
    lista.innerHTML += `
      <div class="mb-2">
        <div onclick="toggleCategoria('${cat}', '${catId}')" class="flex justify-between p-3 bg-[#1a1a1a] rounded-lg cursor-pointer border-l-4 border-[#caa85c]">
          <b class="text-xs uppercase">${cat} (${total})</b>
          <span id="seta-${catId}">‚ñº</span>
        </div>
        <div id="cat-content-${catId}" class="hidden flex flex-col gap-1 mt-1 pl-2 border-l border-[#222]"></div>
      </div>`;
  });
}

function toggleCategoria(nomeCat, catId) {
  const content = document.getElementById(`cat-content-${catId}`);
  const isHidden = content.classList.contains('hidden');
  if (isHidden) {
    content.classList.remove('hidden');
    const prods = cacheProdutos.filter(p => (p.category || "Sem Categoria") === nomeCat);
    content.innerHTML = prods.map(p => `
      <div class="card flex justify-between py-2 px-3 text-[11px] bg-[#0d0d0d] mb-1">
        <div><span class="text-[#caa85c]">[${p.sku || '---'}]</span> <b>${p.name}</b> ${p.variacao ? `<br><small class="text-blue-400">Var: ${p.variacao}</small>` : ''}</div>
        <button class="text-red-500 font-bold" onclick="if(confirm('Excluir?')) db.ref('products/${p.key}').remove().then(()=>carregarProdutos())">√ó</button>
      </div>`).join('');
  } else {
    content.classList.add('hidden');
  }
}

/* PROMO√á√ïES (RECUPERADO PORCENTAGEM E COR) */
function listarPromos(tipo) {
  const container = document.getElementById('listaPromocoes');
  container.innerHTML = '<p class="text-center p-4">Carregando itens...</p>';
  
  const path = tipo === 'categorias' ? 'categories' : 'products';
  db.ref(path).once('value', s => {
    container.innerHTML = '';
    let itens = [];
    s.forEach(child => itens.push({ key: child.key, ...child.val() }));
    itens.sort((a,b) => (a.name || '').localeCompare(b.name || ''));

    itens.forEach(item => {
      const nome = tipo === 'categorias' ? item.name : `[${item.sku || '---'}] ${item.name}`;
      const cor = item.promoCor || '#caa85c';
      const pct = item.promoPct || 0;

      container.innerHTML += `
        <div class="card mb-2 border-l-4" style="border-color: ${pct > 0 ? cor : '#2a2a2a'}">
          <div class="flex justify-between items-center gap-2">
            <b class="text-[10px] uppercase flex-1">${nome}</b>
            
            <div class="flex items-center gap-2 bg-black/40 p-1 rounded border border-white/5">
              <input type="number" class="w-12 m-0 p-1 text-center text-xs bg-transparent outline-none" 
                value="${pct}" 
                onchange="db.ref('${path}/${item.key}').update({promoPct: +this.value})">
              
              <span class="text-[10px] text-gray-500">%</span>
              
              <input type="color" class="w-6 h-6 p-0 border-none bg-transparent cursor-pointer" 
                value="${cor}" 
                onchange="db.ref('${path}/${item.key}').update({promoCor: this.value})">
            </div>
          </div>
        </div>`;
    });
  });
}

/* PEDIDOS */
function carregarPedidos() {
  const lista = document.getElementById('listaPedidos');
  db.ref('orders').on('value', snapshot => {
    lista.innerHTML = '';
    if (!snapshot.exists()) return;
    let peds = [];
    snapshot.forEach(ped => peds.push({key: ped.key, ...ped.val()}));
    peds.reverse().forEach(p => {
      lista.innerHTML += `
        <div class="card mb-3 border-l-4 border-[#caa85c]">
          <div class="flex justify-between mb-1">
            <b class="text-sm uppercase text-[#caa85c]">${p.cliente?.nome || p.cliente}</b>
            <span class="text-[9px] bg-[#222] px-1 rounded">${p.pagamento || ''}</span>
          </div>
          <div class="grid grid-cols-3 gap-1 mb-2">
            <button class="btn text-[9px]" onclick="gerarRomaneio('${p.key}', 1)">Simples</button>
            <button class="btn text-[9px]" onclick="gerarRomaneio('${p.key}', 2)">Completo</button>
            <button class="btn text-[9px]" onclick="gerarRomaneio('${p.key}', 3)">Com Foto</button>
          </div>
          <div class="flex gap-2">
            <button class="btn flex-1 text-blue-400" onclick="abrirEditorPedido('${p.key}')">‚úé AJUSTAR</button>
            <button class="btn flex-1 text-red-500" onclick="excluirPedido('${p.key}')">EXCLUIR</button>
          </div>
          <div class="text-right mt-2 font-bold">${fMoeda(p.total)}</div>
        </div>`;
    });
  });
}

function excluirPedido(id) {
  if (confirm("Excluir?")) db.ref('orders/' + id).remove();
}

function abrirEditorPedido(id) {
  db.ref('orders/' + id).once('value', s => {
    const p = s.val();
    const nt = prompt("Novo total:", p.total);
    const obs = prompt("Observa√ß√£o:", p.obs || "");
    if (nt !== null) db.ref('orders/' + id).update({ total: +nt, obs: obs, ajustadoManualmente: true });
  });
}

function gerarRomaneio(id, tipo) {
  db.ref('orders/'+id).once('value', s => {
    const p = s.val();
    db.ref('settings/empresa').once('value', e => {
      const emp = e.val() || {};
      let h = `<div style="font-family:Arial;padding:20px;background:#fff;color:#000;">
        <h1 style="text-align:center;color:#A68966;margin:0;">${emp.nome}</h1>
        <p style="text-align:center;font-size:12px;">${emp.subtitulo}<br>Whats: ${emp.whats}</p>
        <hr><p><b>Cliente:</b> ${p.cliente?.nome || p.cliente}</p>
        <table style="width:100%;font-size:11px;border-collapse:collapse;">
          <tr style="border-bottom:1px solid #000;text-align:left;"><th>Produto</th><th>Qtd</th><th>Pre√ßo</th><th>Total</th></tr>`;
      p.itens.forEach(i => {
        h += `<tr style="border-bottom:1px solid #eee">
          <td style="padding:5px;">${i.name} ${i.variacao ? '('+i.variacao+')' : ''}</td>
          <td>${i.quantidade}</td><td>${fMoeda(i.precoFinal || i.price)}</td>
          <td>${fMoeda((i.precoFinal || i.price) * i.quantidade)}</td></tr>`;
      });
      h += `</table><div style="text-align:right;margin-top:20px;">Subtotal: ${fMoeda(p.subtotal)}<br>
        <b style="font-size:16px;">TOTAL: ${fMoeda(p.total)}</b></div></div>`;
      document.getElementById('print-area').innerHTML = h;
      setTimeout(() => window.print(), 500);
    });
  });
}

/* START */
window.addEventListener('load', () => {
  carregarEmpresaSeExistir();
  showTab('empresa', document.querySelector('nav button'));
});
</script>
</body>
</html>

<!-- === PAINEL ABELLA | VERSÃO OTIMIZADA COM VARIAÇÕES === -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Abella | Gestão Inteligente</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{font-family:Poppins,system-ui;background:#f8f9fa}
.card{background:#fff;border:1px solid #eee;border-radius:14px;padding:12px;cursor:pointer}
.card:hover{border-color:#A68966}
.paused{opacity:.5}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:50;align-items:center;justify-content:center}
.modal-box{background:#fff;border-radius:18px;padding:20px;width:100%;max-width:520px;max-height:90vh;overflow:auto}
input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;margin-bottom:8px}
</style>
</head>
<body>

<!-- MODAL -->
<div id="modal" class="modal" onclick="if(event.target==this)fecharModal()">
  <div class="modal-box">
    <h3 id="modalTitle" class="font-bold mb-4"></h3>
    <div id="modalBody"></div>
    <div class="flex gap-2 mt-4">
      <button onclick="salvarProduto()" class="flex-1 bg-green-600 text-white py-3 rounded-xl">SALVAR</button>
      <button onclick="excluirProduto()" class="bg-red-100 text-red-600 px-6 rounded-xl">EXCLUIR</button>
    </div>
  </div>
</div>

<main class="max-w-6xl mx-auto p-4">
<h2 class="font-bold mb-4">PRODUTOS (ORDENADOS POR SKU)</h2>
<div id="listaProdutos" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
</main>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
  databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let produtoAtual = null;

// === LISTAR PRODUTOS ===
db.ref('products').on('value', snap => {
  const lista = document.getElementById('listaProdutos');
  lista.innerHTML = '';
  let arr = [];
  snap.forEach(p => arr.push({id:p.key,...p.val()}));
  arr.sort((a,b)=>String(a.sku).localeCompare(String(b.sku)));

  arr.forEach(p=>{
    lista.innerHTML += `
      <div class="card ${p.paused?'paused':''}" onclick="abrirProduto('${p.id}')">
        <div class="text-xs font-mono text-gray-400">${p.sku}</div>
        <div class="font-bold text-sm truncate">${p.name}</div>
        <div class="text-[#A68966] text-xs font-bold">R$ ${Number(p.price).toFixed(2)}</div>
        <div class="text-[10px] text-gray-400">${p.weight || 0}g</div>
      </div>`;
  });
});

// === ABRIR MODAL ===
async function abrirProduto(id){
  const s = await db.ref('products/'+id).once('value');
  const p = s.val();
  produtoAtual = id;

  let variacoesHTML = '';
  if(p.variations){
    p.variations.forEach((v,i)=>{
      variacoesHTML += `
        <div class="flex gap-2">
          <input value="${v.label}" disabled>
          <input type="number" id="q-${i}" value="${v.qty}">
        </div>`;
    });
  }

  document.getElementById('modalTitle').innerText = "Editar Produto";
  document.getElementById('modalBody').innerHTML = `
    <label>NOME</label><input id="pNome" value="${p.name}">
    <div class="grid grid-cols-2 gap-2">
      <div><label>SKU</label><input id="pSku" value="${p.sku}"></div>
      <div><label>PESO (g)</label><input id="pPeso" type="number" value="${p.weight||0}"></div>
    </div>
    <label>PREÇO</label><input id="pPreco" type="number" value="${p.price}">
    ${variacoesHTML ? `<h4 class="font-bold mt-3 text-sm">VARIAÇÕES</h4>${variacoesHTML}` : ''}
    <label class="flex gap-2 items-center mt-3">
      <input type="checkbox" id="pPause" ${p.paused?'checked':''}> Pausar produto
    </label>
  `;
  document.getElementById('modal').style.display='flex';
}

// === SALVAR ===
function salvarProduto(){
  const updates = {
    name: pNome.value,
    sku: pSku.value,
    price: Number(pPreco.value),
    weight: Number(pPeso.value),
    paused: pPause.checked
  };
  db.ref('products/'+produtoAtual).update(updates);
  fecharModal();
}

// === EXCLUIR ===
function excluirProduto(){
  if(confirm("Excluir produto?")){
    db.ref('products/'+produtoAtual).remove();
    fecharModal();
  }
}

function fecharModal(){
  document.getElementById('modal').style.display='none';
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel Offline-First | Abella Joias</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        body { background:#1a1a1a; color: white; font-family: sans-serif; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        .nav-btn { flex:1; text-align:center; padding:15px 5px; cursor:pointer; font-weight:bold; font-size:10px; background:#333; border:1px solid #444; }
        .nav-btn.active-btn { background:#A68966; color:#fff; }
        input, select { color: black; width: 100%; padding: 12px; margin: 5px 0; border-radius: 8px; border: none; font-size: 16px; }
        .btn-acao { background:#A68966; padding:15px; width:100%; border-radius:10px; font-weight:bold; margin-top:10px; }
    </style>
</head>
<body>

<nav class="flex sticky top-0 z-50 shadow-xl">
    <div onclick="switchTab('aba-empresa', this)" class="nav-btn active-btn">EMPRESA</div>
    <div onclick="switchTab('aba-produtos', this)" class="nav-btn">PRODUTOS</div>
    <div onclick="switchTab('aba-categorias', this)" class="nav-btn">CATEGORIAS</div>
</nav>

<main class="p-4">

    <div id="aba-empresa" class="tab-panel active">
        <button onclick="puxarConfig()" class="w-full border border-yellow-600 p-2 mb-4 text-xs">CARREGAR DADOS DA LOJA</button>
        <div class="space-y-2">
            <input id="empNome" placeholder="Nome da Loja">
            <input id="empWhats" placeholder="WhatsApp">
            <input id="empPix" placeholder="Desconto Pix %" type="number">
            <input id="empParc" placeholder="Parcelas" type="number">
            <button onclick="saveEmpresa()" class="btn-acao">SALVAR CONFIGURAÇÕES</button>
        </div>
    </div>

    <div id="aba-produtos" class="tab-panel">
        <div class="bg-gray-800 p-4 rounded-xl mb-4">
            <h2 class="text-sm font-bold mb-2 text-yellow-500 uppercase">Buscar ou Criar Produto</h2>
            <input id="pBusca" placeholder="Digite o SKU exato">
            <button onclick="buscarProduto()" class="w-full bg-blue-600 p-3 rounded-lg font-bold mt-2">BUSCAR PRODUTO</button>
        </div>

        <div id="formProduto" class="hidden space-y-2 border-t border-gray-700 pt-4">
            <input id="pNome" placeholder="Nome do Produto">
            <input id="pPreco" placeholder="Preço" type="number" step="0.01">
            <input id="pImg" placeholder="Link da Imagem">
            <select id="pCat"><option value="">Selecione a Categoria</option></select>
            <div class="flex items-center gap-2 p-2 bg-gray-700 rounded">
                <input type="checkbox" id="pPause" style="width:20px; margin:0"> <span>PAUSAR PRODUTO</span>
            </div>
            <button onclick="salvarProduto()" class="btn-acao bg-green-600">GRAVAR ALTERAÇÕES</button>
            <button onclick="excluirProduto()" class="w-full p-2 text-red-400 text-xs mt-4">EXCLUIR PRODUTO DEFINITIVAMENTE</button>
        </div>
    </div>

    <div id="aba-categorias" class="tab-panel">
        <button onclick="listarCategorias()" class="w-full border p-2 mb-4 text-xs">LISTAR CATEGORIAS</button>
        <div id="listaCats" class="space-y-2"></div>
        
        <div class="mt-8 p-4 bg-gray-800 rounded-xl">
            <h3 class="text-xs font-bold mb-2">NOVA CATEGORIA</h3>
            <input id="newCatNome" placeholder="Nome">
            <input id="newCatImg" placeholder="Link Imagem">
            <button onclick="criarCategoria()" class="btn-acao">CRIAR</button>
        </div>
    </div>

</main>

<script>
const firebaseConfig = { apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY", databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function switchTab(id, el) {
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-btn'));
    document.getElementById(id).classList.add('active');
    el.classList.add('active-btn');
}

// EMPRESA
function puxarConfig() {
    db.ref('settings').once('value', s => {
        const v = s.val() || {};
        document.getElementById('empNome').value = v.nome || '';
        document.getElementById('empWhats').value = v.whatsapp || '';
        document.getElementById('empPix').value = v.pix || 0;
        document.getElementById('empParc').value = v.parcelas || 1;
    });
}

function saveEmpresa() {
    db.ref('settings').update({
        nome: document.getElementById('empNome').value,
        whatsapp: document.getElementById('empWhats').value,
        pix: Number(document.getElementById('empPix').value),
        parcelas: Number(document.getElementById('empParc').value)
    }).then(() => alert("Empresa Salva!"));
}

// PRODUTOS (BUSCA INDIVIDUAL)
async function buscarProduto() {
    const sku = document.getElementById('pBusca').value.trim();
    if(!sku) return alert("Digite o SKU");
    const id = sku.replace(/[^a-zA-Z0-9]/g, "-");

    // Carregar categorias para o select primeiro
    const cats = await db.ref('categories').once('value');
    const select = document.getElementById('pCat');
    select.innerHTML = '<option value="">Categoria...</option>';
    cats.forEach(c => select.innerHTML += `<option value="${c.val().slug}">${c.val().name}</option>`);

    db.ref('products/' + id).once('value', s => {
        const v = s.val() || {};
        document.getElementById('pNome').value = v.name || '';
        document.getElementById('pPreco').value = v.price || '';
        document.getElementById('pImg').value = v.image || '';
        document.getElementById('pCat').value = v.category || '';
        document.getElementById('pPause').checked = v.paused || false;
        document.getElementById('formProduto').classList.remove('hidden');
    });
}

function salvarProduto() {
    const sku = document.getElementById('pBusca').value.trim();
    const id = sku.replace(/[^a-zA-Z0-9]/g, "-");
    const dados = {
        name: document.getElementById('pNome').value,
        sku: sku,
        price: Number(document.getElementById('pPreco').value),
        image: document.getElementById('pImg').value,
        category: document.getElementById('pCat').value,
        paused: document.getElementById('pPause').checked
    };
    db.ref('products/' + id).update(dados).then(() => alert("Produto Gravado!"));
}

function excluirProduto() {
    if(confirm("Apagar?")) {
        const id = document.getElementById('pBusca').value.replace(/[^a-zA-Z0-9]/g, "-");
        db.ref('products/' + id).remove().then(() => { alert("Apagado"); location.reload(); });
    }
}

// CATEGORIAS
function listarCategorias() {
    db.ref('categories').once('value', s => {
        const lista = document.getElementById('listaCats');
        lista.innerHTML = '';
        s.forEach(c => {
            lista.innerHTML += `<div class="p-3 bg-gray-700 rounded flex justify-between">
                <span>${c.val().name}</span>
                <button onclick="if(confirm('Excluir?')) db.ref('categories/${c.key}').remove()" class="text-red-400">X</button>
            </div>`;
        });
    });
}

function criarCategoria() {
    const nome = document.getElementById('newCatNome').value;
    const slug = nome.toLowerCase().replace(/[^a-z0-9]+/g, "-");
    db.ref('categories/' + slug).set({ name: nome, image: document.getElementById('newCatImg').value, slug: slug })
    .then(() => { alert("Criada!"); listarCategorias(); });
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Administrativo • Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#0b0b0b;color:#eee;font-family:Inter,Arial;margin:0}
nav button.active{border-color:#caa85c;color:#caa85c}
section{display:none;min-height:300px}
section.active{display:block}
.card{background:#141414;border:1px solid #2a2a2a;border-radius:16px;padding:14px}
.btn{background:#222;border:1px solid #444;padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer}
.btn-gold{background:#caa85c;color:#000;font-weight:700}
input,select{background:#111;border:1px solid #333;padding:8px;border-radius:8px;width:100%;margin-bottom:8px;color:#fff}

#print-area{display:none}

@media print{
 body *{visibility:hidden}
 #print-area,#print-area *{visibility:visible}
 #print-area{position:absolute;top:0;left:0;width:100%;background:#fff;color:#000;display:block}
}
</style>
</head>

<body>

<header class="p-5 text-center text-xl font-bold bg-black border-b border-[#222]">
Painel Administrativo • Abella Joias
</header>

<nav class="flex gap-2 p-2 bg-[#111] sticky top-0 z-50">
<button class="btn active" onclick="showTab('empresa',this)">Empresa</button>
<button class="btn" onclick="showTab('categorias',this)">Categorias</button>
<button class="btn" onclick="showTab('produtos',this)">Produtos</button>
<button class="btn" onclick="abrirPromocoes()">Promoções</button>
<button class="btn" onclick="showTab('pedidos',this)">Pedidos</button>
</nav>

<main class="p-6">

<section id="empresa" class="active">
<div class="card space-y-3">
<h2 class="text-[#caa85c] font-bold">Configurações da Loja</h2>
<input id="empNome" placeholder="Nome da Empresa">
<input id="empSub" placeholder="Subtítulo">
<input id="empWhats" placeholder="WhatsApp">
<input id="empDesc" type="number" placeholder="Desconto PIX (%)">
<input id="empParc" type="number" placeholder="Parcelas sem acréscimo">
<button class="btn-gold w-full" onclick="salvarEmpresa()">Salvar</button>
</div>
</section>

<section id="categorias">
<button class="btn-gold mb-3" onclick="novaCategoria()">+ Nova Categoria</button>
<div id="listaCategorias"></div>
</section>

<section id="produtos">
<button class="btn-gold mb-3" onclick="novoProduto()">+ Novo Produto</button>
<div id="listaProdutos"></div>
</section>

<section id="pedidos">
<h2 class="text-[#caa85c] font-bold mb-4">Pedidos</h2>
<div id="listaPedidos" class="grid gap-4"></div>
</section>

<div id="print-area"></div>

</main>

<script>
/* FIREBASE */
firebase.initializeApp({
 apiKey:"AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
 databaseURL:"https://catalogo-abella-joias-default-rtdb.firebaseio.com"
});
const db=firebase.database();

/* HELPERS */
const fMoeda=v=>new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0);

/* NAVEGAÇÃO - AJUSTE CIRÚRGICO PARA VOLTAR A FUNCIONAR */
function showTab(id,btn){
 document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
 const target = document.getElementById(id);
 if(target) target.classList.add('active');

 document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
 if(btn) btn.classList.add('active');

 if(id==='categorias') carregarCategorias();
 if(id==='produtos') carregarProdutos();
 if(id==='pedidos') carregarPedidos();
}

/* EMPRESA */
function salvarEmpresa(){
 db.ref('settings/empresa').set({
  nome: document.getElementById('empNome').value,
  subtitulo: document.getElementById('empSub').value,
  whats: document.getElementById('empWhats').value,
  descontoPix: +document.getElementById('empDesc').value||0,
  parcelas: +document.getElementById('empParc').value||0
 });
 alert('Salvo');
}

/* CATEGORIAS */
function carregarCategorias(){
 db.ref('categories').once('value',s=>{
  const listaCategorias = document.getElementById('listaCategorias');
  listaCategorias.innerHTML='';
  s.forEach(c=>{
   listaCategorias.innerHTML+=`
    <div class="card flex justify-between mb-2">
     <b>${c.val().name}</b>
     <button class="btn" onclick="db.ref('categories/${c.key}').remove().then(()=>carregarCategorias())">X</button>
    </div>`;
  });
 });
}
function novaCategoria(){
 const n=prompt('Nome da categoria');
 if(n) db.ref('categories').push({name:n}).then(()=>carregarCategorias());
}

/* PRODUTOS */
function carregarProdutos(){
 db.ref('products').once('value',s=>{
  const listaProdutos = document.getElementById('listaProdutos');
  listaProdutos.innerHTML='';
  s.forEach(p=>{
   listaProdutos.innerHTML+=`
    <div class="card mb-2">
     <b>${p.val().name}</b><br>
     ${fMoeda(p.val().price)}
    </div>`;
  });
 });
}
function novoProduto(){
 const n=prompt('Nome');
 const v=prompt('Preço');
 if(n&&v) db.ref('products').push({name:n,price:+v}).then(()=>carregarProdutos());
}

/* PROMOÇÕES */
function abrirPromocoes(){
 alert('Painel de promoções OK');
}

/* PEDIDOS */
function carregarPedidos(){
 db.ref('orders').on('value',s=>{
  const listaPedidos = document.getElementById('listaPedidos');
  listaPedidos.innerHTML='';
  s.forEach(ped=>{
   const p=ped.val();
   listaPedidos.innerHTML+=`
    <div class="card">
     <b>${p.cliente?.nome||p.cliente}</b><br>
     ${fMoeda(p.total)}<br>
     <button class="btn-gold w-full mt-2" onclick="gerarRomaneio('${ped.key}')">
      Romaneio
     </button>
    </div>`;
  });
 });
}

/* ROMANEIO - AJUSTE CIRÚRGICO NO HÍFEN */
function gerarRomaneio(id){
 db.ref('orders/'+id).once('value',s=>{
  const p=s.val(); if(!p) return;
  db.ref('settings/empresa').once('value',e=>{
   const emp=e.val()||{};
   let html=`<div style="color:#000; padding:20px"><h1>${emp.nome||'Abella Joias'}</h1><h3>${emp.subtitulo||''}</h3>`;
   html+=`<p>Cliente: ${p.cliente?.nome||p.cliente}</p>`;
   html+=`<table border="1" width="100%" style="border-collapse:collapse">`;
   if(p.itens) {
       p.itens.forEach(i=>{
        html+=`<tr><td>${i.sku||''}</td><td>${i.name}</td><td>${i.quantidade||i.qty||1}</td></tr>`;
       });
   }
   html+=`</table>`;
   html+=`<h2>Total ${fMoeda(p.total)}</h2></div>`;
   
   // Ajuste aqui: usando getElementById para evitar erro de sintaxe com o hífen
   document.getElementById('print-area').innerHTML=html;
   window.print();
  });
 });
}

/* START */
window.addEventListener('load',()=>{
 // Inicia na aba empresa
 carregarEmpresaSeExistir(); 
});

function carregarEmpresaSeExistir(){
    db.ref('settings/empresa').once('value', s => {
        const v = s.val();
        if(v){
            document.getElementById('empNome').value = v.nome || '';
            document.getElementById('empSub').value = v.subtitulo || '';
            document.getElementById('empWhats').value = v.whats || '';
            document.getElementById('empDesc').value = v.descontoPix || 0;
            document.getElementById('empParc').value = v.parcelas || 0;
        }
    });
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Painel Admin Premium ‚Ä¢ Abella Joias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        body{background:#0b0b0b;color:#eee;font-family:Inter,Arial}
        nav button.active{border-color:#caa85c;color:#caa85c}
        section{display:none}
        section.active{display:block}
        .card{background:#141414;border:1px solid #2a2a2a;border-radius:16px;padding:14px}
        .btn{background:#222;border:1px solid #444;padding:6px 10px;border-radius:8px;font-size:12px;cursor:pointer;transition:0.2s}
        .btn:hover{background:#333}
        .btn-gold{background:#caa85c;color:#000;font-weight:700}
        .btn-red{border-color:#c33;color:#f77}
        #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:100;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
        .modal-box{background:#141414;border:1px solid #333;border-radius:20px;width:100%;max-width:600px;padding:24px;max-height:90vh;overflow-y:auto}
        input,select,textarea{background:#111;border:1px solid #333;padding:10px;border-radius:8px;width:100%;margin-bottom:10px;color:#fff;outline:none}
        input:focus{border-color:#caa85c}
    </style>
</head>
<body>

<header class="p-5 text-center text-xl font-bold bg-black border-b border-[#222] tracking-widest text-[#caa85c]">
    ABELLA JOIAS ‚Ä¢ CONTROL PANEL
</header>

<nav class="flex gap-2 p-2 bg-[#111] overflow-x-auto sticky top-0 z-50 border-b border-[#222]">
    <button class="btn active" onclick="showTab('pedidos',this)">üì¶ Pedidos</button>
    <button class="btn" onclick="showTab('produtos',this)">üíé Produtos</button>
    <button class="btn" onclick="showTab('promocoes',this)">üè∑Ô∏è Promo√ß√µes</button>
    <button class="btn" onclick="showTab('categorias',this)">üìÇ Categorias</button>
    <button class="btn" onclick="showTab('empresa',this)">‚öôÔ∏è Ajustes</button>
</nav>

<main class="p-6">
    <section id="pedidos" class="active">
        <div id="listaPedidos" class="grid gap-4"></div>
    </section>

    <section id="produtos">
        <div id="produtosPorCategoria"></div>
    </section>

    <section id="promocoes">
        <div id="listaPromocoes" class="max-w-md mx-auto space-y-3"></div>
        <button class="btn-gold mt-6 w-full py-4 rounded-xl" onclick="abrirPainelPromocoes()">GERENCIAR PROMO√á√ïES GLOBAIS</button>
    </section>

    <section id="categorias"><div id="listaCategorias" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div></section>
    <section id="empresa" class="max-w-md mx-auto card">
        <label class="text-[10px] uppercase font-bold text-[#caa85c]">WhatsApp da Loja</label>
        <input id="empWhats">
        <label class="text-[10px] uppercase font-bold text-[#caa85c]">Desconto PIX (%)</label>
        <input id="empPix" type="number">
        <button class="btn-gold w-full mt-4 py-3 rounded-lg" onclick="salvarEmpresa()">SALVAR CONFIGURA√á√ïES</button>
    </section>
</main>

<div id="modal">
    <div class="modal-box">
        <div class="flex justify-between items-center mb-6 border-b border-[#333] pb-3">
            <h3 id="modalTitle" class="font-bold text-[#caa85c] uppercase tracking-wider"></h3>
            <button onclick="fecharModal()" class="text-gray-500 hover:text-white">‚úï</button>
        </div>
        <div id="modalBody"></div>
        <div class="flex gap-3 mt-6" id="modalFooter">
            <button class="btn-gold flex-1 py-3 rounded-xl" id="btnSalvar">SALVAR</button>
            <button class="btn flex-1 py-3 rounded-xl" onclick="fecharModal()">CANCELAR</button>
        </div>
    </div>
</div>

<script>
firebase.initializeApp({
    apiKey:"AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
    authDomain:"catalogo-abella-joias.firebaseapp.com",
    databaseURL:"https://catalogo-abella-joias-default-rtdb.firebaseio.com",
    projectId:"catalogo-abella-joias"
});
const db = firebase.database();

function showTab(id,btn){
    document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
}

function abrirModal(t, b, cb) {
    document.getElementById('modal').style.display = 'flex';
    document.getElementById('modalTitle').innerText = t;
    document.getElementById('modalBody').innerHTML = b;
    const btnS = document.getElementById('btnSalvar');
    if (cb) { btnS.style.display='block'; btnS.onclick = () => { cb(); }; }
    else { btnS.style.display='none'; }
}
function fecharModal() { document.getElementById('modal').style.display = 'none'; }

// --- L√ìGICA DE PEDIDOS E ROMANEIOS ---

db.ref('orders').on('value', s => {
    const lista = document.getElementById('listaPedidos');
    lista.innerHTML = '';
    s.forEach(o => {
        const p = o.val();
        if (p.arquivado) return;
        lista.innerHTML += `
        <div class="card flex justify-between items-center border-l-4 border-[#caa85c]">
            <div>
                <div class="text-[10px] text-gray-500 uppercase">Pedido: #${o.key.substring(0,6)}</div>
                <div class="font-bold text-lg">${p.cliente}</div>
                <div class="text-[#caa85c] font-bold text-sm">R$ ${parseFloat(p.total).toFixed(2)}</div>
            </div>
            <div class="flex gap-2">
                <button class="btn btn-gold" onclick="abrirEditorPedido('${o.key}')">EDITAR / VER</button>
                <button class="btn btn-red" onclick="excluirReal('orders','${o.key}')">‚úï</button>
            </div>
        </div>`;
    });
});

function abrirEditorPedido(id) {
    db.ref('orders/' + id).once('value').then(s => {
        const p = s.val();
        const e = p.endereco_detalhado || {};
        
        let htmlItens = '';
        Object.entries(p.itens || {}).forEach(([key, item]) => {
            htmlItens += `
            <div class="flex gap-2 items-center mb-2 bg-black p-2 rounded">
                <img src="${item.image}" class="w-10 h-10 object-cover rounded">
                <div class="flex-1 text-[11px]">${item.nome}</div>
                <input type="number" class="w-12 p-1 mb-0 text-center" value="${item.qtd}" onchange="atualizarQtdItem('${id}','${key}',this.value)">
            </div>`;
        });

        abrirModal('Gerenciar Pedido', `
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-[9px] text-[#caa85c] font-bold uppercase">Cliente</label>
                        <input id="editCliente" value="${p.cliente}">
                    </div>
                    <div>
                        <label class="text-[9px] text-[#caa85c] font-bold uppercase">WhatsApp</label>
                        <input id="editWhats" value="${p.whatsapp || ''}">
                    </div>
                </div>
                
                <div class="bg-[#111] p-3 rounded-lg border border-[#222]">
                    <label class="text-[9px] text-[#caa85c] font-bold uppercase mb-2 block">Dados de Entrega</label>
                    <input id="editRua" placeholder="Rua/Logradouro" value="${e.rua || ''}">
                    <div class="grid grid-cols-3 gap-2">
                        <input id="editNum" placeholder="N¬∫" value="${e.num || ''}" class="col-span-1">
                        <input id="editBairro" placeholder="Bairro" value="${e.bairro || ''}" class="col-span-2">
                    </div>
                    <input id="editCidade" placeholder="Cidade" value="${e.cidade || ''}">
                </div>

                <div class="max-h-40 overflow-y-auto">${htmlItens}</div>

                <div class="grid grid-cols-3 gap-2 pt-4">
                    <button onclick="gerarRomaneio('${id}','simples')" class="btn py-3">SIMPLES</button>
                    <button onclick="gerarRomaneio('${id}','completo')" class="btn py-3">COMPLETO</button>
                    <button onclick="gerarRomaneio('${id}','foto')" class="btn-gold py-3">COM FOTOS</button>
                </div>
            </div>
        `, () => {
            db.ref('orders/' + id).update({
                cliente: document.getElementById('editCliente').value,
                whatsapp: document.getElementById('editWhats').value,
                endereco_detalhado: {
                    rua: document.getElementById('editRua').value,
                    num: document.getElementById('editNum').value,
                    bairro: document.getElementById('editBairro').value,
                    cidade: document.getElementById('editCidade').value
                }
            }).then(() => { alert("Pedido atualizado!"); fecharModal(); });
        });
    });
}

function gerarRomaneio(id, tipo) {
    db.ref('orders/'+id).once('value').then(s => {
        const p = s.val(); if(!p) return;
        const e = p.endereco_detalhado || {};
        const win = window.open('','_blank');
        
        let html = `<html><head><style>
            body{ font-family: sans-serif; padding: 20px; color: #333; }
            .header{ border-bottom: 2px solid #caa85c; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; }
            table{ width: 100%; border-collapse: collapse; margin-top: 20px; }
            th{ background: #f4f4f4; padding: 10px; text-align: left; font-size: 12px; }
            td{ padding: 10px; border-bottom: 1px solid #eee; font-size: 12px; }
            .img-rom{ width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }
            .total-box{ margin-top: 30px; text-align: right; border-top: 2px solid #333; padding-top: 10px; }
        </style></head><body>
        <div class="header">
            <div><h1>ABELLA JOIAS</h1><p>Romaneio: ${tipo.toUpperCase()}</p></div>
            <div style="text-align:right"><p><b>Pedido:</b> #${id.substring(0,8)}</p><p><b>Data:</b> ${new Date().toLocaleDateString()}</p></div>
        </div>
        <div>
            <p><b>Cliente:</b> ${p.cliente}</p>
            <p><b>Endere√ßo:</b> ${e.rua || 'A retirar'}, ${e.num || ''} - ${e.bairro || ''} / ${e.cidade || ''}</p>
        </div>
        <table><thead><tr>
            ${tipo === 'foto' ? '<th>FOTO</th>' : ''}
            <th>DESCRI√á√ÉO</th>
            <th>QTD</th>
            ${tipo !== 'simples' ? '<th>PESO</th>' : ''}
            <th>SUBTOTAL</th>
        </tr></thead><tbody>`;

        Object.values(p.itens || {}).forEach(item => {
            const pesoT = (parseFloat(item.peso || item.weight || 0) * parseInt(item.qtd)).toFixed(2);
            html += `<tr>
                ${tipo === 'foto' ? `<td><img src="${item.image}" class="img-rom"></td>` : ''}
                <td>${item.nome} ${item.sku ? `<br><small>${item.sku}</small>` : ''}</td>
                <td>${item.qtd}</td>
                ${tipo !== 'simples' ? `<td>${pesoT}g</td>` : ''}
                <td>R$ ${(item.preco * item.qtd).toFixed(2)}</td>
            </tr>`;
        });

        html += `</tbody></table>
        <div class="total-box"><h2>TOTAL: R$ ${parseFloat(p.total).toFixed(2)}</h2></div>
        <script>window.onload = () => { window.print(); }</script>
        </body></html>`;
        
        win.document.write(html);
        win.document.close();
    });
}

// Fun√ß√µes de apoio do Firebase para exclus√£o e categorias permanecem conforme PAINEL.GEMINI enviado anteriormente para manter a estabilidade.
// ... (demais fun√ß√µes de categorias e produtos)
</script>
</body>
</html>

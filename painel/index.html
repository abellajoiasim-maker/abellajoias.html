<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel Administrativo ‚Ä¢ Abella Joias</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root { --gold: #caa85c; --bg: #0b0b0b; --card: #141414; }
        body { background: var(--bg); color: #eee; font-family: 'Inter', sans-serif; margin: 0; }
        nav button.active { border-bottom: 2px solid var(--gold); color: var(--gold); }
        section { display: none; }
        section.active { display: block; }
        .card { background: var(--card); border: 1px solid #2a2a2a; border-radius: 16px; padding: 14px; }
        .btn { background: #222; border: 1px solid #444; padding: 8px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; color: white; transition: 0.3s; }
        .btn:hover { background: #333; }
        .btn-gold { background: var(--gold); color: #000; font-weight: 700; padding: 10px; border-radius: 8px; cursor: pointer; }
        input { background: #111; border: 1px solid #333; padding: 8px; border-radius: 8px; width: 100%; margin-bottom: 8px; color: #fff; outline: none; }
        
        /* ESTILOS DE IMPRESS√ÉO - REFORMULADOS */
        #print-area { display: none; }

        @media print {
            @page { size: portrait; margin: 1cm; }
            body * { visibility: hidden !important; }
            #print-area, #print-area * { visibility: visible !important; }
            #print-area { 
                display: block !important; 
                position: absolute !important; 
                left: 0 !important; top: 0 !important; 
                width: 100% !important; 
                background: white !important;
                color: black !important;
            }
            .no-print { display: none !important; }
            
            /* Melhorias de Renderiza√ß√£o */
            img { max-width: 100%; print-color-adjust: exact; -webkit-print-color-adjust: exact; }
            table { border-collapse: collapse !important; width: 100% !important; }
            tr { page-break-inside: avoid !important; }
        }

        /* Estilos do Documento de Impress√£o */
        .p-container { font-family: 'Inter', sans-serif; padding: 0; color: black; }
        .p-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
        .p-header h1 { font-family: 'Cinzel', serif; font-size: 32px; margin: 0; color: black; letter-spacing: 2px; }
        .p-header .tagline { font-weight: bold; font-size: 12px; letter-spacing: 4px; margin-top: 5px; }
        
        .p-grid-info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .p-info-box { border: 1.5px solid #eee; padding: 10px; border-radius: 8px; }
        .p-info-box h3 { font-size: 10px; color: #888; text-transform: uppercase; margin: 0 0 5px 0; letter-spacing: 1px; }
        
        .p-table { width: 100%; border-collapse: collapse; }
        .p-table th { background: #f9f9f9; border-bottom: 2px solid #000; padding: 10px 5px; text-align: left; font-size: 10px; text-transform: uppercase; }
        .p-table td { border-bottom: 1px solid #eee; padding: 8px 5px; vertical-align: middle; }
        
        .p-img-frame { width: 60px; height: 60px; border: 1px solid #eee; border-radius: 4px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .p-img-frame img { width: 100%; height: 100%; object-fit: cover; }
        
        .p-summary { margin-top: 20px; border-top: 2px solid #000; padding-top: 15px; display: flex; justify-content: flex-end; }
        .p-summary-content { width: 250px; }
        .p-row { display: flex; justify-content: space-between; padding: 3px 0; font-size: 11px; }
        .p-row.total { font-size: 16px; font-weight: bold; border-top: 1px solid #000; margin-top: 5px; padding-top: 5px; }
    </style>
</head>
<body>

<header class="p-5 text-center text-xl font-bold bg-black border-b border-[#222] text-[#caa85c] tracking-widest uppercase">
    Abella Joias ‚Ä¢ Painel de Controle
</header>

<nav class="flex gap-2 p-2 bg-[#111] sticky top-0 z-50 overflow-x-auto">
    <button class="btn active" onclick="showTab('empresa', this)">Empresa</button>
    <button class="btn" onclick="showTab('categorias', this)">Categorias</button>
    <button class="btn" onclick="showTab('produtos', this)">Produtos</button>
    <button class="btn" onclick="showTab('pedidos', this)">Pedidos</button>
</nav>

<main class="p-6 max-w-4xl mx-auto">
    <section id="empresa" class="active">
        <div class="card space-y-3">
            <h2 class="text-[#caa85c] font-bold uppercase text-sm">Configura√ß√£o da Loja</h2>
            <input id="empNome" placeholder="Nome da Empresa">
            <input id="empSub" placeholder="Slogan / Subt√≠tulo">
            <input id="empWhats" placeholder="WhatsApp da Loja">
            <button class="btn-gold w-full" onclick="salvarEmpresa()">GUARDAR ALTERA√á√ïES</button>
        </div>
    </section>

    <section id="pedidos">
        <div id="listaPedidos" class="grid gap-4"></div>
    </section>
</main>

<div id="editorPedido" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4">
    <div class="bg-[#111] w-full max-w-5xl rounded-2xl p-6 overflow-auto max-h-[95vh] border border-[#333]">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-[#caa85c] font-bold text-xl uppercase">Gerenciar Pedido</h2>
            <button onclick="fecharEditorPedido()" class="text-white text-2xl">&times;</button>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
            <div class="card bg-black/40">
                <h3 class="text-xs text-gray-500 font-bold mb-3 uppercase">Informa√ß√µes do Cliente</h3>
                <input id="edClienteNome" placeholder="Nome do Cliente">
                <input id="edClienteTel" placeholder="WhatsApp">
                <input id="edLocal" placeholder="Local (Ex: Resid√™ncia, Loja)">
            </div>
            <div class="card bg-black/40">
                <h3 class="text-xs text-gray-500 font-bold mb-3 uppercase">Entrega</h3>
                <input id="edRua" placeholder="Rua / Logradouro">
                <div class="grid grid-cols-2 gap-2">
                    <input id="edNum" placeholder="N¬∫">
                    <input id="edBairro" placeholder="Bairro">
                </div>
                <input id="edCidade" placeholder="Cidade / Estado">
            </div>
        </div>

        <h3 class="font-bold mt-6 mb-2 text-xs text-[#caa85c] uppercase">Produtos Escolhidos</h3>
        <div id="edItens" class="space-y-2 mb-4"></div>

        <div class="grid grid-cols-3 gap-4 p-4 bg-black rounded-xl border border-[#222]">
            <div><label class="text-[10px] text-gray-400 uppercase">Desc. Promo</label><input id="edDescPromo" class="money"></div>
            <div><label class="text-[10px] text-gray-400 uppercase">Desc. PIX</label><input id="edDescPix" class="money"></div>
            <div><label class="text-[10px] text-gray-400 uppercase">Frete</label><input id="edFrete" class="money"></div>
        </div>

        <div class="mt-8 flex flex-col gap-3">
            <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
                <button class="btn bg-blue-700" onclick="imprimir(1)">Conf. 1</button>
                <button class="btn bg-blue-800" onclick="imprimir(2)">Cliente 2</button>
                <button class="btn-gold" onclick="imprimir(3)">üì∏ ROMANEIO COM FOTOS</button>
                <button class="btn bg-purple-700" onclick="imprimir(4)">Grid Conf.</button>
                <button class="btn bg-purple-900" onclick="imprimir(5)">Grid Cliente</button>
            </div>
            <button class="btn-gold py-4" onclick="salvarPedidoEditado()">SALVAR ALTERA√á√ïES NO SISTEMA</button>
        </div>
    </div>
</div>

<div id="print-area"></div>

<script>
/* INICIALIZA√á√ÉO E FIREBASE */
if (!firebase.apps.length) {
    firebase.initializeApp({
        apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
        databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com"
    });
}
const db = firebase.database();
let pedidoEditando = null;

const fMoeda = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);

function showTab(id, btn) {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if (btn) btn.classList.add('active');
    if (id === 'pedidos') carregarPedidos();
    if (id === 'empresa') carregarEmpresaSeExistir();
}

function carregarPedidos() {
    db.ref('orders').on('value', s => {
        const lista = document.getElementById('listaPedidos');
        lista.innerHTML = '';
        s.forEach(ped => {
            const p = ped.val();
            lista.innerHTML += `
                <div class="card flex justify-between items-center">
                    <div>
                        <b class="text-[#caa85c] uppercase">${p.cliente?.nome || p.cliente}</b>
                        <p class="text-[10px] text-gray-400">${p.data || ''} - Total: ${fMoeda(p.total)}</p>
                    </div>
                    <button class="btn-gold text-[10px]" onclick="abrirEditorPedido('${ped.key}')">EDITAR / ROMANEIO</button>
                </div>`;
        });
    });
}

function abrirEditorPedido(id) {
    db.ref('orders/'+id).once('value', s => {
        const p = s.val(); if (!p) return;
        pedidoEditando = id;
        document.getElementById('edClienteNome').value = p.cliente?.nome || '';
        document.getElementById('edClienteTel').value = p.cliente?.telefone || '';
        document.getElementById('edLocal').value = p.entrega?.local || '';
        document.getElementById('edRua').value = p.entrega?.rua || '';
        document.getElementById('edNum').value = p.entrega?.num || '';
        document.getElementById('edBairro').value = p.entrega?.bairro || '';
        document.getElementById('edCidade').value = p.entrega?.cidade || '';
        
        document.getElementById('edDescPromo').value = (p.descontoPromo || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2});
        document.getElementById('edDescPix').value = (p.descontoPix || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2});
        document.getElementById('edFrete').value = (p.frete || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2});

        const container = document.getElementById('edItens');
        container.innerHTML = '';
        const itens = Array.isArray(p.itens) ? p.itens : Object.values(p.itens || {});
        itens.forEach(i => {
            const div = document.createElement('div');
            div.className = "card bg-black/60 border-[#333] grid grid-cols-2 md:grid-cols-6 gap-2 items-center";
            div.innerHTML = `
                <input placeholder="SKU" value="${i.sku || ''}">
                <input placeholder="Nome" value="${i.name || ''}" class="md:col-span-2">
                <input type="number" placeholder="Peso" value="${i.peso || 0}">
                <input type="number" placeholder="Pre√ßo" value="${i.price || 0}">
                <input type="number" placeholder="Qtd" value="${i.quantidade || 1}">
                <input type="hidden" class="item-img" value="${i.image || ''}">
            `;
            container.appendChild(div);
        });
        document.getElementById('editorPedido').classList.remove('hidden');
    });
}

function fecharEditorPedido() { document.getElementById('editorPedido').classList.add('hidden'); }

async function imprimir(tipo) {
    db.ref('orders/' + pedidoEditando).once('value', async s => {
        const p = s.val();
        const itens = Array.isArray(p.itens) ? p.itens : Object.values(p.itens || {});
        
        // Dados da Empresa (Fallback se n√£o carregar)
        const empNome = document.getElementById('empNome').value || "ABELLA JOIAS";
        const empSub = document.getElementById('empSub').value || "JOIAS NO BRUTO";
        const empWhats = document.getElementById('empWhats').value || "";

        let html = `
        <div class="p-container">
            <div class="p-header">
                <h1>${empNome}</h1>
                <div class="tagline">${empSub}</div>
                <div style="font-size:10px; margin-top:5px;">Whatsapp: ${empWhats}</div>
            </div>

            <div class="p-grid-info">
                <div class="p-info-box">
                    <h3>Dados do Cliente</h3>
                    <strong>${p.cliente?.nome || 'N√£o Informado'}</strong><br>
                    <span>${p.cliente?.telefone || ''}</span>
                </div>
                <div class="p-info-box">
                    <h3>Entrega</h3>
                    <strong>${p.entrega?.local || 'Endere√ßo'}</strong><br>
                    <span>${p.entrega?.rua || ''}, ${p.entrega?.num || ''} - ${p.entrega?.bairro || ''}</span><br>
                    <span>${p.entrega?.cidade || ''}</span>
                </div>
            </div>

            <table class="p-table">
                <thead>
                    <tr>
                        ${tipo === 3 ? '<th>Foto</th>' : ''}
                        <th>SKU</th>
                        <th>Descri√ß√£o do Produto</th>
                        <th style="text-align:center">Qtd</th>
                        ${tipo >= 2 ? '<th>Unit.</th><th>Subtotal</th>' : ''}
                    </tr>
                </thead>
                <tbody>`;

        itens.forEach(i => {
            const imgSrc = i.image && i.image !== "" ? i.image : "https://via.placeholder.com/100?text=Sem+Foto";
            html += `
                <tr>
                    ${tipo === 3 ? `
                    <td>
                        <div class="p-img-frame">
                            <img src="${imgSrc}" crossorigin="anonymous">
                        </div>
                    </td>` : ''}
                    <td style="font-weight:600;">${i.sku || '---'}</td>
                    <td>
                        <div style="font-weight:600">${i.name}</div>
                        <div style="font-size:9px; color:#555">Peso Unit: ${i.peso}g</div>
                    </td>
                    <td align="center" style="font-weight:bold; font-size:14px;">${i.quantidade}</td>
                    ${tipo >= 2 ? `
                    <td>${fMoeda(i.price)}</td>
                    <td style="font-weight:600">${fMoeda(i.price * i.quantidade)}</td>
                    ` : ''}
                </tr>`;
        });

        html += `</tbody></table>`;

        // RESUMO FINANCEIRO
        if (tipo === 2 || tipo === 3 || tipo === 5) {
            html += `
            <div class="p-summary">
                <div class="p-summary-content">
                    <div class="p-row"><span>Subtotal Itens:</span><span>${fMoeda(p.subtotal)}</span></div>
                    <div class="p-row"><span>Frete:</span><span>${fMoeda(p.frete)}</span></div>
                    ${p.descontoPromo > 0 ? `<div class="p-row" style="color:#d32f2f"><span>Desconto Promo:</span><span>-${fMoeda(p.descontoPromo)}</span></div>` : ''}
                    ${p.descontoPix > 0 ? `<div class="p-row" style="color:#2e7d32"><span>Desconto PIX:</span><span>-${fMoeda(p.descontoPix)}</span></div>` : ''}
                    <div class="p-row total"><span>TOTAL DO PEDIDO:</span><span>${fMoeda(p.total)}</span></div>
                    <div style="font-size:9px; text-align:right; margin-top:10px; color:#777">
                        Total de Pe√ßas: ${p.totalPecas || 0} | Peso Total: ${p.pesoTotal || 0}g
                    </div>
                </div>
            </div>`;
        } else {
            html += `
            <div class="p-summary">
                <div style="font-size:11px;">
                    <strong>Total de Pe√ßas: ${p.totalPecas || 0}</strong><br>
                    <strong>Peso Total Estimado: ${p.pesoTotal || 0}g</strong>
                </div>
            </div>`;
        }

        html += `</div>`;

        const printDiv = document.getElementById('print-area');
        printDiv.innerHTML = html;

        // --- L√ìGICA DE CARREGAMENTO DE IMAGENS ---
        const imgs = printDiv.querySelectorAll('img');
        const promises = Array.from(imgs).map(img => {
            return new Promise((resolve) => {
                if (img.complete) {
                    resolve();
                } else {
                    img.onload = resolve;
                    img.onerror = resolve; // Resolve mesmo com erro para n√£o travar a impress√£o
                }
            });
        });

        // Aguarda todas as imagens serem carregadas antes de imprimir
        await Promise.all(promises);
        
        // Pequeno delay extra para garantir a renderiza√ß√£o do Chrome/Safari
        setTimeout(() => {
            window.print();
        }, 800);
    });
}

function carregarEmpresaSeExistir() {
    db.ref('settings/empresa').once('value', s => {
        const v = s.val(); if (!v) return;
        document.getElementById('empNome').value = v.nome || '';
        document.getElementById('empSub').value = v.subtitulo || '';
        document.getElementById('empWhats').value = v.whats || '';
    });
}

function salvarEmpresa() {
    db.ref('settings/empresa').update({
        nome: document.getElementById('empNome').value,
        subtitulo: document.getElementById('empSub').value,
        whats: document.getElementById('empWhats').value
    }).then(() => alert("Configura√ß√µes salvas!"));
}

// M√°scara Financeira
document.addEventListener('input', e => {
    if(e.target.classList.contains('money')) {
        let v = e.target.value.replace(/\D/g,'');
        v = (v/100).toLocaleString('pt-BR', {minimumFractionDigits: 2});
        e.target.value = v;
    }
});

window.onload = () => showTab('empresa');
</script>

</body>
</html>

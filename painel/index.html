<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Administrativo ‚Ä¢ Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#0b0b0b;color:#eee;font-family:Inter,Arial;margin:0}
nav button.active{border-bottom:2px solid #caa85c;color:#caa85c}
section{display:none;min-height:300px}
section.active{display:block}
.card{background:#141414;border:1px solid #2a2a2a;border-radius:16px;padding:14px}
.btn{background:#222;border:1px solid #444;padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer}
.btn-gold{background:#caa85c;color:#000;font-weight:700;padding:10px;border-radius:8px}
input,select{background:#111;border:1px solid #333;padding:8px;border-radius:8px;width:100%;margin-bottom:8px;color:#fff;outline:none}
#mainModal.active { display: flex; }
.custom-scroll::-webkit-scrollbar { width: 4px; }
.custom-scroll::-webkit-scrollbar-thumb { background: #caa85c; border-radius: 10px; }
/* Estilos de Impress√£o */
#print-area { display: none; }
@media print {
    body * { visibility: hidden; }
    #print-area, #print-area * { visibility: visible; }
    #print-area { position: absolute; left: 0; top: 0; width: 100%; display: block; background: #fff; color: #000; }
}
</style>
</head>
<body>

<header class="p-5 text-center text-xl font-bold bg-black border-b border-[#222] text-[#caa85c] tracking-widest uppercase">
  Abella Joias ‚Ä¢ Painel de Controlo
</header>

<nav class="flex gap-2 p-2 bg-[#111] sticky top-0 z-50 overflow-x-auto">
  <button type="button" class="btn active" onclick="showTab('empresa', this)">Empresa</button>
  <button type="button" class="btn" onclick="showTab('categorias', this)">Categorias</button>
  <button type="button" class="btn" onclick="showTab('produtos', this)">Produtos</button>
  <button type="button" class="btn" onclick="showTab('promocoes', this)">Promo√ß√µes</button>
  <button type="button" class="btn" onclick="showTab('pedidos', this)">Pedidos</button>
</nav>

<main class="p-6 max-w-4xl mx-auto">
  <section id="empresa" class="active">
    <div class="card space-y-3">
      <h2 class="text-[#caa85c] font-bold uppercase text-sm">Configura√ß√£o da Loja</h2>
      <input id="empNome" placeholder="Nome da Empresa">
      <input id="empSub" placeholder="Slogan / Subt√≠tulo">
      <input id="empWhats" placeholder="WhatsApp da Loja">
      <div class="grid grid-cols-2 gap-2">
        <input id="empDesc" type="number" placeholder="Desc. PIX %">
        <input id="empParc" type="number" placeholder="Parcelas M√°x">
      </div>
      <button class="btn-gold w-full" onclick="salvarEmpresa()">GUARDAR ALTERA√á√ïES</button>
    </div>
  </section>

  <section id="categorias">
    <div class="card mb-4">
        <input id="newCatName" placeholder="Nome da Nova Categoria">
        <button class="btn-gold w-full" onclick="novaCategoria()">+ CADASTRAR CATEGORIA</button>
    </div>
    <div id="listaCategorias" class="grid gap-2"></div>
  </section>

  <section id="produtos">
    <div id="listaProdutos" class="grid gap-2"></div>
  </section>

  <section id="promocoes">
    <div class="card mb-4 text-center">
        <h2 class="serif gold-text uppercase text-sm mb-4 tracking-widest">Configura√ß√µes de Promo√ß√£o</h2>
        <div class="flex flex-col gap-3">
            <button class="btn-gold w-full py-4 uppercase tracking-tighter" onclick="abrirPainelPromocoes()">
                üé® Configurar Etiquetas e Descontos
            </button>
        </div>
    </div>
    <div id="listaPromocoes" class="grid gap-2"></div>
  </section>

  <section id="pedidos">
    <div id="listaPedidos" class="grid gap-4"></div>
  </section>
</main>

<div id="mainModal" class="fixed inset-0 bg-black/90 z-[100] hidden items-center justify-center p-4">
    <div class="bg-[#141414] border border-[#2a2a2a] w-full max-w-lg rounded-2xl overflow-hidden shadow-2xl">
        <div class="p-4 border-b border-[#222] flex justify-between items-center">
            <h3 id="modalTitle" class="text-[#caa85c] uppercase text-sm font-bold">T√≠tulo</h3>
            <button onclick="fecharModal()" class="text-gray-500 hover:text-white text-2xl">&times;</button>
        </div>
        <div id="modalBody" class="p-6 max-h-[70vh] overflow-y-auto custom-scroll"></div>
        <div class="p-4 border-t border-[#222] flex gap-3">
            <button onclick="fecharModal()" class="flex-1 py-3 text-xs uppercase font-bold text-gray-500">Cancelar</button>
            <button id="modalSaveBtn" class="flex-1 btn-gold py-3 text-xs uppercase font-bold">Guardar Altera√ß√µes</button>
        </div>
    </div>
</div>

<div id="editorPedido" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
  <div class="bg-[#111] w-full max-w-4xl rounded-2xl p-5 overflow-auto max-h-[90vh] border border-[#333]">
    <h2 class="text-[#caa85c] font-bold text-lg mb-3 uppercase">Editar Pedido (Atacado)</h2>
    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <h3 class="font-bold mb-2 text-xs text-gray-400 uppercase">Cliente</h3>
        <input id="edClienteNome" placeholder="Nome">
        <input id="edClienteTel" placeholder="WhatsApp">
      </div>
      <div>
        <h3 class="font-bold mb-2 text-xs text-gray-400 uppercase">Entrega</h3>
        <input id="edRua" placeholder="Rua">
        <div class="grid grid-cols-2 gap-2">
            <input id="edNum" placeholder="N¬∫">
            <input id="edBairro" placeholder="Bairro">
        </div>
        <input id="edCidade" placeholder="Cidade">
      </div>
    </div>

    <h3 class="font-bold mt-4 mb-2 text-xs text-[#caa85c] uppercase">Itens do Pedido</h3>
    <div id="edItens" class="space-y-2"></div>
    <button class="btn w-full mt-2 border-dashed border-gray-600" onclick="adicionarItemEditor()">+ Adicionar Item</button>

    <div class="grid grid-cols-3 gap-3 mt-4">
      <div>
          <label class="text-[9px] text-gray-400 uppercase">Desc. Promo (R$)</label>
          <input id="edDescPromo" type="number" placeholder="0.00">
      </div>
      <div>
          <label class="text-[9px] text-gray-400 uppercase">Desc. PIX (R$)</label>
          <input id="edDescPix" type="number" placeholder="0.00">
      </div>
      <div>
          <label class="text-[9px] text-gray-400 uppercase">Peso Total Pedido (g)</label>
          <input id="edPesoTotalMostrador" type="number" readonly class="opacity-50">
      </div>
    </div>

    <div class="flex flex-wrap gap-2 justify-between mt-6 pt-4 border-t border-[#222]">
      <button class="btn px-6" onclick="fecharEditorPedido()">CANCELAR</button>
      <div class="flex gap-2">
          <button class="btn bg-blue-900 border-blue-700" onclick="gerarRomaneio(pedidoEditando, 1)">SIMPLES</button>
          <button class="btn bg-blue-900 border-blue-700" onclick="gerarRomaneio(pedidoEditando, 2)">DETALHADO</button>
          <button class="btn bg-blue-900 border-blue-700" onclick="gerarRomaneio(pedidoEditando, 3)">FOTOS</button>
          <button class="btn-gold px-10" onclick="salvarPedidoEditado()">SALVAR</button>
      </div>
    </div>
  </div>
</div>

<div id="print-area"></div>

<script>
/* CONFIGURA√á√ÉO FIREBASE */
if (!firebase.apps.length) {
  firebase.initializeApp({
    apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
    databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com"
  });
}
const db = firebase.database();
const fMoeda = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);

/* NAVEGA√á√ÉO */
function showTab(id, btn) {
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (btn) btn.classList.add('active');

  if (id === 'categorias') carregarCategorias();
  if (id === 'produtos') carregarProdutos();
  if (id === 'pedidos') carregarPedidos();
  if (id === 'empresa') carregarEmpresaSeExistir();
}

/* PRODUTOS */
function carregarProdutos() {
    const lista = document.getElementById('listaProdutos');
    lista.innerHTML = '<p class="text-center p-4">Carregando...</p>';
    db.ref('categories').once('value', snapCats => {
        db.ref('products').once('value', snapProds => {
            const produtos = [];
            snapProds.forEach(p => { produtos.push({ key: p.key, ...p.val() }); });
            lista.innerHTML = '';
            snapCats.forEach(cat => {
                const prodsDaCat = produtos.filter(p => p.category === cat.key);
                if (prodsDaCat.length > 0) {
                    let htmlP = prodsDaCat.map(p => `
                        <div class="card flex justify-between items-center py-2 px-3 text-[11px] bg-[#0d0d0d] mb-1">
                            <div class="flex items-center gap-3">
                                <img src="${p.image || 'https://via.placeholder.com/50'}" class="w-10 h-10 object-cover rounded border border-[#333]">
                                <span><b class="text-[#caa85c]">[${p.sku || '---'}]</b> ${p.name} | <small>${p.peso || 0}g</small></span>
                            </div>
                            <button class="text-blue-400" onclick="editarProduto('${p.key}')">‚úé</button>
                        </div>
                    `).join('');
                    lista.innerHTML += `<div class="mb-4"><b class="text-xs uppercase text-[#caa85c] ml-2">${cat.val().name}</b><div class="mt-2">${htmlP}</div></div>`;
                }
            });
        });
    });
}

function editarProduto(id) {
  db.ref('products/' + id).once('value', s => {
    const p = s.val(); if (!p) return;
    const nNome  = prompt("Nome do Produto:", p.name);
    const nPreco = prompt("Pre√ßo (ex: 59.90):", p.price);
    const nSku   = prompt("SKU:", p.sku);
    const nPeso  = prompt("Peso em Gramas (ex: 1.5):", p.peso || 0);

    if (nNome !== null) {
      db.ref('products/' + id).update({
        name: nNome, 
        price: parseFloat(nPreco) || 0, 
        sku: nSku || '',
        peso: parseFloat(nPeso) || 0
      }).then(carregarProdutos);
    }
  });
}

/* CATEGORIAS */
function carregarCategorias() {
  const lista = document.getElementById('listaCategorias');
  db.ref('categories').once('value', s => {
    lista.innerHTML = '';
    s.forEach(child => {
      lista.innerHTML += `
        <div class="card flex justify-between items-center mb-1">
          <b class="uppercase text-xs">${child.val().name}</b>
          <button class="btn text-blue-400" onclick="editarCategoria('${child.key}', '${child.val().name}')">‚úé</button>
        </div>`;
    });
  });
}

function editarCategoria(id, nome) {
  const n = prompt("Novo nome da categoria:", nome);
  if (n) db.ref('categories/'+id).update({name:n}).then(carregarCategorias);
}

function novaCategoria() {
    const n = document.getElementById('newCatName').value;
    if(n) db.ref('categories').push({name:n}).then(() => { document.getElementById('newCatName').value=''; carregarCategorias(); });
}

/* PEDIDOS (AQUI FOI CORRIGIDO O RECEBIMENTO) */
let pedidoEditando = null;
function carregarPedidos() {
  const lista = document.getElementById('listaPedidos');
  lista.innerHTML = '<p class="text-center py-10">Sincronizando pedidos...</p>';
  
  db.ref('orders').on('value', s => {
    lista.innerHTML = '';
    if(!s.exists()) {
        lista.innerHTML = '<p class="text-center text-gray-500 py-10">Nenhum pedido no banco de dados.</p>';
        return;
    }
    s.forEach(ped => {
      const p = ped.val();
      // Compatibilidade: Pega nome do cliente independente de como foi salvo
      const nomeCliente = p.cliente?.nome || p.cliente || 'Cliente s/ Nome';
      const dataPedido = p.data || 'Data n√£o registrada';

      lista.innerHTML += `
        <div class="card border-l-4 border-[#caa85c] flex justify-between items-center bg-[#111] mb-2">
          <div class="flex-1">
            <b class="text-[#caa85c] uppercase text-xs">${nomeCliente}</b>
            <br><small class="text-[10px] text-gray-500">${dataPedido}</small>
          </div>
          <div class="flex gap-2">
            <button class="btn-gold text-[10px] py-1 px-3" onclick="abrirEditorPedido('${ped.key}')">EDITAR</button>
            <button class="btn bg-red-900 border-red-700 text-white text-[10px] py-1 px-3" onclick="deletarPedido('${ped.key}')">üóëÔ∏è</button>
          </div>
        </div>`;
    });
  });
}
    
function deletarPedido(id) {
  if (confirm("Excluir este pedido permanentemente?")) {
     db.ref('orders/' + id).remove();
  }
}

function abrirEditorPedido(id){
  db.ref('orders/'+id).once('value',s=>{
    const p=s.val(); if(!p) return;
    pedidoEditando = id;
    
    document.getElementById('edClienteNome').value = p.cliente?.nome || p.cliente || '';
    document.getElementById('edClienteTel').value  = p.cliente?.telefone || p.whatsapp || '';
    document.getElementById('edRua').value = p.entrega?.rua || p.endereco?.rua || '';
    document.getElementById('edNum').value = p.entrega?.num || p.endereco?.num || '';
    document.getElementById('edBairro').value = p.entrega?.bairro || p.endereco?.bairro || '';
    document.getElementById('edCidade').value = p.entrega?.cidade || p.endereco?.cidade || '';
    document.getElementById('edDescPromo').value = p.descontoPromo || 0;
    document.getElementById('edDescPix').value   = p.descontoPix || 0;
    document.getElementById('edPesoTotalMostrador').value = p.pesoTotal || 0;
    
    document.getElementById('edItens').innerHTML='';
    const itens = Array.isArray(p.itens) ? p.itens : Object.values(p.itens || {});
    itens.forEach(i => addItemEditor(i));
    document.getElementById('editorPedido').classList.remove('hidden');
  });
}

function addItemEditor(i={}){
  const div = document.createElement('div');
  div.className = "card bg-black/40 border-[#222] mb-2";
  div.innerHTML = `
    <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
        <div><label class="text-[8px] text-gray-500 uppercase">SKU</label><input placeholder="SKU" value="${i.sku||''}"></div>
        <div><label class="text-[8px] text-gray-500 uppercase">Produto</label><input placeholder="Nome" value="${i.name||''}"></div>
        <div><label class="text-[8px] text-gray-500 uppercase">Peso (g)</label><input type="number" placeholder="Peso" class="val-peso" value="${i.peso||i.weight||0}"></div>
        <div><label class="text-[8px] text-gray-500 uppercase">Pre√ßo</label><input type="number" placeholder="Pre√ßo" value="${i.price||i.precoFinal||0}"></div>
        <div><label class="text-[8px] text-gray-500 uppercase">Qtd</label><input type="number" placeholder="Qtd" class="val-qtd" value="${i.quantidade||i.qtd||1}"></div>
    </div>
    <button class="text-red-500 text-[10px] uppercase font-bold mt-1" onclick="this.parentElement.remove()">Remover Item</button>`;
  document.getElementById('edItens').appendChild(div);
}

function adicionarItemEditor() { addItemEditor(); }
function fecharEditorPedido() { document.getElementById('editorPedido').classList.add('hidden'); }

function salvarPedidoEditado(){
  const itens=[]; let totalBruto=0, pesoAcumulado=0;
  
  document.querySelectorAll('#edItens .card').forEach(c=>{
    const ins = c.querySelectorAll('input');
    const pso = parseFloat(ins[2].value) || 0;
    const prc = parseFloat(ins[3].value) || 0;
    const qtd = parseInt(ins[4].value) || 0;
    
    const i={ 
        sku: ins[0].value, 
        name: ins[1].value, 
        peso: pso, 
        price: prc, 
        quantidade: qtd 
    };
    
    totalBruto += (prc * qtd); 
    pesoAcumulado += (pso * qtd);
    itens.push(i);
  });

  const dp = parseFloat(document.getElementById('edDescPromo').value) || 0;
  const dx = parseFloat(document.getElementById('edDescPix').value) || 0;

  db.ref('orders/'+pedidoEditando).update({
    cliente: { 
        nome: document.getElementById('edClienteNome').value, 
        telefone: document.getElementById('edClienteTel').value 
    },
    entrega: { 
        rua: document.getElementById('edRua').value, 
        num: document.getElementById('edNum').value, 
        bairro: document.getElementById('edBairro').value, 
        cidade: document.getElementById('edCidade').value 
    },
    itens, 
    pesoTotal: pesoAcumulado, 
    descontoPromo: dp, 
    descontoPix: dx, 
    total: (totalBruto - dp - dx),
    ajustadoManualmente: true
  }).then(()=>{ 
      alert("Pedido atualizado com sucesso!"); 
      fecharEditorPedido(); 
  });
}

/* ROMANEIO (CORRIGIDO PARA MOSTRAR PESO) */
function gerarRomaneio(id, tipo = 1) {
  db.ref('orders/' + id).once('value', s => {
    const p = s.val(); if (!p) return;
    db.ref('settings/empresa').once('value', e => {
      const emp = e.val() || {};
      let html = `<style>
        .print-body { font-family: sans-serif; color:#000; padding:20px; }
        .lux-head { text-align:center; border-bottom:2px solid #A68966; padding-bottom:10px; margin-bottom:15px; }
        .grid-dados { display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:15px; font-size:12px; }
        table { width:100%; border-collapse:collapse; font-size:11px; }
        table th { background:#f5f5f5; text-align:left; border-bottom:1px solid #000; padding:6px; }
        table td { border-bottom:1px solid #ddd; padding:6px; }
        .totais { text-align:right; margin-top:20px; font-size:13px; line-height:1.6; }
        .img-mini { width:50px; height:50px; object-fit:cover; border-radius:4px; }
      </style>
      <div class="print-body">
        <div class="lux-head"><h1>${emp.nome || 'Abella Joias'}</h1><p>${emp.subtitulo || ''}<br>WhatsApp: ${emp.whats || ''}</p></div>
        <div class="grid-dados">
          <div><b>CLIENTE:</b> ${p.cliente?.nome || p.cliente || ''}<br>Whats: ${p.cliente?.telefone || p.whatsapp || ''}</div>
          <div><b>ENTREGA:</b> ${p.entrega?.rua || ''}, ${p.entrega?.num || ''}<br>${p.entrega?.bairro || ''} - ${p.entrega?.cidade || ''}</div>
        </div>
        <table><thead><tr>
          ${tipo === 3 ? '<th>Foto</th>' : ''}
          <th>SKU</th><th>Produto</th>
          ${tipo > 1 ? '<th>Peso Unit.</th><th>Pre√ßo</th>' : ''}
          <th>Qtd</th>
          ${tipo > 1 ? '<th>Subtotal</th>' : ''}
        </tr></thead><tbody>`;

      let subtotalCalc = 0;
      const itensArr = Array.isArray(p.itens) ? p.itens : Object.values(p.itens || {});
      itensArr.forEach(i => {
        const preco = parseFloat(i.price || i.precoFinal || 0);
        const qtd = parseInt(i.quantidade || i.qtd || 1);
        const sub = preco * qtd;
        subtotalCalc += sub;
        html += `<tr>
          ${tipo === 3 ? `<td><img src="${i.image || ''}" class="img-mini"></td>` : ''}
          <td>${i.sku || '---'}</td><td>${i.name || ''}</td>
          ${tipo > 1 ? `<td>${(i.peso||0)}g</td><td>${fMoeda(preco)}</td>` : ''}
          <td>${qtd}</td>
          ${tipo > 1 ? `<td>${fMoeda(sub)}</td>` : ''}
        </tr>`;
      });

      html += `</tbody></table>`;
      if (tipo > 1) {
        html += `<div class="totais">
          Subtotal Itens: ${fMoeda(subtotalCalc)}<br>
          Descontos Totais: - ${fMoeda((p.descontoPromo||0) + (p.descontoPix||0))}<br>
          <b>PESO TOTAL: ${p.pesoTotal || 0}g</b><br>
          <b style="font-size:18px; color:#A68966">VALOR TOTAL: ${fMoeda(p.total)}</b>
        </div>`;
      } else {
          html += `<div class="totais"><b>PESO TOTAL: ${p.pesoTotal || 0}g</b></div>`;
      }
      html += `</div>`;
      document.getElementById('print-area').innerHTML = html;
      setTimeout(() => { window.print(); }, 500);
    });
  });
}

/* CONFIGURA√á√ïES EMPRESA */
function carregarEmpresaSeExistir() {
  db.ref('settings/empresa').once('value', s => {
    const v = s.val(); if (!v) return;
    document.getElementById('empNome').value = v.nome || '';
    document.getElementById('empSub').value = v.subtitulo || '';
    document.getElementById('empWhats').value = v.whats || '';
    document.getElementById('empDesc').value = v.descontoPix || 0;
    document.getElementById('empParc').value = v.parcelas || 0;
  });
}

function salvarEmpresa() {
  db.ref('settings/empresa').update({
    nome: document.getElementById('empNome').value,
    subtitulo: document.getElementById('empSub').value,
    whats: document.getElementById('empWhats').value,
    descontoPix: parseFloat(document.getElementById('empDesc').value) || 0,
    parcelas: parseInt(document.getElementById('empParc').value) || 0
  }).then(() => alert('Empresa Atualizada!'));
}

/* MODAL E PROMO√á√ïES */
function abrirModal(titulo, conteudo, acaoSalvar) {
    document.getElementById('modalTitle').innerText = titulo;
    document.getElementById('modalBody').innerHTML = conteudo;
    document.getElementById('mainModal').classList.add('active');
    document.getElementById('modalSaveBtn').onclick = acaoSalvar;
}
function fecharModal() { document.getElementById('mainModal').classList.remove('active'); }

async function abrirPainelPromocoes() {
    const [snapPromo, snapCats] = await Promise.all([
        db.ref('settings/promocao').once('value'),
        db.ref('categories').once('value')
    ]);
    const promo = snapPromo.val() || { ativa: false, label: 'OFF', colorBg: '#ff0000', colorText: '#ffffff', porcentagemGeral: 0 };
    let listaCats = '';
    snapCats.forEach(cat => {
        const c = cat.val();
        listaCats += `<div class="flex justify-between items-center bg-[#0d0d0d] p-2 rounded mb-1 border border-[#222]">
            <span class="text-[10px] uppercase font-bold text-gray-300">${c.name}</span>
            <input type="number" id="promo_cat_${cat.key}" value="${c.promoPct || 0}" class="w-16 text-center !p-1 text-xs bg-black border border-[#333] rounded">
        </div>`;
    });

    const html = `<div class="space-y-4">
        <div class="flex justify-between items-center p-3 bg-[#1a1a1a] rounded-xl border border-[#333]">
            <label class="text-[10px] text-[#caa85c] font-bold uppercase">Status</label>
            <button onclick="togglePromoStatus()" id="btnStatusPromo" class="px-4 py-1 rounded-full text-[10px] font-bold ${promo.ativa ? 'bg-green-600' : 'bg-red-600'}">
                ${promo.ativa ? 'ATIVA' : 'INATIVA'}
            </button>
        </div>
        <div class="grid grid-cols-2 gap-2">
            <input id="promoLabel" value="${promo.label}" placeholder="Etiqueta (Ex: OFF)">
            <input type="number" id="promoGeral" value="${promo.porcentagemGeral}" placeholder="Desc Geral %">
        </div>
        <div class="grid grid-cols-2 gap-2">
            <label class="text-[9px] text-center">Fundo <input type="color" id="promoBg" value="${promo.colorBg}" class="h-8"></label>
            <label class="text-[9px] text-center">Texto <input type="color" id="promoTxt" value="${promo.colorText}" class="h-8"></label>
        </div>
        <div class="max-h-40 overflow-y-auto custom-scroll">${listaCats}</div>
    </div>`;

    abrirModal('Promo√ß√µes e Etiquetas', html, () => {
        const updates = {};
        updates['settings/promocao/ativa'] = document.getElementById('btnStatusPromo').innerText === 'ATIVA';
        updates['settings/promocao/label'] = document.getElementById('promoLabel').value.toUpperCase();
        updates['settings/promocao/porcentagemGeral'] = parseInt(document.getElementById('promoGeral').value) || 0;
        updates['settings/promocao/colorBg'] = document.getElementById('promoBg').value;
        updates['settings/promocao/colorText'] = document.getElementById('promoTxt').value;
        snapCats.forEach(cat => {
            updates['categories/' + cat.key + '/promoPct'] = parseInt(document.getElementById('promo_cat_'+cat.key).value) || 0;
        });
        db.ref().update(updates).then(() => { alert("Atualizado!"); fecharModal(); });
    });
}

function togglePromoStatus() {
    const btn = document.getElementById('btnStatusPromo');
    const isAtiva = btn.innerText === 'ATIVA';
    btn.innerText = isAtiva ? 'INATIVA' : 'ATIVA';
    btn.className = `px-4 py-1 rounded-full text-[10px] font-bold ${isAtiva ? 'bg-red-600' : 'bg-green-600'}`;
}

window.addEventListener('DOMContentLoaded', () => { showTab('empresa', document.querySelector('nav button')); });
</script>
</body>
</html>

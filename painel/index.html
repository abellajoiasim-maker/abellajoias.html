<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Administrativo • Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#0b0b0b;color:#eee;font-family:Inter,Arial;margin:0}
nav button.active{border-bottom:2px solid #caa85c;color:#caa85c}
section{display:none}
section.active{display:block}
.card{background:#141414;border:1px solid #2a2a2a;border-radius:16px;padding:14px}
.btn{background:#222;border:1px solid #444;padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer}
.btn-gold{background:#caa85c;color:#000;font-weight:700;padding:10px;border-radius:8px}
input{background:#111;border:1px solid #333;padding:8px;border-radius:8px;width:100%;margin-bottom:8px;color:#fff}
#print-area{display:none}
@media print{
body *{visibility:hidden}
#print-area,#print-area *{visibility:visible}
#print-area{position:absolute;left:0;top:0;width:100%;background:#fff;color:#000}
}
</style>
</head>

<body>

<header class="p-5 text-center font-bold bg-black border-b border-[#222] text-[#caa85c] uppercase">
Abella Joias • Painel
</header>

<nav class="flex gap-2 p-2 bg-[#111] sticky top-0 z-50 overflow-x-auto">
<button class="btn active" onclick="showTab('empresa',this)">Empresa</button>
<button class="btn" onclick="showTab('categorias',this)">Categorias</button>
<button class="btn" onclick="showTab('produtos',this)">Produtos</button>
<button class="btn" onclick="showTab('promocoes',this)">Promoções</button>
<button class="btn" onclick="showTab('pedidos',this)">Pedidos</button>
</nav>

<main class="p-6 max-w-4xl mx-auto">

<section id="empresa" class="active">
<div class="card space-y-3">
<input id="empNome" placeholder="Nome da Empresa">
<input id="empSub" placeholder="Slogan">
<input id="empWhats" placeholder="WhatsApp">
<div class="grid grid-cols-2 gap-2">
<input id="empDesc" type="number" placeholder="Desc. Pix %">
<input id="empParc" type="number" placeholder="Parcelas">
</div>
<button class="btn-gold w-full" onclick="salvarEmpresa()">SALVAR</button>
</div>
</section>

<section id="categorias">
<div class="card mb-4">
<input id="newCatName" placeholder="Nova Categoria">
<button class="btn-gold w-full" onclick="novaCategoria()">Cadastrar</button>
</div>
<div id="listaCategorias"></div>
</section>

<section id="produtos">
<div id="listaProdutos"></div>
</section>

<section id="promocoes">
<div class="card text-center">
<button class="btn-gold w-full" onclick="abrirPainelPromocoes()">Configurar Promoções</button>
</div>
</section>

<section id="pedidos">
<div id="listaPedidos"></div>
</section>

</main>

<div id="editorPedido" class="hidden fixed inset-0 bg-black/80 z-50 p-4 flex items-center justify-center">
<div class="bg-[#111] w-full max-w-4xl p-5 rounded-xl overflow-auto max-h-[90vh]">

<h2 class="text-[#caa85c] font-bold mb-3 uppercase">Editar Pedido</h2>

<input id="edClienteNome" placeholder="Cliente">
<input id="edClienteTel" placeholder="WhatsApp">

<div id="edItens"></div>
<button class="btn w-full" onclick="adicionarItemEditor()">+ Item</button>

<div class="grid grid-cols-2 gap-2 mt-2">
<input id="edDescPromo" type="number" placeholder="Desc Promo">
<input id="edDescPix" type="number" placeholder="Desc Pix">
</div>

<div class="flex justify-between mt-4">
<button class="btn" onclick="fecharEditorPedido()">Cancelar</button>
<div class="flex gap-2">
<button class="btn" onclick="gerarRomaneio(pedidoEditando,1)">Romaneio 1</button>
<button class="btn" onclick="gerarRomaneio(pedidoEditando,2)">Romaneio 2</button>
<button class="btn-gold" onclick="salvarPedidoEditado()">Salvar</button>
</div>
</div>

</div>
</div>

<div id="print-area"></div>

<script>
if(!firebase.apps.length){
firebase.initializeApp({
apiKey:"AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
databaseURL:"https://catalogo-abella-joias-default-rtdb.firebaseio.com"
});
}
const db=firebase.database();
const fM=v=>new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0);

function showTab(id,btn){
document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
document.getElementById(id).classList.add('active');
btn.classList.add('active');
if(id==='pedidos')carregarPedidos();
if(id==='empresa')carregarEmpresa();
if(id==='categorias')carregarCategorias();
if(id==='produtos')carregarProdutos();
}

function carregarEmpresa(){
db.ref('settings/empresa').once('value',s=>{
const v=s.val()||{};
empNome.value=v.nome||'';
empSub.value=v.subtitulo||'';
empWhats.value=v.whats||'';
empDesc.value=v.descontoPix||0;
empParc.value=v.parcelas||0;
});
}

function salvarEmpresa(){
db.ref('settings/empresa').set({
nome:empNome.value,
subtitulo:empSub.value,
whats:empWhats.value,
descontoPix:+empDesc.value||0,
parcelas:+empParc.value||0
});
alert('Salvo');
}

function carregarPedidos(){
db.ref('orders').on('value',s=>{
listaPedidos.innerHTML='';
s.forEach(p=>{
const o=p.val();
listaPedidos.innerHTML+=`
<div class="card mb-2">
<b>${o.cliente?.nome||''}</b>
<button class="btn-gold float-right" onclick="abrirEditorPedido('${p.key}')">Editar</button>
</div>`;
});
});
}

let pedidoEditando=null;

function abrirEditorPedido(id){
db.ref('orders/'+id).once('value',s=>{
const p=s.val();if(!p)return;
pedidoEditando=id;
edClienteNome.value=p.cliente?.nome||'';
edClienteTel.value=p.cliente?.telefone||'';
edDescPromo.value=p.descontoPromo||0;
edDescPix.value=p.descontoPix||0;
edItens.innerHTML='';
(p.itens||[]).forEach(i=>addItemEditor(i));
editorPedido.classList.remove('hidden');
});
}

function addItemEditor(i={}){
const d=document.createElement('div');
d.className='card mb-2';
d.innerHTML=`
<input placeholder="Nome" value="${i.name||''}">
<input type="number" placeholder="Peso" value="${i.peso||0}">
<input type="number" placeholder="Preço" value="${i.price||0}">
<input type="number" placeholder="Qtd" value="${i.quantidade||1}">
<button class="btn text-red-500" onclick="this.parentElement.remove()">Remover</button>`;
edItens.appendChild(d);
}

function adicionarItemEditor(){addItemEditor();}

function fecharEditorPedido(){editorPedido.classList.add('hidden');}

function salvarPedidoEditado(){
let itens=[],total=0,peso=0;
document.querySelectorAll('#edItens .card').forEach(c=>{
const i=c.querySelectorAll('input');
const it={
name:i[0].value,
peso:+i[1].value||0,
price:+i[2].value||0,
quantidade:+i[3].value||1
};
total+=it.price*it.quantidade;
peso+=it.peso*it.quantidade;
itens.push(it);
});
const dp=+edDescPromo.value||0;
const dx=+edDescPix.value||0;
db.ref('orders/'+pedidoEditando).update({
itens,
pesoTotal:peso,
descontoPromo:dp,
descontoPix:dx,
total:total-dp-dx,
ajustadoManualmente:true
});
alert('Salvo');
fecharEditorPedido();
}

function gerarRomaneio(id,tipo){
db.ref('orders/'+id).once('value',s=>{
const p=s.val();if(!p)return;
let peso=Number(p.pesoTotal||0);
let pesoFmt=peso>=1000?(peso/1000).toFixed(3)+' kg':peso+' g';
print-area.innerHTML=`
<h2>Romaneio</h2>
Cliente: ${p.cliente?.nome||''}<br>
Peso Total: ${pesoFmt}<br>
Total: ${fM(p.total)}
`;
setTimeout(()=>window.print(),300);
});
}

window.onload=()=>showTab('empresa',document.querySelector('nav button'));
</script>

</body>
</html>

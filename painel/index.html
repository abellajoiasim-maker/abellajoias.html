<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Recuperação | Abella Joias</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-800 text-white p-4">

    <div class="max-w-xl mx-auto">
        <h1 class="text-xl font-bold text-center mb-6 text-yellow-500">ABELLA - MODO DE SEGURANÇA</h1>
        
        <div class="grid grid-cols-2 gap-2 mb-6">
            <button onclick="carregarLista('products')" class="bg-blue-600 p-4 rounded font-bold uppercase text-xs">Baixar Produtos</button>
            <button onclick="carregarLista('categories')" class="bg-green-600 p-4 rounded font-bold uppercase text-xs">Baixar Categorias</button>
        </div>

        <div class="bg-white text-black p-4 rounded-xl mb-6 shadow-2xl">
            <h2 class="font-bold mb-2">Editar/Criar</h2>
            <input id="fPath" type="hidden">
            <input id="fId" placeholder="ID (ou SKU)" class="w-full border p-2 mb-2">
            <textarea id="fJson" placeholder="Cole aqui o JSON ou preencha os campos abaixo" class="hidden"></textarea>
            
            <div id="campos">
                <input id="fNome" placeholder="Nome" class="w-full border p-2 mb-2">
                <input id="fPreco" placeholder="Preço" type="number" step="0.01" class="w-full border p-2 mb-2">
                <input id="fImg" placeholder="Link Imagem" class="w-full border p-2 mb-2">
            </div>

            <button onclick="salvar()" class="w-full bg-yellow-500 p-3 rounded font-bold uppercase">Salvar no Banco</button>
        </div>

        <div id="resultado" class="space-y-2">
            <p class="text-center text-gray-400">Clique em um botão acima para carregar os dados.</p>
        </div>
    </div>

<script>
const firebaseConfig = { apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY", databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Função para carregar dados apenas quando solicitado
function carregarLista(path) {
    const res = document.getElementById('resultado');
    res.innerHTML = "Buscando dados... aguarde.";
    
    db.ref(path).once('value').then(s => {
        res.innerHTML = "";
        if(!s.exists()) { res.innerHTML = "Nenhum dado encontrado."; return; }
        
        s.forEach(item => {
            const v = item.val();
            const id = item.key;
            res.innerHTML += `
                <div class="bg-gray-700 p-3 rounded flex justify-between items-center border-l-4 ${v.image ? 'border-green-500' : 'border-red-500'}">
                    <div>
                        <p class="text-xs font-bold">${v.name || 'Sem nome'}</p>
                        <p class="text-[10px] text-gray-400">${id}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="preencher('${path}', '${id}')" class="bg-blue-500 px-3 py-1 rounded text-[10px]">EDITAR</button>
                        <button onclick="apagar('${path}/${id}')" class="bg-red-500 px-3 py-1 rounded text-[10px]">X</button>
                    </div>
                </div>`;
        });
    }).catch(e => { alert("Erro ao carregar: " + e.message); });
}

function preencher(path, id) {
    db.ref(path + '/' + id).once('value').then(s => {
        const v = s.val();
        document.getElementById('fPath').value = path;
        document.getElementById('fId').value = id;
        document.getElementById('fNome').value = v.name || '';
        document.getElementById('fPreco').value = v.price || '';
        document.getElementById('fImg').value = v.image || '';
        window.scrollTo(0,0);
    });
}

function salvar() {
    const path = document.getElementById('fPath').value || 'products';
    const id = document.getElementById('fId').value.replace(/[^a-zA-Z0-9]/g, "-");
    
    if(!id) { alert("ID/SKU é obrigatório!"); return; }

    const dados = {
        name: document.getElementById('fNome').value,
        price: Number(document.getElementById('fPreco').value),
        image: document.getElementById('fImg').value,
        sku: document.getElementById('fId').value
    };

    db.ref(path + '/' + id).update(dados).then(() => {
        alert("Sucesso!");
        location.reload();
    });
}

function apagar(path) {
    if(confirm("Excluir?")) {
        db.ref(path).remove().then(() => location.reload());
    }
}
</script>
</body>
</html>

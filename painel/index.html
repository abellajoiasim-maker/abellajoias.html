<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel Admin ‚Ä¢ Abella Joias</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <style>
        body{background:#0b0b0b;color:#eee;font-family:Inter,Arial}
        nav button.active{border-color:#caa85c;color:#caa85c}
        section{display:none}
        section.active{display:block}
        .card{background:#141414;border:1px solid #2a2a2a;border-radius:16px;padding:14px}
        .grid{display:grid;gap:12px}
        @media(min-width:768px){.grid{grid-template-columns:repeat(4,1fr)}}
        @media(min-width:1200px){.grid{grid-template-columns:repeat(6,1fr)}}
        .btn{background:#222;border:1px solid #444;padding:6px 10px;border-radius:8px;font-size:12px;cursor:pointer}
        .btn-gold{background:#caa85c;color:#000;font-weight:700}
        .btn-red{border-color:#c33;color:#f77}
        .btn-pause{border-color:#caa85c;color:#caa85c}
        .tag{font-size:10px;padding:3px 6px;border-radius:999px}
        .ok{background:#1f3;color:#000}
        .no{background:#c33}
        #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:100;align-items:center;justify-content:center}
        .modal-box{background:#141414;border:1px solid #333;border-radius:20px;width:100%;max-width:520px;padding:20px;max-height:90vh;overflow-y:auto}
        .modal-img{height:180px;object-fit:contain;background:#000;border-radius:12px;margin-bottom:12px;width:100%}
        input,select{background:#111;border:1px solid #333;padding:8px;border-radius:8px;width:100%;margin-bottom:8px;color:#fff}
        
        @media print {
            body * { visibility: hidden; }
            #romaneio-print, #romaneio-print * { visibility: visible; }
            #romaneio-print { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>

<body>

<header class="p-5 text-center text-xl font-bold bg-black border-b border-[#222]">
    Painel Administrativo ‚Ä¢ Abella Joias
</header>

<nav class="flex gap-2 p-2 bg-[#111] overflow-x-auto">
    <button class="btn active" onclick="showTab('empresa',this)">Empresa</button>
    <button class="btn" onclick="showTab('categorias',this)">Categorias</button>
    <button class="btn" onclick="showTab('produtos',this)">Produtos</button>
    <button class="btn" onclick="showTab('promocoes',this)">Promo√ß√µes</button>
    <button class="btn" onclick="showTab('pedidos',this)">Pedidos</button>
</nav>

<main class="p-6">
    <section id="empresa" class="active">
        <div class="card max-w-md mx-auto">
            <label class="text-[10px] uppercase opacity-50">Nome da Loja</label>
            <input id="empNome">
            <label class="text-[10px] uppercase opacity-50">WhatsApp</label>
            <input id="empWhats">
            <label class="text-[10px] uppercase opacity-50">Desconto PIX %</label>
            <input id="empPix" type="number">
            <label class="text-[10px] uppercase opacity-50">M√°ximo de Parcelas</label>
            <input id="empParc" type="number">
            <button class="btn-gold w-full mt-2 py-3 rounded-xl" onclick="salvarEmpresa()">Salvar Configura√ß√µes</button>
        </div>
    </section>

    <section id="categorias">
        <button class="btn-gold mb-3" onclick="novaCategoria()">+ Nova Categoria</button>
        <div id="listaCategorias" class="grid"></div>
    </section>

    <section id="produtos">
        <div id="produtosPorCategoria"></div>
    </section>

    <section id="promocoes">
        <div id="listaPromocoes" class="space-y-3 max-w-md mx-auto"></div>
        <button class="btn-gold mt-4 w-full py-3" onclick="salvarPromos()">Aplicar promo√ß√µes</button>
    </section>

    <section id="pedidos">
        <div id="listaPedidos" class="space-y-3"></div>
    </section>
</main>

<div id="modal">
    <div class="modal-box">
        <h3 id="modalTitle" class="font-bold mb-4 text-[#caa85c] border-b border-[#333] pb-2"></h3>
        <div id="modalBody"></div>
        <div class="flex gap-2 mt-4">
            <button class="btn-gold flex-1 py-2" id="btnSalvar">Salvar Altera√ß√µes</button>
            <button class="btn flex-1 py-2" onclick="fecharModal()">Fechar</button>
        </div>
    </div>
</div>

<script>
firebase.initializeApp({
    apiKey:"AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
    authDomain:"catalogo-abella-joias.firebaseapp.com",
    databaseURL:"https://catalogo-abella-joias-default-rtdb.firebaseio.com",
    projectId:"catalogo-abella-joias"
});
const db = firebase.database();

/* UTILS */
function showTab(id,btn){
    document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
}

function abrirModal(t, b, cb) {
    document.getElementById('modal').style.display = 'flex';
    document.getElementById('modalTitle').innerText = t;
    document.getElementById('modalBody').innerHTML = b;
    const btnS = document.getElementById('btnSalvar');
    if (cb) {
        btnS.style.display = 'block';
        btnS.onclick = () => { cb(); fecharModal(); };
    } else {
        btnS.style.display = 'none';
    }
}
function fecharModal() { document.getElementById('modal').style.display = 'none'; }
function excluir(p, id) { if (confirm('Excluir permanentemente?')) db.ref(p + '/' + id).remove(); }
function togglePause(p, id) { db.ref(p + '/' + id + '/paused').transaction(v => !v); }

/* EMPRESA */
db.ref('settings').on('value',s=>{
    const v=s.val()||{};
    document.getElementById('empNome').value=v.nome||'';
    document.getElementById('empWhats').value=v.whatsapp||'';
    document.getElementById('empPix').value=v.pix||0;
    document.getElementById('empParc').value=v.parcelas||1;
});
function salvarEmpresa(){
    db.ref('settings').update({
        nome: empNome.value,
        whatsapp: empWhats.value,
        pix: +empPix.value,
        parcelas: +empParc.value
    });
    alert('Configura√ß√µes salvas!');
}

/* CATEGORIAS & PRODUTOS (L√≥gica que voc√™ j√° tinha) */
db.ref('categories').on('value',s=>{
    const listaCategorias = document.getElementById('listaCategorias');
    const listaPromocoes = document.getElementById('listaPromocoes');
    listaCategorias.innerHTML=''; listaPromocoes.innerHTML='';
    s.forEach(c=>{
        const d=c.val();
        listaCategorias.innerHTML+=`<div class="card"><b>${d.name}</b><div class="flex gap-1 mt-2"><button class="btn" onclick="editarCategoria('${c.key}')">Editar</button><button class="btn btn-red" onclick="excluir('categories','${c.key}')">Excluir</button></div></div>`;
        listaPromocoes.innerHTML+=`<div class="card flex justify-between items-center"><span>${d.name}</span><input type="number" id="promo-${c.key}" value="${d.discount||0}" class="w-20 mb-0"></div>`;
    });
});

db.ref('products').on('value',s=>{
    const container = document.getElementById('produtosPorCategoria');
    container.innerHTML='';
    const map={};
    s.forEach(p=>{
        const v=p.val(); v.id=p.key;
        if(!map[v.category]) map[v.category]=[];
        map[v.category].push(v);
    });
    Object.keys(map).forEach(cat=>{
        container.innerHTML+=`<h3 class="text-[#caa85c] mt-6 mb-2 uppercase text-xs font-bold tracking-widest">${cat}</h3><div class="grid" id="grid-${cat}"></div>`;
        const g = document.getElementById(`grid-${cat}`);
        map[cat].forEach(p=>{
            g.innerHTML+=`<div class="card"><div class="text-[10px] opacity-50">${p.sku||'---'}</div><div class="text-xs font-bold">${p.name}</div><div class="flex gap-1 mt-2"><button class="btn" onclick="editarProduto('${p.id}')">Editar</button><button class="btn btn-red" onclick="excluir('products','${p.id}')">Excluir</button></div></div>`;
        });
    });
});

/* FUN√á√ÉO EDITAR PRODUTO */
function editarProduto(id){
    db.ref('products/'+id).once('value').then(s=>{
        const p = s.val();
        db.ref('categories/'+p.category+'/variacoes').once('value').then(vs=>{
            let opts = '<option value="">Sem varia√ß√£o</option>';
            if(vs.exists()) vs.forEach(c => { opts += `<option value="${c.key}" ${p.variacao===c.key?'selected':''}>${c.val().label||c.key}</option>`; });
            abrirModal('Editar Produto', `
                <input id="pName" value="${p.name}" placeholder="Nome">
                <input id="pSku" value="${p.sku}" placeholder="SKU">
                <input id="pPrice" type="number" step="0.01" value="${p.price}" placeholder="Pre√ßo">
                <input id="pWeight" value="${p.weight}" placeholder="Peso (g)">
                <select id="pVar">${opts}</select>
                <input id="pImg" value="${p.image}" placeholder="URL Imagem">
            `, () => {
                db.ref('products/'+id).update({
                    name: pName.value, sku: pSku.value, price: pPrice.value, weight: pWeight.value, variacao: pVar.value, image: pImg.value
                });
            });
        });
    });
}

/* === GEST√ÉO DE PEDIDOS (VERS√ÉO FINAL ORGANIZADA) === */

db.ref('orders').on('value', s => {
    const lista = document.getElementById('listaPedidos');
    lista.innerHTML = '';
    if (!s.exists()) return;
    s.forEach(o => {
        const p = o.val();
        lista.innerHTML += `
        <div class="card flex justify-between items-center mb-2">
            <div>
                <div class="text-[10px] opacity-40">${o.key}</div>
                <div class="font-bold text-[#caa85c]">${p.cliente}</div>
                <div class="text-xs">R$ ${parseFloat(p.total||0).toFixed(2)}</div>
            </div>
            <div class="flex gap-1">
                <button class="btn btn-gold" onclick="verDetalhesPedido('${o.key}')">Ver</button>
                <button class="btn" onclick="editarPedido('${o.key}')">Editar</button>
                <button class="btn btn-red" onclick="excluir('orders','${o.key}')">‚úï</button>
            </div>
        </div>`;
    });
});

function verDetalhesPedido(id) {
    db.ref('orders/' + id).once('value').then(s => {
        const p = s.val();
        const e = p.endereco_detalhado || {};
        let itensHtml = '';
        Object.values(p.itens||{}).forEach(i => {
            itensHtml += `<div class="flex justify-between text-[11px] border-b border-[#222] py-1"><span>${i.qtd}x ${i.nome}</span><span>R$ ${(i.preco*i.qtd).toFixed(2)}</span></div>`;
        });
        abrirModal('Detalhes do Pedido', `
            <div class="text-[11px] space-y-2">
                <p><b>Cliente:</b> ${p.cliente} (${p.whatsapp})</p>
                <p><b>Endere√ßo:</b> ${e.rua||'N/A'}, ${e.num||''}<br>${e.bairro||''} - ${e.cidade||''}</p>
                <div class="py-2">${itensHtml}</div>
                <div class="text-lg font-bold text-green-500 text-right">Total: R$ ${parseFloat(p.total).toFixed(2)}</div>
                <div class="grid grid-cols-1 gap-2 mt-4 no-print">
                    <button onclick="gerarRomaneio('${id}','simples')" class="btn bg-gray-700">üìÑ Romaneio Simples</button>
                    <button onclick="gerarRomaneio('${id}','completo')" class="btn bg-blue-700">üñ®Ô∏è Romaneio Completo</button>
                    <button onclick="gerarRomaneio('${id}','cliente')" class="btn bg-green-700">üì∏ Romaneio Cliente (Fotos)</button>
                </div>
            </div>
        `, null);
    });
}

function editarPedido(id) {
    db.ref('orders/' + id).once('value').then(s => {
        const p = s.val();
        const e = p.endereco_detalhado || {local:'', rua:'', num:'', bairro:'', cidade:''};
        let itensEditHtml = '';
        Object.entries(p.itens || {}).forEach(([k, i]) => {
            itensEditHtml += `
            <div class="item-edit-row border-b border-[#222] py-2" data-id="${k}">
                <div class="text-[10px] text-[#caa85c]">${i.nome}</div>
                <div class="flex gap-2">
                    <input type="number" class="edit-qtd w-20 mb-0" value="${i.qtd}" oninput="recalcularTotalEdicao()" data-preco="${i.preco}">
                    <input type="text" class="opacity-40 mb-0" value="R$ ${i.preco}" readonly>
                </div>
            </div>`;
        });
        abrirModal('Editar Pedido', `
            <input id="editCli" value="${p.cliente}" placeholder="Nome Cliente">
            <input id="editEndLocal" value="${e.local}" placeholder="Local (Ex: Casa)">
            <input id="editEndRua" value="${e.rua}" placeholder="Rua">
            <input id="editEndNum" value="${e.num}" placeholder="N¬∫">
            <div id="containerItensEdit">${itensEditHtml}</div>
            <div class="mt-4 p-2 bg-black rounded">
                <label class="text-[10px] text-green-500 font-bold uppercase">Total Final</label>
                <input id="editTotal" type="number" step="0.01" value="${p.total}" class="text-xl font-bold text-green-500">
            </div>
        `, () => {
            const novosItens = {...p.itens};
            document.querySelectorAll('.item-edit-row').forEach(row => {
                const iId = row.dataset.id;
                const nQtd = parseInt(row.querySelector('.edit-qtd').value);
                if(nQtd > 0) novosItens[iId].qtd = nQtd; else delete novosItens[iId];
            });
            db.ref('orders/'+id).update({
                cliente: editCli.value,
                total: parseFloat(editTotal.value),
                itens: novosItens,
                endereco_detalhado: { local: editEndLocal.value, rua: editEndRua.value, num: editEndNum.value }
            });
        });
    });
}

function recalcularTotalEdicao() {
    let soma = 0;
    document.querySelectorAll('.item-edit-row').forEach(row => {
        const q = parseInt(row.querySelector('.edit-qtd').value) || 0;
        const p = parseFloat(row.querySelector('.edit-qtd').dataset.preco) || 0;
        soma += (q * p);
    });
    document.getElementById('editTotal').value = soma.toFixed(2);
}

function gerarRomaneio(id, tipo) {
    db.ref('orders/'+id).once('value').then(s => {
        const p = s.val();
        if(!p) return;
        const e = p.endereco_detalhado || {};
        const data = new Date().toLocaleString('pt-BR');
        
        // --- EDITE O TELEFONE DA LOJA AQUI ---
        const telefoneLoja = "(11) 98765-4321"; 
        // -------------------------------------

        db.ref('settings').once('value').then(set => {
            const config = set.val() || { parcelas: 1, pix: 0 };
            const valorTotal = parseFloat(p.total) || 0;
            const desconto = parseFloat(p.descontoPix) || 0;
            const subtotalGeral = valorTotal + desconto;

            let html = `<html><head><title>Romaneio - Abella Joias</title><style>
                @page { size: A4; margin: 1cm; }
                body { font-family: 'Segoe UI', Arial, sans-serif; color: #333; margin: 0; padding: 0; }
                
                /* Cabe√ßalho */
                .header { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid #caa85c; padding-bottom: 8px; margin-bottom: 15px; }
                .logo-area h1 { margin: 0; color: #caa85c; font-size: 22px; letter-spacing: 1px; }
                .logo-area span { font-size: 10px; color: #666; font-weight: bold; }
                .contato-loja { font-size: 10px; color: #444; margin-top: 2px; }
                
                /* Grades de Informa√ß√£o */
                .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; font-size: 10px; line-height: 1.4; }
                .info-box { padding: 8px; border: 1px solid #eee; background: #fafafa; }
                .label { font-size: 8px; color: #caa85c; font-weight: bold; text-transform: uppercase; display: block; margin-bottom: 2px; }

                /* Tabela Uniforme */
                table { width: 100%; border-collapse: collapse; table-layout: fixed; }
                th { background: #f2f2f2; padding: 7px 4px; border: 1px solid #ccc; font-size: 9px; color: #333; text-transform: uppercase; }
                
                /* TODOS OS DADOS COM TAMANHO 9PX PARA UNIFORMIDADE */
                td { 
                    padding: 6px 4px; 
                    border: 1px solid #eee; 
                    font-size: 9px; 
                    color: #444; 
                    vertical-align: middle; 
                    word-wrap: break-word; 
                }

                .col-center { text-align: center; }
                .col-right { text-align: right; }
                .sku-text { font-family: monospace; color: #777; }
                
                /* Financeiro */
                .financeiro-container { display: flex; justify-content: flex-end; margin-top: 15px; }
                .financeiro-box { width: 250px; border: 1px solid #eee; padding: 10px; background: #fff; }
                .fin-row { display: flex; justify-content: space-between; padding: 3px 0; font-size: 10px; border-bottom: 1px solid #f9f9f9; }
                .total-final { font-size: 15px; font-weight: bold; color: #000; border-top: 2px solid #caa85c; padding-top: 5px; margin-top: 5px; }

                .footer { margin-top: 30px; text-align: center; font-size: 8px; color: #bbb; border-top: 1px solid #eee; padding-top: 10px; }
            </style></head><body>
            
            <div class="header">
                <div class="logo-area">
                    <h1>ABELLA JOIAS</h1>
                    <span>ROMANEIO DE CONFER√äNCIA</span>
                    <div class="contato-loja">WhatsApp Suporte: ${telefoneLoja}</div>
                </div>
                <div style="text-align:right; font-size: 10px;">
                    <strong>PEDIDO:</strong> #${id.toUpperCase()}<br>
                    <strong>EMISS√ÉO:</strong> ${data}
                </div>
            </div>

            <div class="info-grid">
                <div class="info-box">
                    <span class="label">Dados do Cliente</span>
                    <strong>${p.cliente}</strong><br>
                    WhatsApp: ${p.whatsapp || 'N/A'}<br>
                    Pagamento: ${p.pagamento || 'A definir'}
                </div>
                <div class="info-box">
                    <span class="label">Endere√ßo de Entrega</span>
                    ${e.rua || 'Retirada local'}, ${e.num || ''}<br>
                    ${e.bairro || ''} - ${e.cidade || ''}<br>
                    <small>${e.local ? '(' + e.local + ')' : ''}</small>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="width: 70px;">SKU</th>
                        <th>DESCRI√á√ÉO</th>
                        <th style="width: 35px;">QTD</th>
                        <th style="width: 55px;">PESO U.</th>
                        <th style="width: 55px;">PESO T.</th>
                        <th style="width: 75px;">VALOR U.</th>
                        <th style="width: 80px;">SUBTOTAL</th>
                    </tr>
                </thead>
                <tbody>`;
            
            let pesoTotalGeral = 0;
            Object.values(p.itens || {}).forEach(i => {
                const qtd = parseInt(i.qtd) || 0;
                const pU = parseFloat(i.weight || i.peso || 0);
                const vU = parseFloat(i.preco || 0);
                const pT = pU * qtd;
                const vT = vU * qtd;
                pesoTotalGeral += pT;

                html += `<tr>
                    <td class="sku-text">${i.sku || '---'}</td>
                    <td>${i.nome} ${i.variacao ? '<small>('+i.variacao+')</small>' : ''}</td>
                    <td class="col-center">${qtd}</td>
                    <td class="col-center">${pU.toFixed(2)}g</td>
                    <td class="col-center">${pT.toFixed(2)}g</td>
                    <td class="col-right">R$ ${vU.toFixed(2)}</td>
                    <td class="col-right"><strong>R$ ${vT.toFixed(2)}</strong></td>
                </tr>`;
            });

            html += `</tbody></table>

            <div class="financeiro-container">
                <div class="financeiro-box">
                    <div class="fin-row"><span>Peso Total:</span> <strong>${pesoTotalGeral.toFixed(2)}g</strong></div>
                    <div class="fin-row"><span>Subtotal Itens:</span> <span>R$ ${subtotalGeral.toFixed(2)}</span></div>
                    <div class="fin-row" style="color:#27ae60;"><span>Desconto:</span> <span>- R$ ${desconto.toFixed(2)}</span></div>
                    <div class="fin-row total-final"><span>TOTAL:</span> <span>R$ ${valorTotal.toFixed(2)}</span></div>
                    <div style="font-size: 8px; margin-top: 5px; color: #888;">
                        * Parcelamento: ${config.parcelas}x de R$ ${(valorTotal/config.parcelas).toFixed(2)}
                    </div>
                </div>
            </div>

            <div class="footer">Este documento √© para confer√™ncia de mercadoria. Abella Joias agradece a prefer√™ncia.</div>
            <script>window.onload = function() { window.print(); window.close(); }<\/script>
            </body></html>`;

            const win = window.open('','_blank');
            win.document.write(html);
            win.document.close();
        });
    });
}
function salvarPromos(){
    document.querySelectorAll('[id^="promo-"]').forEach(i=>{
        db.ref('categories/'+i.id.replace('promo-','')).update({discount:+i.value});
    });
    alert('Promo√ß√µes atualizadas');
}
</script>
</body>
</html>

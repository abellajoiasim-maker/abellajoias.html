<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Administrativo • Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

/* FIREBASE CONFIG */
firebase.initializeApp({
 apiKey:"AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
 databaseURL:"https://catalogo-abella-joias-default-rtdb.firebaseio.com"
});
const db = firebase.database();

/* HELPERS */
const fMoeda = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);

/* NAVEGAÇÃO CENTRALIZADA (CORRIGE O TRAVAMENTO) */
function showTab(id, btn) {
  // 1. Esconde todas as seções 
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  // 2. Desativa todos os botões do menu [cite: 8]
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));

  // 3. Ativa o que foi clicado 
  const target = document.getElementById(id);
  if (target) {
    target.classList.add('active');
    if (btn) btn.classList.add('active');
  }

  // 4. Carrega os dados da aba [cite: 8]
  if (id === 'categorias') carregarCategorias();
  if (id === 'produtos') carregarProdutos();
  if (id === 'pedidos') carregarPedidos();
  if (id === 'promocoes') {
    document.getElementById('listaPromocoes').innerHTML = '<p class="text-center text-gray-500 mt-10">Selecione uma opção acima.</p>';
  }
}

/* EMPRESA */
function salvarEmpresa() {
  db.ref('settings/empresa').set({
    nome: document.getElementById('empNome').value,
    subtitulo: document.getElementById('empSub').value,
    whats: document.getElementById('empWhats').value,
    descontoPix: +document.getElementById('empDesc').value || 0,
    parcelas: +document.getElementById('empParc').value || 0
  }).then(() => alert('Configurações salvas!')); [cite: 8, 9]
}

function carregarEmpresaSeExistir() {
  db.ref('settings/empresa').once('value', s => {
    const v = s.val();
    if (v) {
      document.getElementById('empNome').value = v.nome || '';
      document.getElementById('empSub').value = v.subtitulo || '';
      document.getElementById('empWhats').value = v.whats || '';
      document.getElementById('empDesc').value = v.descontoPix || 0;
      document.getElementById('empParc').value = v.parcelas || 0; [cite: 79, 80]
    }
  });
}

/* CATEGORIAS */
function carregarCategorias() {
  db.ref('categories').once('value', s => {
    const lista = document.getElementById('listaCategorias');
    lista.innerHTML = '';
    let cats = [];
    s.forEach(c => { cats.push({ key: c.key, ...c.val() }); });
    cats.sort((a, b) => a.name.localeCompare(b.name)); [cite: 9]
    cats.forEach(c => {
      lista.innerHTML += `
        <div class="card flex justify-between items-center mb-2 py-2 px-4 text-sm">
          <b class="uppercase">${c.name}</b>
          <div class="flex gap-2">
            <button class="btn text-red-500" onclick="if(confirm('Excluir?')) db.ref('categories/${c.key}').remove().then(()=>carregarCategorias())">X</button>
          </div>
        </div>`; [cite: 10, 11]
    });
  });
}

/* PRODUTOS E CACHE (OTIMIZADO) */
let cacheProdutos = []; [cite: 12]
function carregarProdutos() {
  const lista = document.getElementById('listaProdutos');
  lista.innerHTML = '<p class="text-center p-4">Sincronizando...</p>'; [cite: 13]
  db.ref('products').once('value', s => {
    cacheProdutos = [];
    s.forEach(p => { cacheProdutos.push({ key: p.key, ...p.val() }); }); [cite: 14]
    cacheProdutos.sort((a, b) => (a.sku || "").localeCompare(b.sku || "", undefined, { numeric: true }));
    renderizarEstruturaProdutos(); [cite: 14]
  });
}

function renderizarEstruturaProdutos() {
  const lista = document.getElementById('listaProdutos');
  lista.innerHTML = '';
  const categorias = [...new Set(cacheProdutos.map(p => p.category || "Sem Categoria"))].sort(); [cite: 16]
  categorias.forEach(cat => {
    const total = cacheProdutos.filter(p => (p.category || "Sem Categoria") === cat).length;
    const catId = cat.replace(/\s+/g, '-');
    lista.innerHTML += `
      <div class="mb-2">
        <div onclick="toggleCategoria('${cat}', '${catId}')" class="flex justify-between p-3 bg-[#1a1a1a] rounded-lg cursor-pointer">
          <b class="text-xs uppercase">${cat} (${total})</b>
          <span id="seta-${catId}">▼</span>
        </div>
        <div id="cat-content-${catId}" class="hidden flex flex-col gap-1 mt-1 pl-2 border-l border-[#caa85c]"></div>
      </div>`; [cite: 17, 18]
  });
}

function toggleCategoria(nomeCat, catId) {
  const content = document.getElementById(`cat-content-${catId}`);
  const isHidden = content.classList.contains('hidden');
  document.querySelectorAll('[id^="cat-content-"]').forEach(el => el.classList.add('hidden')); [cite: 19, 20]
  if (isHidden) {
    content.classList.remove('hidden');
    const prods = cacheProdutos.filter(p => (p.category || "Sem Categoria") === nomeCat); [cite: 22]
    content.innerHTML = prods.map(p => `
      <div class="card flex justify-between py-2 px-3 text-[11px] bg-[#0d0d0d]">
        <div>
          <span class="text-[#caa85c]">[${p.sku || '---'}]</span> <b>${p.name}</b>
          ${p.variacao ? `<br><small class="text-blue-400">Var: ${p.variacao}</small>` : ''}
        </div>
        <button class="text-red-500" onclick="removerProduto('${p.key}')">X</button>
      </div>`).join(''); [cite: 23, 24, 25]
  }
}

/* PEDIDOS */
function carregarPedidos() {
  const lista = document.getElementById('listaPedidos');
  db.ref('orders').on('value', snapshot => {
    lista.innerHTML = '';
    if (!snapshot.exists()) return; [cite: 49]
    snapshot.forEach(ped => {
      const p = ped.val();
      const id = ped.key;
      lista.innerHTML += `
        <div class="card mb-3 border-l-4 border-[#caa85c]">
          <div class="flex justify-between">
            <b class="text-sm uppercase">${p.cliente?.nome || p.cliente}</b>
            <span class="text-[9px] bg-[#222] px-1">${p.pagamento || ''}</span>
          </div>
          <div class="grid grid-cols-3 gap-1 mt-2">
            <button class="btn text-[9px]" onclick="gerarRomaneio('${id}', 1)">Simples</button>
            <button class="btn text-[9px]" onclick="gerarRomaneio('${id}', 2)">Completo</button>
            <button class="btn text-[9px]" onclick="gerarRomaneio('${id}', 3)">Com Foto</button>
          </div>
          <div class="flex gap-2 mt-2">
            <button class="btn flex-1 text-blue-400" onclick="abrirEditorPedido('${id}')">✎ AJUSTAR</button>
            <button class="btn flex-1 text-red-500" onclick="excluirPedido('${id}')">EXCLUIR</button>
          </div>
          <div class="text-right mt-2 font-bold">${fMoeda(p.total)}</div>
        </div>`; [cite: 50, 51, 52, 53]
    });
  });
}

function excluirPedido(id) {
  if (confirm("Excluir pedido?")) db.ref('orders/' + id).remove(); [cite: 54]
}

function abrirEditorPedido(id) {
  db.ref('orders/' + id).once('value', s => {
    const p = s.val();
    const novoTotal = prompt("Novo valor total:", p.total);
    const nota = prompt("Observação:", p.obs || "");
    if (novoTotal) db.ref('orders/' + id).update({ total: Number(novoTotal), obs: nota, ajustadoManualmente: true }); [cite: 56]
  });
}

/* ROMANEIO */
function gerarRomaneio(id, tipo) {
  db.ref('orders/'+id).once('value', s => {
    const p = s.val();
    db.ref('settings/empresa').once('value', e => {
      const emp = e.val() || {};
      let html = `<div style="font-family:Arial; padding:20px;">
        <h1 style="text-align:center; color:#A68966">${emp.nome || 'Abella Joias'}</h1>
        <p style="text-align:center">${emp.subtitulo || ''}<br>Whats: ${emp.whats || ''}</p>
        <hr>
        <p><b>Cliente:</b> ${p.cliente?.nome || p.cliente}</p>
        <table style="width:100%; border-collapse:collapse; margin-top:10px;">
          <thead><tr style="border-bottom:1px solid #000"><th>Produto</th><th>Peso</th><th>Preço</th><th>Qtd</th><th>Subtotal</th></tr></thead>
          <tbody>`; [cite: 57, 58, 59, 60, 61]
      
      p.itens.forEach(i => {
        const peso = (Number(i.peso || 0) / 1000).toFixed(3);
        html += `<tr style="border-bottom:1px solid #eee">
          <td>${i.name} ${i.variacao ? '('+i.variacao+')' : ''}</td>
          <td>${peso} Kg</td><td>${fMoeda(i.precoFinal || i.price)}</td><td>${i.quantidade}</td>
          <td>${fMoeda((i.precoFinal || i.price) * i.quantidade)}</td></tr>`; [cite: 69, 70]
      });

      html += `</tbody></table>`;
      if (tipo > 1) {
        html += `<div style="text-align:right; margin-top:20px;">
          Subtotal: ${fMoeda(p.subtotal)}<br>
          <b>TOTAL: ${fMoeda(p.total)}</b><br>
          ${p.obs ? `<small>Obs: ${p.obs}</small>` : ''}
        </div>`; [cite: 72, 74]
      }
      html += `</div>`;
      document.getElementById('print-area').innerHTML = html;
      setTimeout(() => window.print(), 500); [cite: 76]
    });
  });
}

/* INICIALIZAÇÃO */
window.addEventListener('load', () => {
  carregarEmpresaSeExistir();
  showTab('empresa', document.querySelector('nav button')); [cite: 78]
});
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Abella Joias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f6f2; }
        .gold-border { border-color: #d4af37; }
        .gold-bg { background-color: #d4af37; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .status-Novo { background: #fffbeb; color: #92400e; border: 1px solid #fde68a; }
        .status-Separação { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; }
        .status-Enviado { background: #f5f3ff; color: #5b21b6; border: 1px solid #ddd6fe; }
        .status-Finalizado { background: #ecfdf5; color: #065f46; border: 1px solid #a7f3d0; }
        
        @media print {
            body * { visibility: hidden; }
            #romaneio-print, #romaneio-print * { visibility: visible; }
            #romaneio-print { position: absolute; top: 0; left: 0; width: 100%; background: white; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-black text-white p-6 shadow-lg border-b-4 border-[#d4af37]">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold tracking-tighter">ABELLA JOIAS</h1>
                <p class="text-[10px] text-[#d4af37] uppercase tracking-widest">Painel Administrativo</p>
            </div>
            <nav class="hidden md:flex gap-6 text-xs font-bold uppercase">
                <button onclick="showTab('pedidos')" class="hover:text-[#d4af37]">Pedidos</button>
                <button onclick="showTab('produtos')" class="hover:text-[#d4af37]">Produtos</button>
                <button onclick="showTab('categorias')" class="hover:text-[#d4af37]">Categorias</button>
                <button onclick="showTab('galvanicas')" class="hover:text-[#d4af37]">Galvânicas</button>
                <button onclick="showTab('config')" class="hover:text-[#d4af37]">Ajustes</button>
            </nav>
        </div>
    </header>

    <main class="flex-grow max-w-7xl w-full mx-auto p-4 md:p-8">
        
        <section id="pedidos" class="tab-content active">
            <div class="flex justify-between items-end mb-6">
                <h2 class="text-2xl font-bold">Gestão de Pedidos</h2>
            </div>
            <div id="listaPedidos" class="grid gap-4">
                </div>
        </section>

        <section id="produtos" class="tab-content">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 mb-8">
                <h3 class="font-bold mb-4">Cadastrar Novo Produto</h3>
                <form id="formProduto" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="pNome" placeholder="Nome do Produto" class="border p-2 rounded-lg text-sm" required>
                    <input type="text" id="pSku" placeholder="SKU/Código" class="border p-2 rounded-lg text-sm" required>
                    <input type="number" step="0.01" id="pPreco" placeholder="Preço Base (R$)" class="border p-2 rounded-lg text-sm" required>
                    <select id="pCat" class="border p-2 rounded-lg text-sm"></select>
                    <input type="text" id="pImage" placeholder="URL da Imagem" class="border p-2 rounded-lg text-sm md:col-span-3">
                    <button type="submit" class="bg-black text-white p-2 rounded-lg font-bold hover:bg-[#d4af37] transition">SALVAR</button>
                </form>
            </div>
            <div id="gridProdutos" class="grid grid-cols-2 md:grid-cols-5 gap-4"></div>
        </section>

        <section id="categorias" class="tab-content">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 mb-8 max-w-lg">
                <h3 class="font-bold mb-4">Nova Categoria</h3>
                <input type="text" id="catNome" placeholder="Nome (Ex: Brincos)" class="w-full border p-2 rounded-lg mb-4">
                <input type="file" id="catFile" class="text-sm mb-4">
                <button onclick="salvarCategoria()" class="w-full bg-black text-white p-3 rounded-lg font-bold">CRIAR CATEGORIA</button>
            </div>
            <div id="listaCategorias" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
        </section>

        <section id="config" class="tab-content">
            <div class="bg-white p-8 rounded-2xl shadow-sm border max-w-2xl mx-auto">
                <h2 class="text-xl font-bold mb-6">Ajustes do Sistema</h2>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-gray-400">WHATSAPP DE VENDAS (Ex: 55199...)</label>
                        <input type="text" id="confPhone" class="w-full border p-3 rounded-xl mt-1">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-gray-400">DESCONTO PIX (%)</label>
                            <input type="number" id="confPix" class="w-full border p-3 rounded-xl mt-1">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-400">PARCELAS SEM JUROS</label>
                            <input type="number" id="confParc" class="w-full border p-3 rounded-xl mt-1">
                        </div>
                    </div>
                    <button onclick="salvarConfig()" class="w-full bg-[#d4af37] text-white py-4 rounded-xl font-bold shadow-lg mt-4">ATUALIZAR DADOS</button>
                </div>
            </div>
        </section>

        <section id="galvanicas" class="tab-content">
             <h2 class="text-2xl font-bold mb-6">Galvânicas Parceiras</h2>
             <p class="text-gray-500 text-sm mb-4">Gerencie as empresas de banho que aparecem para seus clientes.</p>
             <div id="listaGalvAdmin" class="grid gap-4"></div>
        </section>

    </main>

    <div id="romaneio-print" class="p-10 text-black">
        <h1 class="text-2xl font-bold border-b-2 pb-2 mb-4">ABELLA JOIAS - ROMANEIO</h1>
        <div id="romaneio-content"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
            authDomain: "catalogo-abella-joias.firebaseapp.com",
            databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
            projectId: "catalogo-abella-joias",
            storageBucket: "catalogo-abella-joias.appspot.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const storage = firebase.storage();

        // Troca de Abas
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        }

        // --- GESTÃO DE CATEGORIAS ---
        async function salvarCategoria() {
            const nome = document.getElementById('catNome').value;
            const file = document.getElementById('catFile').files[0];
            if(!nome || !file) return alert("Preencha nome e imagem");

            const ref = storage.ref(`categorias/${file.name}`);
            await ref.put(file);
            const url = await ref.getDownloadURL();
            
            db.ref('categories').push({ name: nome, image: url });
            alert("Categoria Criada!");
            document.getElementById('catNome').value = "";
        }

        db.ref('categories').on('value', snap => {
            const list = document.getElementById('listaCategorias');
            const select = document.getElementById('pCat');
            list.innerHTML = ''; select.innerHTML = '';
            snap.forEach(s => {
                const c = s.val();
                list.innerHTML += `
                    <div class="bg-white p-2 border rounded-xl relative group">
                        <img src="${c.image}" class="w-full aspect-square object-cover rounded-lg">
                        <p class="text-center font-bold text-xs mt-2 uppercase">${c.name}</p>
                        <button onclick="db.ref('categories/${s.key}').remove()" class="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition">✕</button>
                    </div>
                `;
                select.innerHTML += `<option value="${s.key}">${c.name}</option>`;
            });
        });

        // --- GESTÃO DE PRODUTOS ---
        document.getElementById('formProduto').onsubmit = (e) => {
            e.preventDefault();
            const p = {
                name: document.getElementById('pNome').value,
                sku: document.getElementById('pSku').value,
                price: parseFloat(document.getElementById('pPreco').value),
                category: document.getElementById('pCat').value,
                image: document.getElementById('pImage').value || 'https://via.placeholder.com/300'
            };
            db.ref('products').push(p);
            e.target.reset();
        };

        db.ref('products').on('value', snap => {
            const grid = document.getElementById('gridProdutos');
            grid.innerHTML = '';
            snap.forEach(s => {
                const p = s.val();
                grid.innerHTML += `
                    <div class="bg-white border rounded-lg overflow-hidden text-[10px] relative group">
                        <img src="${p.image}" class="w-full aspect-square object-cover">
                        <div class="p-2">
                            <p class="font-bold truncate">${p.name}</p>
                            <p class="text-gray-400">SKU: ${p.sku}</p>
                            <p class="text-[#b8860b] font-bold">R$ ${p.price.toFixed(2)}</p>
                        </div>
                        <button onclick="db.ref('products/${s.key}').remove()" class="absolute top-1 right-1 bg-black text-white px-2 py-1 rounded opacity-0 group-hover:opacity-100">✕</button>
                    </div>
                `;
            });
        });

        // --- GESTÃO DE PEDIDOS ---
        db.ref('orders').on('value', snap => {
            const container = document.getElementById('listaPedidos');
            container.innerHTML = '';
            snap.forEach(s => {
                const o = s.val();
                container.innerHTML += `
                    <div class="bg-white border rounded-xl p-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <p class="text-xs text-gray-400">${o.data}</p>
                            <h4 class="font-bold text-lg">${o.cliente}</h4>
                            <p class="text-sm font-semibold text-[#b8860b]">Total: R$ ${parseFloat(o.total).toFixed(2)}</p>
                        </div>
                        <div class="flex gap-2">
                            <select onchange="updateStatus('${s.key}', this.value)" class="status-${o.status || 'Novo'} text-xs font-bold p-2 rounded-lg border-none focus:ring-0">
                                <option ${o.status=='Novo'?'selected':''}>Novo</option>
                                <option ${o.status=='Separação'?'selected':''}>Separação</option>
                                <option ${o.status=='Enviado'?'selected':''}>Enviado</option>
                                <option ${o.status=='Finalizado'?'selected':''}>Finalizado</option>
                            </select>
                            <button onclick='imprimirRomaneio(${JSON.stringify(o)})' class="bg-gray-100 p-2 rounded-lg text-xs font-bold hover:bg-gray-200">IMPRIMIR</button>
                            <button onclick="db.ref('orders/${s.key}').remove()" class="text-red-400 p-2 text-xs">Excluir</button>
                        </div>
                    </div>
                `;
            });
        });

        function updateStatus(id, status) {
            db.ref(`orders/${id}`).update({ status });
        }

        function imprimirRomaneio(o) {
            const content = document.getElementById('romaneio-content');
            let itensHtml = '';
            o.itens.forEach(i => {
                itensHtml += `<tr class="border-b"><td class="py-2">${i.sku}</td><td>${i.name}</td><td class="text-right">R$ ${i.price.toFixed(2)}</td></tr>`;
            });
            
            content.innerHTML = `
                <div class="mb-4">
                    <p><strong>Cliente:</strong> ${o.cliente}</p>
                    <p><strong>Data:</strong> ${o.data}</p>
                    <p><strong>Pagamento:</strong> ${o.pagamento || 'N/A'}</p>
                </div>
                <table class="w-full text-left border-collapse">
                    <thead><tr class="border-b-2"><th>SKU</th><th>Produto</th><th class="text-right">Preço</th></tr></thead>
                    <tbody>${itensHtml}</tbody>
                </table>
                <div class="mt-4 text-right font-bold text-xl">TOTAL: R$ ${parseFloat(o.total).toFixed(2)}</div>
            `;
            window.print();
        }

        // --- CONFIGURAÇÕES ---
        function salvarConfig() {
            const data = {
                phone: document.getElementById('confPhone').value,
                pix: parseInt(document.getElementById('confPix').value),
                installments: parseInt(document.getElementById('confParc').value)
            };
            db.ref('settings').set(data);
            alert("Configurações atualizadas!");
        }

        db.ref('settings').once('value', s => {
            const c = s.val();
            if(c) {
                document.getElementById('confPhone').value = c.phone || "";
                document.getElementById('confPix').value = c.pix || 0;
                document.getElementById('confParc').value = c.installments || 1;
            }
        });

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Painel Admin ‚Ä¢ Abella Joias</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <style>
        body{background:#0b0b0b;color:#eee;font-family:Inter,Arial}
        nav button.active{border-color:#caa85c;color:#caa85c}
        section{display:none}
        section.active{display:block}
        .card{background:#141414;border:1px solid #2a2a2a;border-radius:16px;padding:14px}
        .grid{display:grid;gap:12px}
        @media(min-width:768px){.grid{grid-template-columns:repeat(4,1fr)}}
        @media(min-width:1200px){.grid{grid-template-columns:repeat(6,1fr)}}
        .btn{background:#222;border:1px solid #444;padding:6px 10px;border-radius:8px;font-size:12px;cursor:pointer}
        .btn-gold{background:#caa85c;color:#000;font-weight:700}
        .btn-red{border-color:#c33;color:#f77}
        
        /* MODAL */
        #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:100;align-items:center;justify-content:center;padding:15px}
        .modal-box{background:#141414;border:1px solid #333;border-radius:20px;width:100%;max-width:500px;padding:20px;max-height:90vh;overflow-y:auto}
        
        input,select{background:#111;border:1px solid #333;padding:10px;border-radius:8px;width:100%;margin-bottom:8px;color:#fff;outline:none}
        input:focus{border-color:#caa85c}
        .badge-desconto { position: absolute; top: 5px; right: 5px; background: #16a34a; color: white; font-size: 9px; font-weight: 800; padding: 2px 6px; border-radius: 4px; z-index: 10; }
        .preco-riscado { text-decoration: line-through; }
    </style>
</head>

<body>

<header class="p-5 text-center text-xl font-bold bg-black border-b border-[#222]">
    Painel Administrativo ‚Ä¢ Abella Joias
</header>

<nav class="flex gap-2 p-2 bg-[#111] overflow-x-auto sticky top-0 z-50">
    <button class="btn active" onclick="showTab('empresa',this)">Empresa</button>
    <button class="btn" onclick="showTab('pedidos',this)">Pedidos</button>
    <button class="btn" onclick="showTab('categorias',this)">Categorias</button>
    <button class="btn" onclick="showTab('produtos',this)">Produtos</button>
    <button class="btn" onclick="showTab('promocoes',this)">Promo√ß√µes</button>
</nav>

<main class="p-4">
    <section id="empresa" class="active">
        <div class="card max-w-md mx-auto">
            <label class="text-[10px] uppercase opacity-50">Nome da Loja</label>
            <input id="empNome">
            <label class="text-[10px] uppercase opacity-50">WhatsApp</label>
            <input id="empWhats">
            <label class="text-[10px] uppercase opacity-50">Desconto PIX %</label>
            <input id="empPix" type="number">
            <label class="text-[10px] uppercase opacity-50">M√°ximo de Parcelas</label>
            <input id="empParc" type="number">
            <button class="btn-gold w-full mt-2 py-3 rounded-xl" onclick="salvarEmpresa()">Salvar Configura√ß√µes</button>
        </div>
    </section>

    <section id="pedidos">
        <input type="text" id="inputBusca" oninput="filtrarPedidos()" placeholder="üîç Buscar por N¬∫ ou Cliente..." class="mb-4">
        <div id="listaPedidos" class="space-y-2"></div>
    </section>

    <section id="categorias">
        <div id="listaCategorias" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
    </section>

    <section id="produtos">
        <div id="produtosPorCategoria"></div>
    </section>

    <section id="promocoes">
        <div class="card max-w-md mx-auto">
            <h2 class="text-[#caa85c] font-bold mb-4 uppercase text-xs">Ajuste R√°pido de Categorias</h2>
            <div id="listaPromocoes" class="space-y-3"></div>
            <button class="btn-gold mt-6 w-full py-3" onclick="salvarPromos()">Salvar Todos os Descontos</button>
            <hr class="my-6 border-[#222]">
            <button class="btn border-blue-500 text-blue-400 w-full py-3" onclick="abrirPainelPromocoes()">Gerenciar Promo√ß√£o Global</button>
        </div>
    </section>
</main>

<div id="modal">
    <div class="modal-box">
        <h2 id="modalTitle" class="text-lg font-bold text-[#caa85c] mb-4"></h2>
        <div id="modalBody"></div>
        <div class="flex gap-2 mt-6">
            <button class="btn flex-1" onclick="fecharModal()">Cancelar</button>
            <button id="modalConfirm" class="btn-gold flex-[2] py-2 rounded-lg">Salvar Altera√ß√µes</button>
        </div>
    </div>
</div>

<script>
// CONFIGURA√á√ÉO FIREBASE
const firebaseConfig = {
    apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
    databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* NAVEGA√á√ÉO */
function showTab(id, btn) {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

/* L√ìGICA DO MODAL */
function abrirModal(titulo, html, onConfirm) {
    document.getElementById('modalTitle').innerText = titulo;
    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('modal').style.display = 'flex';
    document.getElementById('modalConfirm').onclick = () => { onConfirm(); fecharModal(); };
}
function fecharModal() { document.getElementById('modal').style.display = 'none'; }

/* EMPRESA */
db.ref('settings').on('value', s => {
    const v = s.val() || {};
    document.getElementById('empNome').value = v.nome || '';
    document.getElementById('empWhats').value = v.whatsapp || '';
    document.getElementById('empPix').value = v.pix || 0;
    document.getElementById('empParc').value = v.parcelas || 1;
});
function salvarEmpresa() {
    db.ref('settings').update({
        nome: empNome.value,
        whatsapp: empWhats.value,
        pix: +empPix.value,
        parcelas: +empParc.value
    }).then(() => alert('Configura√ß√µes salvas!'));
}

/* CATEGORIAS & PROMO√á√ïES */
db.ref('categories').on('value', s => {
    const listaCat = document.getElementById('listaCategorias');
    const listaPromos = document.getElementById('listaPromocoes');
    listaCat.innerHTML = ''; listaPromos.innerHTML = '';

    s.forEach(c => {
        const d = c.val(); const id = c.key;
        const foto = d.image || 'https://via.placeholder.com/150?text=Sem+Foto';

        listaCat.innerHTML += `
            <div class="card flex items-center gap-3">
                <img src="${foto}" class="w-12 h-12 rounded-lg object-cover border border-[#333]">
                <div class="flex-1">
                    <b class="text-[11px] uppercase text-white">${d.name}</b>
                    <div class="flex gap-1 mt-1">
                        <button class="btn text-[9px] py-1 bg-blue-900/40 border-blue-700" onclick="editarCategoria('${id}')">Editar</button>
                        <button class="btn btn-red text-[9px] py-1" onclick="excluir('categories','${id}')">‚úï</button>
                    </div>
                </div>
            </div>`;

        listaPromos.innerHTML += `
            <div class="flex justify-between items-center p-2 bg-[#0a0a0a] rounded-lg border border-[#222]">
                <span class="text-[11px] font-medium text-gray-300 uppercase">${d.name}</span>
                <div class="flex items-center gap-2">
                    <input type="number" id="promo-${id}" value="${d.discount || 0}" class="w-14 mb-0 text-center text-xs p-1 bg-black">
                    <span class="text-[#caa85c] text-xs">%</span>
                </div>
            </div>`;
    });
});

/* PRODUTOS (AGRUPADOS COM MAIOR DESCONTO) */
db.ref('products').on('value', snapProdutos => {
    const container = document.getElementById('produtosPorCategoria');
    container.innerHTML = '';
    const map = {};

    Promise.all([
        db.ref('settings/promocao').once('value'),
        db.ref('categories').once('value')
    ]).then(([snapPromoGlobal, snapCats]) => {
        const promoGeral = snapPromoGlobal.val() || { ativa: false, porcentagem: 0 };
        const categorias = snapCats.val() || {};

        snapProdutos.forEach(p => {
            const v = p.val(); v.id = p.key;
            if (!map[v.category]) map[v.category] = [];
            map[v.category].push(v);
        });

        Object.keys(map).forEach(catID => {
            const nomeCat = categorias[catID]?.name || catID;
            container.innerHTML += `<h3 class="text-[#caa85c] mt-8 mb-4 uppercase text-[10px] font-bold tracking-widest border-b border-[#caa85c]/20 pb-2">${nomeCat}</h3><div class="grid" id="grid-${catID}"></div>`;
            
            const grid = document.getElementById(`grid-${catID}`);
            map[catID].forEach(p => {
                const precoBase = parseFloat(p.price || 0);
                const descInd = parseInt(p.discount || 0);
                const descCat = parseInt(categorias[catID]?.discount || 0);
                const descGlob = promoGeral.ativa ? parseInt(promoGeral.porcentagem || 0) : 0;
                const melhorDesc = Math.max(descInd, descCat, descGlob);

                let precoHtml = `<div class="text-sm font-bold text-white">R$ ${precoBase.toFixed(2)}</div>`;
                let badge = '';

                if (melhorDesc > 0) {
                    const precoFinal = precoBase * (1 - (melhorDesc / 100));
                    badge = `<div class="badge-desconto">-${melhorDesc}%</div>`;
                    precoHtml = `<div class="text-[10px] preco-riscado text-gray-500">R$ ${precoBase.toFixed(2)}</div><div class="text-sm font-bold text-green-500">R$ ${precoFinal.toFixed(2)}</div>`;
                }

                grid.innerHTML += `
                    <div class="card relative bg-[#111]">
                        ${badge}
                        <img src="${p.image}" class="w-full h-28 object-cover rounded-lg mb-2 border border-[#222]">
                        <div class="text-[10px] truncate text-gray-300 mb-1">${p.name}</div>
                        ${precoHtml}
                        <div class="flex gap-1 mt-3">
                            <button class="btn flex-1 py-1" onclick="editarProduto('${p.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-red px-2" onclick="excluir('products','${p.id}')">‚úï</button>
                        </div>
                    </div>`;
            });
        });
    });
});

/* PEDIDOS */
db.ref('orders').on('value', s => {
    const lista = document.getElementById('listaPedidos');
    lista.innerHTML = '';
    s.forEach(o => {
        const p = o.val();
        if(p.arquivado) return;
        lista.innerHTML += `
        <div class="card flex justify-between items-center mb-2 pedido-card">
            <div>
                <div class="font-bold text-[#caa85c] text-xs">#${p.numeroPedido || o.key.substring(0,6)}</div>
                <div class="text-white font-medium">${p.cliente}</div>
                <div class="text-[10px] opacity-60">Total: R$ ${parseFloat(p.total||0).toFixed(2)}</div>
            </div>
            <div class="flex gap-1">
                <button class="btn-gold px-3 py-1 text-[10px]" onclick="gerarRomaneio('${o.key}','cliente')">Romaneio</button>
                <button class="btn bg-orange-700 text-white border-none px-2" onclick="cancelarPedido('${o.key}')">üì¶</button>
                <button class="btn btn-red" onclick="excluir('orders','${o.key}')">‚úï</button>
            </div>
        </div>`;
    });
});

/* FUN√á√ïES DE EDI√á√ÉO (MODAIS) */
function editarProduto(id) {
    db.ref('products/' + id).once('value').then(s => {
        const p = s.val();
        abrirModal('Editar Produto', `
            <label class="text-[10px] font-bold text-[#caa85c]">NOME</label>
            <input id="pName" value="${p.name}">
            <div class="grid grid-cols-2 gap-2">
                <div><label class="text-[10px] font-bold">PRE√áO (R$)</label><input id="pPrice" type="number" step="0.01" value="${p.price}"></div>
                <div><label class="text-[10px] font-bold text-green-500">DESC INDIVIDUAL %</label><input id="pDisc" type="number" value="${p.discount || 0}"></div>
            </div>
            <label class="text-[10px] font-bold">URL IMAGEM</label>
            <input id="pImg" value="${p.image}">
        `, () => {
            db.ref('products/' + id).update({
                name: document.getElementById('pName').value,
                price: parseFloat(document.getElementById('pPrice').value),
                discount: parseInt(document.getElementById('pDisc').value),
                image: document.getElementById('pImg').value
            });
        });
    });
}

function editarCategoria(id) {
    db.ref('categories/' + id).once('value').then(s => {
        const d = s.val();
        abrirModal('Editar Categoria', `
            <label class="text-[10px] font-bold text-[#caa85c]">NOME</label><input id="cName" value="${d.name}">
            <label class="text-[10px] font-bold text-[#caa85c]">URL FOTO</label><input id="cImg" value="${d.image || ''}">
        `, () => {
            db.ref('categories/' + id).update({
                name: document.getElementById('cName').value,
                image: document.getElementById('cImg').value
            });
        });
    });
}

function abrirPainelPromocoes() {
    db.ref('settings/promocao').once('value').then(s => {
        const p = s.val() || { ativa: false, porcentagem: 0 };
        abrirModal('Promo√ß√£o Global (Loja Toda)', `
            <div class="flex items-center justify-between mb-4 bg-black p-3 rounded-lg border border-[#333]">
                <span class="font-bold text-xs uppercase">Status da Promo√ß√£o</span>
                <button onclick="togglePromoStatus()" class="btn ${p.ativa ? 'bg-green-600' : 'bg-red-600'} text-white border-none font-bold">
                    ${p.ativa ? 'ATIVA' : 'INATIVA'}
                </button>
            </div>
            <label class="text-[10px] font-bold">PORCENTAGEM DE DESCONTO (%)</label>
            <input id="pGlobal" type="number" value="${p.porcentagem}">
        `, () => {
            db.ref('settings/promocao/porcentagem').set(parseInt(document.getElementById('pGlobal').value));
        });
    });
}

function togglePromoStatus() {
    db.ref('settings/promocao/ativa').once('value').then(s => {
        db.ref('settings/promocao/ativa').set(!s.val());
        fecharModal(); abrirPainelPromocoes();
    });
}

function salvarPromos() {
    const updates = {};
    document.querySelectorAll('[id^="promo-"]').forEach(i => {
        updates[`categories/${i.id.replace('promo-','')}/discount`] = parseInt(i.value) || 0;
    });
    db.ref().update(updates).then(() => alert('Descontos de categoria salvos!'));
}

function excluir(path, id) { if(confirm("Deseja excluir permanentemente?")) db.ref(path + '/' + id).remove(); }
function filtrarPedidos() {
    const termo = document.getElementById('inputBusca').value.toLowerCase();
    document.querySelectorAll('.pedido-card').forEach(c => c.style.display = c.innerText.toLowerCase().includes(termo) ? 'flex' : 'none');
}

function cancelarPedido(id) { if(confirm("Arquivar este pedido?")) db.ref('orders/'+id).update({arquivado: true}); }

function gerarRomaneio(id, tipo) {
    db.ref('orders/'+id).once('value').then(s => {
        const p = s.val(); if(!p) return;
        const mostrarFoto = (tipo === 'cliente');
        let html = `<html><head><style>body{font-family:sans-serif;padding:20px} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ddd;padding:8px;text-align:left} .total{font-size:18px;font-weight:bold;margin-top:20px}</style></head><body>`;
        html += `<h1>Pedido: #${id.substring(0,6).toUpperCase()}</h1><p>Cliente: ${p.cliente}</p><table><thead><tr>${mostrarFoto?'<th>Foto</th>':''}<th>Item</th><th>Qtd</th><th>Subtotal</th></tr></thead><tbody>`;
        Object.values(p.itens||{}).forEach(i => {
            html += `<tr>${mostrarFoto?`<td><img src="${i.image}" style="width:50px"></td>`:''}<td>${i.nome}</td><td>${i.qtd}</td><td>R$ ${(i.qtd*i.preco).toFixed(2)}</td></tr>`;
        });
        html += `</tbody></table><div class="total">Total: R$ ${parseFloat(p.total).toFixed(2)}</div><script>window.print();<\/script></body></html>`;
        const win = window.open('','_blank'); win.document.write(html); win.document.close();
    });
}
</script>
</body>
</html>

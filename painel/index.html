<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Administrativo | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#F8F6F2}
.font-serif{font-family:'Cinzel',serif}
.gold{color:#A68966}
.tab{display:none}
.tab.active{display:block}
img.square{aspect-ratio:1/1;object-fit:contain}
.log-ok{color:#047857}
.log-err{color:#b91c1c}
</style>
</head>

<body>

<header class="bg-white border-b px-10 py-6 flex justify-between">
  <div>
    <h1 class="font-serif text-xl tracking-widest gold">Abella Joias</h1>
    <p class="text-xs tracking-widest text-gray-400 uppercase">Painel Administrativo</p>
  </div>

  <nav class="flex gap-6 text-xs uppercase tracking-widest">
    <button onclick="openTab('empresa')" class="gold">Empresa</button>
    <button onclick="openTab('categorias')">Categorias</button>
    <button onclick="openTab('produtos')">Produtos</button>
    <button onclick="openTab('importacao')" class="font-bold">Importa√ß√£o CSV</button>
    <button onclick="openTab('pedidos')">Pedidos</button>
  </nav>
</header>

<main class="max-w-7xl mx-auto p-8 space-y-16">

<!-- IMPORTA√á√ÉO CSV -->
<section id="importacao" class="tab active space-y-6">
<h2 class="font-serif text-2xl gold">Importa√ß√£o de Produtos (CSV)</h2>

<div class="bg-white border p-6 space-y-4">
<p class="text-sm text-gray-600">
üì• Envie um arquivo CSV usando <b>;</b> como separador<br>
Cabe√ßalho obrigat√≥rio:
</p>

<pre class="bg-gray-100 p-3 text-xs">tipo;nome;sku;categoria;preco;peso;imagem;variacoes</pre>

<input type="file" id="csvFile" accept=".csv" class="border p-3 w-full">

<button onclick="importarCSV()" class="bg-green-600 text-white px-6 py-3">
IMPORTAR PRODUTOS
</button>

<div id="importStatus" class="text-sm mt-4"></div>
<div id="importLog" class="text-xs mt-4 space-y-1"></div>
</div>
</section>

</main>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
   authDomain: "catalogo-abella-joias.firebaseapp.com",
 databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
  projectId: "catalogo-abella-joias",
});
const db = firebase.database();

function openTab(id){
 document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
 document.getElementById(id).classList.add('active');
}

async function importarCSV() {
  const fileInput = document.getElementById('csvFile');
  const file = fileInput.files[0];
  const status = document.getElementById('importStatus');
  const log = document.getElementById('importLog');

  log.innerHTML = '';
  status.innerHTML = '';

  if (!file) {
    status.innerHTML = '<span class="log-err">‚ùå Nenhum arquivo selecionado</span>';
    return;
  }

  status.innerHTML = '‚è≥ Lendo arquivo e conectando ao Firebase...';

  const reader = new FileReader();

  reader.onload = async (e) => {
    try {
      // Remove retornos de carro e espa√ßos em branco nas extremidades
      const texto = e.target.result.replace(/\r/g, '').trim();
      const linhas = texto.split('\n');

      if (linhas.length < 2) {
        status.innerHTML = '<span class="log-err">‚ùå O arquivo est√° vazio ou cont√©m apenas o cabe√ßalho</span>';
        return;
      }

      // Valida√ß√£o do Cabe√ßalho
      const cabecalho = linhas[0].toLowerCase().trim();
      if (!cabecalho.includes('tipo') || !cabecalho.includes('sku')) {
        status.innerHTML = '<span class="log-err">‚ùå Cabe√ßalho inv√°lido. Verifique se usou ";" como separador.</span>';
        return;
      }

      let sucesso = 0;
      let erros = 0;

      // Itera sobre as linhas de dados
      const dados = linhas.slice(1);
      
      for (const [index, linha] of dados.entries()) {
        const linhaLimpa = linha.trim();
        if (!linhaLimpa) continue; // Pula linhas vazias

        const col = linhaLimpa.split(';');

        // Valida√ß√£o m√≠nima de colunas
        if (col.length < 6) {
          log.innerHTML += `<div class="log-err">Linha ${index + 2}: Colunas insuficientes (esperado 8, obtido ${col.length})</div>`;
          erros++;
          continue;
        }

        // Tratamento de Pre√ßo e Peso (substitui v√≠rgula por ponto para o JavaScript entender)
        const precoNum = parseFloat(col[4].replace(',', '.').trim()) || 0;
        const pesoNum = parseFloat(col[5].replace(',', '.').trim()) || 0;

        const produto = {
          tipo: col[0].trim(),
          nome: col[1].trim(),
          sku: col[2].trim(),
          categoria: col[3].trim(),
          preco: precoNum,
          peso: pesoNum,
          imagem: col[6] ? col[6].trim() : "",
          variacoes: col[7] ? col[7].trim() : "FALSE",
          dataImportacao: new Date().toISOString()
        };

        try {
          // Envia para o n√≥ 'products' no Realtime Database
          await db.ref('products').push(produto);
          sucesso++;
          log.innerHTML += `<div class="log-ok">‚úî [${produto.sku}] ${produto.nome} - Salvo com sucesso</div>`;
        } catch (dbError) {
          erros++;
          log.innerHTML += `<div class="log-err">‚ùå Erro no SKU ${produto.sku}: ${dbError.message}</div>`;
        }
      }

      status.innerHTML = `
        <div class="p-4 bg-white border-l-4 border-green-500 shadow-sm">
          <b class="text-green-700 text-lg">‚úÖ Importa√ß√£o Finalizada!</b><br>
          <span class="text-gray-700">Produtos no banco: <b>${sucesso}</b></span><br>
          <span class="text-red-600">Falhas ignoradas: <b>${erros}</b></span>
        </div>
      `;
      
      // Limpa o input de arquivo para permitir nova importa√ß√£o
      fileInput.value = '';

    } catch (processError) {
      status.innerHTML = `<span class="log-err">‚ùå Erro no processamento: ${processError.message}</span>`;
    }
  };

  reader.onerror = () => {
    status.innerHTML = '<span class="log-err">‚ùå Erro ao ler o arquivo f√≠sico</span>';
  };

  reader.readAsText(file, 'UTF-8');
}
</script>

</body>
</html>


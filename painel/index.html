<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel Admin ‚Ä¢ Abella Joias</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <style>
        body { background: #0b0b0b; color: #eee; font-family: Inter, Arial; margin: 0; }
        nav button.active { border-color: #caa85c; color: #caa85c; }
        section { display: none; }
        section.active { display: block; }
        .card { background: #141414; border: 1px solid #2a2a2a; border-radius: 16px; padding: 14px; }
        .grid { display: grid; gap: 12px; }
        @media(min-width:768px) { .grid { grid-template-columns: repeat(4,1fr); } }
        .btn { background: #222; border: 1px solid #444; padding: 6px 10px; border-radius: 8px; font-size: 12px; cursor: pointer; }
        .btn-gold { background: #caa85c; color: #000; font-weight: 700; }
        input, select { background: #111; border: 1px solid #333; padding: 8px; border-radius: 8px; width: 100%; margin-bottom: 8px; color: #fff; }
        #modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.85); z-index: 100; align-items: center; justify-content: center; padding: 20px; }
        .modal-box { background: #141414; border: 1px solid #333; border-radius: 20px; width: 100%; max-width: 520px; padding: 20px; max-height: 90vh; overflow-y: auto; }
        @media print { body * { visibility: hidden; } #romaneio-area, #romaneio-area * { visibility: visible; } #romaneio-area { position: absolute; left: 0; top: 0; width: 100%; } }
    </style>
</head>
<body>

    <header class="p-5 text-center text-xl font-bold bg-black border-b border-[#222]">
        Painel Administrativo ‚Ä¢ Abella Joias
    </header>

    <nav class="flex gap-2 p-2 bg-[#111] overflow-x-auto sticky top-0 z-50">
        <button class="btn active" onclick="showTab('empresa',this)">Empresa</button>
        <button class="btn" onclick="showTab('categorias',this)">Categorias</button>
        <button class="btn" onclick="showTab('produtos',this)">Produtos</button>
        <button class="btn" onclick="abrirPainelPromocoes()">Promo√ß√µes</button>
        <button class="btn" onclick="showTab('pedidos',this)">Pedidos</button>
    </nav>

    <main class="p-6">
        <section id="empresa" class="active">
            <div class="card max-w-md mx-auto">
                <label class="text-[10px] uppercase opacity-50">Nome da Loja</label>
                <input id="empNome">
                <label class="text-[10px] uppercase opacity-50">WhatsApp (DDD + N√∫mero)</label>
                <input id="empWhats">
                <label class="text-[10px] uppercase opacity-50">Desconto PIX %</label>
                <input id="empPix" type="number">
                <label class="text-[10px] uppercase opacity-50">M√°ximo Parcelas</label>
                <input id="empParc" type="number">
                <button class="btn-gold w-full mt-2 py-3 rounded-xl" onclick="salvarEmpresa()">Salvar Configura√ß√µes</button>
            </div>
        </section>

        <section id="categorias">
            <button class="btn-gold mb-3" onclick="novaCategoria()">+ Nova Categoria</button>
            <div id="listaCategorias" class="grid"></div>
        </section>

        <section id="produtos">
            <button class="btn-gold mb-3" onclick="addProduto()">+ Novo Produto</button>
            <div id="produtosPorCategoria"></div>
        </section>

        <section id="pedidos">
            <div id="listaPedidos" class="space-y-3"></div>
        </section>
    </main>

    <div id="modal">
        <div class="modal-box">
            <h3 id="modalTitle" class="font-bold mb-4 text-[#caa85c] border-b border-[#333] pb-2 text-lg"></h3>
            <div id="modalBody"></div>
            <div class="flex gap-2 mt-4">
                <button class="btn-gold flex-1 py-2" id="btnSalvar">Confirmar</button>
                <button class="btn flex-1 py-2" onclick="fecharModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="romaneio-area"></div>

   <script>
    // 1. CONFIGURA√á√ÉO FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
        authDomain: "catalogo-abella-joias.firebaseapp.com",
        databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
        projectId: "catalogo-abella-joias"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. FORMATADOR DE MOEDA (R$ 0.000,00)
    const fMoeda = (v) => new Intl.NumberFormat('pt-BR', { 
        style: 'currency', 
        currency: 'BRL' 
    }).format(v || 0);

    // 3. NAVEGA√á√ÉO E MODAL
    function showTab(id, btn) {
        document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        
        if(id === 'categorias') carregarCategorias();
        if(id === 'produtos') carregarProdutos();
        if(id === 'pedidos') carregarPedidos();
    }

    function abrirModal(titulo, conteudo, acaoSalvar) {
        document.getElementById('modalTitle').innerText = titulo;
        document.getElementById('modalBody').innerHTML = conteudo;
        document.getElementById('modal').style.display = 'flex';
        const btnS = document.getElementById('btnSalvar');
        btnS.style.display = 'block';
        btnS.onclick = () => { acaoSalvar(); };
    }

    function fecharModal() { document.getElementById('modal').style.display = 'none'; }

    // 4. LOGICA DE PEDIDOS
   function carregarPedidos() {
    db.ref('orders').on('value', snap => {
        let html = '';
        snap.forEach(ped => {
            const p = ped.val();
            
            // Seguran√ßa para o nome
            const nomeExibicao = (p.cliente && p.cliente.nome) ? p.cliente.nome : (p.cliente || "Cliente");
            
            // Seguran√ßa para a moeda (evita R$ duplicado)
            let totalExibicao = p.total || "0,00";
            if (typeof totalExibicao === 'number') totalExibicao = fMoeda(totalExibicao);
            if (typeof totalExibicao === 'string' && !totalExibicao.includes("R$")) totalExibicao = `R$ ${totalExibicao}`;

            html += `
                <div class="card border-t-4 border-[#caa85c] flex flex-col justify-between p-4">
                    <div>
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] font-mono text-gray-500">#${ped.key.slice(-6).toUpperCase()}</span>
                            <span class="text-[10px] bg-[#222] px-2 py-1 rounded text-gray-300">${p.data || ''}</span>
                        </div>
                        <div class="font-bold text-lg leading-tight mb-1 text-white uppercase">${nomeExibicao}</div>
                        <div class="text-sm text-gray-400 mb-4">${p.whatsapp || 'Sem contato'}</div>
                        
                        <div class="bg-black/30 p-3 rounded-lg mb-4 border border-white/5">
                            <div class="flex justify-between text-xs opacity-70 mb-1">
                                <span>Itens:</span>
                                <span>${p.itens ? (p.itens.length || 0) : 0} pe√ßas</span>
                            </div>
                            <div class="flex justify-between font-bold text-[#caa85c]">
                                <span>Total:</span>
                                <span>${totalExibicao}</span>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="gerarRomaneio('${ped.key}', 'foto')" class="w-full bg-[#caa85c] text-black font-bold py-2 rounded text-xs uppercase transition">
                        Imprimir Romaneio
                    </button>
                </div>
            `;
        });
        document.getElementById('lista-pedidos').innerHTML = html;
    });
}
    // 5. SISTEMA DE ROMANEIOS LUXO
    function abrirOpcoesImpressao(id) {
        const body = `
            <div class="grid grid-cols-1 gap-3">
                <button class="p-4 bg-[#1a1a1a] border border-[#333] rounded-xl hover:border-[#caa85c] text-left transition" onclick="gerarRomaneio('${id}', 'simples')">
                    <div class="font-bold text-[#caa85c]">üìÑ Romaneio de Expedi√ß√£o</div>
                    <div class="text-[10px] opacity-60">Foco em log√≠stica: Nome, Endere√ßo, SKU e Qtd. (Sem Pre√ßos)</div>
                </button>
                <button class="p-4 bg-[#1a1a1a] border border-[#333] rounded-xl hover:border-[#caa85c] text-left transition" onclick="gerarRomaneio('${id}', 'completo')">
                    <div class="font-bold text-[#caa85c]">üìë Romaneio Financeiro Completo</div>
                    <div class="text-[10px] opacity-60">Dados completos, Pesos, Pre√ßos, Descontos e Totais.</div>
                </button>
                <button class="p-4 bg-[#1a1a1a] border border-[#333] rounded-xl hover:border-[#caa85c] text-left transition" onclick="gerarRomaneio('${id}', 'foto')">
                    <div class="font-bold text-[#caa85c]">üñºÔ∏è Romaneio Premium com Foto</div>
                    <div class="text-[10px] opacity-60">Visualiza√ß√£o das pe√ßas + Dados financeiros completos.</div>
                </button>
            </div>
        `;
        abrirModal("Selecione o Formato de Impress√£o", body, () => {});
        document.getElementById('btnSalvar').style.display = 'none'; // Esconde o bot√£o confirmar padr√£o
    }

    function salvarEmpresa() {
    const dados = {
        nome: document.getElementById('empNome').value,
        subtitulo: document.getElementById('empSub').value, // NOVO: Subt√≠tulo
        whats: document.getElementById('empWhats').value,
        descontoPix: document.getElementById('empDesc').value, // NOVO: % Desconto
        parcelas: document.getElementById('empParc').value
    };
    db.ref('settings/empresa').set(dados).then(() => alert('Configura√ß√µes salvas com sucesso!'));
}

   function gerarRomaneio(id, tipo) {
    db.ref('orders/' + id).once('value', s => {
        const p = s.val();
        if (!p) return;

        db.ref('settings/empresa').once('value', empSnap => {
            const emp = empSnap.val() || {};
            
            // LIMPEZA DE MOEDA GARANTIDA
            const formatarParaNumero = (str) => {
                if (!str) return 0;
                if (typeof str === 'number') return str;
                // Remove R$, espa√ßos e pontos de milhar, troca v√≠rgula por ponto
                let n = str.replace('R$', '').replace(/\s/g, '').replace(/\./g, '').replace(',', '.');
                return parseFloat(n) || 0;
            };

            const valorTotalCalculado = formatarParaNumero(p.total);
            const endereco = p.endereco || {};

            let html = `
            <div style="padding:20px; font-family:sans-serif; font-size:11px; color:#000;">
                
                <div style="text-align:center; border-bottom:2px solid #000; padding-bottom:10px; margin-bottom:15px;">
                    <h1 style="margin:0; font-size:20px;">${(emp.nome || 'ABELLA JOIAS').toUpperCase()}</h1>
                    <p style="margin:2px 0; font-weight:bold;">${(emp.subtitulo || 'ATACADO DE JOIAS NO BRUTO').toUpperCase()}</p>
                    <p>WhatsApp: ${emp.whats || ''} | Pedido: #${id.slice(-6).toUpperCase()} | Data: ${p.data}</p>
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <div style="flex: 1; border: 1px solid #ccc; border-radius: 6px; padding: 8px;">
                        <p style="margin:0 0 5px 0; color: #557799; font-weight: bold; font-size: 9px; text-transform: uppercase;">Dados do Cliente</p>
                        <strong>Nome:</strong> ${p.cliente.nome || p.cliente}<br>
                        <strong>WhatsApp:</strong> ${p.whatsapp || 'N/I'}
                    </div>
                    <div style="flex: 1; border: 1px solid #ccc; border-radius: 6px; padding: 8px;">
                        <p style="margin:0 0 5px 0; color: #557799; font-weight: bold; font-size: 9px; text-transform: uppercase;">Local de Entrega</p>
                        <strong>Logradouro:</strong> ${endereco.rua || ''}, ${endereco.num || ''}<br>
                        <strong>Bairro:</strong> ${endereco.bairro || ''} | <strong>Cidade:</strong> ${endereco.cidade || ''}
                    </div>
                </div>

                <table style="width:100%; border-collapse:collapse; margin-bottom:15px;">
                    <thead>
                        <tr style="background:#f2f2f2;">
                            <th style="border:1px solid #ddd; padding:5px; text-align:left;">Ref/SKU</th>
                            <th style="border:1px solid #ddd; padding:5px; text-align:left;">Descri√ß√£o</th>
                            <th style="border:1px solid #ddd; padding:5px; text-align:right;">Pre√ßo Un.</th>
                            <th style="border:1px solid #ddd; padding:5px; text-align:center;">Qtd</th>
                            <th style="border:1px solid #ddd; padding:5px; text-align:right;">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${p.itens.map(item => {
                            const precoUn = formatarParaNumero(item.precoFinal || item.price);
                            const qtd = item.quantidade || item.qtd || 0;
                            return `
                            <tr>
                                <td style="border:1px solid #ddd; padding:5px;">${item.sku || '---'}</td>
                                <td style="border:1px solid #ddd; padding:5px;">${item.name.toUpperCase()}</td>
                                <td style="border:1px solid #ddd; padding:5px; text-align:right;">${fMoeda(precoUn)}</td>
                                <td style="border:1px solid #ddd; padding:5px; text-align:center;">${qtd}</td>
                                <td style="border:1px solid #ddd; padding:5px; text-align:right;">${fMoeda(precoUn * qtd)}</td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>

                <div style="text-align:right; border-top:2px solid #000; padding-top:10px;">
                    <span style="font-size:14px; font-weight:bold;">VALOR TOTAL: ${fMoeda(valorTotalCalculado)}</span>
                </div>
            </div>`;

            document.getElementById('print-area').innerHTML = html;
            setTimeout(() => { window.print(); }, 500);
        });
    });
}
</script>
</body>
</html>

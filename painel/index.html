<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Abella Joias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f6f2; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Ajuste do Status */
        .status-Novo { background: #fffbeb; color: #92400e; border: 1px solid #fde68a; }
        .status-Separação { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; }
        .status-Enviado { background: #f5f3ff; color: #5b21b6; border: 1px solid #ddd6fe; }
        .status-Finalizado { background: #ecfdf5; color: #065f46; border: 1px solid #a7f3d0; }

        /* CONFIGURAÇÃO DE IMPRESSÃO (ROMANEIO) */
        @media print {
            body * { visibility: hidden; }
            #romaneio-print, #romaneio-print * { visibility: visible; }
            #romaneio-print { 
                position: absolute; 
                top: 0; 
                left: 0; 
                width: 100%; 
                padding: 20px;
                color: black !important;
            }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border-bottom: 1px solid #ddd; padding: 8px; text-align: left; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-black text-white p-6 shadow-lg border-b-4 border-[#d4af37]">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold tracking-tighter">ABELLA JOIAS</h1>
                <p class="text-[10px] text-[#d4af37] uppercase tracking-widest">Painel Administrativo</p>
            </div>
            <nav class="flex gap-4 md:gap-6 text-[10px] md:text-xs font-bold uppercase">
                <button onclick="showTab('pedidos')" class="hover:text-[#d4af37]">Pedidos</button>
                <button onclick="showTab('produtos')" class="hover:text-[#d4af37]">Produtos</button>
                <button onclick="showTab('categorias')" class="hover:text-[#d4af37]">Categorias</button>
                <button onclick="showTab('galvanicas')" class="hover:text-[#d4af37]">Galvânicas</button>
                <button onclick="showTab('config')" class="hover:text-[#d4af37]">Ajustes</button>
            </nav>
        </div>
    </header>

    <main class="flex-grow max-w-7xl w-full mx-auto p-4 md:p-8">
        
        <section id="pedidos" class="tab-content active">
            <h2 class="text-2xl font-bold mb-6">Gestão de Pedidos</h2>
            <div id="listaPedidos" class="grid gap-4"></div>
        </section>

        <section id="produtos" class="tab-content">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 mb-8">
                <h3 class="font-bold mb-4">Cadastrar Novo Produto</h3>
                <form id="formProduto" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <input type="text" id="pNome" placeholder="Nome do Produto" class="border p-2 rounded-lg text-sm" required>
                    <input type="text" id="pSku" placeholder="SKU" class="border p-2 rounded-lg text-sm" required>
                    <input type="number" step="0.01" id="pPreco" placeholder="Preço (R$)" class="border p-2 rounded-lg text-sm" required>
                    <input type="number" step="0.01" id="pPeso" placeholder="Peso (g)" class="border p-2 rounded-lg text-sm" required>
                    <select id="pCat" class="border p-2 rounded-lg text-sm"></select>
                    <input type="text" id="pImage" placeholder="URL da Imagem" class="border p-2 rounded-lg text-sm md:col-span-4">
                    <button type="submit" class="bg-black text-white p-2 rounded-lg font-bold hover:bg-[#d4af37]">SALVAR</button>
                </form>
            </div>
            <div id="gridProdutos" class="grid grid-cols-2 md:grid-cols-5 gap-4 text-xs"></div>
        </section>

        <section id="categorias" class="tab-content">
            <div class="bg-white p-6 rounded-2xl shadow-sm border max-w-lg">
                <h3 class="font-bold mb-4">Nova Categoria</h3>
                <input type="text" id="catNome" placeholder="Nome" class="w-full border p-2 rounded-lg mb-2">
                <input type="file" id="catFile" class="text-xs mb-4">
                <button onclick="salvarCategoria()" class="w-full bg-black text-white p-3 rounded-lg font-bold">CRIAR</button>
            </div>
            <div id="listaCategorias" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-8"></div>
        </section>

        <section id="galvanicas" class="tab-content">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 mb-8">
                <h3 class="font-bold mb-4 text-[#b8860b]">Cadastrar Galvânica Parceira</h3>
                <form id="formGalvanica" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" id="gNome" placeholder="Nome da Empresa" class="border p-2 rounded-lg text-sm" required>
                    <input type="text" id="gTel" placeholder="Telefone (Fixo)" class="border p-2 rounded-lg text-sm">
                    <input type="text" id="gWhats" placeholder="WhatsApp (55...)" class="border p-2 rounded-lg text-sm" required>
                    <input type="text" id="gEnd" placeholder="Endereço Completo" class="border p-2 rounded-lg text-sm md:col-span-3" required>
                    <textarea id="gDesc" placeholder="Descrição dos serviços..." class="border p-2 rounded-lg text-sm md:col-span-3"></textarea>
                    <input type="text" id="gLogo" placeholder="URL do Logotipo" class="border p-2 rounded-lg text-sm md:col-span-2">
                    <button type="submit" class="bg-[#d4af37] text-white p-2 rounded-lg font-bold">SALVAR PARCEIRO</button>
                </form>
            </div>
            <div id="listaGalvAdmin" class="grid gap-4"></div>
        </section>

        <section id="config" class="tab-content">
            <div class="bg-white p-8 rounded-2xl shadow-sm border max-w-2xl mx-auto">
                <h2 class="text-xl font-bold mb-6 italic">Configurações da Loja</h2>
                <div class="space-y-4">
                    <input type="text" id="confPhone" placeholder="WhatsApp Recebe Pedidos" class="w-full border p-3 rounded-xl">
                    <input type="number" id="confPix" placeholder="Desconto PIX %" class="w-full border p-3 rounded-xl">
                    <button onclick="salvarConfig()" class="w-full bg-black text-white py-4 rounded-xl font-bold uppercase">Salvar Alterações</button>
                </div>
            </div>
        </section>

    </main>

    <div id="romaneio-print" class="hidden">
        <div style="text-align:center; border-bottom: 2px solid #000; padding-bottom: 10px;">
            <h1 style="font-size: 24px; font-weight: bold; margin:0;">ABELLA JOIAS</h1>
            <p style="font-size: 12px; text-transform: uppercase;">Romaneio de Separação de Pedido</p>
        </div>
        <div id="romaneio-info" style="margin-top: 20px; font-size: 14px;"></div>
        <table id="romaneio-table">
            <thead>
                <tr>
                    <th style="width: 15%">SKU</th>
                    <th style="width: 55%">Produto</th>
                    <th style="width: 15%">Peso (g)</th>
                    <th style="width: 15%">Preço</th>
                </tr>
            </thead>
            <tbody id="romaneio-body"></tbody>
        </table>
        <div id="romaneio-footer" style="margin-top: 30px; text-align: right; border-top: 1px solid #000; padding-top: 10px;"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
            authDomain: "catalogo-abella-joias.firebaseapp.com",
            databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
            projectId: "catalogo-abella-joias",
            storageBucket: "catalogo-abella-joias.appspot.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const storage = firebase.storage();

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- PRODUTOS (Com Peso) ---
        document.getElementById('formProduto').onsubmit = (e) => {
            e.preventDefault();
            const p = {
                name: document.getElementById('pNome').value,
                sku: document.getElementById('pSku').value,
                price: parseFloat(document.getElementById('pPreco').value),
                weight: parseFloat(document.getElementById('pPeso').value),
                category: document.getElementById('pCat').value,
                image: document.getElementById('pImage').value || 'https://via.placeholder.com/300'
            };
            db.ref('products').push(p);
            e.target.reset();
        };

        db.ref('products').on('value', snap => {
            const grid = document.getElementById('gridProdutos');
            grid.innerHTML = '';
            snap.forEach(s => {
                const p = s.val();
                grid.innerHTML += `
                    <div class="bg-white border rounded p-2 relative group">
                        <img src="${p.image}" class="w-full aspect-square object-cover mb-2">
                        <p class="font-bold">${p.name}</p>
                        <p class="text-gray-400">SKU: ${p.sku} | ${p.weight}g</p>
                        <p class="text-[#b8860b] font-bold">R$ ${p.price.toFixed(2)}</p>
                        <button onclick="db.ref('products/${s.key}').remove()" class="absolute top-1 right-1 bg-red-500 text-white p-1 rounded opacity-0 group-hover:opacity-100">✕</button>
                    </div>
                `;
            });
        });

        // --- PEDIDOS & ROMANEIO (Ajustado) ---
        db.ref('orders').on('value', snap => {
            const container = document.getElementById('listaPedidos');
            container.innerHTML = '';
            snap.forEach(s => {
                const o = s.val();
                container.innerHTML += `
                    <div class="bg-white border rounded-xl p-4 flex justify-between items-center shadow-sm">
                        <div>
                            <p class="text-[10px] text-gray-400">${o.data}</p>
                            <h4 class="font-bold uppercase text-sm">${o.cliente}</h4>
                            <p class="text-xs text-blue-600 font-bold">R$ ${parseFloat(o.total).toFixed(2)}</p>
                        </div>
                        <div class="flex gap-2">
                            <select onchange="db.ref('orders/${s.key}').update({status:this.value})" class="status-${o.status || 'Novo'} text-[10px] font-bold p-2 rounded border-none">
                                <option ${o.status=='Novo'?'selected':''}>Novo</option>
                                <option ${o.status=='Separação'?'selected':''}>Separação</option>
                                <option ${o.status=='Enviado'?'selected':''}>Enviado</option>
                                <option ${o.status=='Finalizado'?'selected':''}>Finalizado</option>
                            </select>
                            <button onclick='imprimirRomaneio(${JSON.stringify(o)})' class="bg-black text-white px-3 py-2 rounded text-[10px] font-bold">ROMANEIO</button>
                        </div>
                    </div>
                `;
            });
        });

        function imprimirRomaneio(o) {
            document.getElementById('romaneio-info').innerHTML = `
                <p><strong>Cliente:</strong> ${o.cliente}</p>
                <p><strong>Data:</strong> ${o.data}</p>
                <p><strong>Pagamento:</strong> ${o.pagamento}</p>
            `;
            
            const tbody = document.getElementById('romaneio-body');
            tbody.innerHTML = '';
            let pesoTotal = 0;

            o.itens.forEach(i => {
                const p = i.weight || 0;
                pesoTotal += p;
                tbody.innerHTML += `
                    <tr>
                        <td>${i.sku}</td>
                        <td>${i.name}</td>
                        <td>${p.toFixed(2)}g</td>
                        <td>R$ ${i.price.toFixed(2)}</td>
                    </tr>
                `;
            });

            document.getElementById('romaneio-footer').innerHTML = `
                <p>Qtd Itens: ${o.itens.length}</p>
                <p><strong>PESO TOTAL: ${pesoTotal.toFixed(2)}g</strong></p>
                <p style="font-size: 18px;"><strong>VALOR TOTAL: R$ ${parseFloat(o.total).toFixed(2)}</strong></p>
            `;

            window.print();
        }

        // --- GALVÂNICAS (CRUD) ---
        document.getElementById('formGalvanica').onsubmit = (e) => {
            e.preventDefault();
            const g = {
                nome: document.getElementById('gNome').value,
                tel: document.getElementById('gTel').value,
                whats: document.getElementById('gWhats').value,
                end: document.getElementById('gEnd').value,
                desc: document.getElementById('gDesc').value,
                logo: document.getElementById('gLogo').value || 'https://via.placeholder.com/100'
            };
            db.ref('galvanicas').push(g);
            e.target.reset();
        };

        db.ref('galvanicas').on('value', snap => {
            const list = document.getElementById('listaGalvAdmin');
            list.innerHTML = '';
            snap.forEach(s => {
                const g = s.val();
                list.innerHTML += `
                    <div class="bg-white p-4 border rounded-lg flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <img src="${g.logo}" class="w-12 h-12 rounded object-contain border">
                            <div>
                                <p class="font-bold text-sm">${g.nome}</p>
                                <p class="text-[10px] text-gray-500">${g.end}</p>
                            </div>
                        </div>
                        <button onclick="db.ref('galvanicas/${s.key}').remove()" class="text-red-500 font-bold text-xs">REMOVER</button>
                    </div>
                `;
            });
        });

        // --- CATEGORIAS & CONFIG (Originais mantidos) ---
        async function salvarCategoria() {
            const nome = document.getElementById('catNome').value;
            const file = document.getElementById('catFile').files[0];
            if(!nome || !file) return alert("Preencha tudo");
            const ref = storage.ref(`cat/${file.name}`);
            await ref.put(file);
            const url = await ref.getDownloadURL();
            db.ref('categories').push({ name: nome, image: url });
            document.getElementById('catNome').value = "";
        }

        db.ref('categories').on('value', snap => {
            const list = document.getElementById('listaCategorias');
            const select = document.getElementById('pCat');
            list.innerHTML = ''; select.innerHTML = '';
            snap.forEach(s => {
                list.innerHTML += `<div class="bg-white border p-2 rounded text-center"><img src="${s.val().image}" class="h-20 w-full object-cover mb-1"><p class="text-[10px] uppercase font-bold">${s.val().name}</p></div>`;
                select.innerHTML += `<option value="${s.key}">${s.val().name}</option>`;
            });
        });

        function salvarConfig() {
            db.ref('settings').update({ 
                phone: document.getElementById('confPhone').value, 
                pix: document.getElementById('confPix').value 
            });
            alert("Ajustes salvos!");
        }

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Luxo | Abella Joias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8f6f2; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .gold-text { color: #d4af37; }
        .gold-bg { background-color: #d4af37; }
        
        /* Status do Pedido */
        .status-Novo { background: #FEF3C7; color: #92400e; }
        .status-Separação { background: #E0F2FE; color: #1e40af; }
        .status-Enviado { background: #EDE9FE; color: #5b21b6; }
        .status-Finalizado { background: #ECFDF5; color: #065f46; }

        @media print {
            body * { visibility: hidden; }
            #romaneio, #romaneio * { visibility: visible; }
            #romaneio { position: absolute; top: 0; left: 0; width: 100%; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-black text-white p-6 shadow-xl border-b-4 border-[#d4af37]">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold tracking-widest uppercase">Abella Joias</h1>
                <p class="text-[10px] text-[#d4af37] uppercase tracking-[0.3em]">Painel de Controle Administrativo</p>
            </div>
            <nav class="hidden md:flex gap-8 text-xs font-bold uppercase tracking-widest">
                <button onclick="showTab('pedidos')" class="hover:text-[#d4af37] transition">Pedidos</button>
                <button onclick="showTab('produtos')" class="hover:text-[#d4af37] transition">Produtos</button>
                <button onclick="showTab('galvanicas')" class="hover:text-[#d4af37] transition text-[#d4af37]">Galvânicas</button>
                <button onclick="showTab('config')" class="hover:text-[#d4af37] transition">Ajustes</button>
            </nav>
        </div>
    </header>

    <main class="flex-grow max-w-7xl w-full mx-auto p-4 md:p-8">
        
        <section id="galvanicas" class="tab-content active space-y-8">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                <h3 id="formGalvTitle" class="font-bold mb-6 uppercase text-sm tracking-widest gold-text">Cadastrar / Editar Galvânica Parceira</h3>
                <form id="formGalvanica" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="hidden" id="gId">
                    <input type="text" id="gNome" placeholder="Nome da Galvânica" class="border p-3 rounded-xl text-sm" required>
                    <input type="text" id="gWhats" placeholder="WhatsApp (Link ou Número)" class="border p-3 rounded-xl text-sm" required>
                    <input type="text" id="gTel" placeholder="Telefone de Contato" class="border p-3 rounded-xl text-sm">
                    <input type="text" id="gEnd" placeholder="Endereço Completo" class="border p-3 rounded-xl text-sm md:col-span-3" required>
                    <textarea id="gDesc" placeholder="Descrição dos serviços prestados..." class="border p-3 rounded-xl text-sm md:col-span-3" rows="3"></textarea>
                    
                    <div class="md:col-span-2">
                        <label class="text-[10px] uppercase font-bold text-gray-400 ml-2">Logo da Empresa (Upload)</label>
                        <input type="file" id="gFile" class="w-full border p-2 rounded-xl text-xs mt-1">
                    </div>

                    <div class="flex items-end gap-2">
                        <button type="submit" id="btnGalv" class="flex-grow bg-black text-white py-3 rounded-xl font-bold hover:bg-[#d4af37] transition uppercase text-xs">Salvar Galvânica</button>
                        <button type="button" onclick="cancelarEdicaoGalv()" id="btnCancelGalv" class="hidden bg-red-100 text-red-600 px-4 py-3 rounded-xl font-bold text-xs uppercase">Cancelar</button>
                    </div>
                </form>
            </div>

            <div class="space-y-4">
                <h4 class="font-bold text-gray-500 uppercase text-[11px] tracking-widest ml-2">Galvânicas Ativas no Site</h4>
                <div id="listaGalvAdmin" class="grid gap-4">
                    </div>
            </div>
        </section>

        <section id="produtos" class="tab-content space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border">
                <h3 class="font-bold mb-4 uppercase text-sm">Gerenciar Produtos</h3>
                <form id="formProduto" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="pNome" placeholder="Nome" class="border p-2 rounded-lg text-sm">
                    <input type="text" id="pSku" placeholder="SKU" class="border p-2 rounded-lg text-sm">
                    <input type="number" id="pPreco" placeholder="Preço (R$)" class="border p-2 rounded-lg text-sm">
                    <input type="number" id="pPeso" placeholder="Peso (g)" class="border p-2 rounded-lg text-sm">
                    <button type="submit" class="bg-black text-white p-2 rounded-lg col-span-1 md:col-span-4 font-bold">CADASTRAR PRODUTO</button>
                </form>
            </div>
            <div id="gridProdutos" class="grid grid-cols-2 md:grid-cols-5 gap-4"></div>
        </section>

        <section id="pedidos" class="tab-content">
            <h2 class="text-2xl font-bold mb-6">Gestão de Pedidos</h2>
            <div id="listaPedidos" class="space-y-4"></div>
        </section>

        <section id="config" class="tab-content">
            <div class="bg-white p-8 rounded-2xl shadow-sm border max-w-2xl mx-auto">
                <h2 class="text-xl font-bold mb-6 italic">Ajustes do Sistema</h2>
                <div class="space-y-4">
                    <input type="text" id="confPhone" placeholder="WhatsApp (ex: 5511999999999)" class="w-full border p-3 rounded-xl">
                    <input type="number" id="confPix" placeholder="Desconto PIX (%)" class="w-full border p-3 rounded-xl">
                    <input type="number" id="confParc" placeholder="Parcelas Máximas (ex: 3)" class="w-full border p-3 rounded-xl">
                    <button onclick="salvarConfig()" class="w-full bg-black text-white py-4 rounded-xl font-bold shadow-lg mt-4 hover:bg-[#d4af37] transition">SALVAR ALTERAÇÕES</button>
                </div>
            </div>
        </section>

    </main>

    <script>
        // Configuração Firebase (Verifique se é a sua correta)
        const firebaseConfig = {
            apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
            authDomain: "catalogo-abella-joias.firebaseapp.com",
            databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
            projectId: "catalogo-abella-joias",
            storageBucket: "catalogo-abella-joias.appspot.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const storage = firebase.storage();

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        /* =========================================
           GESTÃO DE GALVÂNICAS (CORRIGIDA)
        ========================================= */
        let editandoGalvId = null;

        document.getElementById('formGalvanica').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnGalv');
            btn.disabled = true;
            btn.innerText = "PROCESSANDO...";

            const file = document.getElementById('gFile').files[0];
            let logoUrl = "";

            // Se subir nova imagem
            if(file) {
                const ref = storage.ref(`galvanicas/${Date.now()}_${file.name}`);
                await ref.put(file);
                logoUrl = await ref.getDownloadURL();
            } else if (editandoGalvId) {
                // Se estiver editando e não subir imagem, tenta manter a anterior
                const snapshot = await db.ref(`galvanicas/${editandoGalvId}`).once('value');
                logoUrl = snapshot.val().logo || "";
            }

            const dados = {
                nome: document.getElementById('gNome').value,
                whatsapp: document.getElementById('gWhats').value,
                telefone: document.getElementById('gTel').value,
                endereco: document.getElementById('gEnd').value,
                descricao: document.getElementById('gDesc').value,
                logo: logoUrl
            };

            if(editandoGalvId) {
                await db.ref(`galvanicas/${editandoGalvId}`).update(dados);
                alert("Galvânica atualizada!");
            } else {
                await db.ref('galvanicas').push(dados);
                alert("Galvânica cadastrada com sucesso!");
            }

            cancelarEdicaoGalv();
            btn.disabled = false;
        };

        function editarGalvanica(id, g) {
            editandoGalvId = id;
            document.getElementById('gNome').value = g.nome;
            document.getElementById('gWhats').value = g.whatsapp;
            document.getElementById('gTel').value = g.telefone || "";
            document.getElementById('gEnd').value = g.endereco;
            document.getElementById('gDesc').value = g.descricao || "";
            
            document.getElementById('formGalvTitle').innerText = "Editando: " + g.nome;
            document.getElementById('btnGalv').innerText = "ATUALIZAR DADOS";
            document.getElementById('btnCancelGalv').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelarEdicaoGalv() {
            editandoGalvId = null;
            document.getElementById('formGalvanica').reset();
            document.getElementById('formGalvTitle').innerText = "Cadastrar / Editar Galvânica Parceira";
            document.getElementById('btnGalv').innerText = "Salvar Galvânica";
            document.getElementById('btnCancelGalv').classList.add('hidden');
        }

        // LER GALVÂNICAS DO BANCO (O MESMO QUE O SITE USA)
        db.ref('galvanicas').on('value', snap => {
            const list = document.getElementById('listaGalvAdmin');
            list.innerHTML = '';
            
            if(!snap.exists()) {
                list.innerHTML = '<p class="text-center text-gray-400 py-10">Nenhuma galvânica encontrada no banco de dados.</p>';
                return;
            }

            snap.forEach(s => {
                const g = s.val();
                list.innerHTML += `
                    <div class="bg-white border rounded-2xl p-5 flex justify-between items-center shadow-sm hover:shadow-md transition">
                        <div class="flex items-center gap-5">
                            <img src="${g.logo || 'https://via.placeholder.com/100'}" class="w-16 h-16 rounded-xl object-cover border shadow-inner">
                            <div>
                                <h4 class="font-bold text-gray-800">${g.nome}</h4>
                                <p class="text-[10px] text-gray-400 uppercase font-bold tracking-tighter">${g.endereco}</p>
                                <p class="text-xs gold-text mt-1 font-semibold">${g.whatsapp}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick='editarGalvanica("${s.key}", ${JSON.stringify(g)})' class="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl text-[10px] font-bold uppercase hover:bg-blue-600 hover:text-white transition">Editar</button>
                            <button onclick="if(confirm('Excluir esta galvânica?')) db.ref('galvanicas/${s.key}').remove()" class="bg-red-50 text-red-600 px-4 py-2 rounded-xl text-[10px] font-bold uppercase hover:bg-red-600 hover:text-white transition">Excluir</button>
                        </div>
                    </div>
                `;
            });
        });

        /* =========================================
           DEMAIS FUNÇÕES (PRODUTOS, CONFIG, PEDIDOS)
        ========================================= */
        // Ajuste de Configurações
        function salvarConfig() {
            db.ref('settings').update({
                phone: document.getElementById('confPhone').value,
                pix: parseInt(document.getElementById('confPix').value),
                installments: parseInt(document.getElementById('confParc').value)
            });
            alert("Configurações atualizadas!");
        }

        db.ref('settings').on('value', s => {
            const c = s.val(); if(c){
                document.getElementById('confPhone').value = c.phone || "";
                document.getElementById('confPix').value = c.pix || 0;
                document.getElementById('confParc').value = c.installments || 1;
            }
        });

        // Simpificação de Produtos para demonstração
        db.ref('products').on('value', snap => {
            const grid = document.getElementById('gridProdutos'); grid.innerHTML = '';
            snap.forEach(s => {
                const p = s.val();
                grid.innerHTML += `
                    <div class="bg-white border rounded-xl overflow-hidden p-2">
                        <img src="${p.image}" class="w-full aspect-square object-cover rounded-lg">
                        <p class="text-[10px] font-bold mt-2 truncate uppercase">${p.name}</p>
                        <p class="text-[9px] gold-text font-bold">R$ ${Number(p.price).toFixed(2)}</p>
                    </div>
                `;
            });
        });

    </script>
</body>
</html>

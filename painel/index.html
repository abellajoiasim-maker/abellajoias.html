<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Painel Admin ‚Ä¢ Abella Joias</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <style>
        body{background:#0b0b0b;color:#eee;font-family:Inter,Arial}
        nav button.active{border-color:#caa85c;color:#caa85c}
        section{display:none}
        section.active{display:block}
        .card{background:#141414;border:1px solid #2a2a2a;border-radius:16px;padding:14px}
        .grid{display:grid;gap:12px}
        @media(min-width:768px){.grid{grid-template-columns:repeat(4,1fr)}}
        @media(min-width:1200px){.grid{grid-template-columns:repeat(6,1fr)}}
        .btn{background:#222;border:1px solid #444;padding:6px 10px;border-radius:8px;font-size:12px;cursor:pointer}
        .btn-gold{background:#caa85c;color:#000;font-weight:700}
        .btn-red{border-color:#c33;color:#f77}
        
        /* MODAL */
        #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:100;align-items:center;justify-content:center;padding:15px}
        .modal-box{background:#141414;border:1px solid #333;border-radius:20px;width:100%;max-width:500px;padding:20px;max-height:90vh;overflow-y:auto}
        
        input,select{background:#111;border:1px solid #333;padding:10px;border-radius:8px;width:100%;margin-bottom:8px;color:#fff;outline:none}
        input:focus{border-color:#caa85c}
        .badge-desconto { position: absolute; top: 5px; right: 5px; background: #16a34a; color: white; font-size: 9px; font-weight: 800; padding: 2px 6px; border-radius: 4px; z-index: 10; }
        .preco-riscado { text-decoration: line-through; }
    </style>
</head>

<body>

<header class="p-5 text-center text-xl font-bold bg-black border-b border-[#222]">
    Painel Administrativo ‚Ä¢ Abella Joias
</header>

<nav class="flex gap-2 p-2 bg-[#111] overflow-x-auto sticky top-0 z-50">
    <button class="btn active" onclick="showTab('empresa',this)">Empresa</button>
    <button class="btn" onclick="showTab('pedidos',this)">Pedidos</button>
    <button class="btn" onclick="showTab('categorias',this)">Categorias</button>
    <button class="btn" onclick="showTab('produtos',this)">Produtos</button>
    <button class="btn" onclick="showTab('promocoes',this)">Promo√ß√µes</button>
</nav>

<main class="p-4">
    <section id="empresa" class="active">
        <div class="card max-w-md mx-auto">
            <label class="text-[10px] uppercase opacity-50">Nome da Loja</label>
            <input id="empNome">
            <label class="text-[10px] uppercase opacity-50">WhatsApp</label>
            <input id="empWhats">
            <label class="text-[10px] uppercase opacity-50">Desconto PIX %</label>
            <input id="empPix" type="number">
            <label class="text-[10px] uppercase opacity-50">M√°ximo de Parcelas</label>
            <input id="empParc" type="number">
            <button class="btn-gold w-full mt-2 py-3 rounded-xl" onclick="salvarEmpresa()">Salvar Configura√ß√µes</button>
        </div>
    </section>

    <section id="pedidos">
        <input type="text" id="inputBusca" oninput="filtrarPedidos()" placeholder="üîç Buscar por N¬∫ ou Cliente..." class="mb-4">
        <div id="listaPedidos" class="space-y-2"></div>
    </section>

    <section id="categorias">
        <div id="listaCategorias" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
    </section>

    <section id="produtos">
        <div id="produtosPorCategoria"></div>
    </section>

    <section id="promocoes">
        <div class="card max-w-md mx-auto">
            <h2 class="text-[#caa85c] font-bold mb-4 uppercase text-xs">Ajuste R√°pido de Categorias</h2>
            <div id="listaPromocoes" class="space-y-3"></div>
            <button class="btn-gold mt-6 w-full py-3" onclick="salvarPromos()">Salvar Todos os Descontos</button>
            <hr class="my-6 border-[#222]">
            <button class="btn border-blue-500 text-blue-400 w-full py-3" onclick="abrirPainelPromocoes()">Gerenciar Promo√ß√£o Global</button>
        </div>
    </section>
</main>

<div id="modal">
    <div class="modal-box">
        <h2 id="modalTitle" class="text-lg font-bold text-[#caa85c] mb-4"></h2>
        <div id="modalBody"></div>
        <div class="flex gap-2 mt-6">
            <button class="btn flex-1" onclick="fecharModal()">Cancelar</button>
            <button id="modalConfirm" class="btn-gold flex-[2] py-2 rounded-lg">Salvar Altera√ß√µes</button>
        </div>
    </div>
</div>

<script>
// CONFIGURA√á√ÉO FIREBASE
const firebaseConfig = {
    apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
    databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* NAVEGA√á√ÉO */
function showTab(id, btn) {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

/* L√ìGICA DO MODAL */
function abrirModal(titulo, html, onConfirm) {
    document.getElementById('modalTitle').innerText = titulo;
    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('modal').style.display = 'flex';
    document.getElementById('modalConfirm').onclick = () => { onConfirm(); fecharModal(); };
}
function fecharModal() { document.getElementById('modal').style.display = 'none'; }

/* EMPRESA */
db.ref('settings').on('value', s => {
    const v = s.val() || {};
    document.getElementById('empNome').value = v.nome || '';
    document.getElementById('empWhats').value = v.whatsapp || '';
    document.getElementById('empPix').value = v.pix || 0;
    document.getElementById('empParc').value = v.parcelas || 1;
});
function salvarEmpresa() {
    db.ref('settings').update({
        nome: empNome.value,
        whatsapp: empWhats.value,
        pix: +empPix.value,
        parcelas: +empParc.value
    }).then(() => alert('Configura√ß√µes salvas!'));
}

/* CATEGORIAS & PROMO√á√ïES */
db.ref('categories').on('value', s => {
    const listaCat = document.getElementById('listaCategorias');
    const listaPromos = document.getElementById('listaPromocoes');
    listaCat.innerHTML = ''; listaPromos.innerHTML = '';

    s.forEach(c => {
        const d = c.val(); const id = c.key;
        const foto = d.image || 'https://via.placeholder.com/150?text=Sem+Foto';

        listaCat.innerHTML += `
            <div class="card flex items-center gap-3">
                <img src="${foto}" class="w-12 h-12 rounded-lg object-cover border border-[#333]">
                <div class="flex-1">
                    <b class="text-[11px] uppercase text-white">${d.name}</b>
                    <div class="flex gap-1 mt-1">
                        <button class="btn text-[9px] py-1 bg-blue-900/40 border-blue-700" onclick="editarCategoria('${id}')">Editar</button>
                        <button class="btn btn-red text-[9px] py-1" onclick="excluir('categories','${id}')">‚úï</button>
                    </div>
                </div>
            </div>`;

        listaPromos.innerHTML += `
            <div class="flex justify-between items-center p-2 bg-[#0a0a0a] rounded-lg border border-[#222]">
                <span class="text-[11px] font-medium text-gray-300 uppercase">${d.name}</span>
                <div class="flex items-center gap-2">
                    <input type="number" id="promo-${id}" value="${d.discount || 0}" class="w-14 mb-0 text-center text-xs p-1 bg-black">
                    <span class="text-[#caa85c] text-xs">%</span>
                </div>
            </div>`;
    });
});

/* PRODUTOS (AGRUPADOS COM MAIOR DESCONTO) */
db.ref('products').on('value', snapProdutos => {
    const container = document.getElementById('produtosPorCategoria');
    container.innerHTML = '';
    const map = {};

    Promise.all([
        db.ref('settings/promocao').once('value'),
        db.ref('categories').once('value')
    ]).then(([snapPromoGlobal, snapCats]) => {
        const promoGeral = snapPromoGlobal.val() || { ativa: false, porcentagem: 0 };
        const categorias = snapCats.val() || {};

        snapProdutos.forEach(p => {
            const v = p.val(); v.id = p.key;
            if (!map[v.category]) map[v.category] = [];
            map[v.category].push(v);
        });

        Object.keys(map).forEach(catID => {
            const nomeCat = categorias[catID]?.name || catID;
            container.innerHTML += `<h3 class="text-[#caa85c] mt-8 mb-4 uppercase text-[10px] font-bold tracking-widest border-b border-[#caa85c]/20 pb-2">${nomeCat}</h3><div class="grid" id="grid-${catID}"></div>`;
            
            const grid = document.getElementById(`grid-${catID}`);
            map[catID].forEach(p => {
                const precoBase = parseFloat(p.price || 0);
                const descInd = parseInt(p.discount || 0);
                const descCat = parseInt(categorias[catID]?.discount || 0);
                const descGlob = promoGeral.ativa ? parseInt(promoGeral.porcentagem || 0) : 0;
                const melhorDesc = Math.max(descInd, descCat, descGlob);

                let precoHtml = `<div class="text-sm font-bold text-white">R$ ${precoBase.toFixed(2)}</div>`;
                let badge = '';

                if (melhorDesc > 0) {
                    const precoFinal = precoBase * (1 - (melhorDesc / 100));
                    badge = `<div class="badge-desconto">-${melhorDesc}%</div>`;
                    precoHtml = `<div class="text-[10px] preco-riscado text-gray-500">R$ ${precoBase.toFixed(2)}</div><div class="text-sm font-bold text-green-500">R$ ${precoFinal.toFixed(2)}</div>`;
                }

                grid.innerHTML += `
                    <div class="card relative bg-[#111]">
                        ${badge}
                        <img src="${p.image}" class="w-full h-28 object-cover rounded-lg mb-2 border border-[#222]">
                        <div class="text-[10px] truncate text-gray-300 mb-1">${p.name}</div>
                        ${precoHtml}
                        <div class="flex gap-1 mt-3">
                            <button class="btn flex-1 py-1" onclick="editarProduto('${p.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-red px-2" onclick="excluir('products','${p.id}')">‚úï</button>
                        </div>
                    </div>`;
            });
        });
    });
});

/* === GEST√ÉO DE PEDIDOS (SISTEMA COMPLETO) === */

db.ref('orders').on('value', s => {
    const lista = document.getElementById('listaPedidos');
    
    // 1. Injeta a Barra de Busca se n√£o existir
    if (!document.getElementById('inputBusca')) {
        lista.insertAdjacentHTML('beforebegin', `
            <input type="text" id="inputBusca" oninput="filtrarPedidos()" 
            placeholder="üîç Buscar por N¬∫ ou Nome..." 
            class="w-full p-2 mb-3 bg-[#111] border border-[#333] rounded text-xs text-white outline-none focus:border-[#caa85c]">
        `);
    }

    lista.innerHTML = '';
    if (!s.exists()) return;

    s.forEach(o => {
        const p = o.val();
        if (p.arquivado) return; // Regra da Lixeira (Oculta mas n√£o deleta)

        lista.innerHTML += `
        <div class="card flex justify-between items-center mb-2 pedido-card">
            <div>
                <div class="font-bold text-[#caa85c] text-[11px]">#${p.numeroPedido || '---'}</div>
                <div class="text-[9px] opacity-30 uppercase">${o.key.substring(0,8)}</div>
                <div class="font-bold text-gray-200 text-sm">${p.cliente}</div>
                <div class="text-xs text-green-500 font-bold">R$ ${parseFloat(p.total||0).toFixed(2)}</div>
            </div>
            <div class="flex gap-1">
                <button class="btn bg-blue-900/50 border-blue-700 px-2 py-1 text-[10px]" onclick="verDetalhesPedido('${o.key}')">Ver / Imprimir</button>
                <button class="btn px-2 py-1 text-[10px]" onclick="editarPedido('${o.key}')">‚úèÔ∏è</button>
                <button class="btn bg-orange-600/20 border-orange-600 text-orange-500 px-2 py-1 text-[10px]" title="Arquivar" onclick="cancelarPedido('${o.key}')">üì¶</button>
                <button class="btn btn-red px-2 py-1 text-[10px]" title="Excluir Permanente" onclick="excluirReal('${o.key}')">‚úï</button>
            </div>
        </div>`;
    });
});

/* === FUN√á√ïES DE APOIO E GEST√ÉO === */

function filtrarPedidos() {
    const termo = document.getElementById('inputBusca').value.toLowerCase();
    const cards = document.querySelectorAll('.pedido-card');
    cards.forEach(card => {
        const textoCard = card.innerText.toLowerCase();
        card.style.display = textoCard.includes(termo) ? 'flex' : 'none';
    });
}

function excluirReal(id) {
    if(confirm("‚ö†Ô∏è AVISO: Isso apagar√° o pedido permanentemente do Banco de Dados. Deseja continuar?")) {
        db.ref('orders/' + id).remove();
    }
}

function cancelarPedido(id) {
    if(confirm("Deseja arquivar este pedido? Ele sair√° da lista principal, mas ficar√° salvo no banco.")) {
        db.ref('orders/' + id).update({ status: 'Arquivado', arquivado: true });
    }
}

function verDetalhesPedido(id) {
    db.ref('orders/' + id).once('value').then(s => {
        const p = s.val();
        const e = p.endereco_detalhado || {};
        
        const subtotalItens = Object.values(p.itens||{}).reduce((acc, i) => acc + (i.preco * i.qtd), 0);
        const descPromo = parseFloat(p.descontoPromocional || 0);
        const descPix = parseFloat(p.descontoPix || 0);
        const totalFinal = parseFloat(p.total || 0);

        let itensHtml = '';
        Object.values(p.itens||{}).forEach(i => {
            itensHtml += `
            <div class="flex justify-between items-center text-[11px] border-b border-[#222] py-2">
                <div class="flex items-center gap-2">
                    <img src="${i.image}" class="w-8 h-8 rounded object-cover border border-[#333]">
                    <span>${i.qtd}x ${i.nome}</span>
                </div>
                <span class="font-bold">R$ ${(i.preco * i.qtd).toFixed(2)}</span>
            </div>`;
        });

        abrirModal('Detalhes & Romaneio', `
            <div class="text-[11px] space-y-3">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <b class="text-[#caa85c] block border-b border-[#333] mb-1">DADOS CLIENTE</b>
                        <p>${p.cliente}<br>Whats: ${p.whatsapp || 'S/N'}</p>
                    </div>
                    <div>
                        <b class="text-[#caa85c] block border-b border-[#333] mb-1">ENTREGA</b>
                        <p>${e.rua||'A retirar'}, ${e.num||''}<br>${e.bairro||''} - ${e.cidade||''}</p>
                    </div>
                </div>
                
                <b class="text-[#caa85c] block border-b border-[#333] mb-1">ITENS DO PEDIDO</b>
                <div class="max-h-48 overflow-y-auto pr-2">${itensHtml}</div>
                
                <div class="bg-[#0a0a0a] p-3 rounded border border-[#222] space-y-1 mt-2">
                    <div class="flex justify-between opacity-60"><span>Subtotal Bruto:</span> <span>R$ ${subtotalItens.toFixed(2)}</span></div>
                    ${descPromo > 0 ? `<div class="flex justify-between text-orange-400"><span>Descontos:</span> <span>- R$ ${descPromo.toFixed(2)}</span></div>` : ''}
                    ${descPix > 0 ? `<div class="flex justify-between text-green-500"><span>Desconto PIX:</span> <span>- R$ ${descPix.toFixed(2)}</span></div>` : ''}
                    <div class="flex justify-between text-lg font-bold text-white border-t border-[#333] pt-1 mt-1">
                        <span>TOTAL:</span> <span class="text-[#caa85c]">R$ ${totalFinal.toFixed(2)}</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-2 mt-4">
                    <button onclick="gerarRomaneio('${id}','simples')" class="btn bg-gray-800 hover:bg-gray-700 py-2">üìÑ Romaneio Simples (Lista)</button>
                    <button onclick="gerarRomaneio('${id}','completo')" class="btn bg-blue-900/40 border-blue-700 py-2">üñ®Ô∏è Romaneio Completo (Peso/SKU)</button>
                    <button onclick="gerarRomaneio('${id}','cliente')" class="btn bg-green-900/40 border-green-700 py-2 font-bold text-green-400">üì∏ Romaneio com Fotos (WhatsApp)</button>
                </div>
            </div>
        `, null);
    });
}

function editarPedido(id) {
    db.ref('orders/' + id).once('value').then(s => {
        const p = s.val();
        const e = p.endereco_detalhado || {local:'', rua:'', num:'', bairro:'', cidade:''};
        
        let itensEditHtml = '';
        Object.entries(p.itens || {}).forEach(([k, i]) => {
            itensEditHtml += `
            <div class="item-edit-row border-b border-[#222] py-2 flex items-center justify-between" data-id="${k}">
                <div class="text-[10px] text-[#caa85c] w-1/2">${i.nome}</div>
                <div class="flex gap-2 items-center">
                    <input type="number" class="edit-qtd w-16 mb-0 text-center bg-black border-[#333]" value="${i.qtd}" oninput="recalcularTotalEdicao()" data-preco="${i.preco}">
                    <span class="text-[9px] opacity-40">x R$ ${i.preco}</span>
                </div>
            </div>`;
        });

        abrirModal('Editar Pedido', `
            <div class="space-y-2 text-left max-h-[70vh] overflow-y-auto pr-2">
                <label class="text-[10px] text-[#caa85c] uppercase font-bold">Dados do Cliente</label>
                <input id="editCli" value="${p.cliente}">
                
                <label class="text-[10px] text-[#caa85c] uppercase font-bold mt-2 block">Endere√ßo</label>
                <input id="editEndRua" value="${e.rua || ''}" placeholder="Rua/Av">
                <div class="flex gap-2">
                    <input id="editEndNum" value="${e.num || ''}" placeholder="N¬∫" class="w-24">
                    <input id="editEndBairro" value="${e.bairro || ''}" placeholder="Bairro" class="flex-1">
                </div>
                <input id="editEndCidade" value="${e.cidade || ''}" placeholder="Cidade">

                <label class="text-[10px] text-[#caa85c] uppercase font-bold mt-4 block">Itens do Pedido</label>
                <div id="containerItensEdit">${itensEditHtml}</div>
                
                <div class="mt-4 p-3 bg-black rounded border border-[#caa85c]/30">
                    <label class="text-[10px] text-green-500 font-bold uppercase">Valor Final do Pedido</label>
                    <div class="flex items-center">
                         <span class="text-xl mr-2 text-green-500">R$</span>
                         <input id="editTotal" type="number" step="0.01" value="${p.total}" class="text-xl font-bold text-green-500 bg-transparent border-none w-full outline-none">
                    </div>
                </div>
            </div>
        `, () => {
            const novosItens = {...p.itens};
            document.querySelectorAll('.item-edit-row').forEach(row => {
                const iId = row.dataset.id;
                const nQtd = parseInt(row.querySelector('.edit-qtd').value);
                if(nQtd > 0) {
                    if(novosItens[iId]) novosItens[iId].qtd = nQtd;
                } else {
                    delete novosItens[iId];
                }
            });

            db.ref('orders/' + id).update({
                cliente: document.getElementById('editCli').value,
                total: parseFloat(document.getElementById('editTotal').value),
                itens: novosItens,
                endereco_detalhado: { 
                    rua: document.getElementById('editEndRua').value, 
                    num: document.getElementById('editEndNum').value,
                    bairro: document.getElementById('editEndBairro').value,
                    cidade: document.getElementById('editEndCidade').value
                }
            }).then(() => alert("Pedido atualizado com sucesso!"));
        });
    });
}

function recalcularTotalEdicao() {
    let soma = 0;
    document.querySelectorAll('.item-edit-row').forEach(row => {
        const q = parseInt(row.querySelector('.edit-qtd').value) || 0;
        const p = parseFloat(row.querySelector('.edit-qtd').dataset.preco) || 0;
        soma += (q * p);
    });
    document.getElementById('editTotal').value = soma.toFixed(2);
}

function gerarRomaneio(id, tipo) {
    db.ref('orders/'+id).once('value').then(s => {
        const p = s.val();
        if(!p) return;
        
        const e = p.endereco_detalhado || {};
        const data = new Date().toLocaleString('pt-BR');
        const telefoneLoja = document.getElementById('empWhats').value; 

        db.ref('settings').once('value').then(set => {
            const config = set.val() || { pix: 0 };
            const valorTotal = parseFloat(p.total) || 0;
            const desconto = parseFloat(p.descontoPix || 0);
            const subtotalGeral = valorTotal + desconto;

            const mostrarFoto = (tipo === 'cliente');

            let html = `<html><head><title>Romaneio ${tipo.toUpperCase()}</title><style>
                @page { size: A4; margin: 1cm; }
                body { font-family: 'Segoe UI', Arial; color: #333; margin: 0; padding: 0; }
                .header { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid #caa85c; padding-bottom: 8px; margin-bottom: 15px; }
                .logo-area h1 { margin: 0; color: #caa85c; font-size: 24px; }
                .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; font-size: 11px; }
                .info-box { padding: 10px; border: 1px solid #eee; background: #fafafa; }
                table { width: 100%; border-collapse: collapse; }
                th { background: #f2f2f2; padding: 8px; border: 1px solid #ccc; font-size: 10px; }
                td { padding: 8px; border: 1px solid #eee; font-size: 11px; }
                .col-center { text-align: center; }
                .col-right { text-align: right; }
                .img-item { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
                .financeiro-box { width: 260px; border: 1px solid #eee; padding: 10px; margin-left: auto; margin-top: 15px; }
                .fin-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 11px; }
                .total-final { font-size: 16px; font-weight: bold; border-top: 2px solid #caa85c; padding-top: 5px; color: #000; }
            </style></head><body>
            
            <div class="header">
                <div class="logo-area">
                    <h1>ABELLA JOIAS</h1>
                    <div style="font-size:11px;">Whats: ${telefoneLoja}</div>
                </div>
                <div style="text-align:right; font-size: 11px;">
                    <strong>PEDIDO:</strong> #${id.substring(0,8).toUpperCase()}<br><strong>DATA:</strong> ${data}
                </div>
            </div>

            <div class="info-grid">
                <div class="info-box">
                    <strong>CLIENTE:</strong> ${p.cliente}<br>
                    <strong>CONTATO:</strong> ${p.whatsapp || 'N/A'}<br>
                    <strong>FORMA PAGTO:</strong> ${p.pagamento || 'A combinar'}
                </div>
                <div class="info-box">
                    <strong>ENDERE√áO DE ENTREGA:</strong><br>
                    ${e.rua || 'A retirar'}, ${e.num || ''}<br>
                    ${e.bairro || ''} - ${e.cidade || ''}
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        ${mostrarFoto ? '<th style="width: 70px;">FOTO</th>' : ''}
                        <th>DESCRI√á√ÉO DO ITEM</th>
                        <th style="width: 50px;">QTD</th>
                        ${tipo === 'completo' ? '<th style="width: 80px;">PESO T.</th>' : ''}
                        <th style="width: 90px;">SUBTOTAL</th>
                    </tr>
                </thead>
                <tbody>`;
            
            let pesoTotalGeral = 0;
            Object.values(p.itens || {}).forEach(i => {
                const qtd = parseInt(i.qtd) || 0;
                const vU = parseFloat(i.preco || 0);
                const pU = parseFloat(i.peso || 0);
                const vT = vU * qtd;
                const pT = pU * qtd;
                pesoTotalGeral += pT;

                html += `<tr>
                    ${mostrarFoto ? `<td class="col-center"><img src="${i.image}" class="img-item"></td>` : ''}
                    <td>${i.nome}</td>
                    <td class="col-center">${qtd}</td>
                    ${tipo === 'completo' ? `<td class="col-center">${pT.toFixed(2)}g</td>` : ''}
                    <td class="col-right">R$ ${vT.toFixed(2)}</td>
                </tr>`;
            });

            html += `</tbody></table>

            <div class="financeiro-box">
                ${tipo === 'completo' ? `<div class="fin-row"><span>Peso Total:</span> <strong>${pesoTotalGeral.toFixed(2)}g</strong></div>` : ''}
                <div class="fin-row"><span>Subtotal:</span> <span>R$ ${subtotalGeral.toFixed(2)}</span></div>
                <div class="fin-row" style="color:green;"><span>Desconto:</span> <span>- R$ ${desconto.toFixed(2)}</span></div>
                <div class="fin-row total-final"><span>TOTAL FINAL:</span> <span>R$ ${valorTotal.toFixed(2)}</span></div>
            </div>

            <script>window.onload = function() { setTimeout(() => { window.print(); window.close(); }, 700); }<\/script>
            </body></html>`;

            const win = window.open('','_blank');
            win.document.write(html);
            win.document.close();
        });
    });
}
}
</script>
</body>
</html>

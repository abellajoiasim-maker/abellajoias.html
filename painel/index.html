<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Administrativo ‚Ä¢ Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#0b0b0b;color:#eee;font-family:Inter,Arial;margin:0}
nav button.active{border-bottom:2px solid #caa85c;color:#caa85c}
section{display:none;min-height:300px}
section.active{display:block}
.card{background:#141414;border:1px solid #2a2a2a;border-radius:16px;padding:14px}
.btn{background:#222;border:1px solid #444;padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer}
.btn-gold{background:#caa85c;color:#000;font-weight:700;padding:10px;border-radius:8px}
input,select{background:#111;border:1px solid #333;padding:8px;border-radius:8px;width:100%;margin-bottom:8px;color:#fff;outline:none}
#print-area{display:none}
@media print{ body *{visibility:hidden} #print-area,#print-area *{visibility:visible} #print-area{position:absolute;top:0;left:0;width:100%;background:#fff;color:#000;display:block} }
</style>
</head>
<body>

<header class="p-5 text-center text-xl font-bold bg-black border-b border-[#222] text-[#caa85c] tracking-widest uppercase">
  Abella Joias ‚Ä¢ Painel de Controlo
</header>

<nav class="flex gap-2 p-2 bg-[#111] sticky top-0 z-50 overflow-x-auto">
  <button type="button" class="btn active" onclick="showTab('empresa', this)">Empresa</button>
  <button type="button" class="btn" onclick="showTab('categorias', this)">Categorias</button>
  <button type="button" class="btn" onclick="showTab('produtos', this)">Produtos</button>
  <button type="button" class="btn" onclick="showTab('promocoes', this)">Promo√ß√µes</button>
  <button type="button" class="btn" onclick="showTab('pedidos', this)">Pedidos</button>
</nav>

<main class="p-6 max-w-4xl mx-auto">
  <section id="empresa" class="active">
    <div class="card space-y-3">
      <h2 class="text-[#caa85c] font-bold uppercase text-sm">Configura√ß√£o da Loja</h2>
      <input id="empNome" placeholder="Nome da Empresa">
      <input id="empSub" placeholder="Slogan / Subt√≠tulo">
      <input id="empWhats" placeholder="WhatsApp da Loja (ex: 5511...)">
      <div class="grid grid-cols-2 gap-2">
        <input id="empDesc" type="number" placeholder="Desc. PIX %">
        <input id="empParc" type="number" placeholder="Parcelas M√°x">
      </div>
      <button class="btn-gold w-full" onclick="salvarEmpresa()">GUARDAR ALTERA√á√ïES</button>
    </div>
  </section>

  <section id="categorias">
    <div id="listaCategorias" class="grid gap-2"></div>
  </section>

  <section id="produtos">
    <div id="listaProdutos" class="grid gap-2"></div>
  </section>

  <section id="promocoes">
    <div class="flex gap-2 mb-4">
      <button class="btn flex-1 py-3" onclick="listarPromos('categories')">üè∑Ô∏è Por Categorias</button>
      <button class="btn flex-1 py-3" onclick="listarPromos('products')">üíé Por Produtos</button>
    </div>
    <div id="listaPromocoes" class="grid gap-2"></div>
  </section>

  <section id="pedidos">
    <div id="listaPedidos" class="grid gap-4"></div>
  </section>
</main>

<div id="print-area"></div>

<script>
/* INICIALIZA√á√ÉO FIREBASE */
if (!firebase.apps.length) {
  firebase.initializeApp({
    apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
    databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com"
  });
}
const db = firebase.database();
const fMoeda = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);

/* NAVEGA√á√ÉO ENTRE ABAS */
function showTab(id, btn) {
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (btn) btn.classList.add('active');

  if (id === 'categorias') carregarCategorias();
  if (id === 'produtos') carregarProdutos();
  if (id === 'pedidos') carregarPedidos();
}

/* GEST√ÉO DA EMPRESA */
function salvarEmpresa() {
  db.ref('settings/empresa').set({
    nome: document.getElementById('empNome').value,
    subtitulo: document.getElementById('empSub').value,
    whats: document.getElementById('empWhats').value,
    descontoPix: +document.getElementById('empDesc').value || 0,
    parcelas: +document.getElementById('empParc').value || 0
  }).then(() => alert('Configura√ß√µes guardadas!'));
}

function carregarEmpresa() {
  db.ref('settings/empresa').once('value', s => {
    const v = s.val();
    if (v) {
      document.getElementById('empNome').value = v.nome || '';
      document.getElementById('empSub').value = v.subtitulo || '';
      document.getElementById('empWhats').value = v.whats || '';
      document.getElementById('empDesc').value = v.descontoPix || 0;
      document.getElementById('empParc').value = v.parcelas || 0;
    }
  });
}

/* GEST√ÉO DE CATEGORIAS */
function carregarCategorias() {
  const lista = document.getElementById('listaCategorias');
  db.ref('categories').once('value', s => {
    lista.innerHTML = '';
    s.forEach(child => {
      const c = child.val();
      lista.innerHTML += `
        <div class="card flex justify-between items-center mb-1">
          <b class="uppercase text-sm">${c.name}</b>
          <div class="flex gap-2">
            <button class="btn text-blue-400" onclick="editarCat('${child.key}', '${c.name}')">‚úé</button>
            <button class="btn text-red-500" onclick="if(confirm('Eliminar?')) db.ref('categories/${child.key}').remove().then(carregarCategorias)">X</button>
          </div>
        </div>`;
    });
  });
}

function editarCat(id, nome) {
  const n = prompt("Novo nome da categoria:", nome);
  if (n) db.ref('categories/' + id).update({ name: n }).then(carregarCategorias);
}

/* GEST√ÉO DE PRODUTOS (CORRIGIDA) */
let cacheProdutos = [];
function carregarProdutos() {
  const lista = document.getElementById('listaProdutos');
  lista.innerHTML = '<p class="text-center p-4">A carregar produtos...</p>';
  db.ref('products').once('value', s => {
    cacheProdutos = [];
    s.forEach(p => cacheProdutos.push({ key: p.key, ...p.val() }));
    renderizarProdutosPorCategoria();
  });
}

function renderizarProdutosPorCategoria() {
  const lista = document.getElementById('listaProdutos');
  lista.innerHTML = '';
  
  db.ref('categories').once('value', catSnap => {
    catSnap.forEach(c => {
      const catKey = c.key;
      const catNome = c.val().name;
      // FILTRO POR ID (AQUI ESTAVA O ERRO)
      const prods = cacheProdutos.filter(p => p.category === catKey);

      lista.innerHTML += `
        <div class="mb-2">
          <div onclick="toggleCat('${catKey}')" class="flex justify-between p-3 bg-[#1a1a1a] rounded-lg cursor-pointer border-l-4 border-[#caa85c]">
            <b class="text-xs uppercase">${catNome} (${prods.length})</b>
            <span id="seta-${catKey}">‚ñº</span>
          </div>
          <div id="cat-${catKey}" class="hidden flex flex-col gap-1 mt-1 pl-2 border-l border-[#333]">
            ${prods.map(p => `
              <div class="card flex justify-between py-1 px-2 text-[11px] bg-[#0d0d0d]">
                <span><b class="text-[#caa85c]">[${p.sku || '---'}]</b> ${p.name}</span>
                <button class="text-red-500 font-bold" onclick="removerProd('${p.key}')">√ó</button>
              </div>
            `).join('')}
          </div>
        </div>`;
    });
  });
}

function toggleCat(key) {
  const el = document.getElementById('cat-' + key);
  const seta = document.getElementById('seta-' + key);
  el.classList.toggle('hidden');
  seta.innerText = el.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
}

function removerProd(id) {
  if (confirm("Deseja eliminar este produto?")) {
    db.ref('products/' + id).remove().then(carregarProdutos);
  }
}

/* PROMO√á√ïES (SISTEMA DE EDI√á√ÉO R√ÅPIDA) */
function listarPromos(tipo) {
  const container = document.getElementById('listaPromocoes');
  container.innerHTML = '<p class="text-center p-4">A carregar...</p>';
  db.ref(tipo).once('value', s => {
    container.innerHTML = '';
    s.forEach(child => {
      const item = child.val();
      const nome = tipo === 'categories' ? item.name : `[${item.sku}] ${item.name}`;
      container.innerHTML += `
        <div class="card flex justify-between items-center" style="border-left: 4px solid ${item.promoCor || '#caa85c'}">
          <b class="text-[10px] uppercase flex-1">${nome}</b>
          <div class="flex items-center gap-2">
            <input type="number" class="w-12 p-1 text-center bg-black text-xs" value="${item.promoPct || 0}" 
                   onchange="db.ref('${tipo}/${child.key}').update({promoPct: +this.value})">
            <input type="text" class="w-14 p-1 text-center bg-black text-xs" value="${item.promoTexto || 'OFF'}" 
                   onchange="db.ref('${tipo}/${child.key}').update({promoTexto: this.value})">
            <input type="color" class="w-6 h-6 p-0 border-none bg-transparent" value="${item.promoCor || '#caa85c'}" 
                   onchange="db.ref('${tipo}/${child.key}').update({promoCor: this.value})">
          </div>
        </div>`;
    });
  });
}

/* PEDIDOS */
function carregarPedidos() {
  db.ref('orders').on('value', s => {
    const lista = document.getElementById('listaPedidos');
    lista.innerHTML = '';
    if (!s.exists()) { lista.innerHTML = '<p class="text-center text-gray-500 mt-10">Sem pedidos no momento.</p>'; return; }
    
    s.forEach(ped => {
      const p = ped.val();
      lista.innerHTML += `
        <div class="card border-l-4 border-[#caa85c]">
          <div class="flex justify-between items-start mb-2 text-xs">
             <div><b class="uppercase text-[#caa85c]">${p.cliente?.nome || p.cliente}</b><br><small>${p.data || ''}</small></div>
             <span class="bg-black px-2 py-1 rounded border border-gray-800">${p.pagamento}</span>
          </div>
          <div class="flex gap-1">
            <button class="btn flex-1" onclick="alert('Funcionalidade de Romaneio')">Imprimir</button>
            <button class="btn text-red-500" onclick="if(confirm('Eliminar pedido?')) db.ref('orders/${ped.key}').remove()">X</button>
          </div>
          <div class="text-right mt-2 font-bold text-[#caa85c]">${fMoeda(p.total)}</div>
        </div>`;
    });
  });
}

/* INICIALIZA√á√ÉO */
window.addEventListener('load', () => {
  carregarEmpresa();
  showTab('empresa', document.querySelector('nav button'));
});
</script>
</body>
</html>

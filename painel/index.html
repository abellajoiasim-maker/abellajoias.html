<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Administrativo ‚Ä¢ Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#0b0b0b;color:#eee;font-family:Inter,Arial;margin:0}
nav button.active{border-bottom:2px solid #caa85c;color:#caa85c}
section{display:none;min-height:300px}
section.active{display:block}
.card{background:#141414;border:1px solid #2a2a2a;border-radius:16px;padding:14px}
.btn{background:#222;border:1px solid #444;padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer}
.btn-gold{background:#caa85c;color:#000;font-weight:700;padding:10px;border-radius:8px}
input,select{background:#111;border:1px solid #333;padding:8px;border-radius:8px;width:100%;margin-bottom:8px;color:#fff;outline:none}
#print-area{display:none}
@media print{ body *{visibility:hidden} #print-area,#print-area *{visibility:visible} #print-area{position:absolute;top:0;left:0;width:100%;background:#fff;color:#000;display:block} }
</style>
</head>
<body>

<header class="p-5 text-center text-xl font-bold bg-black border-b border-[#222] text-[#caa85c] tracking-widest uppercase">
  Abella Joias ‚Ä¢ Painel de Controlo
</header>

<nav class="flex gap-2 p-2 bg-[#111] sticky top-0 z-50 overflow-x-auto">
  <button type="button" class="btn active" onclick="showTab('empresa', this)">Empresa</button>
  <button type="button" class="btn" onclick="showTab('categorias', this)">Categorias</button>
  <button type="button" class="btn" onclick="showTab('produtos', this)">Produtos</button>
  <button type="button" class="btn" onclick="showTab('promocoes', this)">Promo√ß√µes</button>
  <button type="button" class="btn" onclick="showTab('pedidos', this)">Pedidos</button>
</nav>

<main class="p-6 max-w-4xl mx-auto">
  <section id="empresa" class="active">
    <div class="card space-y-3">
      <h2 class="text-[#caa85c] font-bold uppercase text-sm">Configura√ß√£o da Loja</h2>
      <input id="empNome" placeholder="Nome da Empresa">
      <input id="empSub" placeholder="Slogan / Subt√≠tulo">
      <input id="empWhats" placeholder="WhatsApp da Loja (ex: 5511...)">
      <div class="grid grid-cols-2 gap-2">
        <input id="empDesc" type="number" placeholder="Desc. PIX %">
        <input id="empParc" type="number" placeholder="Parcelas M√°x">
      </div>
      <button class="btn-gold w-full" onclick="salvarEmpresa()">GUARDAR ALTERA√á√ïES</button>
    </div>
  </section>

  <section id="categorias">
    <div class="card mb-4">
        <input id="newCatName" placeholder="Nome da Nova Categoria">
        <button class="btn-gold w-full" onclick="novaCategoria()">+ CADASTRAR CATEGORIA</button>
    </div>
    <div id="listaCategorias" class="grid gap-2"></div>
  </section>

  <section id="produtos">
    <div id="listaProdutos" class="grid gap-2"></div>
  </section>

  <section id="promocoes">
    <div class="flex gap-2 mb-4">
      <button class="btn flex-1 py-3" onclick="listarPromos('categories')">üè∑Ô∏è Categorias</button>
      <button class="btn flex-1 py-3" onclick="listarPromos('products')">üíé Produtos</button>
    </div>
    <div id="listaPromocoes" class="grid gap-2"></div>
  </section>

  <section id="pedidos">
    <div id="listaPedidos" class="grid gap-4"></div>
  </section>
</main>

<div id="editorPedido" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
  <div class="bg-[#111] w-full max-w-4xl rounded-2xl p-5 overflow-auto max-h-[90vh] border border-[#333]">
    <h2 class="text-[#caa85c] font-bold text-lg mb-3 uppercase">Editar Pedido (Atacado)</h2>

    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <h3 class="font-bold mb-2 text-xs text-gray-400">CLIENTE</h3>
        <input id="edClienteNome" placeholder="Nome do Cliente">
        <input id="edClienteTel" placeholder="WhatsApp">
      </div>
      <div>
        <h3 class="font-bold mb-2 text-xs text-gray-400">ENTREGA</h3>
        <input id="edEntregaNome" placeholder="Local">
        <input id="edRua" placeholder="Rua">
        <div class="grid grid-cols-2 gap-2">
            <input id="edNum" placeholder="N¬∫">
            <input id="edBairro" placeholder="Bairro">
        </div>
        <input id="edCidade" placeholder="Cidade">
      </div>
    </div>

    <h3 class="font-bold mt-4 mb-2 text-xs text-[#caa85c]">ITENS DO PEDIDO</h3>
    <div id="edItens" class="space-y-2"></div>
    <button class="btn w-full mt-2 border-dashed border-gray-600" onclick="adicionarItemEditor()">+ Adicionar Item</button>

    <h3 class="font-bold mt-4 mb-2 text-xs text-[#caa85c]">DESCONTOS</h3>
    <div class="grid grid-cols-2 gap-3">
      <input id="edDescPromo" type="number" placeholder="Desconto Promo√ß√£o (R$)">
      <input id="edDescPix" type="number" placeholder="Desconto PIX (R$)">
    </div>

    <div class="flex justify-between mt-6 pt-4 border-t border-[#222]">
      <button class="btn px-6" onclick="fecharEditorPedido()">CANCELAR</button>
      <button class="btn-gold px-10" onclick="salvarPedidoEditado()">SALVAR PEDIDO</button>
    </div>
  </div>
</div>

<script>
/* INICIALIZA√á√ÉO FIREBASE */
if (!firebase.apps.length) {
  firebase.initializeApp({
    apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
    databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com"
  });
}
const db = firebase.database();
const fMoeda = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);

/* NAVEGA√á√ÉO */
function showTab(id, btn) {
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (btn) btn.classList.add('active');

  if (id === 'categorias') carregarCategorias();
  if (id === 'produtos') carregarProdutos();
  if (id === 'pedidos') carregarPedidos();
}

/* GEST√ÉO DE PRODUTOS - CORRE√á√ÉO DEFINITIVA */
function carregarProdutos() {
    const lista = document.getElementById('listaProdutos');
    lista.innerHTML = '<p class="text-center p-4">Carregando categorias e produtos...</p>';

    // 1. Pegamos as categorias primeiro
    db.ref('categories').once('value', snapshotCats => {
        // 2. Pegamos os produtos
        db.ref('products').once('value', snapshotProds => {
            const produtos = [];
            snapshotProds.forEach(p => { produtos.push({ key: p.key, ...p.val() }); });

            lista.innerHTML = '';
            
            snapshotCats.forEach(cat => {
                const catKey = cat.key;
                const catNome = cat.val().name;
                // Filtra produtos que pertencem a esta categoria
                const prodsDaCat = produtos.filter(p => p.category === catKey);

                if (prodsDaCat.length > 0) {
                    let htmlProds = prodsDaCat.map(p => `
                        <div class="card flex justify-between items-center py-2 px-3 text-[11px] bg-[#0d0d0d] mb-1">
                            <div class="flex items-center gap-3">
                                <img src="${p.image || 'https://via.placeholder.com/50'}" class="w-10 h-10 object-cover rounded border border-[#333]">
                                <div class="flex flex-col">
                                    <span><b class="text-[#caa85c]">[${p.sku || '---'}]</b> ${p.name}</span>
                                    <span class="text-gray-400">${fMoeda(p.price)}</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button class="text-blue-400" onclick="editarProduto('${p.key}')">‚úé</button>
                                <button class="text-red-500 font-bold p-1" onclick="removerProd('${p.key}')">√ó</button>
                            </div>
                        </div>
                    `).join('');

                    lista.innerHTML += `
                        <div class="mb-4">
                            <div onclick="toggleCat('${catKey}')" class="flex justify-between p-3 bg-[#1a1a1a] rounded-lg cursor-pointer border-l-4 border-[#caa85c]">
                                <b class="text-xs uppercase">${catNome} (${prodsDaCat.length})</b>
                                <span id="seta-${catKey}">‚ñº</span>
                            </div>
                            <div id="cat-${catKey}" class="hidden mt-2 space-y-1">
                                ${htmlProds}
                            </div>
                        </div>`;
                }
            });
        });
    });
}

function toggleCat(key) {
  const el = document.getElementById('cat-' + key);
  const seta = document.getElementById('seta-' + key);
  if(el) el.classList.toggle('hidden');
  if(seta) seta.innerText = el.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
}

/* EDITOR DE PEDIDO (ATACADO) */
let pedidoEditando = null;
function abrirEditorPedido(id){
  db.ref('orders/'+id).once('value',s=>{
    const p=s.val(); if(!p) return alert("Pedido n√£o encontrado");
    pedidoEditando = id;
    document.getElementById('edClienteNome').value = p.cliente?.nome || p.cliente || '';
    document.getElementById('edClienteTel').value  = p.cliente?.telefone || p.whatsapp || '';
    document.getElementById('edEntregaNome').value = p.entrega?.nome || '';
    document.getElementById('edRua').value = p.entrega?.rua || p.endereco?.rua || '';
    document.getElementById('edNum').value = p.entrega?.num || p.endereco?.num || '';
    document.getElementById('edBairro').value = p.entrega?.bairro || p.endereco?.bairro || '';
    document.getElementById('edCidade').value = p.entrega?.cidade || p.endereco?.cidade || '';
    document.getElementById('edDescPromo').value = p.descontoPromo || 0;
    document.getElementById('edDescPix').value   = p.descontoPix || 0;
    document.getElementById('edItens').innerHTML='';
    const itens = Array.isArray(p.itens) ? p.itens : Object.values(p.itens || {});
    itens.forEach((i,idx)=>addItemEditor(i,idx));
    document.getElementById('editorPedido').classList.remove('hidden');
  });
}

function addItemEditor(i={},idx=Date.now()){
  const div = document.createElement('div');
  div.className = "card bg-black/40 border-[#222]";
  div.innerHTML = `
    <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
        <input placeholder="SKU" value="${i.sku||''}">
        <input placeholder="Nome" value="${i.name||''}">
        <input type="number" placeholder="Peso" value="${i.peso||i.weight||0}">
        <input type="number" placeholder="Pre√ßo" value="${i.price||0}">
        <input type="number" placeholder="Qtd" value="${i.quantidade||i.qtd||1}">
    </div>
    <button class="text-red-500 text-[10px] uppercase font-bold mt-1" onclick="this.parentElement.remove()">Remover Item</button>`;
  document.getElementById('edItens').appendChild(div);
}

function adicionarItemEditor() { addItemEditor(); }
function fecharEditorPedido() { document.getElementById('editorPedido').classList.add('hidden'); }

function salvarPedidoEditado(){
  const itens=[];
  let total=0, pesoTotal=0;
  document.querySelectorAll('#edItens .card').forEach(c=>{
    const ins = c.querySelectorAll('input');
    const i={ sku:ins[0].value, name:ins[1].value, peso:+ins[2].value||0, price:+ins[3].value||0, quantidade:+ins[4].value||1 };
    total+=(i.price*i.quantidade); pesoTotal+=(i.peso*i.quantidade);
    itens.push(i);
  });
  const dp = +document.getElementById('edDescPromo').value||0;
  const dx = +document.getElementById('edDescPix').value||0;
  db.ref('orders/'+pedidoEditando).update({
    cliente:{ nome:document.getElementById('edClienteNome').value, telefone:document.getElementById('edClienteTel').value },
    entrega:{ nome:document.getElementById('edEntregaNome').value, rua:document.getElementById('edRua').value, num:document.getElementById('edNum').value, bairro:document.getElementById('edBairro').value, cidade:document.getElementById('edCidade').value },
    itens, pesoTotal, descontoPromo:dp, descontoPix:dx, total: (total-dp-dx), ajustadoManualmente:true
  }).then(()=>{ alert("Pedido salvo!"); fecharEditorPedido(); carregarPedidos(); });
}

/* CATEGORIAS E EMPRESA */
function carregarCategorias() {
  const lista = document.getElementById('listaCategorias');
  db.ref('categories').once('value', s => {
    lista.innerHTML = '';
    s.forEach(child => {
      lista.innerHTML += `
        <div class="card flex justify-between items-center mb-1">
          <b class="uppercase text-xs">${child.val().name}</b>
          <div class="flex gap-2">
            <button class="btn text-blue-400" onclick="editarCat('${child.key}', '${child.val().name}')">‚úé</button>
            <button class="btn text-red-500" onclick="if(confirm('Eliminar?')) db.ref('categories/${child.key}').remove().then(carregarCategorias)">X</button>
          </div>
        </div>`;
    });
  });
}

function novaCategoria() {
    const nome = document.getElementById('newCatName').value;
    if(!nome) return alert("Digite o nome");
    db.ref('categories').push({ name: nome }).then(() => {
        document.getElementById('newCatName').value = '';
        carregarCategorias();
    });
}

function carregarEmpresa() {
  db.ref('settings/empresa').once('value', s => {
    const v = s.val() || {};
    document.getElementById('empNome').value = v.nome || '';
    document.getElementById('empSub').value = v.subtitulo || '';
    document.getElementById('empWhats').value = v.whats || '';
    document.getElementById('empDesc').value = v.descontoPix || 0;
    document.getElementById('empParc').value = v.parcelas || 0;
  });
}

function salvarEmpresa() {
  db.ref('settings/empresa').set({
    nome: document.getElementById('empNome').value,
    subtitulo: document.getElementById('empSub').value,
    whats: document.getElementById('empWhats').value,
    descontoPix: +document.getElementById('empDesc').value || 0,
    parcelas: +document.getElementById('empParc').value || 0
  }).then(() => alert('Salvo!'));
}

function carregarPedidos() {
  db.ref('orders').on('value', s => {
    const lista = document.getElementById('listaPedidos');
    lista.innerHTML = '';
    if (!s.exists()) return lista.innerHTML = '<p class="text-center text-gray-500 mt-10">Sem pedidos.</p>';
    s.forEach(ped => {
      const p = ped.val();
      lista.innerHTML += `
        <div class="card border-l-4 border-[#caa85c]">
          <div class="flex justify-between items-start mb-2 text-xs">
             <div><b class="uppercase text-[#caa85c]">${p.cliente?.nome || p.cliente}</b><br><small>${p.data || ''}</small></div>
             <span class="bg-black px-2 py-1 rounded border border-gray-800">${p.pagamento || 'WhatsApp'}</span>
          </div>
          <button class="btn-gold w-full text-xs py-2" onclick="abrirEditorPedido('${ped.key}')">EDITAR / VER DETALHES</button>
          <div class="text-right mt-2 font-bold text-[#caa85c]">${fMoeda(p.total)}</div>
        </div>`;
    });
  });
}
  function gerarRomaneio(id, tipo = 1) {
  db.ref('orders/' + id).once('value', s => {
    const p = s.val();
    if (!p) return;

    db.ref('settings/empresa').once('value', e => {
      const emp = e.val() || {};

      let html = `
      <style>
        .print-body { font-family: Arial, sans-serif; color:#000; padding:20px; font-size:11px; }
        .lux-head { text-align:center; border-bottom:2px solid #A68966; padding-bottom:10px; margin-bottom:15px; }
        .lux-head h1 { margin:0; color:#A68966; font-size:22px; }
        .grid-dados { display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:15px; }
        table { width:100%; border-collapse:collapse; margin-top:10px; font-size:11px; }
        table th { background:#f5f5f5; text-align:left; border-bottom:1px solid #000; padding:4px; }
        table td { border-bottom:1px solid #ddd; padding:4px; }
        .totais { text-align:right; margin-top:15px; font-size:12px; }
        .img-mini { width:40px; height:40px; object-fit:cover; border-radius:4px; }
      </style>

      <div class="print-body">
        <div class="lux-head">
          <h1>${emp.nome || 'Abella Joias'}</h1>
          <p>${emp.subtitulo || ''}<br>WhatsApp: ${emp.whats || ''}</p>
        </div>

        <div class="grid-dados">
          <div>
            <b>DADOS DO CLIENTE</b><br>
            Nome: ${p.cliente?.nome || p.cliente || ''}<br>
            WhatsApp: ${p.cliente?.telefone || p.whatsapp || ''}
          </div>
          <div>
            <b>LOCAL DE ENTREGA</b><br>
            ${p.endereco?.nome || 'Residencial'}<br>
            ${p.endereco?.rua || ''}, ${p.endereco?.num || ''}<br>
            ${p.endereco?.bairro || ''} - ${p.endereco?.cidade || ''}
          </div>
        </div>

        <table>
          <thead>
            <tr>
              ${tipo === 3 ? '<th>Foto</th>' : ''}
              <th>SKU</th>
              <th>Produto</th>
              ${tipo > 1 ? '<th>Peso U.</th><th>Pre√ßo U.</th>' : ''}
              <th>Qtd</th>
              ${tipo > 1 ? '<th>Subtotal</th>' : ''}
            </tr>
          </thead>
          <tbody>
      `;

      let subtotalCalc = 0;
      let pesoTotalCalc = 0;

      (p.itens || []).forEach(i => {
        const preco = Number(i.precoFinal || i.price || 0);
        const qtd = Number(i.quantidade || 1);
        const pesoKg = (Number(i.peso || 0) / 1000);
        const subtotalItem = preco * qtd;

        subtotalCalc += subtotalItem;
        pesoTotalCalc += pesoKg * qtd;

        html += `
          <tr>
            ${tipo === 3 ? `<td><img src="${i.image || ''}" class="img-mini"></td>` : ''}
            <td>${i.sku || '---'}</td>
            <td>${i.name || ''}</td>
            ${tipo > 1 ? `<td>${pesoKg.toFixed(3)} Kg</td><td>${fMoeda(preco)}</td>` : ''}
            <td>${qtd}</td>
            ${tipo > 1 ? `<td>${fMoeda(subtotalItem)}</td>` : ''}
          </tr>
        `;
      });

      html += `</tbody></table>`;

      if (tipo > 1) {
        html += `
          <div class="totais">
            Subtotal: ${fMoeda(p.subtotal ?? subtotalCalc)}<br>
            Peso Total: ${pesoTotalCalc.toFixed(2)} Kg<br>
            Descontos: - ${fMoeda(p.descontos || 0)}<br>
            <b style="font-size:16px; color:#A68966">TOTAL: ${fMoeda(p.total)}</b>
            ${p.obs ? `<div style="margin-top:6px;font-size:10px;"><b>Obs:</b> ${p.obs}</div>` : ''}
          </div>
        `;
      }

      html += `</div>`;

      document.getElementById('print-area').innerHTML = html;

      setTimeout(() => {
        window.print();
      }, 500);
    });
  });
}

function carregarEmpresaSeExistir() {
  db.ref('settings/empresa').once('value', s => {
    const v = s.val();
    if (!v) return;

    const empNome  = document.getElementById('empNome');
    const empSub   = document.getElementById('empSub');
    const empWhats = document.getElementById('empWhats');
    const empDesc  = document.getElementById('empDesc');
    const empParc  = document.getElementById('empParc');

    if (empNome)  empNome.value  = v.nome || '';
    if (empSub)   empSub.value   = v.subtitulo || '';
    if (empWhats) empWhats.value = v.whats || '';
    if (empDesc)  empDesc.value  = v.descontoPix || 0;
    if (empParc)  empParc.value  = v.parcelas || 0;
  });
}
 function editarProduto(id) {
  db.ref('products/' + id).once('value', s => {
    const p = s.val();
    if (!p) return alert("Produto n√£o encontrado.");

    const novoNome = prompt("Nome do produto:", p.name || "");
    const novoPreco = prompt("Pre√ßo do produto:", p.price || 0);
    const novoSku = prompt("SKU do produto:", p.sku || "");

    if (novoNome !== null) {
      db.ref('products/' + id).update({
        name: novoNome,
        price: Number(novoPreco) || 0,
        sku: novoSku
      }).then(() => {
        alert("Produto atualizado!");
        carregarProdutos(); // Atualiza a tela
      });
    }
  });
}
function editarCategoria(id, nomeAtual) {
  const novoNome = prompt("Novo nome da categoria:", nomeAtual);
  if (!novoNome || novoNome === nomeAtual) return;

  db.ref('categories/' + id).update({ name: novoNome })
    .then(() => {
      alert("Categoria atualizada!");
      carregarCategorias(); // Atualiza lista
    })
    .catch(() => alert("Erro ao atualizar categoria."));
}


function listarPromos(tipo) {
  const container = document.getElementById('listaPromocoes');
  db.ref(tipo).once('value', s => {
    container.innerHTML = '';
    s.forEach(child => {
      const item = child.val();
      container.innerHTML += `
        <div class="card flex justify-between items-center mb-1">
          <b class="text-[10px] uppercase">${item.name || item.sku}</b>
          <input type="number" class="w-16 p-1 bg-black text-xs" value="${item.promoPct || 0}" 
                 onchange="db.ref('${tipo}/${child.key}').update({promoPct: +this.value})">
        </div>`;
    });
  });
}

window.addEventListener('load', () => { carregarEmpresa(); showTab('empresa', document.querySelector('nav button')); });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel Administrativo • Abella Joias</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <style>
        body{background:#0b0b0b;color:#eee;font-family:Inter,Arial;margin:0}
        nav button.active{border-bottom:2px solid #caa85c;color:#caa85c}
        section{display:none}
        section.active{display:block}
        .card{background:#141414;border:1px solid #2a2a2a;border-radius:12px;padding:15px}
        .btn-gold{background:#caa85c;color:#000;font-weight:700;padding:10px;border-radius:8px;cursor:pointer}
        input{background:#111;border:1px solid #333;padding:10px;border-radius:8px;width:100%;margin-bottom:10px;color:#fff}
        
        #print-area { display: none; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; display: block; color: #000; background: #fff; }
        }
    </style>
</head>
<body>

<header class="p-4 text-center text-lg font-bold bg-black border-b border-[#222] text-[#caa85c] uppercase tracking-widest">
    Abella Joias • Painel de Controle
</header>

<nav class="flex gap-4 p-3 bg-[#111] sticky top-0 z-50 justify-center border-b border-[#222]">
    <button class="text-xs font-bold uppercase" onclick="showTab('empresa', this)">Empresa</button>
    <button class="text-xs font-bold uppercase" onclick="showTab('categorias', this)">Categorias</button>
    <button class="text-xs font-bold uppercase" onclick="showTab('produtos', this)">Produtos</button>
    <button class="text-xs font-bold uppercase active" onclick="showTab('pedidos', this)">Pedidos</button>
</nav>

<main class="p-4 max-w-5xl mx-auto">
    <section id="empresa">
        <div class="card max-w-md mx-auto">
            <h2 class="text-[#caa85c] font-bold mb-4 uppercase text-sm">Dados da Loja para Romaneio</h2>
            <input id="empNome" placeholder="Nome da Empresa">
            <input id="empWhats" placeholder="WhatsApp da Loja">
            <input id="empSub" placeholder="Subtítulo/Slogan">
            <button class="btn-gold w-full mt-2" onclick="salvarEmpresa()">SALVAR DADOS</button>
        </div>
    </section>

    <section id="categorias">
        <div id="listaCategorias" class="grid gap-2"></div>
    </section>

    <section id="produtos">
        <div id="listaProdutos" class="grid gap-2"></div>
    </section>

    <section id="pedidos" class="active">
        <div id="listaPedidos" class="grid gap-3"></div>
    </section>
</main>

<div id="editorPedido" class="hidden fixed inset-0 bg-black/95 flex items-center justify-center z-50 p-4">
    <div class="bg-[#111] w-full max-w-5xl rounded-xl p-6 overflow-auto max-h-[95vh] border border-[#333]">
        <div class="flex justify-between items-center mb-6 border-b border-[#222] pb-4">
            <h2 class="text-[#caa85c] font-bold text-lg uppercase">Negociação de Pedido</h2>
            <button onclick="fecharEditorPedido()" class="bg-red-600 text-white px-4 py-1 rounded text-xs">FECHAR</button>
        </div>

        <div id="edItens" class="space-y-2 mb-6"></div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-black/40 p-5 rounded-xl border border-[#222]">
            <div>
                <label class="text-[10px] text-[#caa85c] font-bold uppercase">Desconto Promoção (R$)</label>
                <input id="edDescPromo" type="number" step="0.01" class="!mb-0 text-lg text-red-400 font-bold">
            </div>
            <div>
                <label class="text-[10px] text-[#caa85c] font-bold uppercase">Desconto PIX (R$)</label>
                <input id="edDescPix" type="number" step="0.01" class="!mb-0 text-lg text-red-400 font-bold">
            </div>
            <div>
                <label class="text-[10px] text-gray-400 font-bold uppercase">Valor do Frete (R$)</label>
                <input id="edValorFrete" type="number" step="0.01" class="!mb-0 text-lg">
            </div>
        </div>

        <div class="flex flex-wrap gap-3 mt-8 justify-center">
            <button class="btn-gold bg-blue-700 text-white border-none px-6" onclick="gerarRomaneio(pedidoEditando, 1)">CONFERÊNCIA</button>
            <button class="btn-gold bg-blue-900 text-white border-none px-6" onclick="gerarRomaneio(pedidoEditando, 2)">ROMANEIO</button>
            <button class="btn-gold bg-purple-900 text-white border-none px-6" onclick="gerarRomaneio(pedidoEditando, 3)">FOTOS</button>
            <button class="btn-gold px-12" onclick="salvarPedidoEditado()">SALVAR E ATUALIZAR</button>
        </div>
    </div>
</div>

<div id="print-area"></div>

<script>
/* CONFIGURAÇÃO */
const firebaseConfig = {
    apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
    databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const fMoeda = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);

let pedidoEditando = null;

function showTab(id, btn) {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
}

function carregarPedidos() {
    db.ref('orders').on('value', s => {
        const lista = document.getElementById('listaPedidos');
        lista.innerHTML = '';
        s.forEach(ped => {
            const p = ped.val();
            lista.innerHTML += `
                <div class="card flex justify-between items-center border-l-4 border-[#caa85c]">
                    <div>
                        <b class="text-[#caa85c] uppercase text-sm">${p.cliente?.nome || p.cliente}</b><br>
                        <small class="text-gray-500">${p.data} • <b>Total: ${fMoeda(p.total)}</b></small>
                    </div>
                    <button class="btn-gold text-[10px] px-4" onclick="abrirEditorPedido('${ped.key}')">ABRIR NEGOCIAÇÃO</button>
                </div>`;
        });
    });
}

/* ESTA É A FUNÇÃO QUE RECUPERA OS DESCONTOS */
function abrirEditorPedido(id) {
    db.ref('orders/' + id).once('value', s => {
        const p = s.val(); if (!p) return;
        pedidoEditando = id;
        
        // Preenche os campos com o que está no banco (se estiver vazio, coloca 0)
        document.getElementById('edDescPromo').value = p.descontoPromo || 0;
        document.getElementById('edDescPix').value = p.descontoPix || 0;
        document.getElementById('edValorFrete').value = p.entrega?.valorFrete || p.valorFrete || 0;

        document.getElementById('edItens').innerHTML = '';
        const itens = Array.isArray(p.itens) ? p.itens : Object.values(p.itens || {});
        itens.forEach(i => {
            const div = document.createElement('div');
            div.className = "flex gap-2 p-2 bg-black/40 rounded border border-[#222]";
            div.innerHTML = `<input class="flex-1 !mb-0" value="${i.name}" readonly> <input class="w-24 !mb-0 text-center" value="${fMoeda(i.price)}">`;
            document.getElementById('edItens').appendChild(div);
        });
        
        document.getElementById('editorPedido').classList.remove('hidden');
    });
}

function salvarPedidoEditado() {
    const dp = Number(document.getElementById('edDescPromo').value);
    const dx = Number(document.getElementById('edDescPix').value);
    const vf = Number(document.getElementById('edValorFrete').value);

    // Lógica para recalcular o total no momento de salvar
    db.ref('orders/' + pedidoEditando).once('value', s => {
        const p = s.val();
        const itens = Array.isArray(p.itens) ? p.itens : Object.values(p.itens || {});
        const subtotal = itens.reduce((acc, i) => acc + (i.price * (i.quantidade || i.qtd || 1)), 0);
        
        db.ref('orders/' + pedidoEditando).update({
            descontoPromo: dp,
            descontoPix: dx,
            "entrega/valorFrete": vf,
            total: (subtotal - dp - dx + vf)
        }).then(() => {
            alert("Valores atualizados!");
            fecharEditorPedido();
        });
    });
}

function gerarRomaneio(id, tipo) {
    db.ref('orders/' + id).once('value', s => {
        const p = s.val();
        db.ref('settings/empresa').once('value', e => {
            const emp = e.val() || { nome: 'Abella Joias', whats: '19 98820-7658' };
            
            let html = `
            <div style="font-family: Arial; padding: 20px;">
                <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px;">
                    <h1 style="margin:0;">${emp.nome}</h1>
                    <p style="margin:0;">WhatsApp: ${emp.whats} | ${emp.subtitulo || ''}</p>
                </div>
                <h3>PEDIDO: ${p.cliente?.nome || p.cliente}</h3>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <thead><tr style="background: #eee;">
                        ${tipo === 3 ? '<th>Foto</th>' : ''}
                        <th style="border: 1px solid #000; padding: 5px;">Produto</th>
                        <th style="border: 1px solid #000; padding: 5px;">Qtd</th>
                        <th style="border: 1px solid #000; padding: 5px;">Preço</th>
                    </tr></thead>
                    <tbody>`;

            const itens = Array.isArray(p.itens) ? p.itens : Object.values(p.itens || {});
            let subtotal = 0;
            itens.forEach(i => {
                subtotal += (i.price * (i.quantidade || i.qtd || 1));
                html += `<tr>
                    ${tipo === 3 ? `<td style="border: 1px solid #000; text-align:center;"><img src="${i.image}" style="width:50px;"></td>` : ''}
                    <td style="border: 1px solid #000; padding: 5px;">${i.name}</td>
                    <td style="border: 1px solid #000; padding: 5px; text-align:center;">${i.quantidade || i.qtd}</td>
                    <td style="border: 1px solid #000; padding: 5px; text-align:center;">${fMoeda(i.price)}</td>
                </tr>`;
            });

            const dp = p.descontoPromo || 0;
            const dx = p.descontoPix || 0;
            const vf = p.entrega?.valorFrete || 0;

            html += `</tbody></table>
                <div style="text-align: right;">
                    <p>Subtotal: ${fMoeda(subtotal)}</p>
                    <p style="color:red;">Desconto Promo: - ${fMoeda(dp)}</p>
                    <p style="color:red;">Desconto PIX: - ${fMoeda(dx)}</p>
                    <p>Frete: + ${fMoeda(vf)}</p>
                    <hr>
                    <h2>TOTAL: ${fMoeda(subtotal - dp - dx + vf)}</h2>
                    <p style="color:green;"><b>Economia do Cliente: ${fMoeda(dp + dx)}</b></p>
                </div>
            </div>`;

            document.getElementById('print-area').innerHTML = html;
            setTimeout(() => window.print(), 500);
        });
    });
}

function salvarEmpresa() {
    db.ref('settings/empresa').update({
        nome: document.getElementById('empNome').value,
        whats: document.getElementById('empWhats').value,
        subtitulo: document.getElementById('empSub').value
    }).then(() => alert("Dados da empresa salvos!"));
}

function fecharEditorPedido() { document.getElementById('editorPedido').classList.add('hidden'); }

window.onload = () => {
    carregarPedidos();
    db.ref('settings/empresa').once('value', s => {
        const v = s.val() || {};
        document.getElementById('empNome').value = v.nome || '';
        document.getElementById('empWhats').value = v.whats || '';
        document.getElementById('empSub').value = v.subtitulo || '';
    });
};
</script>
</body>
</html>

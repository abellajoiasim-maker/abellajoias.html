<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Administrativo ‚Ä¢ Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#0b0b0b;color:#eee;font-family:Inter,Arial;margin:0}
nav button.active{border-color:#caa85c;color:#caa85c}
section{display:none;min-height:300px}
section.active{display:block}
.card{background:#141414;border:1px solid #2a2a2a;border-radius:16px;padding:14px}
.btn{background:#222;border:1px solid #444;padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer}
.btn-gold{background:#caa85c;color:#000;font-weight:700}
input,select{background:#111;border:1px solid #333;padding:8px;border-radius:8px;width:100%;margin-bottom:8px;color:#fff}

#print-area{display:none}

@media print{
 body *{visibility:hidden}
 #print-area,#print-area *{visibility:visible}
 #print-area{position:absolute;top:0;left:0;width:100%;background:#fff;color:#000;display:block}
}
</style>
</head>

<body>

<header class="p-5 text-center text-xl font-bold bg-black border-b border-[#222]">
  Painel Administrativo ‚Ä¢ Abella Joias
</header>

<nav class="flex gap-2 p-2 bg-[#111] sticky top-0 z-50 overflow-x-auto">
  <button class="btn active" onclick="showTab('empresa',this)">Empresa</button>
  <button class="btn" onclick="showTab('categorias',this)">Categorias</button>
  <button class="btn" onclick="showTab('produtos',this)">Produtos</button>
  <button class="btn" onclick="showTab('promocoes',this)">Promo√ß√µes</button>
  <button class="btn" onclick="showTab('pedidos',this)">Pedidos</button>
</nav>

<main class="p-6">

<section id="empresa" class="active">
  <div class="card space-y-3">
    <h2 class="text-[#caa85c] font-bold">Configura√ß√µes da Loja</h2>
    <input id="empNome" placeholder="Nome da Empresa">
    <input id="empSub" placeholder="Subt√≠tulo">
    <input id="empWhats" placeholder="WhatsApp">
    <input id="empDesc" type="number" placeholder="Desconto PIX (%)">
    <input id="empParc" type="number" placeholder="Parcelas sem acr√©scimo">
    <button class="btn-gold w-full" onclick="salvarEmpresa()">Salvar</button>
  </div>
</section>

<section id="categorias">
  <button class="btn-gold mb-3" onclick="novaCategoria()">+ Nova Categoria</button>
  <div id="listaCategorias"></div>
</section>

<section id="produtos">
  <button class="btn-gold mb-3" onclick="novoProduto()">+ Novo Produto</button>
  <div id="listaProdutos"></div>
</section>

<section id="promocoes">
  <h2 class="text-[#caa85c] font-bold mb-4 text-center">Gest√£o de Promo√ß√µes Individual</h2>
  <div class="flex gap-2 mb-4">
    <button class="btn flex-1 bg-[#222] border-[#caa85c]/50 text-[#caa85c] font-bold py-3" onclick="listarPromos('categorias')">üè∑Ô∏è Por Categorias</button>
    <button class="btn flex-1 bg-[#222] border-[#caa85c]/50 text-[#caa85c] font-bold py-3" onclick="listarPromos('produtos')">üíé Por Produtos</button>
  </div>
  
  <div id="listaPromocoes" class="grid gap-2">
    <p class="text-center text-gray-500 mt-10">Selecione uma op√ß√£o acima para editar os descontos.</p>
  </div>
</section>

<section id="pedidos">
  <h2 class="text-[#caa85c] font-bold mb-4 text-center uppercase tracking-widest">Pedidos Recebidos</h2>
  <div id="listaPedidos" class="grid gap-4"></div>
</section>

<div id="print-area"></div>

</main>

<script>
// No seu script, lembre-se de atualizar a showTab para carregar as promos se necess√°rio:
function showTab(id, btn) {
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  if(id === 'pedidos') carregarPedidos();
  if(id === 'categorias') carregarCategorias();
  if(id === 'produtos') carregarProdutos();
  // Se clicar em promo√ß√µes sem selecionar, ele limpa a lista para o estado inicial
  if(id === 'promocoes') document.getElementById('listaPromocoes').innerHTML = '<p class="text-center text-gray-500 mt-10">Selecione "Por Categorias" ou "Por Produtos" acima.</p>';
}
/* FIREBASE */
firebase.initializeApp({
 apiKey:"AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
 databaseURL:"https://catalogo-abella-joias-default-rtdb.firebaseio.com"
});
const db=firebase.database();

/* HELPERS */
const fMoeda=v=>new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0);

/* NAVEGA√á√ÉO UNIFICADA E CORRIGIDA */
function showTab(id, btn) {
  // Remove a classe 'active' de todas as se√ß√µes e bot√µes
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));

  // Ativa a se√ß√£o e o bot√£o clicado
  const target = document.getElementById(id);
  if (target) {
    target.classList.add('active');
    if (btn) btn.classList.add('active');
  }

  // Carrega os dados espec√≠ficos da aba selecionada
  if (id === 'categorias') carregarCategorias();
  if (id === 'produtos') carregarProdutos();
  if (id === 'pedidos') carregarPedidos();
  
  // Reset visual da aba de promo√ß√µes ao entrar nela
  if (id === 'promocoes') {
     document.getElementById('listaPromocoes').innerHTML = 
       '<p class="text-center text-gray-500 mt-10">Selecione "Por Categorias" ou "Por Produtos" acima.</p>';
  }
}

/* EMPRESA */
function salvarEmpresa(){
 db.ref('settings/empresa').set({
  nome: document.getElementById('empNome').value,
  subtitulo: document.getElementById('empSub').value,
  whats: document.getElementById('empWhats').value,
  descontoPix: +document.getElementById('empDesc').value||0,
  parcelas: +document.getElementById('empParc').value||0
 });
 alert('Salvo');
}

/* CATEGORIAS - ORDEM ALFAB√âTICA E CARDS PEQUENOS */
function carregarCategorias() {
  db.ref('categories').once('value', s => {
    const lista = document.getElementById('listaCategorias');
    lista.innerHTML = '';
    let cats = [];
    s.forEach(c => { cats.push({ key: c.key, ...c.val() }); });

    // Ordena√ß√£o Alfab√©tica [Ajuste Cir√∫rgico]
    cats.sort((a, b) => a.name.localeCompare(b.name));

    cats.forEach(c => {
      // Verifica se existe campo de imagem na categoria (indicador)
      const temImg = c.image ? '<span title="Possui Imagem">üñºÔ∏è</span>' : '<span class="opacity-20">üö´</span>';
      
      lista.innerHTML += `
        <div class="card flex justify-between items-center mb-2 py-2 px-4 text-sm">
          <div class="flex items-center gap-3">
            ${temImg}
            <b class="uppercase">${c.name}</b>
          </div>
          <div class="flex gap-2">
            <button class="btn text-blue-400 hover:bg-blue-900/20" onclick="editarCategoria('${c.key}', '${c.name}')">‚úé</button>
            <button class="btn text-red-500 hover:bg-red-900/20" onclick="if(confirm('Excluir categoria?')) db.ref('categories/${c.key}').remove().then(()=>carregarCategorias())">X</button>
          </div>
        </div>`;
    });
  });
}

/* PRODUTOS - CARREGAMENTO R√ÅPIDO E GEST√ÉO DE VARIA√á√ïES */
let cacheProdutos = []; 

function carregarProdutos() {
  const lista = document.getElementById('listaProdutos');
  lista.innerHTML = '<p class="text-center p-4 text-gray-500">Sincronizando estoque...</p>';

  // Busca √∫nica para o Cache
  db.ref('products').once('value', s => {
    cacheProdutos = [];
    s.forEach(p => { 
      cacheProdutos.push({ key: p.key, ...p.val() }); 
    });

    // Ordena√ß√£o por SKU (Num√©rica/Crescente)
    cacheProdutos.sort((a, b) => (a.sku || "").localeCompare(b.sku || "", undefined, {numeric: true}));

    renderizarEstruturaProdutos();
  });
}

function renderizarEstruturaProdutos() {
  const lista = document.getElementById('listaProdutos');
  lista.innerHTML = '';

  // Filtro de categorias √∫nicas presentes nos produtos
  const categoriasPresentes = [...new Set(cacheProdutos.map(p => p.category || "Sem Categoria"))].sort();

  categoriasPresentes.forEach(cat => {
    const totalNaCat = cacheProdutos.filter(p => (p.category || "Sem Categoria") === cat).length;
    
    const divCat = document.createElement('div');
    divCat.className = "mb-2";
    // Geramos o ID escapado para evitar erros com espa√ßos no nome da categoria
    const catId = cat.replace(/\s+/g, '-');
    
    divCat.innerHTML = `
      <div onclick="toggleCategoria('${cat}', '${catId}')" 
           class="flex justify-between items-center bg-[#141414] p-3 rounded-lg cursor-pointer border-l-4 border-[#caa85c] hover:bg-[#1a1a1a] transition-all">
        <b class="text-[11px] uppercase tracking-wider">${cat} <span class="text-[#caa85c] ml-2">(${totalNaCat})</span></b>
        <span id="seta-${catId}" class="text-[10px] text-gray-500">‚ñº</span>
      </div>
      <div id="cat-content-${catId}" class="hidden flex flex-col gap-1 mt-1 pl-2 border-l border-[#222]">
        </div>
    `;
    lista.appendChild(divCat);
  });
}

function toggleCategoria(nomeCat, catId) {
  const content = document.getElementById(`cat-content-${catId}`);
  const seta = document.getElementById(`seta-${catId}`);
  const isHidden = content.classList.contains('hidden');

  // Fecha todos os outros para manter o painel limpo e r√°pido
  document.querySelectorAll('[id^="cat-content-"]').forEach(el => el.classList.add('hidden'));
  document.querySelectorAll('[id^="seta-"]').forEach(el => el.innerText = '‚ñº');

  if (isHidden) {
    content.classList.remove('hidden');
    seta.innerText = '‚ñ≤';
    
    // Filtra os produtos do cache para esta categoria espec√≠fica
    const produtosFiltrados = cacheProdutos.filter(p => (p.category || "Sem Categoria") === nomeCat);
    
    // Renderiza apenas os produtos desta categoria
    content.innerHTML = produtosFiltrados.map(p => {
      const temImagem = p.image ? 'üñºÔ∏è' : '<span class="text-red-900">üö´</span>';
      // Exibi√ß√£o da Varia√ß√£o (Letras A-Z ou Dizeres)
      const labelVariacao = p.variacao ? `<span class="bg-[#222] text-[#caa85c] px-1 rounded ml-1 text-[9px] border border-[#caa85c]/30">${p.variacao}</span>` : '';

      return `
        <div class="card flex justify-between items-center py-2 px-3 text-[11px] bg-[#0d0d0d] border-[#222] hover:border-[#333]">
          <div class="flex-1">
            <span class="text-gray-500 font-mono text-[9px] uppercase">${p.sku || '---'}</span>
            <b class="ml-1 uppercase text-gray-200">${p.name}</b>
            ${labelVariacao}
            ${temImagem}
            <div class="text-[#caa85c] mt-0.5">${fMoeda(p.price)}</div>
          </div>
          <div class="flex gap-3">
            <button class="text-blue-400 hover:text-blue-300 transition-colors" onclick="editarProduto('${p.key}')">‚úé</button>
            <button class="text-red-500 hover:text-red-400 transition-colors" onclick="removerProduto('${p.key}')">X</button>
          </div>
        </div>`;
    }).join('');
  }
}

function toggleCategoria(cat) {
  const content = document.getElementById(`cat-content-${cat}`);
  const isHidden = content.classList.contains('hidden');

  // Fecha todos os outros para economizar mem√≥ria (opcional)
  document.querySelectorAll('[id^="cat-content-"]').forEach(el => el.classList.add('hidden'));

  if (isHidden) {
    content.classList.remove('hidden');
    // Filtra os produtos desta categoria
    const produtosFiltrados = cacheProdutos.filter(p => (p.category || "Sem Categoria") === cat);
    
    content.innerHTML = produtosFiltrados.map(p => `
      <div class="card flex justify-between items-center py-1 px-3 text-[11px] bg-[#111]">
        <div class="flex-1">
          <span class="text-[#caa85c] font-bold">[${p.sku || '---'}]</span> 
          <span class="ml-1">${p.name}</span>
          ${p.variacao ? `<br><small class="text-blue-400">Varia√ß√£o: ${p.variacao}</small>` : ''}
        </div>
        <div class="flex gap-2">
          <button onclick="editarProduto('${p.key}')">‚úé</button>
          <button class="text-red-500" onclick="removerProduto('${p.key}')">X</button>
        </div>
      </div>
    `).join('');
  }
}
/* PROMO√á√ïES - SISTEMA DE GEST√ÉO INDIVIDUAL */

function listarPromos(tipo) {
  const container = document.getElementById('listaPromocoes');
  container.innerHTML = '<p class="text-center p-4">Carregando itens...</p>';

  db.ref(tipo === 'categorias' ? 'categories' : 'products').once('value', s => {
    container.innerHTML = '';
    let itens = [];
    s.forEach(child => { itens.push({ key: child.key, ...child.val() }); });

    // Ordenar alfabeticamente pelo nome ou categoria
    itens.sort((a, b) => (a.name || a.category || '').localeCompare(b.name || b.category || ''));

    if (itens.length === 0) {
      container.innerHTML = '<p class="text-center p-4 text-gray-500">Nenhum item encontrado.</p>';
      return;
    }

    itens.forEach(item => {
      const nome = tipo === 'categorias' ? item.name : `[${item.sku || '---'}] ${item.name}`;
      const promoPct = item.promoPct || 0;
      const promoCor = item.promoCor || '#caa85c';
      const promoTexto = item.promoTexto || 'OFF';

      container.innerHTML += `
        <div class="card mb-2 border-l-4" style="border-color: ${promoPct > 0 ? promoCor : '#2a2a2a'}">
          <div class="flex justify-between items-center flex-wrap gap-2">
            <div class="flex-1 min-w-[150px]">
              <small class="text-[#caa85c] uppercase text-[9px] font-bold">${tipo.slice(0,-1)}</small><br>
              <b class="text-xs uppercase">${nome}</b>
              ${tipo === 'produtos' ? `<br><span class="text-gray-400 text-[10px]">${fMoeda(item.price)}</span>` : ''}
            </div>
            
            <div class="flex items-center gap-3 bg-[#0b0b0b] p-2 rounded-lg border border-[#222]">
              <div class="flex flex-col">
                <label class="text-[8px] text-gray-500 uppercase font-bold text-center">Desconto %</label>
                <input type="number" class="w-12 bg-transparent border-b border-[#333] text-center text-sm focus:border-[#caa85c] outline-none" 
                  value="${promoPct}" onchange="salvarPromo('${tipo}', '${item.key}', 'promoPct', this.value)">
              </div>
              
              <div class="flex flex-col">
                <label class="text-[8px] text-gray-500 uppercase font-bold text-center">Texto</label>
                <input type="text" class="w-14 bg-transparent border-b border-[#333] text-center text-[10px] uppercase outline-none" 
                  value="${promoTexto}" onchange="salvarPromo('${tipo}', '${item.key}', 'promoTexto', this.value)">
              </div>

              <div class="flex flex-col items-center">
                <label class="text-[8px] text-gray-500 uppercase font-bold text-center">Cor</label>
                <input type="color" class="w-6 h-6 bg-transparent border-none cursor-pointer p-0" 
                  value="${promoCor}" onchange="salvarPromo('${tipo}', '${item.key}', 'promoCor', this.value)">
              </div>

              <button class="text-red-500 hover:text-red-400 font-bold px-2 ml-1" 
                onclick="limparPromo('${tipo}', '${item.key}')" title="Zerar Desconto">√ó</button>
            </div>
          </div>
        </div>`;
    });
  });
}

/* SALVAMENTO AUTOM√ÅTICO */
function salvarPromo(tipo, id, campo, valor) {
  const v = campo === 'promoPct' ? Number(valor) : valor;
  
  if (tipo === 'categorias') {
    // Atualiza a categoria
    db.ref('categories/' + id).update({ [campo]: v });
    
    // Cascata: Atualiza todos os produtos que pertencem a essa categoria
    db.ref('categories/' + id).once('value', catSnap => {
      const nomeCat = catSnap.val().name;
      db.ref('products').once('value', prodSnap => {
        prodSnap.forEach(p => {
          if (p.val().category === nomeCat) {
            db.ref('products/' + p.key).update({ [campo]: v });
          }
        });
      });
    });
  } else {
    // Atualiza apenas o produto individual
    db.ref('products/' + id).update({ [campo]: v });
  }
}

/* LIMPAR PROMO√á√ÉO */
function limparPromo(tipo, id) {
  if (!confirm("Deseja remover todos os dados de promo√ß√£o deste item?")) return;
  const reset = { promoPct: 0, promoTexto: 'OFF', promoCor: '#caa85c' };
  
  if (tipo === 'categorias') {
    db.ref('categories/' + id).update(reset).then(() => listarPromos('categorias'));
    // Aqui voc√™ tamb√©m poderia adicionar a cascata para limpar os produtos da categoria se desejar
  } else {
    db.ref('products/' + id).update(reset).then(() => listarPromos('produtos'));
  }
}

/* PEDIDOS - GEST√ÉO COMPLETA (ROMANEIOS + EDI√á√ÉO + EXCLUS√ÉO) */
function carregarPedidos() {
  const listaPedidos = document.getElementById('listaPedidos');
  listaPedidos.innerHTML = '<p class="p-4 text-center text-gray-500">Carregando pedidos...</p>';

  db.ref('orders').on('value', snapshot => {
    listaPedidos.innerHTML = '';
    if (!snapshot.exists()) {
      listaPedidos.innerHTML = '<p class="p-4 text-center text-gray-500">Nenhum pedido encontrado.</p>';
      return;
    }

    let pedidosHtml = [];
    snapshot.forEach(ped => {
      const p = ped.val();
      const id = ped.key;
      const nomeCliente = (p.cliente && typeof p.cliente === 'object') ? p.cliente.nome : (p.cliente || 'Cliente s/ nome');
      
      const html = `
        <div class="card mb-3 border-l-4 border-[#caa85c]">
          <div class="flex justify-between items-start mb-2">
            <div>
              <b class="text-[#caa85c] text-sm uppercase">${nomeCliente}</b>
              <p class="text-[10px] text-gray-400">${p.data || ''}</p>
            </div>
            <span class="bg-[#222] px-2 py-1 rounded text-[9px] font-bold uppercase">${p.pagamento || 'N/A'}</span>
          </div>

          <div class="grid grid-cols-3 gap-1 mt-2 border-t border-[#2a2a2a] pt-2">
            <button class="btn text-[9px] py-1" onclick="gerarRomaneio('${id}', 1)">Simples</button>
            <button class="btn text-[9px] py-1" onclick="gerarRomaneio('${id}', 2)">Completo</button>
            <button class="btn text-[9px] py-1" onclick="gerarRomaneio('${id}', 3)">Com Foto</button>
          </div>

          <div class="flex gap-2 mt-2">
            <button class="btn flex-1 text-blue-400 border-blue-900/30 text-[10px] py-1" onclick="abrirEditorPedido('${id}')">‚úé AJUSTAR</button>
            <button class="btn flex-1 text-red-500 border-red-900/30 text-[10px] py-1" onclick="excluirPedido('${id}')">EXCLUIR</button>
          </div>

          <div class="mt-2 text-right">
             ${p.ajustadoManualmente ? '<span class="text-[9px] text-green-500 mr-2 font-bold">AJUSTADO</span>' : ''}
             <b class="text-white text-sm">${fMoeda(p.total)}</b>
          </div>
        </div>`;
      pedidosHtml.push(html);
    });
    listaPedidos.innerHTML = pedidosHtml.reverse().join('');
  });
}

 /* EXCLUIR PEDIDO */
function excluirPedido(id) {
  if (confirm("Deseja realmente apagar este pedido? Esta a√ß√£o n√£o pode ser desfeita.")) {
    db.ref('orders/' + id).remove()
      .then(() => alert("Pedido removido do sistema."))
      .catch(e => alert("Erro ao excluir."));
  }
}

/* EDITAR PEDIDO - AJUSTE MANUAL PARA ATACADO */
function abrirEditorPedido(id) {
  db.ref('orders/' + id).once('value', s => {
    const p = s.val();
    if (!p) return;

    // Pergunta o novo valor total (ideal para dar descontos de √∫ltima hora)
    const novoTotal = prompt(`Valor Total Atual: ${fMoeda(p.total)}\nInforme o novo valor final para o cliente:`, p.total);
    
    // Adiciona uma nota interna (ex: "Desconto por volume de 50 pe√ßas")
    const nota = prompt(`Motivo do ajuste ou observa√ß√£o para o romaneio:`, p.obs || "");

    if (novoTotal !== null && novoTotal !== "") {
      db.ref('orders/' + id).update({
        total: Number(novoTotal),
        obs: nota,
        ajustadoManualmente: true
      }).then(() => {
        alert("Pedido atualizado!");
      });
    }
  });
}

function gerarRomaneio(id, tipo = 1) {
 db.ref('orders/'+id).once('value', s => {
  const p = s.val(); if(!p) return;
  db.ref('settings/empresa').once('value', e => {
   const emp = e.val() || {};
   let html = `
   <style>
    .print-body { font-family: 'Poppins', sans-serif; color:#000; padding:20px; font-size: 11px; }
    .lux-head { text-align:center; border-bottom:2px solid #A68966; padding-bottom:10px; margin-bottom:15px; }
    .lux-head h1 { font-family: 'Cinzel', serif; margin:0; color:#A68966; font-size:24px; }
    .grid-dados { display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:15px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; font-size:11px; }
    table th { background:#f9f9f9; text-align:left; border-bottom:1px solid #000; padding:5px; }
    table td { border-bottom:1px solid #eee; padding:5px; }
    .totais { text-align:right; margin-top:15px; font-size:12px; }
    .img-mini { width:40px; height:40px; object-fit:cover; border-radius:4px; }
   </style>
   <div class="print-body">
    <div class="lux-head">
     <h1>${emp.nome || 'Abella Joias'}</h1>
     <p>${emp.subtitulo || ''}<br>WhatsApp: ${emp.whats || ''}</p>
    </div>
    
    <div class="grid-dados">
     <div>
      <b>DADOS DO CLIENTE</b><br>
      Nome: ${p.cliente?.nome || p.cliente}<br>
      WhatsApp: ${p.cliente?.telefone || p.whatsapp || ''}
     </div>
     <div>
      <b>LOCAL DE ENTREGA</b><br>
      ${p.endereco?.nome || 'Residencial'}<br>
      ${p.endereco?.rua || ''}, ${p.endereco?.num || ''}<br>
      ${p.endereco?.bairro || ''} - ${p.endereco?.cidade || ''}
     </div>
    </div>

    <table>
     <thead>
      <tr>
       ${tipo === 3 ? '<th>Foto</th>' : ''}
       <th>SKU</th>
       <th>Produto</th>
       ${tipo > 1 ? '<th>Peso U.</th><th>Pre√ßo U.</th>' : ''}
       <th>Qtd</th>
       ${tipo > 1 ? '<th>Subtotal</th>' : ''}
      </tr>
     </thead>
     <tbody>`;

 p.itens.forEach(i => {
    const vPreco = Number(i.precoFinal || i.price || 0);
    const vPesoGramas = Number(i.peso || 0); // Assume-se que o banco guarda em gramas
    const vQtd = Number(i.quantidade || 1);
    
    // Converte peso unit√°rio para Kg (ex: 0.050 Kg)
    const vPesoKg = (vPesoGramas / 1000).toFixed(3);

    html += `<tr>
     ${tipo === 3 ? `<td><img src="${i.image}" class="img-mini"></td>` : ''}
     <td>${i.sku || '---'}</td>
     <td>${i.name}</td>
     ${tipo > 1 ? `<td>${vPesoKg} Kg</td><td>${fMoeda(vPreco)}</td>` : ''}
     <td>${vQtd}</td>
     ${tipo > 1 ? `<td>${fMoeda(vPreco * vQtd)}</td>` : ''}
    </tr>`;
  });

  html += `</tbody></table>`;

 if (tipo > 1) {
    // C√°lculo do peso em Kg com 2 casas decimais
    const pesoTotalKg = (Number(p.pesoTotal || 0) / 1000).toFixed(2);

    html += `
     <div class="totais" style="text-align:right; margin-top:15px; font-size:12px; line-height: 1.5;">
      <span>Subtotal: ${fMoeda(p.subtotal)}</span><br>
      <span style="color:#666">Peso Total: ${pesoTotalKg} Kg</span><br>
      <span style="color:#666">Descontos Aplicados: - ${fMoeda(p.descontos)}</span><br>
      
      ${p.ajustadoManualmente ? `
        <div style="color: #2e7d32; font-style: italic; margin-top: 4px;">
          ‚úì Ajuste de negocia√ß√£o aplicado
        </div>` : ''}
      
      ${p.obs ? `
        <div style="background: #fdfaf3; border: 1px solid #f0e6d2; padding: 5px; display: inline-block; margin-top: 5px; text-align: left; border-radius: 4px; font-size: 10px; max-width: 250px;">
          <b>Observa√ß√£o:</b> ${p.obs}
        </div><br>` : ''}

      <div style="margin-top:8px; border-top:2px solid #A68966; padding-top:8px;">
        <span style="font-size:10px; color:#666; text-transform:uppercase;">Valor Final a Pagar:</span><br>
        <b style="font-size:18px; color:#A68966">${fMoeda(p.total)}</b>
      </div>
     </div>`;
  }

  html += `</div>`; // Fecha a div print-body
  document.getElementById('print-area').innerHTML = html;
  
  // Pequeno delay para garantir que as fontes e imagens carreguem antes do print
  setTimeout(() => { window.print(); }, 500);
 }
});
}

  html += `</div>`;
  document.getElementById('print-area').innerHTML = html;
  window.print();
 });
});
}

/* START - INICIALIZA√á√ÉO AUTOM√ÅTICA */
window.addEventListener('load', () => {
  // Carrega os dados da empresa nos inputs [cite: 79]
  carregarEmpresaSeExistir(); 
  
  // Ativa visualmente a aba 'empresa' e o primeiro bot√£o do menu [cite: 7, 8]
  const btnInicial = document.querySelector('nav button');
  showTab('empresa', btnInicial);
});

function carregarEmpresaSeExistir(){
    db.ref('settings/empresa').once('value', s => {
        const v = s.val();
        if(v){
            document.getElementById('empNome').value = v.nome || ''; [cite: 79]
            document.getElementById('empSub').value = v.subtitulo || ''; [cite: 79]
            document.getElementById('empWhats').value = v.whats || ''; [cite: 79]
            document.getElementById('empDesc').value = v.descontoPix || 0; [cite: 79]
            document.getElementById('empParc').value = v.parcelas || 0; [cite: 80]
        }
    });
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Admin | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#0e0e0e;color:#fff}
.nav-btn{flex:1;padding:14px;font-size:11px;font-weight:800;text-align:center;cursor:pointer;background:#141414}
.nav-btn.active{background:#000;color:#caa85c;border-bottom:3px solid #caa85c}
.card{background:#141414;border:1px solid #2a2a2a;border-radius:14px;padding:12px;position:relative}
.dot{width:10px;height:10px;border-radius:50%;position:absolute;top:8px;right:8px}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:999;align-items:center;justify-content:center}
</style>
</head>

<body>

<header class="sticky top-0 z-50">
<nav class="flex">
<div class="nav-btn active" onclick="tab('empresa',this)">EMPRESA</div>
<div class="nav-btn" onclick="tab('categorias',this)">CATEGORIAS</div>
<div class="nav-btn" onclick="tab('produtos',this)">PRODUTOS</div>
<div class="nav-btn" onclick="tab('promocoes',this)">PROMOÇÕES</div>
<div class="nav-btn" onclick="tab('pedidos',this)">PEDIDOS</div>
</nav>
</header>

<main class="p-4 max-w-7xl mx-auto space-y-8">

<!-- EMPRESA -->
<section id="empresa">
<div class="card max-w-xl">
<h2 class="font-bold mb-4 text-[#caa85c]">Dados da Empresa</h2>
<input id="empNome" class="w-full p-2 mb-2 bg-black border" placeholder="Nome">
<input id="empWhats" class="w-full p-2 mb-2 bg-black border" placeholder="WhatsApp">
<input id="empPix" type="number" class="w-full p-2 mb-2 bg-black border" placeholder="Desconto Pix %">
<input id="empParc" type="number" class="w-full p-2 mb-4 bg-black border" placeholder="Parcelas">
<button onclick="salvarEmpresa()" class="w-full bg-[#caa85c] text-black font-bold py-3 rounded-xl">SALVAR</button>
</div>
</section>

<!-- CATEGORIAS -->
<section id="categorias" class="hidden">
<div class="flex justify-between mb-4">
<h2 class="font-bold text-[#caa85c]">Categorias</h2>
<button onclick="novaCategoria()" class="bg-[#caa85c] text-black px-4 rounded">+</button>
</div>
<div id="listaCategorias" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
</section>

<!-- PRODUTOS -->
<section id="produtos" class="hidden">
<h2 class="font-bold text-[#caa85c] mb-4">Produtos</h2>
<div id="produtosPorCategoria" class="space-y-10"></div>
</section>

<!-- PROMOÇÕES -->
<section id="promocoes" class="hidden">
<h2 class="mb-4 font-bold text-xl text-[#caa85c]">Promoções por Categoria</h2>
<div class="bg-[#141414] border rounded-2xl p-6 max-w-2xl">
<div id="listaPromos" class="space-y-3"></div>
<button onclick="salvarPromos()" class="w-full mt-6 bg-[#caa85c] text-black font-bold py-3 rounded-xl">APLICAR</button>
</div>
</section>

<!-- PEDIDOS -->
<section id="pedidos" class="hidden">
<h2 class="mb-4 font-bold text-[#caa85c]">Pedidos</h2>
<div id="containerPedidos" class="space-y-4"></div>
</section>

</main>

<!-- MODAL -->
<div id="modal" class="modal">
<div class="bg-[#141414] p-6 rounded-2xl w-full max-w-md">
<h2 id="modalTitulo" class="font-bold mb-4"></h2>
<div id="modalConteudo" class="space-y-3"></div>
<div class="flex gap-2 mt-6">
<button onclick="salvarModal()" class="flex-1 bg-green-600 py-2 rounded">Salvar</button>
<button onclick="fecharModal()" class="flex-1 bg-gray-700 py-2 rounded">Cancelar</button>
</div>
<button id="btnExcluir" class="mt-4 w-full text-red-500 text-xs">EXCLUIR</button>
</div>
</div>

<script>
const firebaseConfig={
apiKey:"AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
databaseURL:"https://catalogo-abella-joias-default-rtdb.firebaseio.com"
}
firebase.initializeApp(firebaseConfig)
const db=firebase.database()

let MODAL_PATH='',MODAL_ID=''

function tab(id,el){
document.querySelectorAll('main section').forEach(s=>s.classList.add('hidden'))
document.getElementById(id).classList.remove('hidden')
document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'))
el.classList.add('active')
}

/* EMPRESA */
db.ref('settings').on('value',s=>{
const v=s.val()||{}
empNome.value=v.nome||''
empWhats.value=v.whatsapp||''
empPix.value=v.pix||0
empParc.value=v.parcelas||1
})
function salvarEmpresa(){
db.ref('settings').update({
nome:empNome.value,whatsapp:empWhats.value,
pix:Number(empPix.value),parcelas:Number(empParc.value)
})
alert('Salvo')
}

/* CATEGORIAS */
db.ref('categories').on('value',snap=>{
listaCategorias.innerHTML=''
snap.forEach(c=>{
const v=c.val()
listaCategorias.innerHTML+=`
<div class="card">
<div class="dot ${v.image?'bg-green-500':'bg-red-500'}"></div>
<img src="${v.image||''}" class="w-full h-24 object-contain bg-black mb-2">
<p class="text-xs font-bold uppercase">${v.name}</p>
<div class="flex gap-2 mt-2 text-[10px]">
<button onclick="editarCategoria('${c.key}')" class="bg-[#caa85c] text-black px-2 rounded">EDITAR</button>
<button onclick="pausar('categories','${c.key}')" class="bg-gray-600 px-2 rounded">PAUSAR</button>
<button onclick="excluir('categories','${c.key}')" class="bg-red-600 px-2 rounded">EXCLUIR</button>
</div>
</div>`
})
})

function novaCategoria(){editarCategoria(null)}
function editarCategoria(id){
MODAL_PATH='categories';MODAL_ID=id
modal.style.display='flex'
modalTitulo.innerText=id?'Editar Categoria':'Nova Categoria'
db.ref('categories/'+id).once('value',s=>{
const v=s.val()||{}
modalConteudo.innerHTML=`
<input id="fNome" class="w-full bg-black border p-2" placeholder="Nome" value="${v.name||''}">
<input id="fImg" class="w-full bg-black border p-2" placeholder="URL Imagem" value="${v.image||''}">
<h3 class="text-xs mt-3 text-[#caa85c]">Variações</h3>
<div id="listaVariacoes"></div>
<button onclick="novaVariacao()" class="text-xs text-green-400 mt-2">+ Nova Variação</button>
`
if(v.variations){
Object.entries(v.variations).forEach(([k,val])=>{
listaVariacoes.innerHTML+=`
<div class="flex gap-2 text-xs">
<input value="${val.name}" onchange="updVar('${k}',this.value)" class="flex-1 bg-black border p-1">
<button onclick="delVar('${k}')" class="text-red-500">X</button>
</div>`
})
}
})
btnExcluir.onclick=()=>{excluir('categories',id)}
}

<script>
/* ========= PRODUTOS (FOCO REAL EM PRODUTOS) ========= */
db.ref('products').on('value', snap => {

  produtosPorCategoria.innerHTML = ''

  const produtos = []
  snap.forEach(p => produtos.push({ id: p.key, ...p.val() }))

  // ordena por SKU
  produtos.sort((a, b) => (a.sku || '').localeCompare(b.sku || ''))

  // agrupa por categoria
  const grupos = {}
  produtos.forEach(p => {
    const cat = p.category || 'sem-categoria'
    if (!grupos[cat]) grupos[cat] = []
    grupos[cat].push(p)
  })

  // renderização final
  Object.keys(grupos).forEach(catId => {

    const bloco = document.createElement('div')
    bloco.innerHTML = `
      <h3 class="font-bold text-[#caa85c] mb-3">
        ${catId === 'sem-categoria' ? 'Sem Categoria' : catId}
      </h3>
      <div class="grid grid-cols-2 md:grid-cols-6 gap-3" id="grupo-${catId}"></div>
    `
    produtosPorCategoria.appendChild(bloco)

    const container = bloco.querySelector(`#grupo-${catId}`)

    grupos[catId].forEach(p => {
      container.innerHTML += `
        <div class="card">
          <div class="dot ${p.image ? 'bg-green-500' : 'bg-red-500'}"></div>
          <p class="text-[9px] font-mono">${p.sku || '-'}</p>
          <p class="text-[10px] font-bold uppercase truncate">${p.name || ''}</p>

          <div class="flex gap-1 text-[9px] mt-2">
            <button onclick="editarProduto('${p.id}')" class="bg-[#caa85c] text-black px-1 rounded">EDIT</button>
            <button onclick="pausar('products','${p.id}')" class="bg-gray-600 px-1 rounded">PAUSAR</button>
            <button onclick="excluir('products','${p.id}')" class="bg-red-600 px-1 rounded">EXCLUIR</button>
          </div>
        </div>
      `
    })
  })
})
</script>


/* PROMOÇÕES */
db.ref('categories').on('value',snap=>{
listaPromos.innerHTML=''
snap.forEach(c=>{
const d=c.val()
listaPromos.innerHTML+=`
<div class="flex justify-between bg-black p-2 rounded">
<span class="text-xs">${d.name}</span>
<input id="promo-${c.key}" type="number" value="${d.discount||0}" class="w-16 bg-black border text-center">
</div>`
})
})
function salvarPromos(){
document.querySelectorAll('[id^=promo-]').forEach(i=>{
db.ref('categories/'+i.id.replace('promo-','')).update({discount:Number(i.value)})
})
alert('Promoções salvas')
}

/* PEDIDOS */
db.ref('orders').on('value',snap=>{
containerPedidos.innerHTML=''
snap.forEach(o=>{
const v=o.val()
containerPedidos.innerHTML+=`
<div class="card">
<p class="text-xs opacity-60">Pedido #${o.key.slice(-5)}</p>
<p class="font-bold">${v.customer?.name||''}</p>
<p class="text-xs">${v.status||'Pendente'}</p>
<div class="flex gap-2 mt-2 text-xs">
<button onclick="alert(JSON.stringify(v,null,2))" class="bg-[#caa85c] text-black px-2 rounded">ROMANEIO</button>
<button onclick="statusPedido('${o.key}')" class="bg-gray-600 px-2 rounded">STATUS</button>
<button onclick="excluir('orders','${o.key}')" class="bg-red-600 px-2 rounded">EXCLUIR</button>
</div>
</div>`
})
})

function statusPedido(id){
const s=prompt('Novo status:')
if(s)db.ref('orders/'+id).update({status:s})
}

function pausar(path,id){
db.ref(path+'/'+id+'/paused').set(true)
alert('Pausado')
}
function excluir(path,id){
if(confirm('Excluir?'))db.ref(path+'/'+id).remove()
}
function fecharModal(){modal.style.display='none'}
function salvarModal(){
const id=MODAL_ID||fNome.value.toLowerCase().replace(/[^a-z0-9]/g,'-')
db.ref(MODAL_PATH+'/'+id).update({
name:fNome.value,image:fImg.value
})
fecharModal()
}
</script>

</body>
</html>

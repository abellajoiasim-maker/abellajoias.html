<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Painel Admin ‚Ä¢ Abella Joias</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <style>
        body{background:#0b0b0b;color:#eee;font-family:Inter,Arial}
        nav button.active{border-color:#caa85c;color:#caa85c}
        section{display:none}
        section.active{display:block}
        .card{background:#141414;border:1px solid #2a2a2a;border-radius:16px;padding:14px}
        .btn{background:#222;border:1px solid #444;padding:6px 10px;border-radius:8px;font-size:12px;cursor:pointer;transition: all 0.2s}
        .btn:hover{background:#333}
        .btn-gold{background:#caa85c;color:#000;font-weight:700}
        .btn-red{border-color:#c33;color:#f77}
        #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:100;align-items:center;justify-content:center;padding:15px}
        .modal-box{background:#141414;border:1px solid #333;border-radius:20px;width:100%;max-width:500px;padding:20px;max-height:90vh;overflow-y:auto}
        input,select{background:#111;border:1px solid #333;padding:10px;border-radius:8px;width:100%;margin-bottom:8px;color:#fff;outline:none}
        input:focus{border-color:#caa85c}
        .badge-desconto { position: absolute; top: 5px; right: 5px; background: #16a34a; color: white; font-size: 9px; font-weight: 800; padding: 2px 6px; border-radius: 4px; z-index: 10; }
        .preco-riscado { text-decoration: line-through; }
    </style>
</head>

<body>

<header class="p-5 text-center text-xl font-bold bg-black border-b border-[#222]">
    Painel Administrativo ‚Ä¢ Abella Joias
</header>

<nav class="flex gap-2 p-2 bg-[#111] overflow-x-auto sticky top-0 z-50">
    <button class="btn active" onclick="showTab('empresa',this)">Empresa</button>
    <button class="btn" onclick="showTab('pedidos',this)">Pedidos</button>
    <button class="btn" onclick="showTab('categorias',this)">Categorias</button>
    <button class="btn" onclick="showTab('produtos',this)">Produtos</button>
    <button class="btn" onclick="showTab('promocoes',this)">Promo√ß√µes</button>
</nav>

<main class="p-4">
    <section id="empresa" class="active">
        <div class="card max-w-md mx-auto">
            <label class="text-[10px] uppercase opacity-50">Nome da Loja</label>
            <input id="empNome">
            <label class="text-[10px] uppercase opacity-50">WhatsApp</label>
            <input id="empWhats">
            <label class="text-[10px] uppercase opacity-50">Desconto PIX %</label>
            <input id="empPix" type="number">
            <label class="text-[10px] uppercase opacity-50">M√°ximo de Parcelas</label>
            <input id="empParc" type="number">
            <button class="btn-gold w-full mt-2 py-3 rounded-xl" onclick="salvarEmpresa()">Salvar Configura√ß√µes</button>
        </div>
    </section>

    <section id="pedidos">
        <div id="listaPedidos" class="space-y-2"></div>
    </section>

    <section id="categorias">
        <div id="listaCategorias" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
    </section>

    <section id="produtos">
        <div id="produtosPorCategoria"></div>
    </section>

    <section id="promocoes">
        <div class="card max-w-md mx-auto">
            <h2 class="text-[#caa85c] font-bold mb-4 uppercase text-xs">Desconto por Categoria</h2>
            <div id="listaPromocoes" class="space-y-3"></div>
            <button class="btn-gold mt-6 w-full py-3" onclick="salvarPromos()">Salvar Descontos</button>
        </div>
    </section>
</main>

<div id="modal">
    <div class="modal-box">
        <h2 id="modalTitle" class="text-lg font-bold text-[#caa85c] mb-4"></h2>
        <div id="modalBody"></div>
        <div class="flex gap-2 mt-6">
            <button class="btn flex-1" onclick="fecharModal()">Cancelar</button>
            <button id="modalConfirm" class="btn-gold flex-[2] py-2 rounded-lg">Confirmar</button>
        </div>
    </div>
</div>

<script>
// CONFIGURA√á√ÉO FIREBASE
const firebaseConfig = {
    apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
    databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* NAVEGA√á√ÉO */
function showTab(id, btn) {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

/* L√ìGICA DO MODAL */
function abrirModal(titulo, html, onConfirm) {
    document.getElementById('modalTitle').innerText = titulo;
    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('modal').style.display = 'flex';
    document.getElementById('modalConfirm').onclick = () => { onConfirm(); fecharModal(); };
}
function fecharModal() { document.getElementById('modal').style.display = 'none'; }

/* EMPRESA */
db.ref('settings').on('value', s => {
    const v = s.val() || {};
    document.getElementById('empNome').value = v.nome || '';
    document.getElementById('empWhats').value = v.whatsapp || '';
    document.getElementById('empPix').value = v.pix || 0;
    document.getElementById('empParc').value = v.parcelas || 1;
});

function salvarEmpresa() {
    db.ref('settings').update({
        nome: empNome.value,
        whatsapp: empWhats.value,
        pix: +empPix.value,
        parcelas: +empParc.value
    }).then(() => alert('Configura√ß√µes salvas!'));
}

/* CATEGORIAS & PROMO√á√ïES */
db.ref('categories').on('value', s => {
    const listaCat = document.getElementById('listaCategorias');
    const listaPromos = document.getElementById('listaPromocoes');
    listaCat.innerHTML = ''; listaPromos.innerHTML = '';

    s.forEach(c => {
        const d = c.val(); const id = c.key;
        const foto = d.image || 'https://via.placeholder.com/150?text=Sem+Foto';

        listaCat.innerHTML += `
            <div class="card flex items-center gap-3">
                <img src="${foto}" class="w-12 h-12 rounded-lg object-cover border border-[#333]">
                <div class="flex-1">
                    <b class="text-[11px] uppercase text-white">${d.name}</b>
                    <div class="flex gap-1 mt-1">
                        <button class="btn btn-red text-[9px] py-1" onclick="excluir('categories','${id}')">‚úï Excluir</button>
                    </div>
                </div>
            </div>`;

        listaPromos.innerHTML += `
            <div class="flex justify-between items-center p-2 bg-[#0a0a0a] rounded-lg border border-[#222]">
                <span class="text-[11px] font-medium text-gray-300 uppercase">${d.name}</span>
                <div class="flex items-center gap-2">
                    <input type="number" id="promo-${id}" value="${d.discount || 0}" class="w-14 mb-0 text-center text-xs p-1 bg-black">
                    <span class="text-[#caa85c] text-xs">%</span>
                </div>
            </div>`;
    });
});

function salvarPromos() {
    const updates = {};
    document.querySelectorAll('[id^="promo-"]').forEach(input => {
        const id = input.id.replace('promo-', '');
        updates[`categories/${id}/discount`] = parseInt(input.value) || 0;
    });
    db.ref().update(updates).then(() => alert('Descontos atualizados!'));
}

/* PRODUTOS */
db.ref('products').on('value', snapProdutos => {
    const container = document.getElementById('produtosPorCategoria');
    container.innerHTML = '';
    const map = {};

    db.ref('categories').once('value').then(snapCats => {
        const categorias = snapCats.val() || {};
        snapProdutos.forEach(p => {
            const v = p.val(); v.id = p.key;
            if (!map[v.category]) map[v.category] = [];
            map[v.category].push(v);
        });

        Object.keys(map).forEach(catID => {
            const nomeCat = categorias[catID]?.name || "Sem Categoria";
            container.innerHTML += `
                <h3 class="text-[#caa85c] mt-8 mb-4 uppercase text-[10px] font-bold tracking-widest border-b border-[#caa85c]/20 pb-2">${nomeCat}</h3>
                <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-3" id="grid-${catID}"></div>`;
            
            const grid = document.getElementById(`grid-${catID}`);
            map[catID].forEach(p => {
                grid.innerHTML += `
                    <div class="card bg-[#111]">
                        <img src="${p.image}" class="w-full h-24 object-cover rounded-lg mb-2">
                        <div class="text-[10px] truncate text-gray-300">${p.name}</div>
                        <div class="text-xs font-bold">R$ ${parseFloat(p.price).toFixed(2)}</div>
                        <button class="btn btn-red w-full mt-2 py-1 text-[9px]" onclick="excluir('products','${p.id}')">Excluir</button>
                    </div>`;
            });
        });
    });
});

/* PEDIDOS */
db.ref('orders').on('value', s => {
    const lista = document.getElementById('listaPedidos');
    if (!document.getElementById('inputBusca')) {
        lista.insertAdjacentHTML('beforebegin', `<input type="text" id="inputBusca" oninput="filtrarPedidos()" placeholder="üîç Buscar pedido..." class="w-full p-2 mb-3 bg-[#111] border border-[#333] rounded text-xs">`);
    }
    lista.innerHTML = '';
    s.forEach(o => {
        const p = o.val();
        if (p.arquivado) return;
        lista.innerHTML += `
            <div class="card flex justify-between items-center mb-2 pedido-card">
                <div>
                    <div class="font-bold text-[#caa85c] text-[11px]">#${p.numeroPedido || '---'}</div>
                    <div class="font-bold text-gray-200 text-sm">${p.cliente}</div>
                    <div class="text-xs text-green-500">R$ ${parseFloat(p.total||0).toFixed(2)}</div>
                </div>
                <div class="flex gap-1">
                    <button class="btn bg-blue-900/50 border-blue-700 text-[10px]" onclick="verDetalhesPedido('${o.key}')">Ver</button>
                    <button class="btn px-2 text-[10px]" onclick="editarPedido('${o.key}')">‚úèÔ∏è</button>
                    <button class="btn bg-orange-600/20 text-orange-500 text-[10px]" onclick="cancelarPedido('${o.key}')">üì¶</button>
                    <button class="btn btn-red text-[10px]" onclick="excluir('orders','${o.key}')">‚úï</button>
                </div>
            </div>`;
    });
});

/* FUN√á√ïES DE APOIO */
function filtrarPedidos() {
    const termo = document.getElementById('inputBusca').value.toLowerCase();
    document.querySelectorAll('.pedido-card').forEach(card => {
        card.style.display = card.innerText.toLowerCase().includes(termo) ? 'flex' : 'none';
    });
}

function excluir(path, id) {
    if(confirm("Deseja realmente excluir este item?")) {
        db.ref(`${path}/${id}`).remove();
    }
}

function cancelarPedido(id) {
    if(confirm("Arquivar este pedido?")) {
        db.ref('orders/' + id).update({ arquivado: true });
    }
}

function editarPedido(id) {
    db.ref('orders/' + id).once('value').then(s => {
        const p = s.val();
        abrirModal('Editar Total', `
            <label class="text-xs">Alterar Valor Total do Pedido</label>
            <input type="number" id="novoTotal" value="${p.total}">
        `, () => {
            const nt = document.getElementById('novoTotal').value;
            db.ref('orders/' + id).update({ total: parseFloat(nt) });
        });
    });
}

function verDetalhesPedido(id) {
    db.ref('orders/' + id).once('value').then(s => {
        const p = s.val();
        const itens = Object.values(p.itens || {}).map(i => `<li>${i.qtd}x ${i.nome}</li>`).join('');
        abrirModal('Detalhes do Pedido', `
            <div class="text-xs space-y-2">
                <p><b>Cliente:</b> ${p.cliente}</p>
                <p><b>WhatsApp:</b> ${p.whatsapp || 'N/A'}</p>
                <hr class="border-[#333]">
                <ul>${itens}</ul>
                <hr class="border-[#333]">
                <button onclick="gerarRomaneio('${id}','cliente')" class="btn-gold w-full py-2">üì∏ Gerar Romaneio Foto</button>
            </div>
        `, () => {});
    });
}

/* === ROMANEIO CORRIGIDO === */
function gerarRomaneio(id, tipo) {
    db.ref('orders/' + id).once('value').then(s => {
        const p = s.val();
        if (!p) return;

        const e = p.endereco_detalhado || {};
        const data = new Date().toLocaleString('pt-BR');
        
        // Busca o telefone da loja dinamicamente das configura√ß√µes
        db.ref('settings').once('value').then(set => {
            const config = set.val() || {};
            const telefoneLoja = config.whatsapp || "(00) 00000-0000";
            const valorTotal = parseFloat(p.total) || 0;
            const desconto = parseFloat(p.descontoPix || 0);
            const subtotalGeral = valorTotal + desconto;

            const mostrarFoto = (tipo === 'foto' || tipo === 'cliente');

            let html = `<html><head><title>Romaneio ${tipo.toUpperCase()}</title><style>
                @page { size: A4; margin: 1cm; }
                body { font-family: 'Segoe UI', Arial, sans-serif; color: #333; margin: 0; padding: 0; }
                .header { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid #caa85c; padding-bottom: 8px; margin-bottom: 15px; }
                .logo-area h1 { margin: 0; color: #caa85c; font-size: 22px; letter-spacing: 1px; }
                .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; font-size: 10px; }
                .info-box { padding: 8px; border: 1px solid #eee; background: #fafafa; line-height: 1.5; }
                table { width: 100%; border-collapse: collapse; table-layout: fixed; }
                th { background: #f2f2f2; padding: 7px 4px; border: 1px solid #ccc; font-size: 9px; text-transform: uppercase; }
                td { padding: 6px 4px; border: 1px solid #eee; font-size: 9px; vertical-align: middle; }
                .col-right { text-align: right; }
                .col-center { text-align: center; }
                .img-item { width: 45px; height: 45px; object-fit: cover; border-radius: 3px; border: 1px solid #ddd; display: block; margin: 0 auto; }
                .financeiro-box { width: 250px; border: 1px solid #eee; padding: 10px; margin-left: auto; margin-top: 15px; }
                .total-final { font-size: 15px; font-weight: bold; border-top: 2px solid #caa85c; padding-top: 5px; }
            </style></head><body>
            
            <div class="header">
                <div class="logo-area">
                    <h1>ABELLA JOIAS</h1>
                    <div style="font-size:10px;">WhatsApp: ${telefoneLoja}</div>
                </div>
                <div style="text-align:right; font-size: 10px;">
                    <strong>PEDIDO:</strong> #${id.substring(0,8).toUpperCase()}<br><strong>DATA:</strong> ${data}
                </div>
            </div>

            <div class="info-grid">
                <div class="info-box">
                    <strong>CLIENTE:</strong> ${p.cliente}<br>
                    <strong>FORMA PAGTO:</strong> ${p.pagamento || 'A combinar'}
                </div>
                <div class="info-box">
                    <strong>ENDERE√áO:</strong> ${e.rua || 'A retirar'}, ${e.num || 'S/N'}<br>
                    <strong>CIDADE:</strong> ${e.cidade || '---'}
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        ${mostrarFoto ? '<th style="width: 55px;">FOTO</th>' : ''}
                        <th style="width: 70px;">SKU</th>
                        <th>DESCRI√á√ÉO</th>
                        <th style="width: 35px;">QTD</th>
                        ${tipo !== 'simples' ? '<th style="width: 50px;">PESO T.</th>' : ''}
                        <th style="width: 75px;">SUBTOTAL</th>
                    </tr>
                </thead>
                <tbody>`;

            let pesoTotalGeral = 0;
            Object.values(p.itens || {}).forEach(i => {
                const qtd = parseInt(i.qtd) || 0;
                const pU = parseFloat(i.peso || i.weight || 0);
                const vU = parseFloat(i.preco || 0);
                const pT = pU * qtd;
                const vT = vU * qtd;
                pesoTotalGeral += pT;

                html += `<tr>
                    ${mostrarFoto ? `<td class="col-center"><img src="${i.image}" class="img-item" onerror="this.src='https://via.placeholder.com/45'"></td>` : ''}
                    <td style="font-family: monospace;">${i.sku || '---'}</td>
                    <td>${i.nome}</td>
                    <td class="col-center">${qtd}</td>
                    ${tipo !== 'simples' ? `<td class="col-center">${pT.toFixed(2)}g</td>` : ''}
                    <td class="col-right">R$ ${vT.toFixed(2)}</td>
                </tr>`;
            });

            html += `</tbody></table>
            <div class="financeiro-box">
                <div class="total-final col-right">TOTAL: R$ ${valorTotal.toFixed(2)}</div>
            </div>
            <script>window.onload = function() { setTimeout(() => { window.print(); window.close(); }, 500); }<\/script>
            </body></html>`;

            const win = window.open('', '_blank');
            win.document.write(html);
            win.document.close();
        });
    });
}

/* === SALVAR PROMOS OTIMIZADO === */
function salvarPromos() {
    const updates = {};
    document.querySelectorAll('[id^="promo-"]').forEach(i => {
        const catId = i.id.replace('promo-', '');
        updates['categories/' + catId + '/discount'] = Number(i.value);
    });

    db.ref().update(updates)
        .then(() => alert('Promo√ß√µes atualizadas com sucesso!'))
        .catch(e => alert('Erro ao salvar: ' + e.message));
    /* === GERENCIADOR DE PROMO√á√ïES (CATEGORIAS + GLOBAL) === */

// Fun√ß√£o simples para salvar os inputs da aba Promo√ß√µes
function salvarPromos() {
    const updates = {};
    document.querySelectorAll('[id^="promo-"]').forEach(i => {
        const id = i.id.replace('promo-', '');
        updates[`categories/${id}/discount`] = parseInt(i.value) || 0;
    });
    db.ref().update(updates).then(() => alert('Promo√ß√µes de categorias atualizadas!'));
}

// Fun√ß√£o do Painel Avan√ßado (Modal)
function abrirPainelPromocoes() {
    Promise.all([
        db.ref('settings/promocao').once('value'),
        db.ref('categories').once('value')
    ]).then(([snapPromo, snapCats]) => {
        const promo = snapPromo.val() || { ativa: false, porcentagem: 0 };
        
        let listaCatsHtml = '';
        snapCats.forEach(cat => {
            const d = cat.val();
            listaCatsHtml += `
                <div class="flex items-center justify-between p-2 bg-black border border-[#222] mb-1 rounded">
                    <span class="text-[10px] text-white uppercase font-bold">${d.name || cat.key}</span>
                    <div class="flex items-center gap-1">
                        <input type="number" id="promo_cat_${cat.key}" value="${d.discount || 0}" 
                            class="w-12 p-1 bg-[#111] border border-[#333] text-center text-xs text-white mb-0">
                        <span class="text-[#caa85c] text-[10px] font-bold">%</span>
                    </div>
                </div>`;
        });

        abrirModal('Gerenciar Promo√ß√µes', `
            <div class="space-y-4 text-left p-1">
                <div class="p-3 bg-[#111] rounded-xl border border-[#222]">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-white font-bold text-xs uppercase">Promo√ß√£o Global (Loja Toda)</span>
                        <button onclick="togglePromo()" id="btnStatusPromo" 
                            class="px-3 py-1 rounded-lg text-[9px] font-bold transition-all ${promo.ativa ? 'bg-green-600' : 'bg-red-600'}">
                            ${promo.ativa ? 'ATIVA' : 'INATIVA'}
                        </button>
                    </div>
                    <label class="text-[9px] text-[#caa85c] uppercase font-bold block mb-1">Porcentagem Global</label>
                    <input type="number" id="promoPorcentagem" value="${promo.porcentagem}" 
                        class="w-full p-2 bg-black border border-[#333] text-white rounded-lg outline-none mb-0">
                </div>
                <div>
                    <label class="text-[9px] text-[#caa85c] uppercase font-bold block mb-2 px-1">Ajuste por Categoria</label>
                    <div class="max-h-48 overflow-y-auto pr-1 space-y-1">${listaCatsHtml}</div>
                </div>
            </div>
        `, () => {
            const updates = {};
            updates['settings/promocao/porcentagem'] = parseInt(document.getElementById('promoPorcentagem').value || 0);
            
            snapCats.forEach(cat => {
                const valorCat = parseInt(document.getElementById(`promo_cat_${cat.key}`).value || 0);
                updates[`categories/${cat.key}/discount`] = valorCat;
            });

            db.ref().update(updates).then(() => alert("Promo√ß√µes atualizadas!"));
        });
    });
}

function togglePromo() {
    db.ref('settings/promocao/ativa').once('value').then(s => {
        const novoStatus = !(s.val() || false);
        db.ref('settings/promocao/ativa').set(novoStatus).then(() => {
            fecharModal();
            abrirPainelPromocoes(); // Recarrega o modal com a cor nova
        });
    });
}
}
</script>
</body>
</html>

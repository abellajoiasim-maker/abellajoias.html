<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Administrativo ‚Ä¢ Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#0b0b0b;color:#eee;font-family:Inter,Arial;margin:0}
nav button.active{border-bottom:2px solid #caa85c;color:#caa85c}
section{display:none;min-height:300px}
section.active{display:block}
.card{background:#141414;border:1px solid #2a2a2a;border-radius:16px;padding:14px}
.btn{background:#222;border:1px solid #444;padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer}
.btn-gold{background:#caa85c;color:#000;font-weight:700;padding:10px;border-radius:8px;cursor:pointer}
input,select{background:#111;border:1px solid #333;padding:8px;border-radius:8px;width:100%;margin-bottom:8px;color:#fff;outline:none}
#mainModal.active { display: flex; }
.custom-scroll::-webkit-scrollbar { width: 4px; }
.custom-scroll::-webkit-scrollbar-thumb { background: #caa85c; border-radius: 10px; }
#print-area { display: none; }
@media print {
    body * { visibility: hidden; }
    #print-area, #print-area * { visibility: visible; }
    #print-area { position: absolute; left: 0; top: 0; width: 100%; display: block; background: #fff; color: #000; }
}
</style>
</head>
<body>

<header class="p-5 text-center text-xl font-bold bg-black border-b border-[#222] text-[#caa85c] tracking-widest uppercase">
  Abella Joias ‚Ä¢ Painel de Controlo
</header>

<nav class="flex gap-2 p-2 bg-[#111] sticky top-0 z-50 overflow-x-auto">
  <button type="button" class="btn active" onclick="showTab('empresa', this)">Empresa</button>
  <button type="button" class="btn" onclick="showTab('categorias', this)">Categorias</button>
  <button type="button" class="btn" onclick="showTab('produtos', this)">Produtos</button>
  <button type="button" class="btn" onclick="showTab('promocoes', this)">Promo√ß√µes</button>
  <button type="button" class="btn" onclick="showTab('pedidos', this)">Pedidos</button>
</nav>

<main class="p-6 max-w-4xl mx-auto">
  <section id="empresa" class="active">
    <div class="card space-y-3">
      <h2 class="text-[#caa85c] font-bold uppercase text-sm">Configura√ß√£o da Loja</h2>
      <input id="empNome" placeholder="Nome da Empresa">
      <input id="empSub" placeholder="Slogan / Subt√≠tulo">
      <input id="empWhats" placeholder="WhatsApp da Loja">
      <div class="grid grid-cols-2 gap-2">
        <input id="empDesc" type="number" placeholder="Desc. PIX %">
        <input id="empParc" type="number" placeholder="Parcelas M√°x">
      </div>
      <button class="btn-gold w-full" onclick="salvarEmpresa()">GUARDAR ALTERA√á√ïES</button>
    </div>
  </section>

  <section id="categorias">
    <div class="card mb-4">
        <input id="newCatName" placeholder="Nome da Nova Categoria">
        <button class="btn-gold w-full" onclick="novaCategoria()">+ CADASTRAR CATEGORIA</button>
    </div>
    <div id="listaCategorias" class="grid gap-2"></div>
  </section>

  <section id="produtos">
    <div id="listaProdutos" class="grid gap-2"></div>
  </section>

 <section id="promocoes">
    <div class="card mb-4 text-center">
        <h2 class="serif gold-text uppercase text-sm mb-4 tracking-widest">Configura√ß√µes de Promo√ß√£o</h2>
        <p class="text-[10px] text-gray-500 mb-4 uppercase">Gerencie as etiquetas de desconto e promo√ß√µes globais ou espec√≠ficas.</p>
        <div class="flex flex-col gap-3">
            <button class="btn-gold w-full py-4 uppercase tracking-tighter" onclick="abrirPainelPromocoes()">
                üé® Configurar Etiquetas e Descontos
            </button>
            <div class="flex gap-2">
                <button class="btn flex-1 py-3 text-[10px] uppercase" onclick="alert('Funcionalidade em desenvolvimento')">üè∑Ô∏è Ver Categorias</button>
                <button class="btn flex-1 py-3 text-[10px] uppercase" onclick="alert('Funcionalidade em desenvolvimento')">üíé Ver Produtos</button>
            </div>
        </div>
    </div>
    <div id="listaPromocoes" class="grid gap-2"></div>
</section>

  <section id="pedidos">
    <div id="listaPedidos" class="grid gap-4"></div>
  </section>
</main>

<div id="mainModal" class="fixed inset-0 bg-black/90 z-[100] hidden items-center justify-center p-4">
    <div class="bg-[#141414] border border-[#2a2a2a] w-full max-w-lg rounded-2xl overflow-hidden shadow-2xl">
        <div class="p-4 border-b border-[#222] flex justify-between items-center">
            <h3 id="modalTitle" class="serif gold-text uppercase text-sm">T√≠tulo</h3>
            <button onclick="fecharModal()" class="text-gray-500 hover:text-white">&times;</button>
        </div>
        <div id="modalBody" class="p-6 max-h-[70vh] overflow-y-auto"></div>
        <div class="p-4 border-t border-[#222] flex gap-3">
            <button onclick="fecharModal()" class="flex-1 py-3 text-xs uppercase font-bold text-gray-500">Cancelar</button>
            <button id="modalSaveBtn" class="flex-1 btn-gold py-3 text-xs uppercase font-bold">Guardar Altera√ß√µes</button>
        </div>
    </div>
</div>

<div id="editorPedido" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
  <div class="bg-[#111] w-full max-w-4xl rounded-2xl p-5 overflow-auto max-h-[90vh] border border-[#333]">
    <h2 class="text-[#caa85c] font-bold text-lg mb-3 uppercase">Editar Pedido (Atacado)</h2>
    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <h3 class="font-bold mb-2 text-xs text-gray-400">CLIENTE</h3>
        <input id="edClienteNome" placeholder="Nome">
        <input id="edClienteTel" placeholder="WhatsApp">
      </div>
      <div>
        <h3 class="font-bold mb-2 text-xs text-gray-400">ENTREGA</h3>
        <input id="edRua" placeholder="Rua">
        <div class="grid grid-cols-2 gap-2">
            <input id="edNum" placeholder="N¬∫">
            <input id="edBairro" placeholder="Bairro">
        </div>
        <input id="edCidade" placeholder="Cidade">
      </div>
    </div>
    
    <h3 class="font-bold mt-4 mb-2 text-xs text-[#caa85c]">ITENS DO PEDIDO</h3>
    <div id="edItens" class="space-y-2"></div>
    <button class="btn w-full mt-2 border-dashed border-gray-600" onclick="adicionarItemEditor()">+ Adicionar Item</button>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6 p-4 bg-black/20 rounded-xl border border-[#222]">
      <div class="space-y-2">
          <h3 class="font-bold text-xs text-gray-400 uppercase">Ajustes de Frete</h3>
          <input id="edFreteNome" placeholder="Ex: SEDEX, Transportadora, Motoboy">
          <input id="edFreteValor" type="number" placeholder="Valor do Frete (0.00)">
      </div>
      <div class="space-y-2">
          <h3 class="font-bold text-xs text-gray-400 uppercase">Descontos</h3>
          <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="text-[9px] text-gray-500 uppercase">Desc. Promo (R$)</label>
                <input id="edDescPromo" type="number" placeholder="0.00">
              </div>
              <div>
                <label class="text-[9px] text-gray-500 uppercase">Desc. PIX (R$)</label>
                <input id="edDescPix" type="number" placeholder="0.00">
              </div>
          </div>
      </div>
    </div>

    <div class="flex flex-wrap gap-2 justify-between mt-6 pt-4 border-t border-[#222]">
      <button class="btn px-6" onclick="fecharEditorPedido()">CANCELAR</button>
      <div class="flex gap-2">
          <button class="btn bg-blue-900 border-blue-700" onclick="gerarRomaneio(pedidoEditando, 1)">ROMANEIO 1</button>
          <button class="btn bg-blue-900 border-blue-700" onclick="gerarRomaneio(pedidoEditando, 2)">ROMANEIO 2</button>
          <button class="btn bg-blue-900 border-blue-700" onclick="gerarRomaneio(pedidoEditando, 3)">FOTOS</button>
          <button class="btn-gold px-10" onclick="salvarPedidoEditado()">SALVAR</button>
      </div>
    </div>
  </div>
</div>

<div id="print-area"></div>

<script>
/* FIREBASE */
if (!firebase.apps.length) {
  firebase.initializeApp({
    apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
    databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com"
  });
}
const db = firebase.database();
const fMoeda = v => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0);

/* ===================== */
/* PEDIDOS ‚Äì CORE LOGIC */
/* ===================== */

let pedidoEditando = null;

/* üîê TRAVA DESCONTOS */
function aplicarTravaDescontos(p) {
  const dp = document.getElementById('edDescPromo');
  const dx = document.getElementById('edDescPix');
  if (!dp || !dx) return;

  const travado = p?.ajustadoManualmente !== true;
  dp.disabled = travado;
  dx.disabled = travado;
  dp.style.opacity = travado ? 0.4 : 1;
  dx.style.opacity = travado ? 0.4 : 1;
}

/* üß† REC√ÅLCULO CENTRAL */
function recalcularResumo(itens, dp, dx, frete) {
  let subtotal = 0, peso = 0;
  itens.forEach(i=>{
    const q = +i.quantidade||1;
    const pr = +i.price||0;
    const pe = +i.peso||0;
    subtotal += pr*q;
    peso += pe*q;
  });
  return {
    subtotalBruto: +subtotal.toFixed(2),
    descontoPromo: dp,
    descontoPix: dx,
    frete: frete,
    totalFinal: +(subtotal - dp - dx + frete).toFixed(2),
    pesoTotal: +peso.toFixed(2)
  };
}

/* ===================== */
/* ABRIR EDITOR */
/* ===================== */

function abrirEditorPedido(id){
  db.ref('orders/'+id).once('value',s=>{
    const p=s.val(); if(!p) return;
    pedidoEditando = id;

    edClienteNome.value = p.cliente?.nome || '';
    edClienteTel.value = p.cliente?.telefone || '';
    edRua.value = p.entrega?.rua || '';
    edNum.value = p.entrega?.num || '';
    edBairro.value = p.entrega?.bairro || '';
    edCidade.value = p.entrega?.cidade || '';

    edDescPromo.value = p.resumo?.descontoPromo || p.descontoPromo || 0;
    edDescPix.value = p.resumo?.descontoPix || p.descontoPix || 0;
    edFreteNome.value = p.freteNome || '';
    edFreteValor.value = p.freteValor || 0;

    edItens.innerHTML='';
    const itens = Array.isArray(p.itens)?p.itens:Object.values(p.itens||{});
    itens.forEach(i=>addItemEditor(i));

    aplicarTravaDescontos(p);
    editorPedido.classList.remove('hidden');
  });
}

/* ===================== */
/* SALVAR PEDIDO */
/* ===================== */

function salvarPedidoEditado(){
  const itens=[];
  document.querySelectorAll('#edItens > div.card').forEach(c=>{
    const ins=c.querySelectorAll('input');
    itens.push({
      sku:ins[0].value,
      name:ins[1].value,
      peso:+ins[2].value||0,
      price:+ins[3].value||0,
      quantidade:+ins[4].value||1
    });
  });

  const dp=+edDescPromo.value||0;
  const dx=+edDescPix.value||0;
  const frete=+edFreteValor.value||0;

  const resumo=recalcularResumo(itens,dp,dx,frete);

  db.ref('orders/'+pedidoEditando).update({
    cliente:{nome:edClienteNome.value,telefone:edClienteTel.value},
    entrega:{rua:edRua.value,num:edNum.value,bairro:edBairro.value,cidade:edCidade.value},
    itens,
    freteNome:edFreteNome.value,
    freteValor:frete,
    resumo,
    total:resumo.totalFinal,
    ajustadoManualmente:false
  }).then(()=>{
    alert("Pedido salvo e travado!");
    fecharEditorPedido();
  });
}

/* ===================== */
/* üìÑ ROMANEIO COM DESCONTOS */
/* ===================== */

function gerarRomaneio(id){
  db.ref('orders/'+id).once('value',s=>{
    const p=s.val(); if(!p) return;
    const r=p.resumo||{};
    let html=`<h2>ROMANEIO</h2><hr>`;
    (Array.isArray(p.itens)?p.itens:Object.values(p.itens||{})).forEach(i=>{
      html+=`${i.quantidade}x ${i.name} ‚Äî ${fMoeda(i.price)}<br>`;
    });
    html+=`<hr>
    Subtotal: ${fMoeda(r.subtotalBruto)}<br>
    Desc. Promo: -${fMoeda(r.descontoPromo)}<br>
    Desc. Pix: -${fMoeda(r.descontoPix)}<br>
    Frete: ${fMoeda(r.frete)}<br>
    <b>TOTAL: ${fMoeda(r.totalFinal)}</b>`;
    print-area.innerHTML=html;
    setTimeout(()=>window.print(),300);
  });
}
</script>

</body>
</html>

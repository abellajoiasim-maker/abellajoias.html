<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel Gestão | Abella Joias</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body { background:#F8F6F2; font-family: sans-serif; }
        .serif { font-family: 'Cinzel', serif; }
        .gold { color: #A68966; }
        .tab-panel { display: none; } 
        .tab-panel.active { display: block !important; }
        .nav-btn { padding: 12px 20px; font-size: 11px; font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; }
        .nav-btn.active { color: #A68966; border-bottom-color: #A68966; background: #fff; }
        input, select { border: 1px solid #ddd; padding: 10px; border-radius: 8px; width: 100%; margin-bottom: 5px; font-size: 14px; }
        label { font-size: 10px; font-weight: bold; color: #999; text-transform: uppercase; }
       .cat-group-title { 
    grid-column: 1 / -1; /* Isso obriga o título a ocupar a largura total do grid */
    background: #eee; 
    padding: 8px 15px; 
    font-weight: bold; 
    font-size: 12px; 
    border-radius: 4px; 
    margin-top: 20px; 
    color: #666; 
}  
        
        /* ESTILO PARA ITENS PAUSADOS */
        .paused { opacity: 0.5; filter: grayscale(1); border: 2px dashed red !important; }
    </style>
</head>
<body>

<header class="bg-white border-b sticky top-0 z-[100] shadow-sm">
    <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center px-6 py-3">
        <div class="text-center md:text-left">
            <h1 class="serif text-lg gold uppercase tracking-widest">Abella Joias</h1>
            <p class="text-[9px] text-gray-400 font-bold uppercase">Painel Administrativo</p>
        </div>
        <nav class="flex gap-1 mt-3 md:mt-0">
            <div onclick="switchTab('aba-empresa', this)" class="nav-btn active">EMPRESA</div>
            <div onclick="switchTab('aba-categorias', this)" class="nav-btn">CATEGORIAS</div>
            <div onclick="switchTab('aba-produtos', this)" class="nav-btn">PRODUTOS</div>
            <div onclick="switchTab('aba-pedidos', this)" class="nav-btn">PEDIDOS</div>
        </nav>
    </div>
</header>

<main class="max-w-7xl mx-auto p-6">

    <div id="aba-empresa" class="tab-panel active">
        <h2 class="serif text-xl gold mb-4">Configurações</h2>
        <div class="bg-white p-6 rounded-xl border grid md:grid-cols-2 gap-4">
            <div><label>Nome da Loja</label><input id="empNome"></div>
            <div><label>WhatsApp (DDD + Número)</label><input id="empWhats"></div>
            <div><label>Desconto PIX (%)</label><input id="empPix" type="number"></div>
            <div><label>Parcelas Máximas</label><input id="empParc" type="number"></div>
            <button onclick="saveEmpresa()" class="md:col-span-2 bg-[#A68966] text-white py-3 rounded-lg font-bold text-sm">ATUALIZAR DADOS</button>
        </div>
    </div>

    <div id="aba-categorias" class="tab-panel">
        <h2 class="serif text-xl gold mb-4">Categorias</h2>
        <div class="bg-white p-6 rounded-xl border flex flex-col md:flex-row gap-4 items-end mb-6">
            <input type="hidden" id="editCatId">
            <div class="flex-1"><label>Nome</label><input id="catNome"></div>
            <div class="flex-1"><label>URL Capa</label><input id="catImg"></div>
            <button onclick="saveCategoria()" class="bg-black text-white px-8 py-2.5 rounded-lg font-bold text-sm">SALVAR</button>
        </div>
        <div id="gridCats" class="grid grid-cols-2 md:grid-cols-6 gap-4"></div>
    </div>

    <div id="aba-produtos" class="tab-panel">
        <h2 class="serif text-xl gold mb-4">Produtos</h2>
        <div class="bg-white p-6 rounded-xl border mb-6">
            <input type="hidden" id="editProdId">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="md:col-span-2"><label>Nome</label><input id="pNome"></div>
                <div><label>SKU</label><input id="pSku"></div>
                <div><label>Categoria</label><select id="pCat"></select></div>
                <div><label>Preço (R$)</label><input id="pPreco" type="number" step="0.01"></div>
                <div><label>Peso (G)</label><input id="pPeso" type="number" step="0.01"></div>
                <div class="md:col-span-2"><label>URL Imagem</label><input id="pImg"></div>
            </div>
            <button onclick="saveProduto()" class="w-full bg-black text-white py-3 rounded-lg font-bold mt-4 text-sm uppercase">Salvar Produto</button>
        </div>
        <div id="gridProds" class="grid grid-cols-2 md:grid-cols-5 gap-4 pb-20"></div>
    </div>

    <div id="aba-pedidos" class="tab-panel">
        <h2 class="serif text-xl gold mb-4">Pedidos Recentes</h2>
        <div id="listaPedidos" class="grid gap-4"></div>
    </div>

</main>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
    databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function switchTab(id, el) {
    document.querySelectorAll('.tab-panel').forEach(p => { p.classList.remove('active'); p.style.display='none'; });
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.getElementById(id).style.display='block';
    el.classList.add('active');
}

// EMPRESA
db.ref('settings').on('value', s => {
    const d = s.val() || {};
    empNome.value = d.nome || ''; empWhats.value = d.whatsapp || '';
    empPix.value = d.pix || 0; empParc.value = d.parcelas || 1;
});
function saveEmpresa() {
    db.ref('settings').update({ nome: empNome.value, whatsapp: empWhats.value, pix: Number(empPix.value), parcelas: Number(empParc.value) });
    alert("Dados da empresa atualizados!");
}

// CATEGORIAS
function saveCategoria() {
    const nome = catNome.value;
    if(!nome) return;
    const id = document.getElementById('editCatId').value || nome.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]+/g, "-");
    db.ref('categories/' + id).update({ name: nome, image: catImg.value, slug: id });
    catNome.value = catImg.value = document.getElementById('editCatId').value = '';
}

db.ref('categories').on('value', s => {
    const grid = document.getElementById('gridCats');
    const select = document.getElementById('pCat');
    grid.innerHTML = ''; select.innerHTML = '<option value="">Selecione</option>';
    s.forEach(c => {
        const v = c.val();
        select.innerHTML += `<option value="${v.slug}">${v.name}</option>`;
        grid.innerHTML += `
            <div class="bg-white p-2 border rounded text-center shadow-sm ${v.paused ? 'paused' : ''}">
                <img src="${v.image}" class="w-full aspect-square object-cover rounded mb-1" onerror="this.src='https://via.placeholder.com/100'">
                <p class="text-[9px] font-bold truncate uppercase">${v.name}</p>
                <div class="flex flex-wrap justify-between mt-1 gap-1">
                    <button onclick="editCat('${v.slug}','${v.name}','${v.image}')" class="text-blue-500 text-[8px] font-bold flex-1 bg-blue-50 py-1 rounded">EDITAR</button>
                    <button onclick="togglePauseCat('${v.slug}', ${v.paused || false})" class="text-orange-600 text-[8px] font-bold flex-1 bg-orange-50 py-1 rounded">${v.paused ? 'ATIVAR' : 'PAUSAR'}</button>
                    <button onclick="delCat('${v.slug}')" class="text-red-500 text-[8px] font-bold px-2 bg-red-50 py-1 rounded">X</button>
                </div>
            </div>`;
    });
});
function editCat(id, n, i) { document.getElementById('editCatId').value = id; catNome.value = n; catImg.value = i; window.scrollTo(0,0); }
function togglePauseCat(id, currentStatus) { db.ref('categories/' + id).update({ paused: !currentStatus }); }
function delCat(id) { if(confirm("Excluir categoria?")) db.ref('categories/'+id).remove(); }

// PRODUTOS
function saveProduto() {
    const sku = pSku.value.trim();
    if(!sku) return;
    const id = sku.replace(/[\.\$#\[\]\/]/g, "-");
    db.ref('products/' + id).update({
        name: pNome.value, sku: sku, category: pCat.value,
        price: Number(pPreco.value), weight: pPeso.value, image: pImg.value
    }).then(() => { 
        alert("Produto Atualizado!"); 
        pNome.value=pSku.value=pPreco.value=pPeso.value=pImg.value=document.getElementById('editProdId').value='';
    });
}

// PRODUTOS (LISTAGEM COMPLETA E AGRUPADA)
db.ref('products').on('value', s => {
    const grid = document.getElementById('gridProds');
    grid.innerHTML = ''; // Limpa a tela antes de carregar
    
    if (!s.exists()) {
        grid.innerHTML = '<div class="col-span-full text-center py-10 text-gray-400">Nenhum produto cadastrado.</div>';
        return;
    }

    let prods = [];
    s.forEach(p => {
        prods.push({ id: p.key, ...p.val() });
    });

    // 1. Agrupar produtos por Categoria
    let grouped = prods.reduce((r, a) => {
        const catNome = a.category || "Sem Categoria";
        r[catNome] = [...r[catNome] || [], a];
        return r;
    }, {});

    // 2. Ordenar as categorias alfabeticamente e listar
    Object.keys(grouped).sort().forEach(cat => {
        // Inserir o título da Categoria (ocupa a linha toda)
        grid.innerHTML += `<div class="cat-group-title col-span-full">CATEGORIA: ${cat.toUpperCase().replace(/-/g, ' ')}</div>`;
        
        // Ordenar produtos por SKU dentro da categoria
        grouped[cat].sort((a, b) => (a.sku || "").localeCompare(b.sku || "")).forEach(p => {
            grid.innerHTML += `
                <div class="bg-white border rounded p-2 flex flex-col shadow-sm ${p.paused ? 'paused' : ''}">
                    <div class="relative">
                        <img src="${p.image}" class="w-full aspect-square object-contain" onerror="this.src='https://via.placeholder.com/150?text=Sem+Foto'">
                        ${p.paused ? '<span class="absolute top-1 left-1 bg-red-600 text-white text-[8px] px-1 rounded">PAUSADO</span>' : ''}
                    </div>
                    <p class="text-[10px] font-bold truncate mt-2">${p.name || 'Sem Nome'}</p>
                    <p class="text-[9px] text-gray-400 font-mono">SKU: ${p.sku}</p>
                    <p class="text-[10px] gold font-bold">R$ ${Number(p.price).toFixed(2)}</p>
                    
                    <div class="flex justify-between mt-3 border-t pt-2 gap-1">
                        <button onclick="editProd('${p.id}')" class="text-blue-600 text-[9px] font-bold bg-blue-50 p-1 rounded flex-1">EDITAR</button>
                        <button onclick="togglePauseProd('${p.id}', ${p.paused || false})" class="text-orange-600 text-[9px] font-bold bg-orange-50 p-1 rounded flex-1">${p.paused ? 'ATIVAR' : 'PAUSAR'}</button>
                        <button onclick="delProd('${p.id}')" class="text-red-500 text-[9px] font-bold bg-red-50 p-1 rounded">X</button>
                    </div>
                </div>`;
        });
    });
});

function editProd(id) {
    db.ref('products/'+id).once('value', s => {
        const p = s.val();
        pNome.value=p.name; pSku.value=p.sku; pCat.value=p.category;
        pPreco.value=p.price; pPeso.value=p.weight; pImg.value=p.image;
        document.getElementById('editProdId').value=id; 
        window.scrollTo(0,0);
    });
}
function togglePauseProd(id, currentStatus) { db.ref('products/' + id).update({ paused: !currentStatus }); }
function delProd(id) { if(confirm("Excluir produto?")) db.ref('products/'+id).remove(); }

// PEDIDOS
db.ref('orders').on('value', s => {
    const container = document.getElementById('listaPedidos');
    container.innerHTML = '';
    if(!s.exists()) {
        container.innerHTML = '<div class="bg-white p-10 border text-center text-gray-400">Nenhum pedido registrado.</div>';
        return;
    }
    let pedidos = [];
    s.forEach(child => { pedidos.push(child.val()); });
    pedidos.reverse();
    pedidos.forEach(p => {
        let itensHtml = '';
        p.itens.forEach(i => {
            itensHtml += `<div class="text-[10px] text-gray-600 border-b border-gray-50 py-1">
                ${i.qtd}x ${i.nome} <span class="float-right font-bold">R$ ${(i.preco * i.qtd).toFixed(2)}</span>
            </div>`;
        });
        container.innerHTML += `
            <div class="bg-white p-5 border rounded-xl shadow-sm">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <span class="bg-gold/10 text-[#A68966] text-[10px] font-bold px-2 py-1 rounded-full">${p.id}</span>
                        <p class="text-[10px] text-gray-400 mt-1">${p.data}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] uppercase font-bold text-gray-400">Total do Pedido</p>
                        <p class="gold font-bold text-lg">R$ ${p.total.toFixed(2)}</p>
                    </div>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg mb-3">${itensHtml}</div>
                <div class="flex justify-end gap-2">
                    <button onclick="marcarVendido('${p.id}')" class="text-[10px] bg-green-50 text-green-600 px-3 py-1 rounded font-bold">MARCAR COMO ATENDIDO</button>
                    <button onclick="excluirPedido('${p.id}')" class="text-[10px] bg-red-50 text-red-600 px-3 py-1 rounded font-bold">EXCLUIR</button>
                </div>
            </div>`;
    });
});
function marcarVendido(id) { db.ref('orders/' + id).update({ status: "Atendido" }); alert("Pedido atendido!"); }
function excluirPedido(id) { if(confirm("Apagar pedido?")) db.ref('orders/' + id).remove(); }
</script>
</body>
</html>

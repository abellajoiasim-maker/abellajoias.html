<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Admin • Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#0b0b0b;color:#eee;font-family:Inter,Arial}
nav button.active{border-color:#caa85c;color:#caa85c}
section{display:none}
section.active{display:block}
.card{background:#141414;border:1px solid #2a2a2a;border-radius:16px;padding:14px}
.grid{display:grid;gap:12px}
@media(min-width:768px){.grid{grid-template-columns:repeat(4,1fr)}}
@media(min-width:1200px){.grid{grid-template-columns:repeat(6,1fr)}}
.btn{background:#222;border:1px solid #444;padding:6px 10px;border-radius:8px;font-size:12px}
.btn-gold{background:#caa85c;color:#000;font-weight:700}
.btn-red{border-color:#c33;color:#f77}
.btn-pause{border-color:#caa85c;color:#caa85c}
.tag{font-size:10px;padding:3px 6px;border-radius:999px}
.ok{background:#1f3;color:#000}
.no{background:#c33}
#modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:100;align-items:center;justify-content:center}
.modal-box{background:#141414;border:1px solid #333;border-radius:20px;width:100%;max-width:520px;padding:20px;max-height:90vh;overflow-y:auto}
.modal-img{height:180px;object-fit:contain;background:#000;border-radius:12px;margin-bottom:12px}
input,select{background:#111;border:1px solid #333;padding:8px;border-radius:8px;width:100%;margin-bottom:8px}
</style>
</head>

<body>

<header class="p-5 text-center text-xl font-bold bg-black border-b border-[#222]">
Painel Administrativo • Abella Joias
</header>

<nav class="flex gap-2 p-2 bg-[#111]">
<button class="btn active" onclick="showTab('empresa',this)">Empresa</button>
<button class="btn" onclick="showTab('categorias',this)">Categorias</button>
<button class="btn" onclick="showTab('produtos',this)">Produtos</button>
<button class="btn" onclick="showTab('promocoes',this)">Promoções</button>
<button class="btn" onclick="showTab('pedidos',this)">Pedidos</button>
</nav>

<main class="p-6">

<!-- EMPRESA -->
<section id="empresa" class="active">
<div class="card max-w-md">
<input id="empNome" placeholder="Nome da empresa">
<input id="empWhats" placeholder="WhatsApp">
<input id="empPix" type="number" placeholder="Desconto PIX %">
<input id="empParc" type="number" placeholder="Parcelas">
<button class="btn-gold w-full mt-2" onclick="salvarEmpresa()">Salvar</button>
</div>
</section>

<!-- CATEGORIAS -->
<section id="categorias">
<button class="btn-gold mb-3" onclick="novaCategoria()">+ Nova Categoria</button>
<div id="listaCategorias" class="grid"></div>
</section>

<!-- PRODUTOS -->
<section id="produtos">
<div id="produtosPorCategoria"></div>
</section>

<!-- PROMOÇÕES -->
<section id="promocoes">
<div id="listaPromocoes" class="space-y-3 max-w-md"></div>
<button class="btn-gold mt-4" onclick="salvarPromos()">Aplicar promoções</button>
</section>

<!-- PEDIDOS -->
<section id="pedidos">
<div id="listaPedidos" class="space-y-3"></div>
</section>

</main>

<!-- MODAL -->
<div id="modal">
<div class="modal-box">
<h3 id="modalTitle" class="font-bold mb-2"></h3>
<div id="modalBody"></div>
<button class="btn-gold w-full mt-3" id="btnSalvar">Salvar</button>
<button class="btn w-full mt-2" onclick="fecharModal()">Fechar</button>
</div>
</div>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
 authDomain:"catalogo-abella-joias.firebaseapp.com",
 databaseURL:"https://catalogo-abella-joias-default-rtdb.firebaseio.com",
 projectId:"catalogo-abella-joias"
});
const db=firebase.database();

/* NAV */
function showTab(id,btn){
 document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
 document.getElementById(id).classList.add('active');
 document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
 btn.classList.add('active');
}

/* EMPRESA */
db.ref('settings').on('value',s=>{
 const v=s.val()||{};
 empNome.value=v.nome||'';
 empWhats.value=v.whatsapp||'';
 empPix.value=v.pix||0;
 empParc.value=v.parcelas||1;
});
function salvarEmpresa(){
 db.ref('settings').update({
  nome:empNome.value,
  whatsapp:empWhats.value,
  pix:+empPix.value,
  parcelas:+empParc.value
 });
 alert('Empresa salva');
}

/* CATEGORIAS */
db.ref('categories').on('value',s=>{
 listaCategorias.innerHTML='';
 listaPromocoes.innerHTML='';
 s.forEach(c=>{
  const d=c.val();
  listaCategorias.innerHTML+=`
  <div class="card">
   <div class="flex justify-between">
    <b>${d.name}</b>
    <span class="tag ${d.image?'ok':'no'}">IMG</span>
   </div>
   <div class="text-xs opacity-60">${Object.keys(d.variacoes||{}).length} variações</div>
   <div class="flex gap-1 mt-2">
    <button class="btn" onclick="editarCategoria('${c.key}')">Editar</button>
    <button class="btn btn-pause" onclick="togglePause('categories','${c.key}')">Pausar</button>
    <button class="btn btn-red" onclick="excluir('categories','${c.key}')">Excluir</button>
   </div>
  </div>`;
  
  listaPromocoes.innerHTML+=`
  <div class="card flex justify-between items-center">
   <span>${d.name}</span>
   <input type="number" id="promo-${c.key}" value="${d.discount||0}" class="w-20">
  </div>`;
 });
});

/* VARIAÇÕES NAS CATEGORIAS */
function editarCategoria(id){
 db.ref('categories/'+id).once('value').then(s=>{
  const d=s.val();
  abrirModal('Editar Categoria',`
   <img src="${d.image||''}" class="modal-img">
   <input id="catName" value="${d.name}">
   <input id="catImg" value="${d.image||''}">
   <h4 class="mt-3 font-bold">Variações</h4>
   <div id="vars"></div>
   <button class="btn mt-2" onclick="novaVariacao('${id}')">+ Nova Variação</button>
  `,()=>{
   db.ref('categories/'+id).update({
    name:catName.value,
    image:catImg.value
   });
  });
  
  const box=document.getElementById('vars');
  Object.entries(d.variacoes||{}).forEach(([k,v])=>{
   box.innerHTML+=`
   <div class="flex gap-2 mb-1 text-xs">
    <input value="${v.label||k}" onchange="updVar('${id}','${k}',this.value)">
    <button class="btn btn-red" onclick="delVar('${id}','${k}')">✕</button>
   </div>`;
  });
 });
}
function novaVariacao(cat){
 const k=prompt('Chave da variação (ex: A, DEUS)');
 if(!k) return;
 db.ref(`categories/${cat}/variacoes/${k}`).set({label:k,ativo:true});
}
function updVar(cat,key,val){
 db.ref(`categories/${cat}/variacoes/${key}`).update({label:val});
}
function delVar(cat,key){
 db.ref(`categories/${cat}/variacoes/${key}`).remove();
}

/* PRODUTOS */
db.ref('products').on('value',s=>{
 const map={};
 s.forEach(p=>{
  const v=p.val();v.id=p.key;
  if(!map[v.category]) map[v.category]=[];
  map[v.category].push(v);
 });
 produtosPorCategoria.innerHTML='';
 Object.keys(map).forEach(cat=>{
  produtosPorCategoria.innerHTML+=`<h3 class="text-[#caa85c] mt-6 mb-2">${cat}</h3><div class="grid"></div>`;
  const g=produtosPorCategoria.lastChild;
  map[cat].forEach(p=>{
   g.innerHTML+=`
   <div class="card">
    <div class="flex justify-between">
     <b>${p.sku||''}</b>
     <span class="tag ${p.image?'ok':'no'}">IMG</span>
    </div>
    <div class="text-xs">${p.name}</div>
    <div class="flex gap-1 mt-2">
     <button class="btn" onclick="editarProduto('${p.id}')">Editar</button>
     <button class="btn btn-pause" onclick="togglePause('products','${p.id}')">Pausar</button>
     <button class="btn btn-red" onclick="excluir('products','${p.id}')">Excluir</button>
    </div>
   </div>`;
  });
 });
});

/* PRODUTO MODAL COM VARIAÇÕES CORRIGIDO */
function editarProduto(id){
  db.ref('products/'+id).once('value').then(s=>{
    const p = s.val();
    // Busca as variações da categoria correta deste produto
    db.ref('categories/'+p.category+'/variacoes').once('value').then(vs=>{
      let opts = '<option value="">Sem variação</option>'; // Opção padrão
      
      if(vs.exists()){
        vs.forEach(child => {
          const varData = child.val();
          const varKey = child.key;
          const varLabel = varData.label || varKey;
          
          // Verifica se esta é a variação que o produto já tem selecionada
          const selected = (p.variacao === varKey) ? 'selected' : '';
          
          opts += `<option value="${varKey}" ${selected}>${varLabel}</option>`;
        });
      }

      abrirModal('Editar Produto', `
        <img src="${p.image || ''}" class="modal-img">
        <label class="text-[10px] uppercase opacity-50">Nome do Produto</label>
        <input id="pName" value="${p.name}">
        <label class="text-[10px] uppercase opacity-50">SKU</label>
        <input id="pSku" value="${p.sku}">
        <label class="text-[10px] uppercase opacity-50">Preço</label>
        <input id="pPrice" type="number" step="0.01" value="${p.price}">
        <label class="text-[10px] uppercase opacity-50">Peso (g)</label>
        <input id="pWeight" value="${p.weight}">
        <label class="text-[10px] uppercase opacity-50">Variação da Categoria</label>
        <select id="pVar">${opts}</select>
        <label class="text-[10px] uppercase opacity-50">URL da Imagem</label>
        <input id="pImg" value="${p.image}">
      `, () => {
        db.ref('products/' + id).update({
          name: pName.value,
          sku: pSku.value,
          price: pPrice.value,
          weight: pWeight.value,
          variacao: pVar.value,
          image: pImg.value
        });
      });
    });
  });
}

/* PROMOS */
function salvarPromos(){
 document.querySelectorAll('[id^="promo-"]').forEach(i=>{
  db.ref('categories/'+i.id.replace('promo-','')).update({discount:+i.value});
 });
 alert('Promoções atualizadas');
}

/* PEDIDOS ATUALIZADO */
db.ref('orders').on('value', s => {
    const lista = document.getElementById('listaPedidos');
    lista.innerHTML = '';
    
    if (!s.exists()) {
        lista.innerHTML = '<div class="p-10 text-center opacity-50">Nenhum pedido recebido.</div>';
        return;
    }

    s.forEach(o => {
        const pedido = o.val();
        const id = o.key;
        
        // Formatação de data simples (se existir no seu checkout)
        const data = pedido.data ? new Date(pedido.data).toLocaleString('pt-BR') : 'Sem data';
        
        lista.innerHTML += `
        <div class="card flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
            <div>
                <div class="text-[10px] opacity-40 font-mono">${id}</div>
                <div class="font-bold text-[#caa85c]">${pedido.cliente || 'Cliente não identificado'}</div>
                <div class="text-xs">Total: R$ ${parseFloat(pedido.total || 0).toFixed(2)}</div>
            </div>
            
            <div class="flex gap-2 w-full md:w-auto">
                <button class="btn flex-1 md:flex-none" onclick="verDetalhesPedido('${id}')">Ver Detalhes</button>
                <button class="btn btn-red" onclick="excluir('orders','${id}')">Excluir</button>
            </div>
        </div>`;
    });
});

// Função para abrir o modal com os itens do pedido
function verDetalhesPedido(id) {
    db.ref('orders/' + id).once('value').then(s => {
        const p = s.val();
        let itensHtml = '';
        
        // Monta a lista de itens
        if(p.itens) {
            Object.values(p.itens).forEach(item => {
                itensHtml += `
                <div class="flex justify-between border-b border-[#222] py-2 text-sm">
                    <span>${item.qtd}x ${item.nome} ${item.variacao ? '('+item.variacao+')' : ''}</span>
                    <span class="font-mono text-[#caa85c]">R$ ${(item.preco * item.qtd).toFixed(2)}</span>
                </div>`;
            });
        }

        abrirModal('Detalhes do Pedido', `
            <div class="space-y-4">
                <div>
                    <h4 class="text-[#caa85c] font-bold uppercase text-[10px]">Cliente</h4>
                    <p class="text-lg">${p.cliente || 'N/A'}</p>
                    <p class="text-xs opacity-60">WhatsApp: ${p.whatsapp || 'N/A'}</p>
                </div>
                
                <div>
                    <h4 class="text-[#caa85c] font-bold uppercase text-[10px]">Endereço</h4>
                    <p class="text-sm">${p.endereco || 'Retirada / Não informado'}</p>
                </div>

                <div>
                    <h4 class="text-[#caa85c] font-bold uppercase text-[10px] mb-2">Itens</h4>
                    ${itensHtml}
                </div>

                <div class="bg-[#1a1a1a] p-3 rounded-lg flex justify-between">
                    <span class="font-bold">TOTAL DO PEDIDO:</span>
                    <span class="font-bold text-green-500">R$ ${parseFloat(p.total || 0).toFixed(2)}</span>
                </div>
                
                <div class="text-[10px] opacity-40 italic">Forma de Pagamento: ${p.pagamento || 'Não informada'}</div>
            </div>
        `, () => { console.log('Pedido visualizado'); });
        
        // Oculta o botão "Salvar" do modal, pois é só visualização
        document.getElementById('btnSalvar').style.display = 'none';
    });
}

// Ajuste na função fecharModal para resetar o botão salvar
const fecharOriginal = fecharModal;
fecharModal = () => {
    document.getElementById('btnSalvar').style.display = 'block';
    fecharOriginal();
}

/* UTIL */
function abrirModal(t,b,cb){
 modal.style.display='flex';
 modalTitle.innerText=t;
 modalBody.innerHTML=b;
 btnSalvar.onclick=()=>{cb();fecharModal()};
}
function fecharModal(){modal.style.display='none'}
function excluir(p,id){if(confirm('Excluir?')) db.ref(p+'/'+id).remove()}
function togglePause(p,id){db.ref(p+'/'+id+'/paused').transaction(v=>!v)}
</script>

</body>
</html>

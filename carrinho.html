<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Finalizar Pedido ‚Ä¢ Abella Joias</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Poppins', sans-serif; background: #0b0b0b; color: #eee; margin:0; }
        .serif { font-family: 'Cinzel', serif; }
        .gold-text { color: #caa85c; }
        .gold-bg { background: #caa85c; }
        .card { background: #141414; border-radius: 18px; border: 1px solid #2a2a2a; padding: 20px; margin-bottom: 20px; }
        input { background: #000 !important; border: 1px solid #333 !important; color: #fff !important; padding: 12px; border-radius: 10px; width: 100%; outline: none; margin-bottom: 12px; font-size: 14px; }
        .pay-btn { border: 1px solid #333; border-radius: 14px; padding: 16px; text-align: center; cursor: pointer; transition: 0.3s; }
        .pay-btn.active { border-color: #caa85c; background: rgba(202, 168, 92, 0.05); }
        .price-anchor-highlight { text-decoration: line-through; color: #ff4d4d; font-size: 1.5rem; font-weight: bold; }
        .promo-tag { color: #ff4d4d; font-weight: bold; font-size: 10px; text-transform: uppercase; }
        .btn-remove { color: #ff4d4d; opacity: 0.6; transition: 0.3s; padding: 5px; }
        .btn-remove:hover { opacity: 1; transform: scale(1.1); }
    </style>
</head>
<body>

<header class="sticky top-0 z-50 bg-black/95 backdrop-blur-md border-b border-[#222]">
    <div class="max-w-xl mx-auto p-4 flex justify-between items-center">
        <button onclick="history.back()" class="text-[10px] font-bold uppercase gold-text">‚Üê Voltar</button>
        <h1 class="serif gold-text uppercase text-sm tracking-widest">Finalizar Pedido</h1>
    </div>
</header>

<main class="max-w-xl mx-auto p-4 pb-40">

    <div class="card">
        <h2 class="serif gold-text uppercase text-[10px] mb-4 tracking-widest opacity-70 text-center">Itens no Carrinho</h2>
        <div id="listaItens" class="space-y-4"></div>

        <div class="grid grid-cols-3 gap-2 mt-6 pt-6 border-t border-[#222]">
            <div class="bg-black p-3 rounded-xl border border-[#222] text-center">
                <span class="block text-[8px] uppercase text-gray-500 font-bold mb-1">Modelos</span>
                <b id="totalSkus" class="text-white">0</b>
            </div>
            <div class="bg-black p-3 rounded-xl border border-[#222] text-center">
                <span class="block text-[8px] uppercase text-gray-500 font-bold mb-1">Pe√ßas</span>
                <b id="totalPecas" class="text-white">0</b>
            </div>
            <div class="bg-black p-3 rounded-xl border border-[#caa85c]/20 text-center">
                <span class="block text-[8px] uppercase gold-text font-bold mb-1">Peso Total</span>
                <b id="pesoTotal" class="text-white text-xs">0,00g</b>
            </div>
        </div>
    </div>

    <div class="card">
        <h2 class="serif gold-text uppercase text-[10px] mb-4 tracking-widest border-b border-[#222] pb-2">Identifica√ß√£o</h2>
        <input id="nomeCliente" placeholder="Seu Nome Completo *">
        <input id="telefoneCliente" placeholder="WhatsApp (DDD + N√∫mero) *">
    </div>

    <div class="card">
        <h2 class="serif gold-text uppercase text-[10px] mb-4 tracking-widest border-b border-[#222] pb-2">Local de Entrega</h2>
        <input id="nomeEntrega" placeholder="Nome do Destinat√°rio">
        <input id="rua" placeholder="Rua / Avenida">
        <div class="grid grid-cols-4 gap-2">
            <input id="num" placeholder="N¬∫">
            <input id="bairro" placeholder="Bairro" class="col-span-3">
        </div>
        <input id="cidade" placeholder="Cidade">
        <input id="cepEntrega" placeholder="CEP">
    </div>

    <div class="card">
        <h2 class="serif gold-text uppercase text-[10px] mb-4 tracking-widest border-b border-[#222] pb-2">Forma de Pagamento</h2>
        <div class="grid grid-cols-2 gap-4">
            <div class="pay-btn" onclick="setPagamento('Pix', this)">
                <span class="block text-white font-bold">PIX</span>
                <span class="text-[9px] text-green-500 font-bold uppercase">Com Desconto</span>
            </div>
            <div class="pay-btn" onclick="setPagamento('Cart√£o', this)">
                <span class="block text-white font-bold">CART√ÉO</span>
                <span class="text-[9px] text-blue-400 font-bold uppercase">At√© 3x s/ Juros</span>
            </div>
        </div>
    </div>

    <div class="card">
        <h2 class="serif gold-text uppercase text-[10px] mb-6 tracking-widest text-center border-b border-[#222] pb-2">Resumo Financeiro</h2>
        <div class="space-y-4">
            <div class="flex justify-between text-gray-500 text-sm">
                <span>Subtotal Bruto</span>
                <b id="subtotalTxt" class="text-white">R$ 0,00</b>
            </div>
            <div id="containerDescontos" class="space-y-3 pt-3 border-t border-dashed border-[#333]">
                <div id="linhaDescontoPromo" class="flex justify-between text-emerald-500 italic text-sm hidden">
                    <span id="labelPromo">Desconto Promocional</span>
                    <b id="valorDescontoPromo">- R$ 0,00</b>
                </div>
                <div id="linhaCondicao" class="flex justify-between text-blue-300 italic text-sm hidden">
                    <span id="labelCondicao">Condi√ß√£o Selecionada</span>
                    <b id="valorCondicao">R$ 0,00</b>
                </div>
            </div>
            <div class="mt-6 pt-6 border-t-2 border-[#caa85c] flex flex-col items-end">
                <div id="precoBrutoRiscado" class="price-anchor-highlight hidden">R$ 0,00</div>
                <div class="flex justify-between w-full items-center mt-2">
                    <span class="serif gold-text text-xl">TOTAL A PAGAR</span>
                    <span id="totalTxt" class="text-3xl font-bold gold-text">R$ 0,00</span>
                </div>
            </div>
        </div>
    </div>
</main>

<footer class="fixed bottom-0 left-0 right-0 p-4 bg-black/90 border-t border-[#222] z-50">
    <div class="max-w-xl mx-auto">
        <button onclick="finalizarPedido()" class="w-full gold-bg text-black py-5 rounded-2xl font-bold uppercase tracking-widest active:scale-95 transition shadow-lg">
            Finalizar via WhatsApp
        </button>
    </div>
</footer>

<script>
if (!firebase.apps.length) {
    firebase.initializeApp({
        apiKey:"AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
        databaseURL:"https://catalogo-abella-joias-default-rtdb.firebaseio.com"
    });
}
const db = firebase.database();
let carrinho = JSON.parse(localStorage.getItem('carrinho')||'[]');
let pagamento = '';
let foneLoja = '';
let configEmpresa = { descontoPix: 0, parcelas: 3, nomePromo: "OFERTA" };

const fM = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
const fP = (v) => v.toLocaleString('pt-BR', { minimumFractionDigits: 2 }) + 'g';

// BLOCO DE SINCRONIA INTELIGENTE
db.ref('settings').on('value', s => { 
    const data = s.val();
    if(data) {
        if(data.empresa) {
            foneLoja = data.empresa.whats ? data.empresa.whats.replace(/\D/g,'') : '';
            configEmpresa.descontoPix = parseFloat(data.empresa.descontoPix) || 0;
            configEmpresa.parcelas = parseInt(data.empresa.parcelas) || 3;
        }
        let nomePromocaoPainel = (data.promocoes && data.promocoes.nome) || (data.empresa && data.empresa.nomePromo) || "BLACK FRIDAY";
        configEmpresa.nomePromo = nomePromocaoPainel.toUpperCase();
    }
    carregarCarrinho();
});

function carregarCarrinho() {
    let box = document.getElementById('listaItens');
    box.innerHTML = '';
    let bruto = 0, comPromo = 0, peso = 0, pecas = 0;

    if(carrinho.length === 0) {
        box.innerHTML = `<p class="text-center text-gray-500 py-10">Seu carrinho est√° vazio.</p>`;
    }

    carrinho.forEach((item, index) => {
        let q = parseInt(item.quantidade) || 1;
        let pOrig = parseFloat(item.price || item.precoFinal || 0);
        let pProm = parseFloat(item.precoFinal || item.price || 0);
        bruto += (pOrig * q); comPromo += (pProm * q); pecas += q;
        let pU = item.peso || item.weight || 0;
        if(typeof pU === 'string') pU = parseFloat(pU.replace(',','.')) || 0;
        peso += (pU * q);

        box.innerHTML += `
            <div class="flex items-center gap-3 py-3 border-b border-[#222]">
                <button onclick="removerItem(${index})" class="btn-remove">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
                <img src="${item.image}" class="w-14 h-14 object-cover rounded-lg border border-[#333]">
                <div class="flex-1">
                    <h3 class="text-[10px] font-bold text-white uppercase">${item.name}</h3>
                    <div class="flex items-center gap-2 mt-2">
                        <button onclick="altQtd(${index},-1)" class="w-6 h-6 bg-[#222] border border-[#caa85c] text-[#caa85c] rounded">-</button>
                        <span class="text-xs font-mono">${q}</span>
                        <button onclick="altQtd(${index},1)" class="w-6 h-6 bg-[#222] border border-[#caa85c] text-[#caa85c] rounded">+</button>
                    </div>
                </div>
                <div class="text-right">
                    ${pOrig > pProm ? `<div class="flex flex-col items-end"><span class="promo-tag">${configEmpresa.nomePromo}</span><span class="text-gray-600 line-through text-[9px]">${fM(pOrig*q)}</span></div>` : ''}
                    <b class="gold-text text-sm">${fM(pProm*q)}</b>
                </div>
            </div>`;
    });

    const economiaPromo = bruto - comPromo;
    const descPix = (pagamento === 'Pix') ? comPromo * (configEmpresa.descontoPix / 100) : 0;
    const valorFinal = comPromo - descPix;

    document.getElementById('totalSkus').innerText = carrinho.length;
    document.getElementById('totalPecas').innerText = pecas;
    document.getElementById('pesoTotal').innerText = fP(peso);
    document.getElementById('subtotalTxt').innerText = fM(bruto);
    document.getElementById('totalTxt').innerText = fM(valorFinal);

    if(economiaPromo > 0) {
        document.getElementById('linhaDescontoPromo').classList.remove('hidden');
        document.getElementById('labelPromo').innerText = `Desconto Promocional ${configEmpresa.nomePromo} -`;
        document.getElementById('valorDescontoPromo').innerText = `- ${fM(economiaPromo)}`;
    }

    if(pagamento !== '') {
        document.getElementById('linhaCondicao').classList.remove('hidden');
        document.getElementById('precoBrutoRiscado').classList.remove('hidden');
        document.getElementById('precoBrutoRiscado').innerText = fM(bruto);
        if(pagamento === 'Pix') {
            document.getElementById('labelCondicao').innerText = "B√¥nus Pagamento Pix";
            document.getElementById('valorCondicao').innerText = `- ${fM(descPix)}`;
        } else {
            document.getElementById('labelCondicao').innerText = `Parcelamento em ${configEmpresa.parcelas}x`;
            document.getElementById('valorCondicao').innerText = `${fM(valorFinal/configEmpresa.parcelas)} / m√™s`;
        }
    }
    window.resumoFinal = { total: valorFinal };
}

function removerItem(i) {
    if(confirm("Deseja remover este item do carrinho?")) {
        carrinho.splice(i, 1);
        localStorage.setItem('carrinho', JSON.stringify(carrinho));
        carregarCarrinho();
    }
}

function setPagamento(p, el) {
    pagamento = p;
    document.querySelectorAll('.pay-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    carregarCarrinho();
}

function altQtd(i, d) {
    carrinho[i].quantidade = (carrinho[i].quantidade || 1) + d;
    if(carrinho[i].quantidade < 1) return removerItem(i);
    localStorage.setItem('carrinho', JSON.stringify(carrinho));
    carregarCarrinho();
}

async function finalizarPedido() {
    const nome = document.getElementById('nomeCliente').value;
    if(!nome || !pagamento) return alert("Preencha Nome e Pagamento.");
    
    const totalTexto = fM(window.resumoFinal.total);
    let msg = `Ol√°, meu nome √© *${nome}*!\n\nAcabei de fazer um pedido pelo cat√°logo da Abella Joias.\nüí∞ *Total:* ${totalTexto}\nüí≥ *Pagamento:* ${pagamento}\n\nAguardando seu retorno para finalizar!`;
    
    localStorage.removeItem('carrinho');
    window.location.href = `https://api.whatsapp.com/send?phone=${foneLoja}&text=${encodeURIComponent(msg)}`;
}
</script>
</body>
</html>

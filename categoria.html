<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Produtos | Abella Joias</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background: #fdfcf9; }
        .serif { font-family: 'Cinzel', serif; }
        .gold-text { color: #A68966; }
        .gold-bg { background: #A68966; }
        .card-prod { background: #fff; border-radius: 15px; border: 1px solid #eee; transition: .3s; }
        .btn-nav { border: 1px solid #A68966; color: #A68966; font-size: 10px; font-weight: bold; letter-spacing: 1px; transition: .3s; }
        .btn-nav:hover { background: #A68966; color: #fff; }
        .price-old { text-decoration: line-through; color: #999; font-size: 11px; }
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:100; align-items:center; justify-content:center; }
        .modal.active { display:flex; }
        .card-prod img {
    width: 100%;
    height: 100%;
    object-fit: contain; /* Garante que a joia apareça inteira */
    padding: 8px;
}
    </style>
</head>
<body>

<header class="bg-white border-b border-gray-100 sticky top-0 z-50 shadow-sm text-center">
    <div class="max-w-7xl mx-auto px-4 py-6 flex flex-col items-center">
        <h1 class="serif text-3xl gold-text tracking-widest uppercase">Abella Joias</h1>
        <p class="text-[10px] tracking-[4px] text-gray-400 font-light mt-1 mb-6 uppercase">Atacado de Joias no Bruto</p>
        <div class="flex gap-3 flex-wrap justify-center">
            <a href="index.html" class="btn-nav px-6 py-2 rounded-full">CATEGORIAS</a>
            <a href="galvanicas.html" class="btn-nav px-6 py-2 rounded-full">GALVÂNICAS</a>
            <a href="carrinho.html" class="btn-nav px-6 py-2 rounded-full relative">
                CARRINHO <span id="contadorCarrinho" class="ml-1">(0)</span>
            </a>
        </div>
    </div>
</header>

<main class="max-w-7xl mx-auto p-6">
    <h2 id="tituloCategoria" class="serif text-center text-xl mb-8 gold-text uppercase">...</h2>
    <div id="gridProdutos" class="grid grid-cols-1 md:grid-cols-4 gap-6"></div>
</main>

<div id="modalQtd" class="modal">
    <div class="bg-white p-6 rounded-2xl max-w-sm w-full mx-4 shadow-2xl text-center">
        <div class="aspect-square w-full mb-4 bg-gray-50 rounded-lg overflow-hidden border">
            <img id="modalImgProd" src="" class="w-full h-full object-contain">
        </div>
        <h3 class="serif gold-text text-lg mb-1">Digite a Quantidade</h3>
        <p id="modalNomeProd" class="text-[10px] text-gray-400 uppercase mb-4 font-bold"></p>
        <input type="number" id="inputQtd" value="1" min="1" class="w-full border-2 border-[#A68966] rounded-xl p-3 text-center text-lg font-bold mb-6 outline-none focus:ring-2 ring-[#A68966]">
        <div class="flex gap-2">
            <button onclick="fecharModal()" class="flex-1 py-3 text-[10px] font-bold text-gray-400 uppercase">Cancelar</button>
            <button id="btnConfirmarAdd" class="flex-1 gold-bg text-white py-3 rounded-xl text-[10px] font-bold uppercase shadow-lg">Confirmar</button>
        </div>
    </div>
</div>

<script>
    firebase.initializeApp({
        apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
        databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com"
    });
    const db = firebase.database();
    const urlParams = new URLSearchParams(window.location.search);
    const catId = urlParams.get('id');
    let produtoAtualParaAdd = null;

    // ESTA FUNÇÃO ESTÁ TRAVADA NO FORMATO BRASIL
    const fM = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

    function atualizarContador() {
        const c = JSON.parse(localStorage.getItem('carrinho') || '[]');
        const totalPecas = c.reduce((acc, item) => acc + (parseInt(item.quantidade) || 0), 0);
        document.getElementById('contadorCarrinho').innerText = `(${totalPecas})`;
    }

    async function carregarProdutos() {
        // Busca Configurações do Painel
        const [empSnap, setSnap, catSnap] = await Promise.all([
            db.ref('settings/empresa').once('value'),
            db.ref('settings/promocao').once('value'),
            db.ref('categories/' + catId).once('value')
        ]);

        const configEmpresa = empSnap.val() || { descontoPix: 0, parcelas: 1 };
        const promoGeral = setSnap.val() || { ativa: false, porcentagem: 0 };
        const categoria = catSnap.val() || {};
        
        document.getElementById('tituloCategoria').innerText = categoria.name || "Produtos";

        db.ref('products').on('value', snap => {
            const grid = document.getElementById('gridProdutos');
            grid.innerHTML = '';
            
            snap.forEach(s => {
                const p = s.val();
                if (p.paused || p.category !== catId) return;

                // Cálculo de Descontos
                let porcentagem = 0;
                if (promoGeral.ativa) {
                    porcentagem = p.discount > 0 ? p.discount : (categoria.discount > 0 ? categoria.discount : promoGeral.porcentagem);
                }

                const precoFinal = porcentagem > 0 ? p.price * (1 - porcentagem / 100) : p.price;
                const valorPix = precoFinal * (1 - (configEmpresa.descontoPix / 100));
                const valorParcela = precoFinal / configEmpresa.parcelas;

                grid.innerHTML += `
                    <div class="card-prod p-4 flex flex-col h-full bg-white shadow-sm border border-gray-100">
                        <div class="aspect-square mb-4 bg-white rounded-lg overflow-hidden relative flex items-center justify-center border border-gray-50">
                            ${porcentagem > 0 ? `<span class="absolute top-2 left-2 bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded-full">-${porcentagem}%</span>` : ''}
                            <img src="${p.image}" class="w-full h-full object-contain p-2">
                        </div>
                        <div class="flex-1">
                            <div class="text-[9px] text-gray-400 font-bold uppercase">SKU: ${p.sku}</div>
                            <h3 class="text-[11px] font-bold uppercase mb-1 h-8 overflow-hidden">${p.name}</h3>
                            <div class="text-[10px] text-gray-500 mb-2 italic">Peso: ${p.weight}g</div>
                            
                            <div class="mb-4">
                                ${porcentagem > 0 ? `<div class="text-[11px] text-gray-400 line-through">${fM(p.price)}</div>` : ''}
                                <div class="text-base font-bold gold-text">${fM(precoFinal)}</div>
                                <div class="text-[10px] text-gray-600 font-medium italic">Ou ${configEmpresa.parcelas}x de ${fM(valorParcela)}</div>
                                <div class="text-[10px] text-green-600 font-bold uppercase mt-1">À Vista no PIX: ${fM(valorPix)}</div>
                            </div>
                        </div>

                        <button onclick='prepararAdd(${JSON.stringify({...p, precoFinal, porcentagem}).replace(/'/g, "")})' 
                            class="w-full gold-bg text-white py-3 rounded-lg text-[10px] font-bold uppercase shadow-md active:scale-95 transition">
                            Adicionar ao Carrinho
                        </button>
                    </div>`;
            });
        });
    }

    function prepararAdd(p) {
        produtoAtualParaAdd = p;
        document.getElementById('modalImgProd').src = p.image;
        document.getElementById('modalNomeProd').innerText = p.name;
        document.getElementById('inputQtd').value = 1;
        document.getElementById('modalQtd').classList.add('active');
    }

    function fecharModal() { document.getElementById('modalQtd').classList.remove('active'); }

    document.getElementById('btnConfirmarAdd').onclick = () => {
        const qtd = parseInt(document.getElementById('inputQtd').value);
        if(qtd < 1) return;
        
        let carrinho = JSON.parse(localStorage.getItem('carrinho') || '[]');
        carrinho.push({ ...produtoAtualParaAdd, quantidade: qtd });
        
        localStorage.setItem('carrinho', JSON.stringify(carrinho));
        fecharModal();
        atualizarContador();
    };

    carregarProdutos();
    atualizarContador();
</script>
</body>
</html>

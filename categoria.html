<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Produtos | Abella Joias</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background: #f8f6f2; }
        .serif { font-family: 'Cinzel', serif; }
        .gold { color: #A68966; }
        .card-prod { background: white; border-radius: 12px; overflow: hidden; border: 1px solid #eee; transition: 0.3s; }
        .card-prod:hover { border-color: #A68966; transform: translateY(-3px); }
        
        /* Estilo do Input de Quantidade no Modal */
        #modalQtyInput:focus { border-color: #A68966; outline: none; }
        /* Remove setas do input number para um visual mais limpo */
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body>

<header class="bg-white border-b sticky top-0 z-50 px-6 py-4 flex justify-between items-center shadow-sm">
    <div class="flex items-center gap-4">
        <a href="index.html" class="text-gray-400 hover:text-black">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </a>
        <h1 id="categoryTitle" class="serif text-xl gold uppercase tracking-widest">Carregando...</h1>
    </div>
    
    <div class="flex items-center gap-4">
        <a href="carrinho.html" class="bg-black text-white px-4 py-2 rounded-full text-[10px] font-bold tracking-tighter flex items-center gap-2">
            CARRINHO (<span id="cartCount">0</span>)
        </a>
    </div>
</header>

<main class="max-w-7xl mx-auto p-6">
    <div id="gridProdutos" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6">
        </div>
</main>

<div id="customModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:10000; align-items:center; justify-content:center; backdrop-filter: blur(3px);">
    <div style="background:#fff; padding:30px; border-radius:20px; width:90%; max-width:380px; text-align:center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);">
        <h3 id="modalProductName" class="serif" style="color:#000; margin-bottom:8px; font-size:18px; font-weight:700;">Produto</h3>
        <p id="modalSKU" style="font-size:10px; color:#A68966; margin-bottom:20px; letter-spacing:1px;"></p>
        
        <label style="display:block; font-size:11px; color:#888; margin-bottom:8px; text-transform:uppercase;">Quantidade Desejada</label>
        <input type="number" id="modalQtyInput" value="1" min="1" 
               style="width:120px; padding:15px; border:2px solid #A68966; border-radius:12px; text-align:center; font-size:24px; font-weight:700; margin-bottom:25px; color:#000;">
        
        <div style="display:flex; gap:12px;">
            <button onclick="closeAbellaModal()" style="flex:1; padding:15px; background:#f4f4f4; color:#666; border-radius:10px; font-weight:700; font-size:12px;">CANCELAR</button>
            <button id="confirmBtn" style="flex:2; padding:15px; background:#000; color:#fff; border-radius:10px; font-weight:700; font-size:12px; letter-spacing:1px;">ADICIONAR AO PEDIDO</button>
        </div>
    </div>
</div>

<script>
    // Configurações Firebase
    const firebaseConfig = { 
        apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY", 
        databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Pegar categoria da URL
    const urlParams = new URLSearchParams(window.location.search);
    const catSlug = urlParams.get('cat');
    let currentProductData = null;

    // 1. Carregar Dados da Categoria e Produtos
    if (catSlug) {
        // Título da Categoria
        db.ref('categories').orderByChild('slug').equalTo(catSlug).on('value', snap => {
            snap.forEach(s => { document.getElementById('categoryTitle').innerText = s.val().name; });
        });

        // Lista de Produtos
        db.ref('products').orderByChild('category').equalTo(catSlug).on('value', snap => {
            const grid = document.getElementById('gridProdutos');
            grid.innerHTML = '';
            
            snap.forEach(s => {
                const p = s.val();
                if(p.paused) return;

                grid.innerHTML += `
                <div class="card-prod p-4 flex flex-direction-column flex-col justify-between">
                    <div>
                        <div class="aspect-square mb-4 bg-gray-50 rounded-lg overflow-hidden">
                            <img src="${p.image}" class="w-full h-full object-contain p-2">
                        </div>
                        <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">SKU: ${p.sku}</p>
                        <h4 class="text-xs font-medium text-gray-800 leading-tight mb-2 h-8 overflow-hidden">${p.name}</h4>
                        <p class="text-sm font-bold text-black mb-4">R$ ${parseFloat(p.price).toFixed(2)}</p>
                    </div>
                    <button onclick="abrirModalQuantidade('${p.sku}', '${p.name.replace(/'/g, "\\'")}')" 
                            class="w-full bg-black text-white py-3 rounded-lg text-[10px] font-bold tracking-widest hover:bg-[#A68966] transition">
                        ADICIONAR
                    </button>
                </div>`;
            });
        });
    }

    // 2. Lógica do Modal Customizado
    function abrirModalQuantidade(sku, nome) {
        currentProductData = { sku, nome };
        document.getElementById('modalProductName').innerText = nome;
        document.getElementById('modalSKU').innerText = "SKU: " + sku;
        document.getElementById('modalQtyInput').value = 1;
        document.getElementById('customModal').style.display = 'flex';
        
        // Foca no input e seleciona o texto para o atacadista digitar rápido
        setTimeout(() => {
            const input = document.getElementById('modalQtyInput');
            input.focus();
            input.select();
        }, 150);
    }

    function closeAbellaModal() {
        document.getElementById('customModal').style.display = 'none';
    }

    // 3. Confirmar e Adicionar ao Carrinho Real
    document.getElementById('confirmBtn').onclick = function() {
        const qtd = parseInt(document.getElementById('modalQtyInput').value);
        
        if (isNaN(qtd) || qtd <= 0) {
            alert("Por favor, digite uma quantidade válida.");
            return;
        }

        // Recupera carrinho do LocalStorage ou inicia vazio
        let cart = JSON.parse(localStorage.getItem('abella_cart')) || [];
        
        // Verifica se o item já existe para somar
        const index = cart.findIndex(item => item.sku === currentProductData.sku);
        if (index > -1) {
            cart[index].qty += qtd;
        } else {
            cart.push({
                sku: currentProductData.sku,
                name: currentProductData.name,
                qty: qtd
            });
        }

        // Salva e fecha
        localStorage.setItem('abella_cart', JSON.stringify(cart));
        atualizarContadorCarrinho();
        closeAbellaModal();
        
        // Feedback visual
        console.log("Sucesso no pedido:", currentProductData.name);
    };

    function atualizarContadorCarrinho() {
        const cart = JSON.parse(localStorage.getItem('abella_cart')) || [];
        const total = cart.reduce((acc, item) => acc + item.qty, 0);
        document.getElementById('cartCount').innerText = total;
    }

    // Fecha ao clicar fora
    window.onclick = function(e) {
        if (e.target == document.getElementById('customModal')) closeAbellaModal();
    }

    // Inicia contador
    atualizarContadorCarrinho();
</script>

</body>
</html>

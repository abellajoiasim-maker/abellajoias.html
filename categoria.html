<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Produtos | Abella Joias</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=Poppins:wght@300;500&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Poppins', sans-serif; background: #f8f6f2; }
        .serif { font-family: 'Cinzel', serif; }
        .gold { color: #A68966; }
        .card { background: white; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; }
        .img-box { aspect-ratio: 1/1; width: 100%; display: flex; align-items: center; justify-content: center; background: #fff; padding: 10px; }
        .img-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
    </style>
</head>

<body>

<header class="p-6 flex justify-between items-center border-b bg-white sticky top-0 z-50">
    <a href="index.html" class="text-xs font-bold text-gray-400 hover:text-black transition">← VOLTAR</a>
    <h1 class="serif gold text-lg uppercase tracking-widest" id="tituloCat">Carregando...</h1>
    <button onclick="abrirCarrinho()" class="bg-black text-white px-5 py-2 rounded-full text-[10px] font-bold tracking-widest">CARRINHO (<span id="cartCount">0</span>)</button>
</header>

<main class="max-w-6xl mx-auto p-6 grid grid-cols-2 md:grid-cols-4 gap-6" id="gridProdutos"></main>

<div id="modalCarrinho" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[60] p-4">
    <div class="bg-white w-full max-w-lg rounded-2xl p-8 shadow-2xl">
        <h2 class="serif gold text-2xl mb-6">Meu Pedido</h2>
        <div id="listaItensCarrinho" class="space-y-4 max-h-[60vh] overflow-y-auto mb-6"></div>
        <div class="border-t pt-4 space-y-2">
            <div class="flex justify-between font-bold text-lg">
                <span>Total Estimado:</span>
                <span id="totalCarrinho">R$ 0,00</span>
            </div>
            <p class="text-[10px] text-gray-400 uppercase">* Valores finais e frete serão combinados via WhatsApp.</p>
        </div>
        <div class="mt-8 flex gap-4">
            <button onclick="fecharCarrinho()" class="flex-1 border border-gray-200 py-3 rounded-full text-xs font-bold">CONTINUAR COMPRANDO</button>
            <button onclick="finalizarWhatsApp()" class="flex-1 bg-green-600 text-white py-3 rounded-full text-xs font-bold">FINALIZAR WHATSAPP</button>
        </div>
    </div>
</div>

<script>
firebase.initializeApp({
    apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
    databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com"
});
const db = firebase.database();

// Pega o slug da categoria pela URL
const catSlug = new URLSearchParams(location.search).get('cat');
let configLoja = { pix: 0, parcelas: 1, whatsapp: "" };
let cart = JSON.parse(localStorage.getItem('cartAbella')) || [];

// 1. Carregar Configurações e Título
db.ref('settings').on('value', s => {
    configLoja = s.val() || configLoja;
    atualizarContador();
});

db.ref('categories/' + catSlug).once('value', s => {
    document.getElementById('tituloCat').innerText = s.val() ? s.val().name : "Produtos";
});

// 2. Carregar Produtos da Categoria (Ordenados por SKU)
db.ref('products').orderByChild('category').equalTo(catSlug).on('value', snap => {
    const grid = document.getElementById('gridProdutos');
    grid.innerHTML = '';
    
    let prods = [];
    snap.forEach(s => { prods.push(s.val()); });
    
    // Ordenar por SKU (Crescente)
    prods.sort((a,b) => a.sku.localeCompare(b.sku));

    prods.forEach(p => {
        const precoPix = p.price * (1 - (configLoja.pix / 100));
        const valorParcela = p.price / configLoja.parcelas;

        grid.innerHTML += `
        <div class="card shadow-sm border border-gray-100 p-3">
            <div class="img-box">
                <img src="${p.image || 'assets/img/produtos/'+p.sku+'.jpg'}" onerror="this.src='assets/img/sem-foto.jpg'">
            </div>
            <div class="mt-3 flex-1 flex flex-col">
                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-tighter">SKU: ${p.sku}</p>
                <h3 class="text-[11px] font-medium text-gray-800 leading-tight h-8 overflow-hidden mt-1">${p.name}</h3>
                <p class="text-[10px] text-gray-400 mt-1">Peso: ${p.weight}g</p>
                
                <div class="mt-3 pt-2 border-t border-gray-50">
                    <p class="text-[10px] text-gray-400 line-through">R$ ${p.price.toFixed(2)}</p>
                    <p class="gold font-bold text-base leading-none">R$ ${precoPix.toFixed(2)}</p>
                    <p class="text-[9px] text-gray-500 font-medium">no PIX ou ${configLoja.parcelas}x de R$ ${valorParcela.toFixed(2)}</p>
                </div>

                <button onclick="adicionar('${p.sku}', '${p.name}', ${precoPix})" class="mt-4 w-full bg-black text-white py-2.5 text-[10px] font-bold rounded-full hover:bg-gold transition">
                    ADICIONAR
                </button>
            </div>
        </div>`;
    });
});

// FUNÇÕES DO CARRINHO
function adicionar(sku, nome, preco) {
    const qtd = parseInt(prompt(`Quantidade para ${nome}:`, "1"));
    if (qtd > 0) {
        const index = cart.findIndex(i => i.sku === sku);
        if (index > -1) {
            cart[index].qtd += qtd;
        } else {
            cart.push({ sku, nome, preco, qtd });
        }
        localStorage.setItem('cartAbella', JSON.stringify(cart));
        atualizarContador();
        alert("Adicionado ao carrinho!");
    }
}

function atualizarContador() {
    const totalItens = cart.reduce((acc, item) => acc + item.qtd, 0);
    document.getElementById('cartCount').innerText = totalItens;
}

function abrirCarrinho() {
    const lista = document.getElementById('listaItensCarrinho');
    const totalTxt = document.getElementById('totalCarrinho');
    lista.innerHTML = '';
    let total = 0;

    if (cart.length === 0) {
        lista.innerHTML = '<p class="text-center text-gray-400 py-10">Seu carrinho está vazio.</p>';
    }

    cart.forEach((item, index) => {
        const subtotal = item.preco * item.qtd;
        total += subtotal;
        lista.innerHTML += `
        <div class="flex justify-between items-center border-b pb-3">
            <div class="flex-1">
                <p class="text-xs font-bold text-gray-800">${item.nome}</p>
                <p class="text-[10px] text-gray-400">SKU: ${item.sku} | Qtd: ${item.qtd}</p>
            </div>
            <div class="text-right">
                <p class="text-xs font-bold gold">R$ ${subtotal.toFixed(2)}</p>
                <button onclick="remover(${index})" class="text-[9px] text-red-500 font-bold uppercase">Remover</button>
            </div>
        </div>`;
    });

    totalTxt.innerText = `R$ ${total.toFixed(2)}`;
    document.getElementById('modalCarrinho').classList.replace('hidden', 'flex');
}

function fecharCarrinho() {
    document.getElementById('modalCarrinho').classList.replace('flex', 'hidden');
}

function remover(index) {
    cart.splice(index, 1);
    localStorage.setItem('cartAbella', JSON.stringify(cart));
    abrirCarrinho();
    atualizarContador();
}

function finalizarWhatsApp() {
    if (cart.length === 0) return alert("Carrinho vazio!");
    
    const pedidoId = "PED-" + Math.floor(1000 + Math.random() * 9000);
    const data = new Date().toLocaleString('pt-BR');
    
    let total = 0;
    cart.forEach(i => total += (i.preco * i.qtd));

    // Salvar no Firebase para o Painel ver
    const pedidoDados = {
        id: pedidoId,
        data: data,
        itens: cart,
        total: total,
        status: "Pendente"
    };

    db.ref('orders/' + pedidoId).set(pedidoDados).then(() => {
        // Formatar mensagem para o WhatsApp
        let msg = `*Pedido ${pedidoId} - Abella Joias*\n`;
        msg += `Data: ${data}\n\n`;
        cart.forEach(i => {
            msg += `• ${i.qtd}x ${i.nome} (${i.sku}) - R$ ${(i.preco * i.qtd).toFixed(2)}\n`;
        });
        msg += `\n*Total Estimado: R$ ${total.toFixed(2)}*`;

        const fone = configLoja.whatsapp.replace(/\D/g, '');
        window.open(`https://wa.me/${fone}?text=${encodeURIComponent(msg)}`);
        
        // Limpa carrinho após sucesso
        cart = [];
        localStorage.removeItem('cartAbella');
        atualizarContador();
        fecharCarrinho();
    });
}
</script>

</body>
</html>

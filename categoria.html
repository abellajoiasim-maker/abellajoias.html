<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Produtos | Abella Joias</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=Poppins:wght@300;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background: #f8f6f2; }
        .serif { font-family: 'Cinzel', serif; }
        .gold { color: #A68966; }
        .card { background: white; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; position: relative; }
        .img-box { aspect-ratio: 1/1; width: 100%; display: flex; align-items: center; justify-content: center; background: #fff; padding: 10px; }
        .img-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .tag-promo { position: absolute; top: 12px; left: 12px; background: #000; color: #fff; font-size: 8px; font-weight: 800; padding: 4px 8px; border-radius: 50px; z-index: 10; letter-spacing: 1px; }
    </style>
</head>
<body>

<header class="p-4 flex flex-col md:flex-row justify-between items-center border-b bg-white sticky top-0 z-50 gap-4">
    <div class="flex flex-col items-center md:items-start">
        <h1 class="serif gold text-lg uppercase tracking-widest" id="tituloCat">Carregando...</h1>
    </div>
    
    <div class="flex flex-wrap justify-center gap-2">
        <a href="index.html" class="bg-white border border-gray-200 text-gray-600 px-4 py-2 rounded-full text-[9px] font-bold tracking-widest hover:bg-gray-50">
            CATEGORIAS
        </a>
        <a href="galvanicas.html" class="bg-white border border-gray-200 text-gray-600 px-4 py-2 rounded-full text-[9px] font-bold tracking-widest hover:bg-gray-50">
            GALVÂNICAS
        </a>
        <button onclick="abrirCarrinho()" class="bg-black text-white px-5 py-2 rounded-full text-[9px] font-bold tracking-widest shadow-lg">
            CARRINHO (<span id="cartCount">0</span>)
        </button>
    </div>
</header>
    

<main class="max-w-6xl mx-auto p-6 grid grid-cols-2 md:grid-cols-4 gap-6" id="gridProdutos"></main>

<div id="modalCarrinho" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[60] p-4">
    <div class="bg-white w-full max-w-lg rounded-2xl p-8 shadow-2xl">
        <h2 class="serif gold text-2xl mb-6">Meu Pedido</h2>
        <div id="listaItensCarrinho" class="space-y-4 max-h-[60vh] overflow-y-auto mb-6"></div>
        <div class="border-t pt-4 space-y-2">
            <div class="flex justify-between font-bold text-lg"><span>Total:</span><span id="totalCarrinho">R$ 0,00</span></div>
        </div>
        <div class="mt-8 flex gap-4">
            <button onclick="fecharCarrinho()" class="flex-1 border py-3 rounded-full text-xs font-bold">VOLTAR</button>
            <button onclick="finalizarWhatsApp()" class="flex-1 bg-green-600 text-white py-3 rounded-full text-xs font-bold">WHATSAPP</button>
        </div>
    </div>
</div>

<script>
firebase.initializeApp({ apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY", databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com" });
const db = firebase.database();
const catSlug = new URLSearchParams(location.search).get('cat');
let configLoja = { pix: 0, parcelas: 1, whatsapp: "" };
let cart = JSON.parse(localStorage.getItem('cartAbella')) || [];

db.ref('settings').on('value', s => { configLoja = s.val() || configLoja; atualizarContador(); });
db.ref('categories/' + catSlug).once('value', s => { document.getElementById('tituloCat').innerText = s.val() ? s.val().name : "Produtos"; });

db.ref('products').orderByChild('category').equalTo(catSlug).on('value', snap => {
    const grid = document.getElementById('gridProdutos'); grid.innerHTML = '';
    let prods = [];
    snap.forEach(s => { prods.push(s.val()); });
    prods.sort((a,b) => a.sku.localeCompare(b.sku));

    prods.forEach(p => {
        if(p.paused) return; 
        const precoPix = p.price * (1 - (configLoja.pix / 100));
        const valorParcela = p.price / configLoja.parcelas;
        const tagHtml = p.tag ? `<div class="tag-promo">${p.tag}</div>` : '';

        grid.innerHTML += `
        <div class="card shadow-sm border border-gray-100 p-3">
            ${tagHtml}
            <div class="img-box">
                <img src="${p.image}" onerror="this.src='https://via.placeholder.com/400?text=Sem+Foto'">
            </div>
            <div class="mt-3 flex-1 flex flex-col">
                <p class="text-[10px] text-gray-400 font-bold uppercase">SKU: ${p.sku}</p>
                <h3 class="text-[11px] font-medium text-gray-800 leading-tight h-8 overflow-hidden mt-1">${p.name}</h3>
                <div class="mt-3 pt-2 border-t border-gray-50">
                    <p class="text-[10px] text-gray-400 line-through">R$ ${p.price.toFixed(2)}</p>
                    <p class="gold font-bold text-base">R$ ${precoPix.toFixed(2)}</p>
                    <p class="text-[9px] text-gray-500">${configLoja.parcelas}x de R$ ${valorParcela.toFixed(2)}</p>
                </div>
                <button onclick="adicionar('${p.sku}', '${p.name}', ${precoPix})" class="mt-4 w-full bg-black text-white py-2.5 text-[10px] font-bold rounded-full uppercase">Adicionar</button>
            </div>
        </div>`;
    });
});

function adicionar(sku, nome, preco) {
    const qtd = parseInt(prompt(`Quantidade para ${nome}:`, "1"));
    if (qtd > 0) {
        const index = cart.findIndex(i => i.sku === sku);
        if (index > -1) cart[index].qtd += qtd; else cart.push({ sku, nome, preco, qtd });
        localStorage.setItem('cartAbella', JSON.stringify(cart));
        atualizarContador(); alert("Adicionado!");
    }
}
function atualizarContador() { document.getElementById('cartCount').innerText = cart.reduce((acc, i) => acc + i.qtd, 0); }
function abrirCarrinho() {
    const lista = document.getElementById('listaItensCarrinho');
    const totalTxt = document.getElementById('totalCarrinho');
    lista.innerHTML = ''; let total = 0;
    cart.forEach((item, idx) => {
        total += (item.preco * item.qtd);
        lista.innerHTML += `<div class="flex justify-between border-b pb-2 text-xs"><div><b>${item.nome}</b><br>${item.qtd}x</div><button onclick="remover(${idx})" class="text-red-500">X</button></div>`;
    });
    totalTxt.innerText = `R$ ${total.toFixed(2)}`;
    document.getElementById('modalCarrinho').classList.replace('hidden', 'flex');
}
function fecharCarrinho() { document.getElementById('modalCarrinho').classList.replace('flex', 'hidden'); }
function remover(idx) { cart.splice(idx, 1); localStorage.setItem('cartAbella', JSON.stringify(cart)); abrirCarrinho(); atualizarContador(); }
function finalizarWhatsApp() {
    let msg = `*Novo Pedido - Abella Joias*\n\n`;
    cart.forEach(i => { msg += `• ${i.qtd}x ${i.nome} - R$ ${(i.preco * i.qtd).toFixed(2)}\n`; });
    const fone = configLoja.whatsapp.replace(/\D/g, '');
    window.open(`https://wa.me/${fone}?text=${encodeURIComponent(msg)}`);
}
</script>
</body>
</html>

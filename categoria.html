<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Produtos | Abella Joias</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Poppins', sans-serif; background: #0b0b0b; color: #eee; margin:0; padding-bottom: 60px; }
        .serif { font-family: 'Cinzel', serif; }
        .gold-text { color: #caa85c; }
        .gold-bg { background: #caa85c; }
        header { background: #000; border-bottom: 1px solid #222; }

        .btn-nav { border: 1px solid #caa85c; color: #caa85c; font-size: 10px; font-weight: bold; letter-spacing: 1px; transition: .3s; text-transform: uppercase; }
        .btn-nav:hover { background: #caa85c; color: #000; }

        .card-prod { background:#141414; border-radius:15px; border:1px solid #2a2a2a; transition:.3s; display:flex; flex-direction:column; height:100%; overflow:hidden; position: relative; }
        .card-prod:hover { border-color: #caa85c; transform: translateY(-3px); }

        .img-container { width:100%; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; background:#1a1a1a; overflow:hidden; position:relative; }
        .img-container img { width:100%; height:100%; object-fit:cover; }

        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:100; align-items:center; justify-content:center; padding: 20px; }
        .modal.active { display:flex; }
        .modal-content { background:#141414; border: 1px solid #2a2a2a; padding: 24px; border-radius: 20px; width: 100%; max-width: 400px; text-align: center; }

        input[type="number"] { background: #000; border: 1px solid #333; color: #fff; outline: none; }

    /* AJUSTE PARA MOBILE (COLAR AQUI) */
    @media (max-width: 640px) {
        .img-container img {
            padding: 4px !important; /* Faz a imagem da joia ficar maior no celular */
        }
        
        /* Opcional: Ajusta o arredondamento do card no mobile para ganhar espaço */
        .card-prod {
            border-radius: 10px !important;
        }
    }
</style>
</head>
<body>

<header class="sticky top-0 z-50 shadow-lg text-center bg-black/90 backdrop-blur-md">
    <div class="max-w-7xl mx-auto px-4 py-6 flex flex-col items-center">
        <h1 class="serif text-3xl gold-text tracking-widest uppercase" id="nomeLoja">Abella Joias</h1>
        <p class="text-[10px] tracking-[4px] text-gray-500 font-light mt-1 mb-6 uppercase" id="sloganLoja">Atacado de Joias no Bruto</p>
        
        <div class="flex gap-3 flex-wrap justify-center items-center">
            <a href="index.html" class="btn-nav px-6 py-2 rounded-full">CATEGORIAS</a>
            <a href="galvanicas.html" class="btn-nav px-6 py-2 rounded-full border-dashed">✨ GALVÂNICAS</a>
            <a href="carrinho.html" class="btn-nav px-6 py-2 rounded-full relative flex items-center gap-2">
                <span>CARRINHO</span> <span id="contadorCarrinho" class="font-bold gold-text">R$ 0,00</span>
            </a>
        </div>
    </div>
</header>

<main class="max-w-7xl mx-auto p-6">
    <h2 id="tituloCategoria" class="serif text-center text-xl mb-8 gold-text uppercase tracking-widest">...</h2>
    <div id="gridProdutos" class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
        </div>
</main>

<div id="modalQtd" class="modal">
    <div class="modal-content">
        <div class="img-container mb-4 rounded-xl border border-[#222]">
            <img id="modalImgProd" src="">
        </div>
        <h3 class="serif gold-text text-lg mb-1" id="modalNomeProd">Produto</h3>
        <p class="text-[10px] text-gray-500 uppercase mb-4">Escolha a quantidade</p>
        
        <input type="number" id="inputQtd" value="1" min="1" class="w-full rounded-xl p-3 text-center text-lg font-bold mb-6 focus:ring-2 ring-[#caa85c]">
        
        <div class="flex gap-2">
            <button onclick="fecharModal()" class="flex-1 py-3 text-[10px] font-bold text-gray-500 uppercase">Voltar</button>
            <button id="btnConfirmarAdd" class="flex-1 gold-bg text-black py-3 rounded-xl text-[10px] font-bold uppercase shadow-lg">Confirmar</button>
        </div>
    </div>
</div>

<script>
// Configuração do Firebase
if (!firebase.apps.length) {
    firebase.initializeApp({
        apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
        databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com"
    });
}
const db = firebase.database();
const urlParams = new URLSearchParams(window.location.search);
const catId = urlParams.get('id'); 
let produtoAtualParaAdd = null;

const fM = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

function atualizarContador() {
    const carrinho = JSON.parse(localStorage.getItem('carrinho') || '[]');
    const totalValor = carrinho.reduce((acc, item) => {
        const preco = parseFloat(item.precoFinal || item.price) || 0;
        const qtd = parseInt(item.quantidade || item.qtd) || 0;
        return acc + (preco * qtd);
    }, 0);
    document.getElementById('contadorCarrinho').innerText = fM(totalValor);
}

async function carregarProdutos() {
    const params = new URLSearchParams(window.location.search);
    const catId = params.get('id');

    if(!catId) { window.location.href = 'index.html'; return; }

    const [empSnap, catSnap, promoSnap] = await Promise.all([
        db.ref('settings/empresa').once('value'),
        db.ref('categories/' + catId).once('value'),
        db.ref('settings/promocao').once('value')
    ]);

    const v = empSnap.val() || { nome: "Abella Joias", subtitulo: "Atacado de Joias no Bruto", descontoPix: 5, parcelas: 3 };
    const categoria = catSnap.val() || {};
    const cnf = promoSnap.val() || { ativa: false, label: 'OFF' };

    document.getElementById('nomeLoja').innerText = v.nome;
    document.getElementById('sloganLoja').innerText = v.subtitulo;
    document.getElementById('tituloCategoria').innerText = categoria.name || "Produtos";

    db.ref('products').on('value', snap => {
        const grid = document.getElementById('gridProdutos');
        grid.innerHTML = '';

        snap.forEach(s => {
            const p = s.val();
            if (p.category !== catId || p.paused) return;

            // --- LÓGICA DE PESO (O PONTO CHAVE) ---
            // Tenta pegar do campo 'peso' (do seu CSV), se não der, tenta variações.
            let pesoValor = p.peso || p.weight || p.grs || 0;
            
            // Se o peso vier como string "1,50", transforma em número para não quebrar
            if(typeof pesoValor === 'string') pesoValor = pesoValor.replace(',', '.');
            const pesoExibicao = parseFloat(pesoValor).toFixed(2);

            const porcentagem = categoria.promoPct || p.promoPct || 0;
            const precoFinal = porcentagem > 0 ? p.price * (1 - porcentagem / 100) : p.price;
            const valorPix = precoFinal * (1 - (v.descontoPix / 100));
            const valorParcela = precoFinal / (v.parcelas || 3);

            grid.innerHTML += `
                <div class="card-prod p-4 flex flex-col h-full relative">
                    <div class="img-container mb-4 rounded-xl relative overflow-hidden">
                        ${cnf.ativa && porcentagem > 0 ? `
                            <span style="position: absolute; top: 6px; left: 6px; background: ${cnf.colorBg}; color: ${cnf.colorText}; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px; z-index: 10; text-transform: uppercase;">
                                ${cnf.label} ${porcentagem}%
                            </span>
                        ` : ''}
                        <img src="${p.image || 'https://via.placeholder.com/400'}" class="w-full h-full object-cover">
                    </div>

                    <div class="flex-1 text-left">
                        <div class="text-[9px] text-gray-500 font-bold uppercase mb-1">SKU: ${p.sku || '---'}</div>
                        <h3 class="text-[11px] font-bold uppercase mb-1 leading-tight h-8 overflow-hidden">${p.name}</h3>
                        
                        <div class="text-[10px] text-gray-400 mb-3 italic">Peso Médio: ${pesoExibicao}g</div>

                        <div class="mb-4">
                            ${porcentagem > 0 ? `<div class="text-[10px] text-gray-500 line-through">${fM(p.price)}</div>` : ''}
                            <div class="text-lg font-bold gold-text">${fM(precoFinal)}</div>
                            <div class="text-[9px] text-gray-400">Ou ${v.parcelas || 3}x de ${fM(valorParcela)}</div>
                            <div class="text-[11px] text-green-500 font-bold uppercase mt-1">Pix: ${fM(valorPix)}</div>
                        </div>
                    </div>

                    <button onclick='prepararAdd(${JSON.stringify({ ...p, key: s.key, precoFinal, peso: pesoExibicao }).replace(/'/g,"&apos;")})'
                        class="w-full gold-bg text-black py-3 rounded-xl text-[10px] font-bold uppercase transition hover:opacity-80 mt-auto">
                        Adicionar ao Carrinho
                    </button>
                </div>`;
        });
    });
}
function prepararAdd(p) {
    produtoAtualParaAdd = p;
    document.getElementById('modalImgProd').src = p.image || 'https://via.placeholder.com/400';
    document.getElementById('modalNomeProd').innerText = p.name;
    document.getElementById('inputQtd').value = 1;
    document.getElementById('modalQtd').classList.add('active');
}

function fecharModal() { document.getElementById('modalQtd').classList.remove('active'); }

document.getElementById('btnConfirmarAdd').onclick = () => {
    const qtd = parseInt(document.getElementById('inputQtd').value);
    if (qtd < 1) return;

    let carrinho = JSON.parse(localStorage.getItem('carrinho') || '[]');
    carrinho.push({ ...produtoAtualParaAdd, quantidade: qtd });
    localStorage.setItem('carrinho', JSON.stringify(carrinho));

    fecharModal();
    atualizarContador();
    alert("Produto adicionado!");
};

window.onload = () => {
    carregarProdutos();
    atualizarContador();
};
</script>
</body>
</html>

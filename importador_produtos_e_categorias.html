<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Importador Oficial – Produtos e Categorias</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background:#fdfaf5;
  padding:40px;
  text-align:center;
}
.box {
  max-width:700px;
  margin:auto;
  background:#fff;
  border:2px solid #A68966;
  border-radius:18px;
  padding:30px;
}
button {
  width:100%;
  padding:14px;
  background:#1a1a1a;
  color:#fff;
  border:none;
  font-weight:bold;
  margin-top:15px;
  cursor:pointer;
}
#log {
  margin-top:20px;
  background:#f4f4f4;
  height:240px;
  overflow:auto;
  text-align:left;
  padding:15px;
  font-size:12px;
  font-family:monospace;
}
</style>
</head>

<body>
<div class="box">
  <h2 style="color:#A68966">Importador Abella – Produtos + Categorias</h2>
  <input type="file" id="file" accept=".csv">
  <button onclick="importar()">IMPORTAR AGORA</button>
  <div id="status">Aguardando arquivo…</div>
  <div id="log">Logs:</div>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
  authDomain: "catalogo-abella-joias.firebaseapp.com",
  databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
  projectId: "catalogo-abella-joias"
});

const db = firebase.database();

function slug(text) {
  return text.toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9]/g,"")
    .trim();
}

function importar() {
  const file = document.getElementById("file").files[0];
  const log = document.getElementById("log");
  const status = document.getElementById("status");

  if (!file) return alert("Selecione o CSV");

  status.innerHTML = "Processando…";
  log.innerHTML = "Iniciando importação segura…<br>";

  const reader = new FileReader();
  reader.onload = async e => {
    const linhas = e.target.result.split("\n").map(l => l.trim()).filter(Boolean);
    const headers = linhas.shift().split(",").map(h => h.trim());

    let produtos = {};
    let categorias = {};
    let total = 0;

    for (const linha of linhas) {
      const cols = linha.split(",").map(c => c.replace(/"/g,"").trim());
      let item = {};
      headers.forEach((h,i)=> item[h] = cols[i] ?? "");

      if (!item.sku || !item.nome) continue;

      const catNome = item.categoria || "Geral";
      const catSlug = slug(catNome);
      const prodKey = item.sku.replace(/[.#$/\[\]]/g,"_");

      produtos[prodKey] = {
        nome: item.nome,
        sku: item.sku,
        categoria: catSlug,
        preco: parseFloat(item.preco) || 0,
        peso: parseFloat(item.peso) || 0,
        imagem: item.imagem || "",
        promo: 0
      };

      categorias[catSlug] = {
        nome: catNome,
        ativo: true
      };

      total++;
    }

    await db.ref("products").update(produtos);
    await db.ref("categorias").update(categorias);

    status.innerHTML = "<b style='color:green'>Importação concluída!</b>";
    log.innerHTML += `
✔ Produtos importados: ${Object.keys(produtos).length}<br>
✔ Categorias criadas: ${Object.keys(categorias).length}<br>
`;
  };

  reader.readAsText(file);
}
</script>
</body>
</html>

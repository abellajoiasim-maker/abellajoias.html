<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checkout | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#F8F6F2}
.font-serif{font-family:'Cinzel',serif}
.gold{color:#A68966}
.btn-float{position:fixed;bottom:20px;right:20px;z-index:50}
</style>
</head>

<body>

<header class="bg-white border-b px-6 py-6 text-center">
  <h1 class="font-serif text-2xl gold tracking-widest">
    CHECKOUT ABELLA JOIAS
  </h1>
</header>

<main class="max-w-5xl mx-auto p-6 space-y-6">

<!-- LISTA -->
<div id="lista"></div>

<!-- RESUMO -->
<div class="bg-white border p-6 rounded space-y-3">
  <p>Total cheio: <strong>R$ <span id="totalCheio">0.00</span></strong></p>
  <p class="gold">PIX: <strong>R$ <span id="totalPix">0.00</span></strong></p>
  <p class="text-sm text-gray-500">
    Cartão: <span id="parcelas"></span> sem acréscimo
  </p>
</div>

<!-- PAGAMENTO -->
<div class="bg-white border p-6 rounded space-y-4">
  <p class="font-semibold">Forma de pagamento</p>
  <label class="block">
    <input type="radio" name="pg" value="PIX" checked>
    PIX (desconto aplicado)
  </label>
  <label class="block">
    <input type="radio" name="pg" value="Cartão">
    Cartão de Crédito
  </label>

  <button onclick="finalizar()"
    class="w-full bg-black text-white py-4 uppercase tracking-widest">
    Finalizar Pedido
  </button>
</div>

</main>

<!-- BOTÃO VOLTAR -->
<a href="index.html"
 class="btn-float bg-white border px-5 py-3 rounded-full shadow text-xs uppercase tracking-widest">
⬅ Voltar à Loja
</a>

<script>
/* FIREBASE */
firebase.initializeApp({
 apiKey:"AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
 authDomain:"catalogo-abella-joias.firebaseapp.com",
 databaseURL:"https://catalogo-abella-joias-default-rtdb.firebaseio.com",
 projectId:"catalogo-abella-joias"
});
const db = firebase.database();

/* VARIÁVEIS */
let cart = JSON.parse(localStorage.getItem('cart')) || [];
let descontoPix = 0;
let parcelasTxt = '';

/* EMPRESA */
db.ref('settings').once('value').then(s=>{
 if(s.val()){
   descontoPix = Number(s.val().pix || 0);
   parcelasTxt = s.val().parcelas || '';
   document.getElementById('parcelas').textContent = parcelasTxt;
 }
 render();
});

/* RENDER */
function render(){
 let html = '';
 let total = 0;
 let totalPeso = 0;

 cart.forEach((i,idx)=>{
  const sub = i.price * i.qty;
  total += sub;
  totalPeso += i.weight * i.qty;

  html += `
   <div class="bg-white border rounded p-4 mb-4 flex gap-4 items-center">
     <img src="${i.image}"
      class="w-20 h-20 object-cover">

     <div class="flex-1">
       <p class="font-semibold">${i.name}</p>
       <p class="text-xs text-gray-400">${i.sku}</p>
       <p class="text-xs">Peso unit: ${i.weight}g</p>
     </div>

     <div class="flex items-center gap-2">
       <button onclick="menos(${idx})" class="px-3 border">−</button>
       <span>${i.qty}</span>
       <button onclick="mais(${idx})" class="px-3 border">+</button>
     </div>
   </div>
  `;
 });

 document.getElementById('lista').innerHTML = html;

 document.getElementById('totalCheio').textContent =
  total.toFixed(2);

 const pix = total * (1 - descontoPix/100);
 document.getElementById('totalPix').textContent =
  pix.toFixed(2);
}

/* + − */
function mais(i){ cart[i].qty++; salvar(); }
function menos(i){
 if(cart[i].qty>1) cart[i].qty--;
 else cart.splice(i,1);
 salvar();
}
function salvar(){
 localStorage.setItem('cart',JSON.stringify(cart));
 render();
}

/* FINALIZAR */
function finalizar(){
 if(cart.length===0){
   alert('Carrinho vazio');
   return;
 }

 const pg =
  document.querySelector('input[name=pg]:checked').value;

 let total = cart.reduce((s,i)=>s+i.price*i.qty,0);
 let totalPix = total*(1-descontoPix/100);

 const pedido = {
   data:new Date().toISOString(),
   pagamento:pg,
   totalCheio:total.toFixed(2),
   totalPix:totalPix.toFixed(2),
   itens:cart
 };

 db.ref('orders').push(pedido);

 /* WHATSAPP COMPACTO */
 let msg =
 `Olá Abella Joias,%0A
 Novo pedido realizado.%0A
 Valor: R$ ${(pg==='PIX'?totalPix:total).toFixed(2)}%0A
 Pagamento: ${pg}%0A
 Aguardando contato para confirmação.`;

 window.open(
 `https://wa.me/5519988207658?text=${msg}`,
 '_blank'
 );

 localStorage.removeItem('cart');

 alert(
 'Pedido enviado com sucesso! Em instantes a Abella Joias entrará em contato.'
 );

 window.location.href='index.html';
}
</script>

</body>
</html>

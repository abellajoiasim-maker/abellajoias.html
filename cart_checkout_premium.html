<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checkout | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#F8F6F2}
.font-serif{font-family:'Cinzel',serif}
.gold{color:#A68966}
</style>
</head>

<body class="max-w-5xl mx-auto p-6">

<h1 class="font-serif gold text-2xl mb-6 text-center">Finalizar Pedido</h1>

<!-- ITENS -->
<div id="itensCarrinho" class="space-y-4"></div>

<!-- PAGAMENTO -->
<div class="bg-white border p-6 mt-6 space-y-4">
  <h2 class="font-serif gold text-lg">Forma de pagamento</h2>

  <select id="formaPagamento" class="border p-3 w-full">
    <option value="PIX">PIX (com desconto)</option>
    <option value="CARTAO">Cartão de crédito</option>
  </select>

  <div class="text-sm space-y-1">
    <p>Valor cheio: <strong>R$ <span id="valorCheio">0.00</span></strong></p>
    <p class="text-green-600">PIX: <strong>R$ <span id="valorPix">0.00</span></strong></p>
    <p>Cartão: <span id="parcelasCartao"></span></p>
  </div>

  <button onclick="finalizarPedido()"
    class="bg-black text-white w-full py-4 text-sm tracking-widest">
    FINALIZAR PEDIDO
  </button>
</div>

<!-- BOTÃO VOLTAR -->
<a href="index.html"
 class="fixed bottom-6 left-6 bg-black text-white px-4 py-3 rounded-full shadow-lg text-sm">
Voltar
</a>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
  authDomain: "catalogo-abella-joias.firebaseapp.com",
  databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
  projectId: "catalogo-abella-joias"
});
const db = firebase.database();

/* CARRINHO */
let carrinho = JSON.parse(localStorage.getItem('cart')) || [];
let settings = {};
let total = 0;
let pesoTotal = 0;

/* SETTINGS */
db.ref('settings').once('value').then(s=>{
  settings = s.val() || {};
  atualizarResumo();
});

/* LISTAR ITENS */
function renderCarrinho(){
  itensCarrinho.innerHTML='';
  total = 0;
  pesoTotal = 0;

  carrinho.forEach((i,idx)=>{
    total += i.price * i.qty;
    pesoTotal += (i.weight||0) * i.qty;

    itensCarrinho.innerHTML += `
    <div class="bg-white border p-4 flex gap-4">
      <img src="${i.image}" class="w-24 h-24 object-cover rounded">
      <div class="flex-1">
        <p class="font-semibold">${i.name}</p>
        <p class="text-xs text-gray-500">SKU: ${i.sku}</p>
        <p class="gold font-semibold">R$ ${i.price.toFixed(2)}</p>

        <div class="flex items-center gap-2 mt-2">
          <button onclick="alterarQtd(${idx},-1)" class="border px-3">-</button>
          <span>${i.qty}</span>
          <button onclick="alterarQtd(${idx},1)" class="border px-3">+</button>
        </div>
      </div>
    </div>`;
  });

  atualizarResumo();
}

function alterarQtd(i,v){
  carrinho[i].qty += v;
  if(carrinho[i].qty<=0) carrinho.splice(i,1);
  salvar();
}

function salvar(){
  localStorage.setItem('cart',JSON.stringify(carrinho));
  renderCarrinho();
}

/* RESUMO */
function atualizarResumo(){
  valorCheio.textContent = total.toFixed(2);

  let desconto = settings.pix || 0;
  let totalPix = total - (total * desconto / 100);
  valorPix.textContent = totalPix.toFixed(2);

  parcelasCartao.textContent =
    settings.parcelas
    ? `${settings.parcelas}x sem acréscimo`
    : '-';
}

/* FINALIZAR */
function finalizarPedido(){
  if(carrinho.length===0){
    alert('Carrinho vazio');
    return;
  }

  const pagamento = formaPagamento.value;
  const desconto = pagamento==='PIX' ? settings.pix||0 : 0;
  const totalFinal = total - (total * desconto / 100);

  const pedido={
    cliente:'Cliente Loja',
    whatsapp: settings.whatsapp || '',
    pagamento,
    desconto,
    totalCheio: total,
    total: totalFinal,
    peso: pesoTotal,
    data:new Date().toLocaleString('pt-BR'),
    status:'Novo',
    itens:carrinho
  };

  db.ref('orders').push(pedido);

  /* WHATSAPP */
  const msg = encodeURIComponent(
    `Pedido recebido! Total: R$ ${totalFinal.toFixed(2)}`
  );
  window.open(`https://wa.me/55${settings.whatsapp}?text=${msg}`,'_blank');

  alert('✅ Pedido enviado com sucesso!\nEm instantes a Abella Joias entrará em contato.');

  localStorage.removeItem('cart');
  carrinho=[];
  renderCarrinho();
}

/* INIT */
renderCarrinho();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checkout | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#F8F6F2}
.gold{color:#A68966}

.voltar{
  position:fixed;
  bottom:20px;
  left:20px;
  background:#000;
  color:#fff;
  padding:12px 16px;
  border-radius:50px;
  font-size:12px;
}
</style>
</head>

<body class="max-w-3xl mx-auto p-6">

<h1 class="text-2xl font-serif gold mb-6 text-center">
Finalizar Pedido
</h1>

<!-- DADOS CLIENTE -->
<div class="bg-white border p-6 mb-6 space-y-4">
  <input id="nome" placeholder="Nome completo"
   class="border p-3 w-full">

  <input id="whats" placeholder="WhatsApp (DDD + número)"
   class="border p-3 w-full">

  <select id="pagamento"
   class="border p-3 w-full">
    <option value="">Forma de pagamento</option>
    <option value="PIX">PIX</option>
    <option value="Cartão">Cartão</option>
  </select>
</div>

<!-- RESUMO -->
<div class="bg-white border p-6 mb-6">
  <h2 class="font-semibold mb-4">Resumo do Pedido</h2>
  <div id="lista"></div>

  <div class="mt-4 space-y-1 text-sm">
    <p>Peso total: <strong><span id="peso"></span> g</strong></p>
    <p>Valor cheio: <strong>R$ <span id="total"></span></strong></p>
    <p id="linhaPix" class="hidden">
      Valor com desconto PIX:
      <strong>R$ <span id="totalPix"></span></strong>
    </p>
  </div>
</div>

<button onclick="finalizar()"
 class="bg-black text-white w-full py-4 text-sm tracking-wide">
FINALIZAR PEDIDO
</button>

<a href="index.html" class="voltar">← Voltar</a>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
  authDomain: "catalogo-abella-joias.firebaseapp.com",
  databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
  projectId: "catalogo-abella-joias"
});
const db=firebase.database();

/* DADOS */
const cart=JSON.parse(localStorage.getItem('cart'))||[];
let settings={};

/* CARREGA CONFIGURAÇÕES */
db.ref('settings').once('value').then(s=>{
  settings=s.val()||{};
  render();
});

function render(){
  let html='',peso=0,total=0;
  cart.forEach(i=>{
    peso+=i.weight*i.qty;
    total+=i.price*i.qty;
    html+=`
      <div class="flex items-center gap-3 mb-3 text-sm">
        <img src="${i.image}" class="w-16 h-16 object-cover border">
        <div class="flex-1">
          <p>${i.name}</p>
          <p class="text-xs">${i.qty}x • ${i.weight}g</p>
        </div>
        <strong>R$ ${(i.price*i.qty).toFixed(2)}</strong>
      </div>`;
  });
  lista.innerHTML=html;
  peso.textContent=peso.toFixed(2);
  total.textContent=total.toFixed(2);

  if(settings.pix>0){
    totalPix.textContent=(total*(1-settings.pix/100)).toFixed(2);
  }
}

pagamento.onchange=()=>{
  linhaPix.classList.toggle('hidden',pagamento.value!=='PIX');
};

function finalizar(){
  if(!nome.value||!whats.value||!pagamento.value){
    alert('Preencha todos os campos.');
    return;
  }

  let total=cart.reduce((s,i)=>s+i.price*i.qty,0);
  let peso=cart.reduce((s,i)=>s+i.weight*i.qty,0);
  let desconto=0;

  if(pagamento.value==='PIX'){
    desconto=total*(settings.pix||0)/100;
  }

  const pedido={
    cliente:nome.value,
    whatsapp:whats.value,
    pagamento:pagamento.value,
    total,
    desconto,
    totalFinal:total-desconto,
    peso,
    itens:cart,
    status:'Novo',
    data:new Date().toLocaleString()
  };

  db.ref('orders').push(pedido);

  /* MENSAGEM WHATSAPP — CURTA E PROFISSIONAL */
  const msg=
`Olá! Acabei de finalizar um pedido no App da Abella Joias.

Nome: ${pedido.cliente}
Valor total: R$ ${pedido.totalFinal.toFixed(2)}
Forma de pagamento: ${pedido.pagamento}

Fico no aguardo do contato para confirmação e pagamento.`;

  localStorage.removeItem('cart');

  alert('Pedido enviado com sucesso! Em instantes a Abella Joias entrará em contato.');

  window.open(
    `https://wa.me/55${pedido.whatsapp.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`,
    '_blank'
  );

  location.href='index.html';
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checkout | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body { background:#F8F6F2 }
.gold{color:#A68966}
.font-serif{font-family:'Cinzel',serif}
</style>
</head>

<body class="max-w-xl mx-auto p-4">

<h1 class="font-serif gold text-xl mb-4 text-center">Finalizar Pedido</h1>

<!-- DADOS CLIENTE -->
<div class="bg-white border p-4 space-y-2 mb-4">
  <input id="nome" placeholder="Nome completo" class="border p-2 w-full">
  <input id="whats" placeholder="WhatsApp (somente n√∫meros)" class="border p-2 w-full">
</div>

<!-- CARRINHO -->
<div id="listaCarrinho" class="space-y-3"></div>

<!-- TOTAIS -->
<div class="bg-white border p-4 mt-4 space-y-1 text-sm">
  <p>Subtotal: R$ <span id="subtotal">0.00</span></p>
  <p id="linhaPix" class="hidden text-green-600"></p>
  <p>Peso total: <strong><span id="pesoTotal">0</span>g</strong></p>
  <p class="text-lg font-bold">Total: R$ <span id="total">0.00</span></p>
</div>

<!-- PAGAMENTO -->
<div class="bg-white border p-4 mt-4 space-y-2">
  <select id="pagamento" onchange="calcularTotais()" class="border p-2 w-full">
    <option value="PIX">PIX</option>
    <option id="opCartao" value="CARTAO">Cart√£o</option>
  </select>
</div>

<button onclick="finalizarPedido()" class="bg-black text-white w-full py-3 mt-4 tracking-widest text-xs">
FINALIZAR NO WHATSAPP
</button>

<script>
/* üî• FIREBASE ‚Äî ABELLA JOIAS */
firebase.initializeApp({
  apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
  authDomain: "catalogo-abella-joias.firebaseapp.com",
  databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
  projectId: "catalogo-abella-joias"
});
const db = firebase.database();

/* VARI√ÅVEIS */
let carrinho = JSON.parse(localStorage.getItem('cart')) || [];
let pixDesconto = 0;
let parcelas = 1;
let whatsappLoja = '';

/* CARREGA CONFIG DA EMPRESA */
db.ref('settings').once('value').then(s=>{
  if(!s.val()) return;

  pixDesconto = Number(s.val().pix || 0);
  parcelas = Number(s.val().parcelas || 1);
  whatsappLoja = s.val().whatsapp || '';

  document.getElementById('opCartao').textContent =
    `Cart√£o (${parcelas}x sem acr√©scimo)`;

  calcularTotais();
});

/* RENDER CARRINHO */
function renderCarrinho(){
  listaCarrinho.innerHTML='';
  carrinho.forEach((i,idx)=>{
    listaCarrinho.innerHTML+=`
      <div class="bg-white border p-3 flex gap-3 items-center">
        <img src="${i.image}" class="w-16 h-16 object-cover border rounded">
        <div class="flex-1">
          <p class="font-medium">${i.name}</p>
          <p class="text-xs text-gray-400">${i.sku || ''}</p>
          <p class="text-xs">${i.weight}g</p>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="alterarQtd(${idx},-1)" class="border px-2">-</button>
          <span>${i.qty}</span>
          <button onclick="alterarQtd(${idx},1)" class="border px-2">+</button>
        </div>
      </div>`;
  });
}

/* ALTERAR QUANTIDADE */
function alterarQtd(i,delta){
  carrinho[i].qty += delta;
  if(carrinho[i].qty<=0) carrinho.splice(i,1);
  localStorage.setItem('cart',JSON.stringify(carrinho));
  renderCarrinho();
  calcularTotais();
}

/* CALCULAR TOTAIS */
function calcularTotais(){
  let sub=0, peso=0;
  carrinho.forEach(i=>{
    sub += i.price*i.qty;
    peso += i.weight*i.qty;
  });

  subtotal.textContent=sub.toFixed(2);
  pesoTotal.textContent=peso;

  let total=sub;
  linhaPix.classList.add('hidden');

  if(pagamento.value==='PIX' && pixDesconto>0){
    const desc=sub*(pixDesconto/100);
    total=sub-desc;
    linhaPix.textContent=`Desconto PIX (${pixDesconto}%): -R$ ${desc.toFixed(2)}`;
    linhaPix.classList.remove('hidden');
  }

  totalSpan.textContent=total.toFixed(2);
}

/* FINALIZAR */
function finalizarPedido(){
  if(carrinho.length===0) return alert('Carrinho vazio');
  if(!nome.value||!whats.value) return alert('Preencha nome e WhatsApp');

  let total=Number(totalSpan.textContent);
  let peso=Number(pesoTotal.textContent);
  let pag=pagamento.value;

  const pedido={
    cliente:nome.value,
    whatsapp:whats.value,
    data:new Date().toLocaleString('pt-BR'),
    pagamento: pag==='PIX' ? `PIX (${pixDesconto}% OFF)` : `Cart√£o (${parcelas}x sem acr√©scimo)`,
    peso,
    total,
    status:'Novo',
    itens:carrinho.map(i=>({
      name:i.name,
      sku:i.sku,
      qty:i.qty,
      price:i.price,
      weight:i.weight
    }))
  };

  db.ref('orders').push(pedido);
  localStorage.removeItem('cart');

  let msg=`Ol√°! Pedido de *${pedido.cliente}*:%0A%0A`;
  pedido.itens.forEach(i=>{
    msg+=`${i.qty}x ${i.name} (${i.sku})%0A`;
  });
  msg+=`%0APagamento: ${pedido.pagamento}%0ATotal: R$ ${total.toFixed(2)}%0APeso: ${peso}g`;

  window.open(`https://wa.me/55${whatsappLoja}?text=${msg}`);
}

/* INIT */
renderCarrinho();
</script>

</body>
</html>

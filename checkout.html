<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Finalizar Pedido | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>

<body class="bg-neutral-50 p-4 max-w-xl mx-auto">

<h1 class="text-xl font-serif mb-4 text-center">Finalizar Pedido</h1>

<!-- ITENS DO CARRINHO -->
<div id="listaCarrinho" class="space-y-3 mb-4"></div>

<!-- DADOS DO CLIENTE -->
<input id="cliente" placeholder="Nome" class="border p-2 w-full mb-2">
<input id="whatsapp" placeholder="WhatsApp (DDD + n√∫mero)" class="border p-2 w-full mb-4">

<!-- RESUMO -->
<div class="bg-white border p-3 mb-4 text-sm space-y-1">
  <p>Subtotal: R$ <span id="subtotal">0.00</span></p>
  <p id="linhaPix" class="text-green-600 hidden"></p>
  <p class="font-semibold text-lg">Total: R$ <span id="total">0.00</span></p>
  <p class="text-xs text-gray-500">Peso total: <span id="pesoTotal">0</span>g</p>
</div>

<button onclick="finalizarPedido()"
  class="bg-black text-white w-full py-3 tracking-widest">
FINALIZAR PEDIDO
</button>

<script>
/* üî• FIREBASE ‚Äî MANTIDO */
firebase.initializeApp({
  apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
  authDomain: "catalogo-abella-joias.firebaseapp.com",
  databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
  projectId: "catalogo-abella-joias"
});
const db = firebase.database();

/* DADOS */
let cart = JSON.parse(localStorage.getItem('cart')) || [];
const pagamento = localStorage.getItem('payment') || 'PIX';

let subtotal = 0;
let pesoTotal = 0;
let descontoPix = 0;

/* CONFIGURA√á√ïES DA EMPRESA */
db.ref('settings').once('value').then(s=>{
  if(s.val()){
    descontoPix = Number(s.val().pix||0);
  }
  render();
});

/* RENDER CARRINHO */
function render(){
  listaCarrinho.innerHTML='';
  subtotal=0;
  pesoTotal=0;

  cart.forEach((i,idx)=>{
    subtotal += i.price * i.qty;
    pesoTotal += (i.weight||0) * i.qty;

    listaCarrinho.innerHTML+=`
      <div class="bg-white border p-3 flex gap-3">
        <img src="${i.image}" class="w-16 h-16 object-cover rounded">
        <div class="flex-1">
          <p class="font-semibold">${i.name}</p>
          <p class="text-xs text-gray-500">${i.weight||0}g por unidade</p>

          <div class="flex items-center gap-2 mt-1">
            <button onclick="alterarQtd(${idx},-1)" class="border px-2">‚àí</button>
            <span>${i.qty}</span>
            <button onclick="alterarQtd(${idx},1)" class="border px-2">+</button>
          </div>
        </div>
        <div class="text-right text-sm">
          R$ ${(i.price*i.qty).toFixed(2)}
        </div>
      </div>`;
  });

  subtotalEl.textContent=subtotal.toFixed(2);

  let total=subtotal;
  linhaPix.classList.add('hidden');

  if(pagamento==='PIX' && descontoPix>0){
    const desc = subtotal*(descontoPix/100);
    total = subtotal-desc;
    linhaPix.textContent=`Desconto PIX (${descontoPix}%): -R$ ${desc.toFixed(2)}`;
    linhaPix.classList.remove('hidden');
  }

  totalEl.textContent=total.toFixed(2);
  pesoTotalEl.textContent=pesoTotal;
}

/* CONTROLES */
function alterarQtd(idx,delta){
  cart[idx].qty+=delta;
  if(cart[idx].qty<=0) cart.splice(idx,1);
  localStorage.setItem('cart',JSON.stringify(cart));
  render();
}

/* FINALIZAR */
function finalizarPedido(){
  if(cart.length===0) return alert('Carrinho vazio');
  if(!cliente.value || !whatsapp.value)
    return alert('Preencha nome e WhatsApp');

  const totalFinal = Number(totalEl.textContent);

  const pedido={
    cliente:cliente.value,
    whatsapp:whatsapp.value,
    pagamento,
    data:new Date().toLocaleString('pt-BR'),
    status:'Novo',
    total:totalFinal,
    peso:pesoTotal,
    itens:cart
  };

  db.ref('orders').push(pedido).then(()=>{
    /* ‚úÖ NOVA FUN√á√ÉO ‚Äî CONFIRMA√á√ÉO */
    alert(
      'Pedido enviado com sucesso! üíõ\n\n' +
      'Em instantes a Abella Joias entrar√° em contato para a finaliza√ß√£o.'
    );

    let msg='üõçÔ∏è *NOVO PEDIDO*%0A%0A';
    cart.forEach(i=>{
      msg+=`${i.qty}x ${i.name}%0A`;
    });
    msg+=`%0Aüí≥ Pagamento: ${pagamento}`;
    msg+=`%0A‚öñÔ∏è Peso total: ${pesoTotal}g`;
    msg+=`%0Aüí∞ Total: R$ ${totalFinal.toFixed(2)}`;

    localStorage.removeItem('cart');

    window.location.href=
      `https://wa.me/55${whatsapp.value}?text=${msg}`;
  });
}

/* ELEMENTOS */
const subtotalEl=document.getElementById('subtotal');
const totalEl=document.getElementById('total');
const pesoTotalEl=document.getElementById('pesoTotal');
const linhaPix=document.getElementById('linhaPix');
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checkout | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body { background:#F8F6F2 }
.font-serif { font-family:'Cinzel', serif }
.gold { color:#A68966 }
</style>
</head>

<body class="max-w-xl mx-auto p-6">

<h1 class="font-serif text-2xl gold text-center mb-6">Finalizar Pedido</h1>

<!-- CLIENTE -->
<input id="clienteNome" placeholder="Nome do cliente"
  class="border p-3 w-full mb-3">

<input id="clienteWhats" placeholder="WhatsApp (somente n√∫meros)"
  class="border p-3 w-full mb-6">

<!-- ITENS -->
<div id="itens" class="space-y-3 mb-6"></div>

<!-- RESUMO -->
<div class="border-t pt-4 space-y-1 text-sm">
  <p>Peso total: <strong><span id="pesoTotal">0</span> g</strong></p>
  <p>Subtotal: R$ <span id="subtotal">0.00</span></p>
  <p class="text-lg font-semibold">Total: R$ <span id="total">0.00</span></p>
</div>

<!-- PAGAMENTO -->
<div class="mt-6 space-y-2">
  <label class="flex items-center gap-2">
    <input type="radio" name="pagamento" value="PIX" checked>
    <span class="gold font-medium">PIX</span>
  </label>

  <label class="flex items-center gap-2">
    <input type="radio" name="pagamento" value="CARTAO">
    <span>Cart√£o</span>
  </label>

  <select id="parcelas" class="border p-2 w-full hidden">
    <option value="1x">1x sem juros</option>
    <option value="2x">2x sem juros</option>
    <option value="3x">3x sem juros</option>
  </select>
</div>

<!-- FINALIZAR -->
<button onclick="finalizarPedido()"
  class="w-full bg-black text-white py-3 mt-6 tracking-widest text-xs">
  FINALIZAR NO WHATSAPP
</button>

<script>
/* üî• FIREBASE ‚Äî MESMO DO PROJETO */
firebase.initializeApp({
  apiKey: "SUA_API_KEY",
  authDomain: "SEU_PROJETO.firebaseapp.com",
  databaseURL: "https://SEU_PROJETO-default-rtdb.firebaseio.com",
  projectId: "SEU_PROJETO"
});

const db = firebase.database();

/* DADOS LOCAIS (MANT√âM PADR√ÉO DA MARCINHA) */
const cart = JSON.parse(localStorage.getItem('cart')) || [];
const storePhone = localStorage.getItem('storePhone') || '';
const config = JSON.parse(localStorage.getItem('storeConfig')) || {};

const itensEl = document.getElementById('itens');
const subtotalEl = document.getElementById('subtotal');
const totalEl = document.getElementById('total');
const pesoEl = document.getElementById('pesoTotal');
const parcelasEl = document.getElementById('parcelas');

let subtotal = 0;
let pesoTotal = 0;

/* RENDER */
cart.forEach(i => {
  subtotal += i.price * i.qty;
  pesoTotal += (i.weight || 0) * i.qty;

  itensEl.innerHTML += `
    <div class="flex justify-between border-b pb-2 text-sm">
      <div>
        <p>${i.qty}x ${i.name}</p>
        <p class="text-xs text-gray-400">SKU: ${i.sku || '-'}</p>
      </div>
      <strong>R$ ${(i.price * i.qty).toFixed(2)}</strong>
    </div>
  `;
});

subtotalEl.textContent = subtotal.toFixed(2);
totalEl.textContent = subtotal.toFixed(2);
pesoEl.textContent = pesoTotal;

/* PAGAMENTO */
document.querySelectorAll('[name=pagamento]').forEach(r => {
  r.onchange = () => {
    parcelasEl.classList.toggle('hidden', r.value !== 'CARTAO');
  };
});

/* FINALIZAR */
function finalizarPedido(){
  const nome = clienteNome.value.trim();
  const whats = clienteWhats.value.trim();
  if(!nome || !whats) return alert('Informe nome e WhatsApp');

  const pagamento = document.querySelector('[name=pagamento]:checked').value;
  const parcelas = pagamento === 'CARTAO' ? parcelasEl.value : '√Ä vista';

  const pedido = {
    cliente: nome,
    whatsapp: whats,
    data: new Date().toLocaleString('pt-BR'),
    pagamento,
    parcelas,
    subtotal,
    total: subtotal,
    pesoTotal,
    status: 'Novo',
    itens: cart
  };

  /* SALVA NO FIREBASE */
  db.ref('orders').push(pedido);

  /* MENSAGEM WHATSAPP (IGUAL AO FLUXO ANTIGO) */
  let msg = `üõçÔ∏è Pedido de *${nome}*:%0A%0A`;
  cart.forEach(i => {
    msg += `${i.qty}x ${i.name} - R$ ${i.price}%0A`;
  });
  msg += `%0A‚öñÔ∏è Peso: ${pesoTotal} g`;
  msg += `%0Aüí≥ Pagamento: ${pagamento}`;
  msg += `%0Aüí∞ Total: R$ ${subtotal.toFixed(2)}`;

  localStorage.removeItem('cart');

  window.open(`https://wa.me/55${whats}?text=${msg}`);
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Checkout | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body{background:#F8F6F2}
.gold{color:#A68966}
.font-serif{font-family:'Cinzel',serif}
</style>
</head>

<body class="max-w-2xl mx-auto p-6">

<h1 class="font-serif text-2xl gold mb-6 text-center">Finalizar Pedido</h1>

<!-- CLIENTE -->
<div class="bg-white border p-4 mb-6 space-y-2">
  <input id="cliente" placeholder="Nome completo" class="border p-2 w-full">
  <input id="whatsapp" placeholder="WhatsApp (somente n√∫meros)" class="border p-2 w-full">
</div>

<!-- CARRINHO -->
<div id="listaCarrinho" class="space-y-4"></div>

<!-- PAGAMENTO -->
<div class="bg-white border p-4 mt-6 space-y-3">
  <select id="pagamento" onchange="calcularTotais()" class="border p-2 w-full">
    <option value="PIX">PIX</option>
    <option value="CARTAO">Cart√£o</option>
  </select>

  <p>Subtotal: R$ <span id="subtotal">0.00</span></p>
  <p class="text-green-700">Desconto PIX: R$ <span id="desconto">0.00</span></p>
  <p><strong>Total: R$ <span id="total">0.00</span></strong></p>
  <p class="text-xs text-gray-500">Peso total: <span id="pesoTotal">0</span>g</p>
</div>

<button onclick="finalizarPedido()"
 class="bg-black text-white w-full py-4 mt-6">
FINALIZAR NO WHATSAPP
</button>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
  authDomain: "catalogo-abella-joias.firebaseapp.com",
  databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com",
  projectId: "catalogo-abella-joias"
});
const db=firebase.database();

/* DADOS */
const cart = JSON.parse(localStorage.getItem('cart')) || [];
let pixDesconto = 0;
let parcelas = '';

db.ref('settings').once('value').then(s=>{
  if(!s.val()) return;
  pixDesconto = Number(s.val().pix||0);
  parcelas = s.val().parcelas||'';
  calcularTotais();
});

/* LISTAR CARRINHO */
function renderCarrinho(){
  listaCarrinho.innerHTML='';
  cart.forEach((i,idx)=>{
    listaCarrinho.innerHTML+=`
    <div class="bg-white border p-4 flex gap-4">
      <img src="${i.image}" class="w-20 h-20 object-cover">
      <div class="flex-1">
        <p class="font-semibold">${i.name}</p>
        <p class="text-xs">SKU: ${i.sku}</p>
        <p class="text-xs">Peso: ${i.weight}g</p>

        <div class="flex items-center gap-2 mt-2">
          <button onclick="alterarQtd(${idx},-1)" class="border px-2">‚àí</button>
          <span>${i.qty}</span>
          <button onclick="alterarQtd(${idx},1)" class="border px-2">+</button>
        </div>
      </div>
      <div>
        <p>R$ ${(i.price*i.qty).toFixed(2)}</p>
      </div>
    </div>`;
  });
  calcularTotais();
}

function alterarQtd(i,delta){
  cart[i].qty+=delta;
  if(cart[i].qty<1) cart[i].qty=1;
  localStorage.setItem('cart',JSON.stringify(cart));
  renderCarrinho();
}

/* CALCULOS */
function calcularTotais(){
  let subtotal=0,peso=0;
  cart.forEach(i=>{
    subtotal+=i.price*i.qty;
    peso+=i.weight*i.qty;
  });

  let desconto=0,total=subtotal;
  if(pagamento.value==='PIX'){
    desconto=subtotal*(pixDesconto/100);
    total=subtotal-desconto;
  }

  subtotalSpan.textContent=subtotal.toFixed(2);
  descontoSpan.textContent=desconto.toFixed(2);
  totalSpan.textContent=total.toFixed(2);
  pesoTotal.textContent=peso;
}

/* FINALIZAR */
function finalizarPedido(){
  if(!cliente.value||!whatsapp.value) return alert('Preencha seus dados.');

  const pagamentoSel=pagamento.value;
  const total=Number(totalSpan.textContent);

  const pedido={
    cliente:cliente.value,
    whatsapp:whatsapp.value,
    pagamento:pagamentoSel,
    data:new Date().toLocaleString('pt-BR'),
    status:'Novo',
    itens:cart,
    total,
    peso:Number(pesoTotal.textContent)
  };

  db.ref('orders').push(pedido);

  let msg=`üõçÔ∏è *Pedido Abella Joias*%0A%0A`;
  cart.forEach(i=>{
    msg+=`${i.qty}x ${i.name} ‚Äî R$ ${(i.price*i.qty).toFixed(2)}%0A`;
  });
  msg+=`%0Aüí≥ Pagamento: ${pagamentoSel}`;
  msg+=`%0A‚öñÔ∏è Peso total: ${pedido.peso}g`;
  msg+=`%0Aüí∞ Total: R$ ${total.toFixed(2)}`;
  msg+=`%0A%0A‚ú® Obrigada pela prefer√™ncia! A Abella Joias entrar√° em contato em breve para finaliza√ß√£o do pedido.`;

  localStorage.removeItem('cart');
  window.open(`https://wa.me/55${whatsapp.value}?text=${msg}`);
}

const subtotalSpan=document.getElementById('subtotal');
const descontoSpan=document.getElementById('desconto');
const totalSpan=document.getElementById('total');

renderCarrinho();
</script>

</body>
</html>

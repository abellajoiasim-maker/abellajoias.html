<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Checkout | Abella Joias</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>body{background:#f8f6f2} .gold{color:#A68966}</style>
</head>
<body class="p-6 max-w-4xl mx-auto">

<h1 class="text-2xl font-serif gold mb-6 uppercase tracking-widest text-center">Finalizar Pedido</h1>

<div class="bg-white border p-6 mb-6 space-y-4 rounded-xl shadow-sm">
    <input id="nome" placeholder="Nome completo" class="w-full border p-3 rounded-lg">
    <input id="telefone" placeholder="WhatsApp (DDD+Número)" class="w-full border p-3 rounded-lg">
    <input id="endereco" placeholder="Endereço de entrega" class="w-full border p-3 rounded-lg">
</div>

<div class="bg-white border p-6 mb-6 rounded-xl shadow-sm">
    <h2 class="font-bold gold mb-4 uppercase text-sm">Itens Escolhidos</h2>
    <div id="listaCarrinho" class="space-y-4"></div>
</div>

<div class="bg-white border p-6 mb-6 rounded-xl shadow-sm">
    <label class="block text-xs font-bold mb-2">FORMA DE PAGAMENTO</label>
    <select id="pagamento" onchange="recalcular()" class="w-full border p-3 rounded-lg">
        <option value="PIX">PIX</option>
        <option value="Cartão">Cartão de Crédito</option>
    </select>
</div>

<div class="bg-zinc-800 text-white p-6 rounded-xl space-y-2">
    <div class="flex justify-between"><span>Bruto:</span><span>R$ <span id="bruto">0.00</span></span></div>
    <div class="flex justify-between text-red-400"><span>Descontos Categoria:</span><span>- R$ <span id="descCat">0.00</span></span></div>
    <div class="flex justify-between text-green-400"><span>Desconto PIX:</span><span>- R$ <span id="valPix">0.00</span></span></div>
    <div class="flex justify-between font-bold text-xl border-t border-zinc-700 pt-2">
        <span>TOTAL:</span><span>R$ <span id="total">0.00</span></span>
    </div>
</div>

<button onclick="finalizarPedido()" class="w-full bg-black text-white py-4 rounded-xl mt-6 font-bold uppercase tracking-widest shadow-lg">Enviar via WhatsApp</button>

<script>
    firebase.initializeApp({ apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY", databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com" });
    const db = firebase.database();

    let carrinho = JSON.parse(localStorage.getItem("carrinho") || "[]");
    let settings = {};
    let catDiscounts = {};

    async function recalcular() {
        const sSnap = await db.ref('settings').once('value');
        settings = sSnap.val() || { pix: 5 };
        
        const cSnap = await db.ref('categories').once('value');
        cSnap.forEach(c => { catDiscounts[c.val().name] = c.val().discount || 0; });

        let brutoT = 0, descCatT = 0;
        
        const container = document.getElementById('listaCarrinho');
        container.innerHTML = '';

        carrinho.forEach((item, idx) => {
            const subtotal = item.preco * item.qtd;
            const desconto = subtotal * (catDiscounts[item.category] / 100);
            
            brutoT += subtotal;
            descCatT += desconto;

            container.innerHTML += `
            <div class="flex justify-between text-sm border-b pb-2">
                <div><b>${item.qtd}x</b> ${item.nome}<br><small class="text-gray-400">${item.variacao}</small></div>
                <div>R$ ${subtotal.toFixed(2)}</div>
            </div>`;
        });

        const posCat = brutoT - descCatT;
        const descPix = document.getElementById('pagamento').value === "PIX" ? posCat * (settings.pix/100) : 0;
        const total = posCat - descPix;

        document.getElementById('bruto').innerText = brutoT.toFixed(2);
        document.getElementById('descCat').innerText = descCatT.toFixed(2);
        document.getElementById('valPix').innerText = descPix.toFixed(2);
        document.getElementById('total').innerText = total.toFixed(2);
    }

    function finalizarPedido() {
        const nome = document.getElementById('nome').value;
        const total = document.getElementById('total').innerText;
        if(!nome || carrinho.length === 0) return alert("Preencha os dados!");

        const pedido = {
            cliente: nome,
            tel: document.getElementById('telefone').value,
            itens: carrinho,
            total: total,
            status: "Novo"
        };

        db.ref('orders').push(pedido).then(() => {
            const msg = `Olá! Novo pedido de ${nome}\nTotal: R$ ${total}\nVeja os detalhes no painel.`;
            window.open(`https://wa.me/${document.getElementById('telefone').value}?text=${encodeURIComponent(msg)}`);
            localStorage.removeItem("carrinho");
            location.href = "index.html";
        });
    }

    recalcular();
</script>
</body>
</html>

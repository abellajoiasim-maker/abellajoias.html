<script>
const db = firebase.database();
let cart = JSON.parse(localStorage.getItem("cart")||"[]");

Promise.all([
  db.ref("categories").once("value"),
  db.ref("settings").once("value")
]).then(([catSnap, setSnap])=>{

  const categorias = catSnap.val() || {};
  const cfg = setSnap.val() || {};

  let subtotal = 0;
  let pesoTotal = 0;
  let descontoCat = 0;

  cart.forEach(i=>{
    subtotal += i.price * i.qtd;
    pesoTotal += i.weight * i.qtd;

    const cat = categorias[i.category];
    if(cat?.discount){
      descontoCat += i.price * i.qtd * (cat.discount/100);
    }
  });

  let descontoPix = cfg.pix ? subtotal * (cfg.pix/100) : 0;
  let total = subtotal - descontoCat - descontoPix;

  document.getElementById("subtotal").innerText = subtotal.toFixed(2);
  document.getElementById("desconto").innerText = descontoCat.toFixed(2);
  document.getElementById("pix").innerText = descontoPix.toFixed(2);
  document.getElementById("total").innerText = total.toFixed(2);

  const sel = document.getElementById("parcelas");
  sel.innerHTML="";
  for(let i=1;i<=(cfg.parcelas||6);i++){
    sel.innerHTML+=`<option>${i}x de R$ ${(total/i).toFixed(2)}</option>`;
  }

});

function finalizar(pagamento){
  const pedido = {
    data: Date.now(),
    itens: cart,
    pagamento,
    status:"novo",
    total: document.getElementById("total").innerText
  };

  db.ref("orders").push(pedido);
  localStorage.removeItem("cart");
  alert("Pedido enviado!");
}
</script>

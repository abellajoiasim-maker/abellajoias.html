<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Meu Carrinho | Abella Joias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<style>body{background:#f8f6f2; font-family:'Poppins',sans-serif;}</style>
</head>
<body class="p-4 md:p-10 max-w-3xl mx-auto">

<h1 class="text-2xl font-bold text-center mb-8 uppercase tracking-widest text-[#A68966]">Seu Carrinho</h1>

<div id="lista" class="space-y-4 mb-8"></div>

<div class="bg-white p-6 rounded-2xl shadow-sm border space-y-4">
    <h3 class="font-bold text-sm uppercase">Dados para Entrega</h3>
    <input id="cNomet" placeholder="Nome Completo" class="w-full border p-3 rounded-xl">
    <input id="cTel" placeholder="WhatsApp" class="w-full border p-3 rounded-xl">
    <select id="cPag" class="w-full border p-3 rounded-xl">
        <option value="PIX">PIX (Desconto)</option>
        <option value="CARTÃO">Cartão de Crédito</option>
    </select>
</div>

<div class="bg-black text-white p-6 rounded-2xl mt-6">
    <div class="flex justify-between text-xs opacity-60 mb-1"><span>Subtotal:</span><span id="vSub">R$ 0,00</span></div>
    <div class="flex justify-between text-xs opacity-60 mb-3"><span>Peso Total:</span><span id="vPeso">0g</span></div>
    <div class="flex justify-between font-bold text-lg border-t border-zinc-700 pt-3">
        <span>TOTAL:</span><span id="vTotal">R$ 0,00</span>
    </div>
</div>

<button onclick="enviarPedido()" class="w-full bg-[#A68966] text-white font-bold py-4 rounded-2xl mt-6 shadow-lg uppercase tracking-widest">Enviar Pedido via WhatsApp</button>
<a href="index.html" class="block text-center mt-4 text-xs font-bold text-gray-400 uppercase italic">Continuar Comprando</a>

<script>
    firebase.initializeApp({ apiKey:"AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY", databaseURL:"https://catalogo-abella-joias-default-rtdb.firebaseio.com" });
    const db = firebase.database();
    let carrinho = JSON.parse(localStorage.getItem('carrinho') || '[]');

    function render() {
        let sub = 0, peso = 0;
        lista.innerHTML = '';
        carrinho.forEach((item, i) => {
            sub += item.preco * item.qtd;
            peso += (parseFloat(item.peso) || 0) * item.qtd;
            lista.innerHTML += `
                <div class="bg-white p-4 rounded-xl border flex justify-between items-center">
                    <div>
                        <h4 class="font-bold text-xs uppercase">${item.nome}</h4>
                        <p class="text-[10px] text-gray-400">${item.variacao} | R$ ${item.preco.toFixed(2)}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-sm">${item.qtd}x</span>
                        <button onclick="remover(${i})" class="text-red-400 font-bold">✕</button>
                    </div>
                </div>`;
        });
        vSub.innerText = `R$ ${sub.toFixed(2)}`;
        vTotal.innerText = `R$ ${sub.toFixed(2)}`;
        vPeso.innerText = `${peso.toFixed(2)}g`;
    }

    function remover(i) {
        carrinho.splice(i, 1);
        localStorage.setItem('carrinho', JSON.stringify(carrinho));
        render();
    }

    async function enviarPedido() {
        const nome = cNomet.value;
        if(!nome || carrinho.length === 0) return alert("Carrinho vazio ou nome faltando!");

        // Salvar no Banco
        const pedRef = db.ref('orders').push();
        await pedRef.set({
            customer: { name: nome, phone: cTel.value },
            items: carrinho,
            total: vTotal.innerText,
            status: "Pendente",
            date: new Date().toLocaleString()
        });

        // Montar mensagem WhatsApp
        let msg = `*NOVO PEDIDO - ABELLA JOIAS*\n\nCliente: ${nome}\nPagamento: ${cPag.value}\n\n*ITENS:*\n`;
        carrinho.forEach(i => msg += `- ${i.qtd}x ${i.nome} (${i.variacao})\n`);
        msg += `\n*TOTAL: ${vTotal.innerText}*`;
        
        window.open(`https://wa.me/55SEU_NUMERO_AQUI?text=${encodeURIComponent(msg)}`);
        localStorage.removeItem('carrinho');
        location.href = 'index.html';
    }

    render();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abella Joias | Ultra Performance</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; background: #f8fafc; color: #1e293b; -webkit-font-smoothing: antialiased; }
        .serif { font-family: 'Cinzel', serif; }
        
        /* Otimização de Renderização */
        #gridLoja { content-visibility: auto; contain-intrinsic-size: 300px; }

        .card-enterprise { 
            background: #ffffff; border-radius: 16px; border: 1px solid #f1f5f9; 
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-enterprise:hover { transform: translateY(-4px); box-shadow: 0 12px 20px -5px rgba(0,0,0,0.05); }
        
        .img-box { aspect-ratio: 1/1; background: #f8fafc; border-radius: 12px; margin: 8px; overflow: hidden; }
        .img-box img { width: 100%; height: 100%; object-fit: cover; }

        /* Esconder scrollbar mas manter funcionalidade */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .active-cat { background: white; color: #b89552; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-color: #b89552 !important; }
    </style>
</head>
<body>

<header class="sticky top-0 z-[100] bg-white/90 backdrop-blur-md border-b border-slate-100">
    <div class="max-w-[1600px] mx-auto px-6 py-4 flex items-center justify-between">
        <div>
            <h1 class="serif text-xl font-bold tracking-tighter uppercase">ABELLA <span class="text-[#b89552]">ATACADO</span></h1>
            <p id="statusInfo" class="text-[9px] font-bold text-slate-400 tracking-[2px] uppercase">Carregando catálogo...</p>
        </div>

        <div class="flex items-center gap-4">
            <div id="resumoCart" class="hidden md:flex flex-col items-end pr-4 border-r border-slate-100">
                <span class="text-[10px] font-bold text-slate-400">SEU PEDIDO</span>
                <span id="valorTotalHeader" class="text-sm font-black tracking-tighter">R$ 0,00</span>
            </div>
            <button onclick="window.location.href='carrinho.html'" class="bg-slate-900 text-white p-3 md:px-6 rounded-2xl flex items-center gap-2 hover:bg-[#b89552] transition-all">
                <i class="fas fa-shopping-bag text-sm"></i>
                <span class="hidden md:block font-bold text-xs uppercase tracking-widest">Finalizar</span>
            </button>
        </div>
    </div>
</header>

<div class="max-w-[1600px] mx-auto flex flex-col lg:flex-row p-6 gap-8">
    <aside class="w-full lg:w-64 shrink-0">
        <div class="sticky top-28">
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Categorias</h3>
            <nav id="menuLateral" class="flex flex-row lg:flex-col gap-2 overflow-x-auto no-scrollbar pb-4 lg:pb-0">
                </nav>
        </div>
    </aside>

    <main class="flex-1">
        <div id="gridLoja" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6">
            <div class="h-64 bg-white animate-pulse rounded-2xl"></div>
            <div class="h-64 bg-white animate-pulse rounded-2xl"></div>
            <div class="h-64 bg-white animate-pulse rounded-2xl"></div>
            <div class="h-64 bg-white animate-pulse rounded-2xl"></div>
        </div>

        <div id="loadMore" class="h-20 flex items-center justify-center mt-10 text-slate-400 text-xs font-bold uppercase tracking-widest">
            <i class="fas fa-circle-notch animate-spin mr-2"></i> Buscando mais produtos...
        </div>
    </main>
</div>

<div id="modalCompra" class="fixed inset-0 z-[200] bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-sm rounded-[32px] p-8 shadow-2xl scale-95 transition-transform duration-300">
        <div id="mImg" class="w-full aspect-square rounded-2xl bg-slate-50 overflow-hidden mb-6 border border-slate-100"></div>
        <h3 id="mNome" class="serif text-lg font-bold text-slate-900 uppercase tracking-tight">Nome</h3>
        <p id="mPreco" class="text-[#b89552] font-black text-2xl mt-1">R$ 0,00</p>
        
        <div class="flex items-center justify-between bg-slate-50 p-2 rounded-2xl my-6">
            <button onclick="mudarQtd(-1)" class="w-12 h-12 rounded-xl bg-white shadow-sm flex items-center justify-center active:scale-90 transition"><i class="fas fa-minus"></i></button>
            <span id="mVal" class="text-2xl font-black">1</span>
            <button onclick="mudarQtd(1)" class="w-12 h-12 rounded-xl bg-white shadow-sm flex items-center justify-center active:scale-90 transition"><i class="fas fa-plus"></i></button>
        </div>
        
        <button id="btnAdd" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-bold uppercase tracking-widest text-xs hover:bg-[#b89552] transition-colors shadow-lg">Adicionar ao Carrinho</button>
        <button onclick="fecharModal()" class="w-full text-slate-400 text-[10px] uppercase font-bold mt-4">Fechar</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<script>
    const fM = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    firebase.initializeApp({
        apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
        databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com"
    });
    const db = firebase.database();

    let dbItems = [];
    let displayedItems = [];
    let itemsPerPage = 20;
    let currentPage = 1;

    // --- CARREGAMENTO OTIMIZADO ---
    async function init() {
        // Categorias (Carrega uma vez)
        db.ref('categories').once('value', snap => {
            const menu = document.getElementById('menuLateral');
            menu.innerHTML = `<button onclick="filterCat('all')" id="cat-all" class="cat-btn active-cat border border-transparent whitespace-nowrap">Todos os Brutos</button>`;
            snap.forEach(s => {
                const c = s.val();
                if(!c.paused) {
                    menu.innerHTML += `<button onclick="filterCat('${s.key}')" id="cat-${s.key}" class="cat-btn border border-slate-100 lg:border-transparent whitespace-nowrap lg:w-full">${c.name}</button>`;
                }
            });
        });

        // Produtos (Busca os dados mas não renderiza todos de uma vez)
        db.ref('products').on('value', snap => {
            dbItems = [];
            snap.forEach(s => dbItems.push({id: s.key, ...s.val()}));
            document.getElementById('statusInfo').innerText = `${dbItems.length} Peças Disponíveis`;
            resetAndRender();
        });

        // Listener de Scroll para Infinite Scroll
        window.addEventListener('scroll', () => {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
                loadMoreItems();
            }
        });
    }

    function resetAndRender() {
        currentPage = 1;
        document.getElementById('gridLoja').innerHTML = '';
        renderPage();
    }

    function renderPage() {
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageItems = dbItems.slice(start, end);
        
        const grid = document.getElementById('gridLoja');
        
        pageItems.forEach(p => {
            const div = document.createElement('div');
            div.className = "card-enterprise flex flex-col cursor-pointer";
            div.onclick = () => abrirCompra(p.id);
            div.innerHTML = `
                <div class="img-box relative">
                    <img src="${p.image}" loading="lazy">
                </div>
                <div class="p-4 pt-0 text-center">
                    <p class="text-[8px] text-slate-400 font-bold uppercase mb-1">Ref: ${p.id.substring(0,6)}</p>
                    <h3 class="text-[10px] font-bold text-slate-700 uppercase leading-tight h-8 overflow-hidden mb-2">${p.name}</h3>
                    <span class="text-base font-black text-slate-900 tracking-tight">${fM(p.price)}</span>
                </div>
            `;
            grid.appendChild(div);
        });

        if (end >= dbItems.length) {
            document.getElementById('loadMore').classList.add('hidden');
        } else {
            document.getElementById('loadMore').classList.remove('hidden');
        }
    }

    function loadMoreItems() {
        if ((currentPage * itemsPerPage) < dbItems.length) {
            currentPage++;
            renderPage();
        }
    }

    // --- DINÂMICA DE COMPRA ---
    function abrirCompra(id) {
        const p = dbItems.find(x => x.id === id);
        document.getElementById('mNome').innerText = p.name;
        document.getElementById('mPreco').innerText = fM(p.price);
        document.getElementById('mImg').innerHTML = `<img src="${p.image}" class="w-full h-full object-cover">`;
        document.getElementById('mVal').innerText = "1";
        
        document.getElementById('btnAdd').onclick = () => {
            const qtd = parseInt(document.getElementById('mVal').innerText);
            let cart = JSON.parse(localStorage.getItem('carrinho') || '[]');
            const idx = cart.findIndex(i => i.id === p.id);
            if(idx > -1) cart[idx].quantidade += qtd;
            else cart.push({...p, quantidade: qtd});
            localStorage.setItem('carrinho', JSON.stringify(cart));
            fecharModal();
            atualizarHeader();
        };
        
        document.getElementById('modalCompra').classList.remove('hidden');
        setTimeout(() => document.querySelector('#modalCompra > div').classList.replace('scale-95', 'scale-100'), 10);
    }

    function mudarQtd(v) {
        let el = document.getElementById('mVal');
        el.innerText = Math.max(1, parseInt(el.innerText) + v);
    }

    function fecharModal() {
        document.querySelector('#modalCompra > div').classList.replace('scale-100', 'scale-95');
        setTimeout(() => document.getElementById('modalCompra').classList.add('hidden'), 200);
    }

    function filterCat(catId) {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active-cat'));
        document.getElementById('cat-' + catId).classList.add('active-cat');

        if(catId === 'all') {
            db.ref('products').once('value', snap => {
                dbItems = [];
                snap.forEach(s => dbItems.push({id: s.key, ...s.val()}));
                resetAndRender();
            });
        } else {
            db.ref('products').once('value', snap => {
                dbItems = [];
                snap.forEach(s => {
                    const p = s.val();
                    if(p.category === catId) dbItems.push({id: s.key, ...p});
                });
                resetAndRender();
            });
        }
    }

    function atualizarHeader() {
        const cart = JSON.parse(localStorage.getItem('carrinho') || '[]');
        const total = cart.reduce((acc, i) => acc + (i.price * i.quantidade), 0);
        document.getElementById('valorTotalHeader').innerText = fM(total);
        if(total > 0) document.getElementById('resumoCart').classList.remove('hidden');
    }

    window.onload = () => {
        init();
        atualizarHeader();
    };
</script>
</body>
</html>

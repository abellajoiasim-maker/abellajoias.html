<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abella Joias | Business Intelligence Atacado</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { font-family: 'Poppins', sans-serif; background: #0b0b0b; color: #eee; }
        .serif { font-family: 'Cinzel', serif; }
        .gold-text { color: #caa85c; }
        .bg-gold { background: #caa85c; }
        
        /* Enterprise Card Mix */
        .card-lux { 
            background: #141414; 
            border: 1px solid #2a2a2a; 
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            overflow: hidden;
        }
        .card-lux:hover { 
            transform: translateY(-8px); 
            border-color: #caa85c; 
            box-shadow: 0 15px 30px rgba(0,0,0,0.5);
        }
        
        .img-container {
            width: 100%;
            aspect-ratio: 1/1;
            overflow: hidden;
            background: #000;
        }
        .img-container img {
            width: 100%; height: 100%; object-fit: cover;
            transition: transform 0.8s;
        }
        .card-lux:hover img { transform: scale(1.1); }

        /* Sidebar Enterprise Style */
        .sidebar { height: calc(100vh - 120px); position: sticky; top: 100px; }
        
        /* Modal Style */
        .modal-blur { backdrop-filter: blur(8px); background: rgba(0,0,0,0.8); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #caa85c; border-radius: 10px; }
    </style>
</head>
<body>

<header class="sticky top-0 z-[100] bg-black/95 border-b border-[#222] backdrop-blur-md">
    <div class="max-w-[1600px] mx-auto px-6 py-4 flex flex-col md:flex-row items-center justify-between gap-4">
        <div class="text-center md:text-left">
            <h1 class="serif text-2xl gold-text tracking-widest uppercase" id="nomeLoja">Abella Joias</h1>
            <p class="text-[9px] tracking-[3px] text-gray-500 uppercase font-light" id="sloganLoja">Atacado de Joias no Bruto</p>
        </div>

        <div class="flex items-center gap-4">
            <div class="hidden lg:block text-right mr-4 border-r border-gray-800 pr-4">
                <p class="text-[9px] text-gray-500 uppercase">Faturamento Mínimo</p>
                <div class="w-32 h-1 bg-gray-900 rounded-full mt-1">
                    <div id="progressoMin" class="h-full bg-gold w-0 transition-all duration-700"></div>
                </div>
            </div>
            <button onclick="abrirCarrinho()" class="bg-[#caa85c] text-black px-6 py-2 rounded-full font-bold text-xs flex items-center gap-2 hover:scale-105 transition">
                <i class="fas fa-shopping-cart"></i>
                <span id="contadorCarrinho">R$ 0,00</span>
            </button>
        </div>
    </div>
</header>

<div class="max-w-[1600px] mx-auto flex flex-col lg:flex-row px-6 py-8 gap-8">
    
    <aside class="sidebar w-full lg:w-72 hidden lg:block">
        <h3 class="serif gold-text text-sm tracking-widest mb-6 uppercase">Coleções</h3>
        <nav id="menuCategorias" class="flex flex-col gap-2">
            </nav>
        
        <div class="mt-10 p-6 border border-[#2a2a2a] rounded-2xl">
            <h4 class="text-[10px] gold-text font-bold uppercase mb-2">Suporte Direto</h4>
            <p class="text-[11px] text-gray-500 mb-4">Dúvidas sobre o pedido mínimo ou banho?</p>
            <a href="#" class="text-xs font-bold border-b border-[#caa85c] pb-1">Chamar Consultor</a>
        </div>
    </aside>

    <main class="flex-1">
        <div id="bannerPromo" class="hidden mb-8 p-4 bg-gradient-to-r from-amber-900 to-black rounded-2xl border border-amber-600/30 flex justify-between items-center">
            <div>
                <h4 class="gold-text font-bold text-sm uppercase">Campanha Atacado Ativa</h4>
                <p class="text-[11px] text-gray-300">Descontos aplicados automaticamente no carrinho.</p>
            </div>
            <i class="fas fa-bolt text-amber-500 animate-pulse"></i>
        </div>

        <div id="gridProdutos" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-6">
            </div>
    </main>
</div>

<div id="modalQtd" class="fixed inset-0 z-[200] modal-blur hidden flex items-center justify-center p-4">
    <div class="bg-[#141414] border border-[#2a2a2a] w-full max-w-sm rounded-3xl p-8 text-center">
        <div id="modalImg" class="w-32 h-32 mx-auto rounded-2xl mb-4 bg-black overflow-hidden border border-gray-800"></div>
        <h3 id="modalNome" class="serif gold-text text-lg mb-1 uppercase tracking-widest">Produto</h3>
        <p id="modalPreco" class="text-gray-400 text-sm mb-6">R$ 0,00</p>
        
        <div class="flex items-center justify-center gap-6 mb-8">
            <button onclick="alterarModalQtd(-1)" class="w-12 h-12 rounded-full border border-[#2a2a2a] flex items-center justify-center hover:bg-[#caa85c] hover:text-black transition text-xl">-</button>
            <span id="modalVal" class="text-3xl font-bold">1</span>
            <button onclick="alterarModalQtd(1)" class="w-12 h-12 rounded-full border border-[#2a2a2a] flex items-center justify-center hover:bg-[#caa85c] hover:text-black transition text-xl">+</button>
        </div>
        
        <div class="flex flex-col gap-3">
            <button id="btnConfirmar" class="w-full bg-[#caa85c] text-black py-4 rounded-2xl font-bold uppercase tracking-widest text-xs">Confirmar Peças</button>
            <button onclick="fecharModal()" class="text-gray-500 text-[10px] uppercase font-bold tracking-widest">Cancelar</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<script>
    const fM = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    const firebaseConfig = {
        apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
        databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let allProducts = [];
    let configGeral = {};
    let produtoEmEdicao = null;
    const PEDIDO_MINIMO = 800;

    async function init() {
        await carregarConfig();
        carregarCategorias();
        carregarProdutos();
        atualizarResumo();
    }

    async function carregarConfig() {
        const snap = await db.ref('settings').get();
        configGeral = snap.val() || {};
        if(configGeral.empresa?.nome) document.getElementById('nomeLoja').innerText = configGeral.empresa.nome;
        if(configGeral.promocao?.ativa) document.getElementById('bannerPromo').classList.remove('hidden');
    }

    function carregarCategorias() {
        db.ref('categories').on('value', snap => {
            const side = document.getElementById('menuCategorias');
            side.innerHTML = `<button onclick="renderGrid(allProducts)" class="text-left px-4 py-2 text-[11px] font-bold gold-text bg-white/5 rounded-lg border border-[#caa85c]/30 mb-2 uppercase tracking-widest">Ver Tudo</button>`;
            snap.forEach(s => {
                const cat = s.val();
                if(cat.paused) return;
                side.innerHTML += `
                    <button onclick="filtrar('${s.key}')" class="text-left px-4 py-2 text-[11px] text-gray-500 hover:text-[#caa85c] hover:bg-white/5 rounded-lg transition uppercase tracking-widest">
                        ${cat.name}
                    </button>`;
            });
        });
    }

    function carregarProdutos() {
        db.ref('products').on('value', snap => {
            allProducts = [];
            snap.forEach(s => allProducts.push({id: s.key, ...s.val()}));
            renderGrid(allProducts);
        });
    }

    function renderGrid(list) {
        const grid = document.getElementById('gridProdutos');
        grid.innerHTML = list.map(p => {
            const temPromo = configGeral.promocao?.ativa && p.promoPct > 0;
            return `
                <div class="card-lux rounded-2xl flex flex-col cursor-pointer" onclick="abrirModalCompra('${p.id}')">
                    <div class="img-container relative">
                        ${temPromo ? `<span class="absolute top-3 right-3 bg-[#caa85c] text-black text-[9px] px-2 py-1 rounded font-bold z-10">-${p.promoPct}%</span>` : ''}
                        <img src="${p.image}" loading="lazy">
                    </div>
                    <div class="p-4 text-center flex-1 flex flex-col justify-between">
                        <div>
                            <p class="text-[9px] text-gray-600 font-bold uppercase tracking-widest mb-1">Ref: ${p.id.substring(0,6)}</p>
                            <h3 class="serif text-[11px] gold-text uppercase leading-tight h-8 overflow-hidden">${p.name}</h3>
                        </div>
                        <div class="mt-4">
                            <span class="text-xs text-gray-500 line-through block">${temPromo ? fM(p.price * 1.3) : ''}</span>
                            <span class="text-lg font-black tracking-tighter">${fM(p.price)}</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // DINAMICA DE MODAL (MODUS OPERANDI SOLICITADO)
    function abrirModalCompra(id) {
        const p = allProducts.find(x => x.id === id);
        produtoEmEdicao = p;
        document.getElementById('modalNome').innerText = p.name;
        document.getElementById('modalPreco').innerText = fM(p.price);
        document.getElementById('modalImg').innerHTML = `<img src="${p.image}" class="w-full h-full object-cover">`;
        document.getElementById('modalVal').innerText = "1";
        
        document.getElementById('btnConfirmar').onclick = () => {
            const qtd = parseInt(document.getElementById('modalVal').innerText);
            adicionarAoCarrinho(p, qtd);
        };
        
        document.getElementById('modalQtd').classList.remove('hidden');
    }

    function alterarModalQtd(v) {
        let atual = parseInt(document.getElementById('modalVal').innerText);
        atual = Math.max(1, atual + v);
        document.getElementById('modalVal').innerText = atual;
    }

    function fecharModal() {
        document.getElementById('modalQtd').classList.add('hidden');
    }

    // LOGICA DE CARRINHO (COMPATÍVEL COM O SEU CÓDIGO)
    function adicionarAoCarrinho(p, qtd) {
        let carrinho = JSON.parse(localStorage.getItem('carrinho') || '[]');
        const index = carrinho.findIndex(item => item.id === p.id);
        
        if(index > -1) carrinho[index].quantidade += qtd;
        else carrinho.push({...p, quantidade: qtd});
        
        localStorage.setItem('carrinho', JSON.stringify(carrinho));
        fecharModal();
        atualizarResumo();
    }

    function atualizarResumo() {
        const carrinho = JSON.parse(localStorage.getItem('carrinho') || '[]');
        const total = carrinho.reduce((acc, item) => acc + (item.price * item.quantidade), 0);
        
        document.getElementById('contadorCarrinho').innerText = fM(total);
        
        // Barra de progresso do pedido mínimo
        const perc = Math.min((total / PEDIDO_MINIMO) * 100, 100);
        document.getElementById('progressoMin').style.width = perc + '%';
    }

    function filtrar(catId) {
        const filtrados = allProducts.filter(p => p.category === catId);
        renderGrid(filtrados);
    }

    window.onload = init;
</script>
</body>
</html>

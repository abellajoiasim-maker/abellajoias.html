<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Abella Joias | Cat√°logo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Poppins', sans-serif; background: #0b0b0b; color: #eee; margin:0; }
        .serif { font-family: 'Cinzel', serif; }
        .gold-text { color: #caa85c; }
        .gold-bg { background: #caa85c; }
        header { background: #000; border-bottom: 1px solid #222; }
        
        /* Utilit√°rios de Transi√ß√£o */
        .view { display: none; opacity: 0; transition: opacity 0.4s ease; }
        .view.active { display: block; opacity: 1; }

        /* Estilo dos Cards */
        .card-lux { background: #141414; border: 1px solid #2a2a2a; border-radius: 15px; transition: .3s; overflow: hidden; cursor: pointer; }
        .card-lux:hover { border-color: #caa85c; transform: translateY(-3px); }
        .img-container { width:100%; aspect-ratio:1/1; background:#1a1a1a; display:flex; align-items:center; justify-content:center; overflow:hidden; }
        .img-container img { width:100%; height:100%; object-fit:cover; transition: 0.5s; }
        .card-lux:hover img { transform: scale(1.05); }

        /* Modal */
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:100; align-items:center; justify-content:center; padding: 20px; backdrop-blur: 5px; }
        .modal.active { display:flex; }
        .modal-content { background:#141414; border: 1px solid #2a2a2a; padding: 25px; border-radius: 20px; width: 100%; max-width: 450px; max-height: 85vh; overflow-y: auto; text-align: center; }
        
        .grid-vars { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
        .item-var { background: #0b0b0b; border: 1px solid #333; border-radius: 10px; padding: 8px; }
        .item-var span { display: block; font-size: 10px; color: #caa85c; font-weight: bold; margin-bottom: 4px; }
        .item-var input { background: transparent; border: none; color: #fff; text-align: center; width: 100%; font-weight: bold; }
    </style>
</head>
<body>

<header class="sticky top-0 z-50 shadow-lg text-center bg-black/90 backdrop-blur-md">
    <div class="max-w-7xl mx-auto px-4 py-4">
        <h1 class="serif text-2xl gold-text tracking-widest uppercase" id="nomeLoja">Abella Joias</h1>
        <p class="text-[9px] tracking-[4px] text-gray-500 font-light mt-1 mb-4 uppercase" id="sloganLoja">Atacado de Joias no Bruto</p>
        
        <div class="flex gap-2 justify-center items-center flex-wrap">
            <button onclick="showCategorias()" class="px-4 py-1.5 rounded-full border border-[#caa85c] gold-text text-[10px] font-bold uppercase">Categorias</button>
            <a href="galvanicas.html" class="px-4 py-1.5 rounded-full border border-dashed border-[#caa85c] gold-text text-[10px] font-bold">‚ú® GALV√ÇNICAS</a>
            <a href="carrinho.html" class="px-4 py-1.5 rounded-full border border-[#caa85c] gold-text text-[10px] font-bold flex items-center gap-2">
                üõí <span id="contadorCarrinho">R$ 0,00</span>
            </a>
        </div>
    </div>
</header>

<main class="max-w-7xl mx-auto p-6 pb-20">
    <section id="viewCategorias" class="view active">
        <h2 class="serif text-center mb-8 text-lg gold-text tracking-widest uppercase">Cole√ß√µes</h2>
        <div id="gridCategorias" class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-8"></div>
    </section>

    <section id="viewProdutos" class="view">
        <button onclick="showCategorias()" class="mb-6 text-[10px] font-bold gold-text uppercase">‚Üê Voltar para Categorias</button>
        <h2 id="tituloCategoria" class="serif text-xl mb-8 gold-text uppercase tracking-widest">...</h2>
        <div id="gridProdutos" class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6"></div>
    </section>
</main>

<div id="modalQtd" class="modal">
    <div class="modal-content">
        <h3 class="serif gold-text text-lg mb-4" id="modalNomeProd">Produto</h3>
        <img id="modalImgProd" class="w-full max-w-[200px] aspect-square object-cover rounded-xl mx-auto mb-4 border border-[#333]">
        <div id="containerOpcoes"></div>
        <div class="flex gap-2 mt-8">
            <button onclick="fecharModal()" class="flex-1 py-3 text-[10px] font-bold text-gray-500 uppercase">Voltar</button>
            <button id="btnConfirmarAdd" class="flex-1 gold-bg text-black py-3 rounded-xl text-[10px] font-bold uppercase">Confirmar</button>
        </div>
    </div>
</div>

<script>
// CONFIGURA√á√ÉO
if (!firebase.apps.length) {
    firebase.initializeApp({
        apiKey: "AIzaSyDPBZSxW8XjtQmDMUknzAyIlFda51MvMJY",
        databaseURL: "https://catalogo-abella-joias-default-rtdb.firebaseio.com"
    });
}
const db = firebase.database();
let state = {
    allProducts: [],
    settings: {},
    currentCat: null
};

// UTILIT√ÅRIOS
const fM = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

function atualizarContador() {
    const carrinho = JSON.parse(localStorage.getItem('carrinho') || '[]');
    const total = carrinho.reduce((acc, i) => acc + (parseFloat(i.precoFinal || i.price) * (i.quantidade || 1)), 0);
    document.getElementById('contadorCarrinho').innerText = fM(total);
}

// NAVEGA√á√ÉO
function showCategorias() {
    document.getElementById('viewProdutos').classList.remove('active');
    document.getElementById('viewCategorias').classList.add('active');
    window.scrollTo(0,0);
}

function showProdutos(catId, catName, catPromo) {
    state.currentCat = { id: catId, name: catName, promo: catPromo };
    document.getElementById('tituloCategoria').innerText = catName;
    renderProdutos();
    document.getElementById('viewCategorias').classList.remove('active');
    document.getElementById('viewProdutos').classList.add('active');
    window.scrollTo(0,0);
}

// DADOS
async function init() {
    // Carregar Settings
    db.ref('settings').on('value', s => {
        const val = s.val();
        state.settings = val;
        if(val.empresa) {
            document.getElementById('nomeLoja').innerText = val.empresa.nome;
            document.getElementById('sloganLoja').innerText = val.empresa.subtitulo;
        }
    });

    // Carregar Categorias
    db.ref('categories').on('value', snap => {
        const grid = document.getElementById('gridCategorias');
        grid.innerHTML = '';
        snap.forEach(s => {
            const c = s.val();
            if(c.paused) return;
            grid.innerHTML += `
                <div class="card-lux flex flex-col" onclick="showProdutos('${s.key}', '${c.name}', ${c.promoPct || 0})">
                    <div class="img-container"><img src="${c.image}"></div>
                    <div class="p-4 text-center"><span class="serif text-[11px] gold-text uppercase font-bold">${c.name}</span></div>
                </div>`;
        });
    });

    // Carregar Produtos em cache
    db.ref('products').on('value', snap => {
        state.allProducts = [];
        snap.forEach(s => {
            state.allProducts.push({ key: s.key, ...s.val() });
        });
        if(state.currentCat) renderProdutos();
    });

    atualizarContador();
}

function renderProdutos() {
    const grid = document.getElementById('gridProdutos');
    grid.innerHTML = '';
    
    const prods = state.allProducts.filter(p => String(p.category) === String(state.currentCat.id) && !p.paused);
    
    prods.forEach(p => {
        const pct = state.currentCat.promo || p.promoPct || 0;
        const precoFinal = pct > 0 ? p.price * (1 - pct/100) : p.price;
        
        grid.innerHTML += `
            <div class="card-lux p-4 flex flex-col h-full" onclick='abrirModal(${JSON.stringify({...p, precoFinal}).replace(/'/g,"&apos;")})'>
                <div class="img-container mb-4 rounded-xl relative">
                    <img src="${p.image}">
                </div>
                <div class="flex-1">
                    <h3 class="text-[10px] font-bold uppercase mb-2 leading-tight h-8 overflow-hidden">${p.name}</h3>
                    <div class="text-lg font-bold gold-text">${fM(precoFinal)}</div>
                </div>
                <button class="w-full gold-bg text-black py-2 rounded-lg text-[9px] font-bold uppercase mt-3">Comprar</button>
            </div>`;
    });
}

// L√ìGICA DO MODAL (VARIA√á√ïES)
let produtoParaAdd = null;

function abrirModal(p) {
    produtoParaAdd = p;
    document.getElementById('modalNomeProd').innerText = p.name;
    document.getElementById('modalImgProd').src = p.image;
    
    const container = document.getElementById('containerOpcoes');
    container.innerHTML = '';

    let opcoes = [];
    if (p.variacaoTipo === 'Aro') opcoes = ["10", "12", "14", "16", "18", "20", "22", "24", "26"];
    else if (p.opcoesPersonalizadas) opcoes = p.opcoesPersonalizadas.split(',').map(o => o.trim());

    if (opcoes.length > 0) {
        let html = '<div class="grid-vars">';
        opcoes.forEach(opt => {
            html += `<div class="item-var"><span>${opt}</span><input type="number" min="0" value="0" data-var="${opt}" class="input-var"></div>`;
        });
        container.innerHTML = html + '</div>';
    } else {
        container.innerHTML = `<input type="number" id="qtdSimples" value="1" min="1" class="w-20 p-3 text-center gold-bg text-black rounded-xl font-bold">`;
    }
    document.getElementById('modalQtd').classList.add('active');
}

document.getElementById('btnConfirmarAdd').onclick = () => {
    let carrinho = JSON.parse(localStorage.getItem('carrinho') || '[]');
    const inputs = document.querySelectorAll('.input-var');
    let added = false;

    if (inputs.length > 0) {
        inputs.forEach(i => {
            const q = parseInt(i.value);
            if (q > 0) {
                carrinho.push({ ...produtoParaAdd, name: `${produtoParaAdd.name} (${i.dataset.var})`, quantidade: q });
                added = true;
            }
        });
    } else {
        const q = parseInt(document.getElementById('qtdSimples').value);
        if (q > 0) {
            carrinho.push({ ...produtoParaAdd, quantidade: q });
            added = true;
        }
    }

    if(added) {
        localStorage.setItem('carrinho', JSON.stringify(carrinho));
        atualizarContador();
        fecharModal();
        alert("Adicionado!");
    }
};

function fecharModal() { document.getElementById('modalQtd').classList.remove('active'); }

window.onload = init;
</script>
</body>
</html>
